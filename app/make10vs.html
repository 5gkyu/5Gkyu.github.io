<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>make10 vs - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4a90d9;
            --primary-dark: #357abd;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #eee;
            --text-muted: #888;
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
        }

        header h1 span {
            color: var(--warning-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .user-info .status-dot {
            width: 10px;
            height: 10px;
            background: var(--secondary-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* ãƒ­ãƒ“ãƒ¼ç”»é¢ */
        #lobby-screen.active {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .lobby-header h2 {
            font-size: 1.3rem;
        }

        /* ãƒœã‚¿ãƒ³å…±é€š */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: #555;
            color: white;
        }

        /* ãƒ«ãƒ¼ãƒ ä¸€è¦§ */
        .room-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .room-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
            margin-bottom: 0.5rem;
        }

        .room-count {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .refresh-btn {
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }

        .room-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .room-card:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .room-name .lock-icon {
            font-size: 0.9rem;
            color: var(--warning-color);
        }

        .room-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
        }

        .room-players {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .player-count {
            background: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .player-count.full {
            background: var(--danger-color);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 400px;
            padding: 1.5rem;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.2rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-color);
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .form-group label .required {
            color: var(--danger-color);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #333;
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group input::placeholder {
            color: #555;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* å¾…æ©Ÿç”»é¢ */
        #waiting-screen {
            text-align: center;
            padding: 2rem;
        }

        .waiting-room-info {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .waiting-room-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .waiting-players {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
        }

        .waiting-player {
            text-align: center;
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 0.5rem;
        }

        .player-avatar.empty {
            background: #333;
            border: 3px dashed #555;
        }

        .player-name {
            font-weight: bold;
        }

        .waiting-status {
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .waiting-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-screen.active {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            max-height: calc(100vh - 80px);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }

        .game-player {
            text-align: center;
            flex: 1;
        }

        .game-player-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .game-player-name.highlight {
            color: var(--warning-color);
        }

        .game-score {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
        }

        .score-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #555;
        }

        .score-dot.win {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .score-dot.lose {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }

        .game-vs {
            font-size: 1.2rem;
            font-weight: bold;
            color: #555;
            padding: 0 1rem;
        }

        /* å•é¡Œã‚¨ãƒªã‚¢ */
        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 0.5rem;
            min-height: 0;
        }

        .round-info {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .round-number {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .difficulty {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .difficulty-1 { background: #27ae60; }
        .difficulty-2 { background: #2ecc71; }
        .difficulty-3 { background: #f39c12; }
        .difficulty-4 { background: #e67e22; }
        .difficulty-5 { background: #e74c3c; }

        .problem-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .problem-digits {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .digit-card {
            width: 60px;
            height: 70px;
            background: linear-gradient(135deg, #4a90d9, #357abd);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .digit-card.used {
            opacity: 0.4;
            transform: scale(0.9);
        }

        /* ã‚¿ã‚¤ãƒãƒ¼ */
        .timer-container {
            text-align: center;
            margin: 0.5rem 0;
        }

        .timer-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--warning-color));
            transition: width 0.1s linear;
        }

        .timer-fill.danger {
            background: linear-gradient(90deg, var(--warning-color), var(--danger-color));
        }

        .timer-text {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* å¼è¡¨ç¤º */
        .expression-display {
            background: var(--bg-color);
            border: 2px solid #333;
            border-radius: 10px;
            padding: 1rem;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-family: 'Consolas', monospace;
            margin: 0.5rem 0;
        }

        .expression-display.correct {
            border-color: var(--secondary-color);
            background: rgba(46, 204, 113, 0.1);
        }

        .expression-display.wrong {
            border-color: var(--danger-color);
            background: rgba(231, 76, 60, 0.1);
        }

        .expression-result {
            text-align: center;
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .expression-result.valid {
            color: var(--secondary-color);
        }

        /* å…¥åŠ›ãƒ‘ãƒƒãƒ‰ */
        .input-pad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .input-btn {
            padding: 0.75rem;
            font-size: 1.3rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: #333;
            color: var(--text-color);
        }

        .input-btn:hover {
            background: #444;
            transform: scale(1.05);
        }

        .input-btn:active {
            transform: scale(0.95);
        }

        .input-btn.digit {
            background: var(--primary-color);
        }

        .input-btn.digit:hover {
            background: var(--primary-dark);
        }

        .input-btn.digit.disabled {
            background: #333;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-btn.operator {
            background: var(--warning-color);
            color: #000;
        }

        .input-btn.operator:hover {
            background: #e67e22;
        }

        .input-btn.action {
            background: #555;
        }

        .input-btn.submit {
            background: var(--secondary-color);
            grid-column: span 2;
        }

        .input-btn.submit:hover {
            background: #27ae60;
        }

        .input-btn.submit:disabled {
            background: #333;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-btn.clear {
            background: var(--danger-color);
        }

        /* ç›¸æ‰‹ã®çŠ¶æ…‹è¡¨ç¤º */
        .opponent-status {
            text-align: center;
            padding: 0.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .opponent-status.submitted {
            color: var(--warning-color);
        }

        .opponent-status.correct {
            color: var(--secondary-color);
        }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .countdown-overlay.hidden {
            display: none;
        }

        .countdown-round {
            font-size: 1.5rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .countdown-number {
            font-size: 8rem;
            font-weight: bold;
            color: var(--primary-color);
            animation: countPulse 1s ease-in-out infinite;
        }

        @keyframes countPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .result-overlay.hidden {
            display: none;
        }

        .result-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .result-title.win {
            color: var(--secondary-color);
        }

        .result-title.lose {
            color: var(--danger-color);
        }

        .result-title.draw {
            color: var(--warning-color);
        }

        .result-answer {
            background: var(--card-bg);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .result-answer-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .result-answer-expr {
            font-size: 1.5rem;
            font-family: 'Consolas', monospace;
        }

        /* ãƒãƒƒãƒçµæœ */
        .match-result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 600;
        }

        .match-result-overlay.hidden {
            display: none;
        }

        .match-result-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 2rem;
        }

        .match-result-score {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 2rem;
        }

        /* ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º */
        .test-mode-badge {
            background: var(--warning-color);
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 600px) {
            header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .lobby-header {
                flex-direction: column;
                text-align: center;
            }

            .room-card {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .room-meta {
                justify-content: center;
            }

            .waiting-players {
                flex-direction: column;
            }

            .digit-card {
                width: 50px;
                height: 60px;
                font-size: 1.5rem;
            }

            .input-btn {
                padding: 0.6rem;
                font-size: 1.1rem;
            }

            .expression-display {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header>
        <h1>make<span>10</span> vs</h1>
        <div class="user-info">
            <span class="status-dot"></span>
            <span id="current-user-name">ã‚²ã‚¹ãƒˆ</span>
        </div>
    </header>

    <div class="container">
        <!-- ãƒ­ãƒ“ãƒ¼ç”»é¢ -->
        <div id="lobby-screen" class="screen active">
            <div class="lobby-header">
                <h2>ğŸ® ãƒ«ãƒ¼ãƒ ä¸€è¦§</h2>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="test-room-btn">
                        ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤
                    </button>
                    <button class="btn btn-primary" id="create-room-btn">
                        â• ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <div class="room-list-header">
                <span class="room-count" id="room-count">0 éƒ¨å±‹</span>
                <button class="refresh-btn" id="refresh-btn" title="æ›´æ–°">ğŸ”„</button>
            </div>

            <div class="room-list" id="room-list">
                <!-- ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                <div class="empty-state" id="empty-state">
                    <div class="icon">ğŸ¯</div>
                    <p>ç¾åœ¨å‹Ÿé›†ä¸­ã®ãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã¡ã¾ã—ã‚‡ã†ï¼</p>
                </div>
            </div>
        </div>

        <!-- å¾…æ©Ÿç”»é¢ -->
        <div id="waiting-screen" class="screen">
            <div class="waiting-room-info">
                <div class="waiting-room-name" id="waiting-room-name">ãƒ«ãƒ¼ãƒ å</div>
                <div class="waiting-status">
                    <span id="waiting-bo">BO5</span> â€¢ 
                    <span id="waiting-room-id">Room ID: ---</span>
                </div>
                
                <div class="waiting-players">
                    <div class="waiting-player">
                        <div class="player-avatar" id="host-avatar">ğŸ‘‘</div>
                        <div class="player-name" id="host-name">ãƒ›ã‚¹ãƒˆ</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">ãƒ›ã‚¹ãƒˆ</div>
                    </div>
                    <div style="display: flex; align-items: center; font-size: 2rem; color: #555;">VS</div>
                    <div class="waiting-player">
                        <div class="player-avatar empty" id="guest-avatar">?</div>
                        <div class="player-name" id="guest-name">å¾…æ©Ÿä¸­...</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">ã‚²ã‚¹ãƒˆ</div>
                    </div>
                </div>

                <div class="waiting-spinner" id="waiting-spinner"></div>
                <p id="waiting-message">å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
            </div>

            <button class="btn btn-danger" id="leave-room-btn">ğŸšª ãƒ«ãƒ¼ãƒ ã‚’é€€å‡º</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="screen">
            <!-- ã‚¹ã‚³ã‚¢ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="game-header">
                <div class="game-player">
                    <div class="game-player-name" id="game-host-name">ãƒ›ã‚¹ãƒˆ</div>
                    <div class="game-score" id="host-score"></div>
                </div>
                <div class="game-vs">VS</div>
                <div class="game-player">
                    <div class="game-player-name" id="game-guest-name">ã‚²ã‚¹ãƒˆ</div>
                    <div class="game-score" id="guest-score"></div>
                </div>
            </div>

            <!-- å•é¡Œã‚¨ãƒªã‚¢ -->
            <div class="game-main">
                <div class="round-info">
                    <span class="round-number" id="round-number">ç¬¬1å•</span>
                    <span class="difficulty difficulty-3" id="difficulty">é›£æ˜“åº¦ â˜…â˜…â˜…</span>
                </div>

                <div class="problem-display">
                    <div class="problem-digits" id="problem-digits">
                        <div class="digit-card">3</div>
                        <div class="digit-card">3</div>
                        <div class="digit-card">7</div>
                        <div class="digit-card">9</div>
                    </div>
                </div>

                <div class="timer-container">
                    <div class="timer-bar">
                        <div class="timer-fill" id="timer-fill" style="width: 100%;"></div>
                    </div>
                    <div class="timer-text" id="timer-text">25</div>
                </div>

                <div class="expression-result" id="expression-result">å¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                <div class="expression-display" id="expression-display"></div>

                <div class="opponent-status" id="opponent-status">ç›¸æ‰‹: å…¥åŠ›ä¸­...</div>
            </div>

            <!-- å…¥åŠ›ãƒ‘ãƒƒãƒ‰ -->
            <div class="input-pad" id="input-pad">
                <button class="input-btn digit" data-digit="1">1</button>
                <button class="input-btn digit" data-digit="2">2</button>
                <button class="input-btn digit" data-digit="3">3</button>
                <button class="input-btn operator" data-op="+">+</button>

                <button class="input-btn digit" data-digit="4">4</button>
                <button class="input-btn digit" data-digit="5">5</button>
                <button class="input-btn digit" data-digit="6">6</button>
                <button class="input-btn operator" data-op="-">âˆ’</button>

                <button class="input-btn digit" data-digit="7">7</button>
                <button class="input-btn digit" data-digit="8">8</button>
                <button class="input-btn digit" data-digit="9">9</button>
                <button class="input-btn operator" data-op="*">Ã—</button>

                <button class="input-btn clear" data-action="clear">C</button>
                <button class="input-btn action backspace" data-action="backspace">âŒ«</button>
                <button class="input-btn operator" data-op="/">Ã·</button>
                <button class="input-btn submit" id="submit-btn" disabled>é€ä¿¡</button>
            </div>
        </div>

        <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="countdown-overlay hidden" id="countdown-overlay">
            <div class="countdown-round" id="countdown-round">ç¬¬1å•</div>
            <div class="countdown-number" id="countdown-number">5</div>
        </div>

        <!-- ãƒ©ã‚¦ãƒ³ãƒ‰çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="result-overlay hidden" id="result-overlay">
            <div class="result-title" id="result-title">æ­£è§£ï¼</div>
            <div class="result-answer">
                <div class="result-answer-label">ç­”ãˆ</div>
                <div class="result-answer-expr" id="result-answer">3 Ã— 3 + 7 - 9 = 10</div>
            </div>
        </div>

        <!-- ãƒãƒƒãƒçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="match-result-overlay hidden" id="match-result-overlay">
            <div class="match-result-title" id="match-result-title">ğŸ‰ å‹åˆ©ï¼</div>
            <div class="match-result-score" id="match-result-score">3 - 1</div>
            <button class="btn btn-primary" id="back-to-lobby-btn">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="create-room-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ® ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</h3>
                <button class="modal-close" id="close-create-modal">&times;</button>
            </div>
            <form id="create-room-form">
                <div class="form-group">
                    <label>ãƒ«ãƒ¼ãƒ å <span class="required">*</span></label>
                    <input type="text" id="room-name-input" placeholder="ä¾‹: åˆå¿ƒè€…æ­“è¿ï¼" required maxlength="20">
                </div>
                <div class="form-group">
                    <label>ã‚ãªãŸã®åå‰</label>
                    <input type="text" id="host-name-input" placeholder="ãƒ›ã‚¹ãƒˆ" maxlength="10">
                </div>
                <div class="form-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</label>
                    <input type="password" id="room-password-input" placeholder="ãªã—ã®å ´åˆã¯ç©ºæ¬„">
                </div>
                <div class="form-group">
                    <label>å¯¾æˆ¦æœ¬æ•°</label>
                    <select id="room-bo-input">
                        <option value="3">BO3ï¼ˆ2æœ¬å…ˆå–ï¼‰</option>
                        <option value="5" selected>BO5ï¼ˆ3æœ¬å…ˆå–ï¼‰</option>
                        <option value="7">BO7ï¼ˆ4æœ¬å…ˆå–ï¼‰</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-create-room">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ãƒ«ãƒ¼ãƒ å‚åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="join-room-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸš€ ãƒ«ãƒ¼ãƒ ã«å‚åŠ </h3>
                <button class="modal-close" id="close-join-modal">&times;</button>
            </div>
            <form id="join-room-form">
                <div class="form-group">
                    <label>å‚åŠ ã™ã‚‹ãƒ«ãƒ¼ãƒ </label>
                    <input type="text" id="join-room-name" readonly style="background: #222;">
                </div>
                <div class="form-group">
                    <label>ã‚ãªãŸã®åå‰</label>
                    <input type="text" id="guest-name-input" placeholder="ã‚²ã‚¹ãƒˆ" maxlength="10">
                </div>
                <div class="form-group" id="join-password-group" style="display: none;">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="required">*</span></label>
                    <input type="password" id="join-password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                </div>
                <input type="hidden" id="join-room-id">
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-join-room">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-success">å‚åŠ ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // ========================================
        // Firebase åˆæœŸåŒ–
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBM_6leTzC3lKdmO_b4nvb0SgubTSn2rO0",
            authDomain: "make10vs.firebaseapp.com",
            databaseURL: "https://make10vs-default-rtdb.firebaseio.com",
            projectId: "make10vs",
            storageBucket: "make10vs.firebasestorage.app",
            messagingSenderId: "461653417380",
            appId: "1:461653417380:web:d0c64a9c8b0b5498fc7531",
            measurementId: "G-35DCQ7MMMR"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
        // ========================================
        let currentUserId = null;
        let currentUserName = 'ã‚²ã‚¹ãƒˆ';
        let currentRoomId = null;
        let currentRoomRef = null;
        let roomsListener = null;

        // ========================================
        // DOMè¦ç´ 
        // ========================================
        const lobbyScreen = document.getElementById('lobby-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const gameScreen = document.getElementById('game-screen');
        const roomList = document.getElementById('room-list');
        const emptyState = document.getElementById('empty-state');
        const roomCount = document.getElementById('room-count');
        const currentUserNameEl = document.getElementById('current-user-name');

        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        const createRoomModal = document.getElementById('create-room-modal');
        const joinRoomModal = document.getElementById('join-room-modal');

        // ========================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ========================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showModal(modal) {
            modal.classList.add('active');
        }

        function hideModal(modal) {
            modal.classList.remove('active');
        }

        function hashPassword(password) {
            // ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥ï¼ˆæœ¬ç•ªã§ã¯ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã‚’ä½¿ç”¨ï¼‰
            if (!password) return null;
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        // ========================================
        // ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—ãƒ»è¡¨ç¤º
        // ========================================
        function subscribeToRooms() {
            const roomsRef = database.ref('rooms');
            
            roomsListener = roomsRef.orderByChild('meta/state').equalTo('open').on('value', (snapshot) => {
                const rooms = snapshot.val() || {};
                renderRoomList(rooms);
            });
        }

        function unsubscribeFromRooms() {
            if (roomsListener) {
                database.ref('rooms').off('value', roomsListener);
                roomsListener = null;
            }
        }

        function renderRoomList(rooms) {
            const roomEntries = Object.entries(rooms).filter(([id, room]) => {
                return room.meta && room.meta.state === 'open';
            });

            roomCount.textContent = `${roomEntries.length} éƒ¨å±‹`;

            if (roomEntries.length === 0) {
                emptyState.style.display = 'block';
                // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
                document.querySelectorAll('.room-card').forEach(card => card.remove());
                return;
            }

            emptyState.style.display = 'none';

            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
            document.querySelectorAll('.room-card').forEach(card => card.remove());

            // ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
            roomEntries.forEach(([roomId, room]) => {
                const meta = room.meta;
                const hasPassword = !!meta.passwordHash;
                const playerCount = meta.guestId ? 2 : 1;

                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">
                            ${hasPassword ? '<span class="lock-icon">ğŸ”’</span>' : ''}
                            ${escapeHtml(meta.roomName)}
                        </div>
                        <div class="room-meta">
                            <span>ğŸ‘¤ ${escapeHtml(meta.hostName || 'ãƒ›ã‚¹ãƒˆ')}</span>
                            <span>ğŸ¯ BO${meta.bo}</span>
                        </div>
                    </div>
                    <div class="room-players">
                        <span class="player-count ${playerCount >= 2 ? 'full' : ''}">${playerCount}/2</span>
                        <button class="btn btn-success" ${playerCount >= 2 ? 'disabled' : ''}>
                            å‚åŠ 
                        </button>
                    </div>
                `;

                const joinBtn = card.querySelector('.btn-success');
                if (playerCount < 2) {
                    joinBtn.addEventListener('click', () => openJoinModal(roomId, meta));
                }

                roomList.insertBefore(card, emptyState);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // ãƒ«ãƒ¼ãƒ ä½œæˆ
        // ========================================
        document.getElementById('create-room-btn').addEventListener('click', () => {
            showModal(createRoomModal);
        });

        document.getElementById('close-create-modal').addEventListener('click', () => {
            hideModal(createRoomModal);
        });

        document.getElementById('cancel-create-room').addEventListener('click', () => {
            hideModal(createRoomModal);
        });

        document.getElementById('create-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const roomName = document.getElementById('room-name-input').value.trim();
            const hostName = document.getElementById('host-name-input').value.trim() || 'ãƒ›ã‚¹ãƒˆ';
            const password = document.getElementById('room-password-input').value;
            const bo = parseInt(document.getElementById('room-bo-input').value);

            if (!roomName) {
                alert('ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const newRoomRef = database.ref('rooms').push();
                const roomId = newRoomRef.key;

                await newRoomRef.set({
                    meta: {
                        roomName: roomName,
                        hostId: currentUserId,
                        hostName: hostName,
                        guestId: null,
                        guestName: null,
                        passwordHash: hashPassword(password),
                        bo: bo,
                        state: 'open',
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    }
                });

                currentUserName = hostName;
                currentUserNameEl.textContent = hostName;
                currentRoomId = roomId;

                hideModal(createRoomModal);
                document.getElementById('create-room-form').reset();

                enterWaitingRoom(roomId, roomName, hostName, null, bo, true);

            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ«ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // ========================================
        // ãƒ«ãƒ¼ãƒ å‚åŠ 
        // ========================================
        function openJoinModal(roomId, meta) {
            document.getElementById('join-room-name').value = meta.roomName;
            document.getElementById('join-room-id').value = roomId;
            
            const passwordGroup = document.getElementById('join-password-group');
            if (meta.passwordHash) {
                passwordGroup.style.display = 'block';
                document.getElementById('join-password-input').required = true;
            } else {
                passwordGroup.style.display = 'none';
                document.getElementById('join-password-input').required = false;
            }

            showModal(joinRoomModal);
        }

        document.getElementById('close-join-modal').addEventListener('click', () => {
            hideModal(joinRoomModal);
        });

        document.getElementById('cancel-join-room').addEventListener('click', () => {
            hideModal(joinRoomModal);
        });

        document.getElementById('join-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const roomId = document.getElementById('join-room-id').value;
            const guestName = document.getElementById('guest-name-input').value.trim() || 'ã‚²ã‚¹ãƒˆ';
            const password = document.getElementById('join-password-input').value;

            try {
                const roomRef = database.ref(`rooms/${roomId}`);
                const snapshot = await roomRef.once('value');
                const room = snapshot.val();

                if (!room || room.meta.state !== 'open') {
                    alert('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã‚‹ã‹ã€å­˜åœ¨ã—ã¾ã›ã‚“');
                    hideModal(joinRoomModal);
                    return;
                }

                if (room.meta.guestId) {
                    alert('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«æº€å“¡ã§ã™');
                    hideModal(joinRoomModal);
                    return;
                }

                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
                if (room.meta.passwordHash && hashPassword(password) !== room.meta.passwordHash) {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                // ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ 
                await roomRef.child('meta').update({
                    guestId: currentUserId,
                    guestName: guestName
                });

                currentUserName = guestName;
                currentUserNameEl.textContent = guestName;
                currentRoomId = roomId;

                hideModal(joinRoomModal);
                document.getElementById('join-room-form').reset();

                enterWaitingRoom(roomId, room.meta.roomName, room.meta.hostName, guestName, room.meta.bo, false);

            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒ å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ«ãƒ¼ãƒ ã¸ã®å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // ========================================
        // å¾…æ©Ÿç”»é¢
        // ========================================
        function enterWaitingRoom(roomId, roomName, hostName, guestName, bo, isHost) {
            showScreen('waiting-screen');

            document.getElementById('waiting-room-name').textContent = roomName;
            document.getElementById('waiting-bo').textContent = `BO${bo}`;
            document.getElementById('waiting-room-id').textContent = `Room ID: ${roomId.slice(-6)}`;
            document.getElementById('host-name').textContent = hostName;

            if (guestName) {
                document.getElementById('guest-name').textContent = guestName;
                document.getElementById('guest-avatar').textContent = 'ğŸ®';
                document.getElementById('guest-avatar').classList.remove('empty');
            } else {
                document.getElementById('guest-name').textContent = 'å¾…æ©Ÿä¸­...';
                document.getElementById('guest-avatar').textContent = '?';
                document.getElementById('guest-avatar').classList.add('empty');
            }

            // ãƒ«ãƒ¼ãƒ ã®å¤‰æ›´ã‚’ç›£è¦–
            currentRoomRef = database.ref(`rooms/${roomId}/meta`);
            currentRoomRef.on('value', (snapshot) => {
                const meta = snapshot.val();
                console.log('rooms/' + roomId + '/meta changed:', meta);
                if (!meta) {
                    // ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚ŒãŸ
                    alert('ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                    leaveRoom();
                    return;
                }

                // ã‚²ã‚¹ãƒˆãŒå‚åŠ ã—ãŸ
                if (meta.guestId && meta.guestName) {
                    document.getElementById('guest-name').textContent = meta.guestName;
                    document.getElementById('guest-avatar').textContent = 'ğŸ®';
                    document.getElementById('guest-avatar').classList.remove('empty');
                    document.getElementById('waiting-message').textContent = 'å¯¾æˆ¦æº–å‚™å®Œäº†ï¼ã¾ã‚‚ãªãé–‹å§‹ã—ã¾ã™...';

                    // 2äººæƒã£ãŸã‚‰è©¦åˆé–‹å§‹ï¼ˆãƒ›ã‚¹ãƒˆå´ã§é–‹å§‹å‡¦ç†ï¼‰
                    if (isHost && meta.state === 'open') {
                        console.log('Host: starting match countdown');
                        startMatchCountdown(roomId);
                    }
                }

                // è©¦åˆé–‹å§‹çŠ¶æ…‹ã«ãªã£ãŸ
                if (meta.state === 'playing') {
                    console.log('Detected meta.state=playing for room', roomId);
                    // ã‚²ãƒ¼ãƒ ç”»é¢ã¸é·ç§»
                    document.getElementById('waiting-message').textContent = 'è©¦åˆé–‹å§‹ï¼';
                    document.getElementById('waiting-spinner').style.display = 'none';

                    // ãƒ­ãƒ“ãƒ¼ä¸€è¦§ã®ç›£è¦–ã‚’æ­¢ã‚ã€ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ IDã‚’è¨­å®š
                    try {
                        unsubscribeFromRooms();
                    } catch (e) {
                        console.warn('unsubscribe error', e);
                    }

                    currentRoomId = roomId;
                    gameState.isTestMode = false;
                    gameState.bo = meta.bo || gameState.bo;
                    gameState.round = 1;
                    gameState.hostName = meta.hostName || 'ãƒ›ã‚¹ãƒˆ';
                    gameState.guestName = meta.guestName || 'ã‚²ã‚¹ãƒˆ';

                    // UIåæ˜ ã—ã¦ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆæ—¢ã«ã‚²ãƒ¼ãƒ ç”»é¢ãªã‚‰é‡è¤‡å‘¼ã³å‡ºã—ã—ãªã„ï¼‰
                    currentUserNameEl.textContent = currentUserName;
                    if (!document.getElementById('game-screen').classList.contains('active')) {
                        console.log('Starting game UI for guest/host');
                        startGame();
                    } else {
                        console.log('Game already active, skipping startGame()');
                    }
                }
            });
        }

        async function startMatchCountdown(roomId) {
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰è©¦åˆçŠ¶æ…‹ã«ç§»è¡Œ
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await database.ref(`rooms/${roomId}/meta`).update({
                state: 'playing'
            });
        }

        // ========================================
        // ãƒ«ãƒ¼ãƒ é€€å‡º
        // ========================================
        document.getElementById('leave-room-btn').addEventListener('click', () => {
            if (confirm('æœ¬å½“ã«ãƒ«ãƒ¼ãƒ ã‚’é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
                leaveRoom();
            }
        });

        async function leaveRoom() {
            if (currentRoomRef) {
                currentRoomRef.off();
            }

            if (currentRoomId) {
                try {
                    const roomRef = database.ref(`rooms/${currentRoomId}/meta`);
                    const snapshot = await roomRef.once('value');
                    const meta = snapshot.val();

                    if (meta) {
                        if (meta.hostId === currentUserId) {
                            // ãƒ›ã‚¹ãƒˆãŒé€€å‡º â†’ ãƒ«ãƒ¼ãƒ å‰Šé™¤
                            await database.ref(`rooms/${currentRoomId}`).remove();
                        } else if (meta.guestId === currentUserId) {
                            // ã‚²ã‚¹ãƒˆãŒé€€å‡º
                            await roomRef.update({
                                guestId: null,
                                guestName: null,
                                state: 'open'
                            });
                        }
                    }
                } catch (error) {
                    console.error('é€€å‡ºã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            currentRoomId = null;
            currentRoomRef = null;
            showScreen('lobby-screen');
        }

        // ========================================
        // æ›´æ–°ãƒœã‚¿ãƒ³
        // ========================================
        document.getElementById('refresh-btn').addEventListener('click', () => {
            const btn = document.getElementById('refresh-btn');
            btn.style.transform = 'rotate(360deg)';
            setTimeout(() => btn.style.transform = '', 500);
        });

        // ========================================
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        // ========================================
        createRoomModal.addEventListener('click', (e) => {
            if (e.target === createRoomModal) hideModal(createRoomModal);
        });

        joinRoomModal.addEventListener('click', (e) => {
            if (e.target === joinRoomModal) hideModal(joinRoomModal);
        });

        // ========================================
        // ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
        // ========================================
        let gameState = {
            isTestMode: false,
            bo: 5,
            round: 1,
            hostScore: 0,
            guestScore: 0,
            hostName: 'ãƒ›ã‚¹ãƒˆ',
            guestName: 'ã‚²ã‚¹ãƒˆ',
            digits: [],
            usedDigits: [],
            expression: '',
            timeLeft: 25,
            timerInterval: null,
            submitted: false,
            solutions: []
        };

        // 10ã‚’ä½œã‚Œã‚‹çµ„ã¿åˆã‚ã›ã‚’äº‹å‰è¨ˆç®—ã™ã‚‹ãŸã‚ã®é–¢æ•°
        function generateValidProblems() {
            const validProblems = [];
            for (let a = 1; a <= 9; a++) {
                for (let b = 1; b <= 9; b++) {
                    for (let c = 1; c <= 9; c++) {
                        for (let d = 1; d <= 9; d++) {
                            const digits = [a, b, c, d];
                            const solutions = findSolutions(digits);
                            if (solutions.length > 0) {
                                validProblems.push({ digits, solutions });
                            }
                        }
                    }
                }
            }
            return validProblems;
        }

        // 4ã¤ã®æ•°å­—ã‹ã‚‰10ã‚’ä½œã‚‹å…¨ã¦ã®å¼ã‚’æ¢ã™ï¼ˆæ‹¬å¼§ãªã—ã®ã¿ï¼‰
        function findSolutions(digits) {
            const solutions = [];
            const ops = ['+', '-', '*', '/'];
            const perms = permutations(digits);

            for (const perm of perms) {
                const [a, b, c, d] = perm;
                for (const op1 of ops) {
                    for (const op2 of ops) {
                        for (const op3 of ops) {
                            // æ‹¬å¼§ãªã—: a op1 b op2 c op3 dï¼ˆå·¦ã‹ã‚‰é †ã«è¨ˆç®—ã€æ¼”ç®—å­ã®å„ªå…ˆé †ä½ã«å¾“ã†ï¼‰
                            const expr = `${a}${op1}${b}${op2}${c}${op3}${d}`;
                            if (safeEval(expr) === 10) {
                                solutions.push(formatExpr(a, op1, b, op2, c, op3, d));
                            }
                        }
                    }
                }
            }
            return [...new Set(solutions)];
        }

        function formatExpr(a, op1, b, op2, c, op3, d) {
            const opMap = {'+': ' + ', '-': ' - ', '*': ' Ã— ', '/': ' Ã· '};
            return `${a}${opMap[op1]}${b}${opMap[op2]}${c}${opMap[op3]}${d}`;
        }

        function permutations(arr) {
            if (arr.length <= 1) return [arr];
            const result = [];
            for (let i = 0; i < arr.length; i++) {
                const rest = [...arr.slice(0, i), ...arr.slice(i + 1)];
                for (const perm of permutations(rest)) {
                    result.push([arr[i], ...perm]);
                }
            }
            return result;
        }

        function safeEval(expr) {
            try {
                const result = Function('"use strict"; return (' + expr + ')')();
                return Math.abs(result - 10) < 0.0001 ? 10 : result;
            } catch {
                return null;
            }
        }

        // é›£æ˜“åº¦ã‚’è¨ˆç®—ï¼ˆæ‹¬å¼§ãªã—ç”¨ï¼‰
        // é›£æ˜“åº¦1: è§£ãŒå¤šã„ï¼ˆ10å€‹ä»¥ä¸Šï¼‰
        // é›£æ˜“åº¦2: è§£ãŒãã“ãã“ï¼ˆ5-9å€‹ï¼‰
        // é›£æ˜“åº¦3: è§£ãŒå°‘ãªã‚ï¼ˆ2-4å€‹ï¼‰
        // é›£æ˜“åº¦4: è§£ãŒ1ã¤ã ã‘
        // é›£æ˜“åº¦5: é™¤ç®—ã‚’å«ã¿è§£ãŒ1ã¤ã ã‘
        function calculateDifficulty(solutions) {
            if (solutions.length === 0) return 5;
            
            const hasDivide = solutions.some(s => s.includes('Ã·'));
            const hasMultiply = solutions.some(s => s.includes('Ã—'));
            
            if (solutions.length >= 10) return 1;
            if (solutions.length >= 5) return 2;
            if (solutions.length >= 2) return 3;
            // è§£ãŒ1ã¤ã ã‘
            if (hasDivide) return 5;
            return 4;
        }

        // å•é¡Œã‚’ç”Ÿæˆ
        function generateProblem() {
            // ãƒ©ãƒ³ãƒ€ãƒ ãª4æ¡ã‚’ç”Ÿæˆã—ã€è§£ãŒå­˜åœ¨ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
            let digits, solutions;
            do {
                digits = [
                    Math.floor(Math.random() * 9) + 1,
                    Math.floor(Math.random() * 9) + 1,
                    Math.floor(Math.random() * 9) + 1,
                    Math.floor(Math.random() * 9) + 1
                ];
                solutions = findSolutions(digits);
            } while (solutions.length === 0);

            return { digits, solutions };
        }

        // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        document.getElementById('test-room-btn').addEventListener('click', () => {
            gameState.isTestMode = true;
            gameState.bo = 5;
            gameState.round = 1;
            gameState.hostScore = 0;
            gameState.guestScore = 0;
            gameState.hostName = 'ã‚ãªãŸ';
            gameState.guestName = 'CPU';
            currentUserName = 'ã‚ãªãŸ';
            currentUserNameEl.textContent = 'ã‚ãªãŸ (ãƒ†ã‚¹ãƒˆ)';

            // ãƒ«ãƒ¼ãƒ ç›£è¦–ã‚’åœæ­¢ï¼ˆå¯¾æˆ¦ä¸­ã¯ãƒ­ãƒ“ãƒ¼ã‚’è¦‹ãªã„ï¼‰
            unsubscribeFromRooms();

            startGame();
        });

        function startGame() {
            showScreen('game-screen');
            updateScoreDisplay();
            document.getElementById('game-host-name').textContent = gameState.hostName;
            document.getElementById('game-guest-name').textContent = gameState.guestName;
            
            if (gameState.isTestMode) {
                document.getElementById('game-guest-name').innerHTML = gameState.guestName + ' <span class="test-mode-badge">TEST</span>';
            }

            startRound();
        }

        function startRound() {
            // å•é¡Œç”Ÿæˆ
            const problem = generateProblem();
            gameState.digits = problem.digits;
            gameState.solutions = problem.solutions;
            gameState.usedDigits = [];
            gameState.expression = '';
            gameState.submitted = false;
            gameState.timeLeft = 25;

            const difficulty = calculateDifficulty(gameState.solutions);

            // UIæ›´æ–°
            updateDigitButtons();
            updateExpressionDisplay();
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('opponent-status').textContent = 'ç›¸æ‰‹: å…¥åŠ›ä¸­...';
            document.getElementById('opponent-status').className = 'opponent-status';

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
            showCountdown(gameState.round, () => {
                // å•é¡Œè¡¨ç¤º
                renderProblem(difficulty);
                startTimer();
            });
        }

        function showCountdown(round, callback) {
            const overlay = document.getElementById('countdown-overlay');
            const roundEl = document.getElementById('countdown-round');
            const numberEl = document.getElementById('countdown-number');

            overlay.classList.remove('hidden');
            roundEl.textContent = `ç¬¬${round}å•`;

            let count = 3;
            numberEl.textContent = count;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    numberEl.textContent = count;
                } else {
                    clearInterval(interval);
                    overlay.classList.add('hidden');
                    callback();
                }
            }, 1000);
        }

        function renderProblem(difficulty) {
            document.getElementById('round-number').textContent = `ç¬¬${gameState.round}å•`;

            const diffEl = document.getElementById('difficulty');
            diffEl.textContent = 'é›£æ˜“åº¦ ' + 'â˜…'.repeat(difficulty) + 'â˜†'.repeat(5 - difficulty);
            diffEl.className = `difficulty difficulty-${difficulty}`;

            const digitsContainer = document.getElementById('problem-digits');
            digitsContainer.innerHTML = gameState.digits.map((d, i) => 
                `<div class="digit-card" data-index="${i}">${d}</div>`
            ).join('');
        }

        function startTimer() {
            const timerFill = document.getElementById('timer-fill');
            const timerText = document.getElementById('timer-text');

            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft -= 0.1;
                const percent = (gameState.timeLeft / 25) * 100;
                timerFill.style.width = `${percent}%`;
                timerText.textContent = Math.ceil(gameState.timeLeft);

                if (gameState.timeLeft <= 5) {
                    timerFill.classList.add('danger');
                } else {
                    timerFill.classList.remove('danger');
                }

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    handleTimeout();
                }
            }, 100);
        }

        function handleTimeout() {
            if (!gameState.submitted) {
                showRoundResult('draw', gameState.solutions[0] || 'è§£ãªã—');
            }
        }

        // å…¥åŠ›ãƒ‘ãƒƒãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('input-pad').addEventListener('click', (e) => {
            if (gameState.submitted) return;

            const btn = e.target.closest('.input-btn');
            if (!btn) return;

            const digit = btn.dataset.digit;
            const op = btn.dataset.op;
            const action = btn.dataset.action;

            if (digit) {
                // æ•°å­—ãƒœã‚¿ãƒ³ - ä½¿ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                const digitNum = parseInt(digit);
                const availableDigits = [...gameState.digits];
                gameState.usedDigits.forEach(d => {
                    const idx = availableDigits.indexOf(d);
                    if (idx !== -1) availableDigits.splice(idx, 1);
                });

                if (availableDigits.includes(digitNum)) {
                    gameState.expression += digit;
                    gameState.usedDigits.push(digitNum);
                    updateDigitButtons();
                    updateExpressionDisplay();
                }
            } else if (op) {
                gameState.expression += op;
                updateExpressionDisplay();
            } else if (action === 'backspace') {
                if (gameState.expression.length > 0) {
                    const lastChar = gameState.expression.slice(-1);
                    gameState.expression = gameState.expression.slice(0, -1);
                    
                    // æ•°å­—ã‚’å‰Šé™¤ã—ãŸå ´åˆã€usedDigitsã‹ã‚‰ã‚‚å‰Šé™¤
                    if (/[1-9]/.test(lastChar)) {
                        const idx = gameState.usedDigits.lastIndexOf(parseInt(lastChar));
                        if (idx !== -1) gameState.usedDigits.splice(idx, 1);
                    }
                    updateDigitButtons();
                    updateExpressionDisplay();
                }
            } else if (action === 'clear') {
                gameState.expression = '';
                gameState.usedDigits = [];
                updateDigitButtons();
                updateExpressionDisplay();
            }
        });

        function updateDigitButtons() {
            const availableDigits = [...gameState.digits];
            gameState.usedDigits.forEach(d => {
                const idx = availableDigits.indexOf(d);
                if (idx !== -1) availableDigits.splice(idx, 1);
            });

            document.querySelectorAll('.input-btn.digit').forEach(btn => {
                const digit = parseInt(btn.dataset.digit);
                if (availableDigits.includes(digit)) {
                    btn.classList.remove('disabled');
                } else {
                    btn.classList.add('disabled');
                }
            });

            // å•é¡Œã®æ•°å­—ã‚«ãƒ¼ãƒ‰ã®è¦‹ãŸç›®ã‚‚æ›´æ–°
            document.querySelectorAll('.digit-card').forEach((card, i) => {
                const usedCount = gameState.usedDigits.filter(d => d === gameState.digits[i]).length;
                const originalCount = gameState.digits.filter(d => d === gameState.digits[i]).length;
                // ã“ã®ä½ç½®ã®æ•°å­—ãŒä½¿ç”¨æ¸ˆã¿ã‹ã©ã†ã‹
                let usedSoFar = 0;
                for (let j = 0; j <= i; j++) {
                    if (gameState.digits[j] === gameState.digits[i]) usedSoFar++;
                }
                const thisUsedCount = gameState.usedDigits.filter(d => d === gameState.digits[i]).length;
                if (usedSoFar <= thisUsedCount) {
                    card.classList.add('used');
                } else {
                    card.classList.remove('used');
                }
            });
        }

        function updateExpressionDisplay() {
            const display = document.getElementById('expression-display');
            const resultEl = document.getElementById('expression-result');
            const submitBtn = document.getElementById('submit-btn');

            // è¡¨ç¤ºç”¨ã«æ¼”ç®—å­ã‚’å¤‰æ›
            const displayExpr = gameState.expression
                .replace(/\*/g, 'Ã—')
                .replace(/\//g, 'Ã·');
            display.textContent = displayExpr || ' ';
            display.className = 'expression-display';

            // å¼ã®è©•ä¾¡
            if (gameState.expression && gameState.usedDigits.length === 4) {
                try {
                    const result = safeEval(gameState.expression);
                    if (result !== null) {
                        resultEl.textContent = `= ${result}`;
                        if (result === 10) {
                            resultEl.classList.add('valid');
                            display.classList.add('correct');
                            submitBtn.disabled = false;
                        } else {
                            resultEl.classList.remove('valid');
                            submitBtn.disabled = true;
                        }
                    } else {
                        resultEl.textContent = 'å¼ãŒä¸æ­£ã§ã™';
                        resultEl.classList.remove('valid');
                        submitBtn.disabled = true;
                    }
                } catch {
                    resultEl.textContent = 'å¼ãŒä¸æ­£ã§ã™';
                    resultEl.classList.remove('valid');
                    submitBtn.disabled = true;
                }
            } else if (gameState.expression) {
                // é€”ä¸­ã®å¼ã‚’è©•ä¾¡
                try {
                    const result = safeEval(gameState.expression);
                    if (result !== null) {
                        resultEl.textContent = `= ${result} (æ•°å­—ã‚’ã™ã¹ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„)`;
                    } else {
                        resultEl.textContent = 'æ•°å­—ã‚’ã™ã¹ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„';
                    }
                } catch {
                    resultEl.textContent = 'æ•°å­—ã‚’ã™ã¹ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„';
                }
                resultEl.classList.remove('valid');
                submitBtn.disabled = true;
            } else {
                resultEl.textContent = 'å¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                resultEl.classList.remove('valid');
                submitBtn.disabled = true;
            }
        }

        // é€ä¿¡ãƒœã‚¿ãƒ³
        document.getElementById('submit-btn').addEventListener('click', () => {
            if (gameState.submitted) return;
            submitAnswer();
        });

        function submitAnswer() {
            gameState.submitted = true;
            clearInterval(gameState.timerInterval);

            const displayExpr = gameState.expression
                .replace(/\*/g, 'Ã—')
                .replace(/\//g, 'Ã·');

            if (gameState.isTestMode) {
                // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯å¸¸ã«è‡ªåˆ†ã®å‹ã¡
                showRoundResult('win', displayExpr + ' = 10');
            } else {
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ã®å ´åˆã¯Firebaseã«é€ä¿¡ï¼ˆå¾Œã§å®Ÿè£…ï¼‰
                showRoundResult('win', displayExpr + ' = 10');
            }
        }

        function showRoundResult(result, answer) {
            const overlay = document.getElementById('result-overlay');
            const titleEl = document.getElementById('result-title');
            const answerEl = document.getElementById('result-answer');

            overlay.classList.remove('hidden');
            answerEl.textContent = answer;

            if (result === 'win') {
                titleEl.textContent = 'ğŸ‰ æ­£è§£ï¼';
                titleEl.className = 'result-title win';
                gameState.hostScore++;
            } else if (result === 'lose') {
                titleEl.textContent = 'ğŸ˜¢ ç›¸æ‰‹ãŒå…ˆã«æ­£è§£';
                titleEl.className = 'result-title lose';
                gameState.guestScore++;
            } else {
                titleEl.textContent = 'â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—';
                titleEl.className = 'result-title draw';
            }

            updateScoreDisplay();

            // å‹æ•—ãƒã‚§ãƒƒã‚¯
            const winTarget = Math.ceil(gameState.bo / 2);

            setTimeout(() => {
                overlay.classList.add('hidden');

                if (gameState.hostScore >= winTarget) {
                    showMatchResult('win');
                } else if (gameState.guestScore >= winTarget) {
                    showMatchResult('lose');
                } else {
                    gameState.round++;
                    startRound();
                }
            }, 3000);
        }

        function updateScoreDisplay() {
            const hostScoreEl = document.getElementById('host-score');
            const guestScoreEl = document.getElementById('guest-score');
            const winTarget = Math.ceil(gameState.bo / 2);

            hostScoreEl.innerHTML = '';
            guestScoreEl.innerHTML = '';

            for (let i = 0; i < winTarget; i++) {
                const hostDot = document.createElement('div');
                hostDot.className = 'score-dot' + (i < gameState.hostScore ? ' win' : '');
                hostScoreEl.appendChild(hostDot);

                const guestDot = document.createElement('div');
                guestDot.className = 'score-dot' + (i < gameState.guestScore ? ' win' : '');
                guestScoreEl.appendChild(guestDot);
            }
        }

        function showMatchResult(result) {
            const overlay = document.getElementById('match-result-overlay');
            const titleEl = document.getElementById('match-result-title');
            const scoreEl = document.getElementById('match-result-score');

            overlay.classList.remove('hidden');

            if (result === 'win') {
                titleEl.textContent = 'ğŸ‰ å‹åˆ©ï¼';
                titleEl.style.color = 'var(--secondary-color)';
            } else {
                titleEl.textContent = 'ğŸ˜¢ æ•—åŒ—...';
                titleEl.style.color = 'var(--danger-color)';
            }

            scoreEl.textContent = `${gameState.hostScore} - ${gameState.guestScore}`;
        }

        document.getElementById('back-to-lobby-btn').addEventListener('click', () => {
            document.getElementById('match-result-overlay').classList.add('hidden');
            if (!gameState.isTestMode && currentRoomId) {
                leaveRoom();
            } else {
                showScreen('lobby-screen');
            }
            gameState.isTestMode = false;
            
            // ãƒ«ãƒ¼ãƒ ç›£è¦–ã‚’å†é–‹
            subscribeToRooms();
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›å¯¾å¿œ
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('game-screen').classList.contains('active')) return;
            if (gameState.submitted) return;

            const key = e.key;

            if (/^[1-9]$/.test(key)) {
                const digitNum = parseInt(key);
                const availableDigits = [...gameState.digits];
                gameState.usedDigits.forEach(d => {
                    const idx = availableDigits.indexOf(d);
                    if (idx !== -1) availableDigits.splice(idx, 1);
                });

                if (availableDigits.includes(digitNum)) {
                    gameState.expression += key;
                    gameState.usedDigits.push(digitNum);
                    updateDigitButtons();
                    updateExpressionDisplay();
                }
            } else if (['+', '-', '*', '/'].includes(key)) {
                gameState.expression += key;
                updateExpressionDisplay();
            } else if (key === '(' || key === ')') {
                    // æ‹¬å¼§å…¥åŠ›ã¯ç„¡åŠ¹åŒ–ï¼ˆç„¡è¦–ï¼‰
                } else if (key === 'Backspace') {
                if (gameState.expression.length > 0) {
                    const lastChar = gameState.expression.slice(-1);
                    gameState.expression = gameState.expression.slice(0, -1);
                    if (/[1-9]/.test(lastChar)) {
                        const idx = gameState.usedDigits.lastIndexOf(parseInt(lastChar));
                        if (idx !== -1) gameState.usedDigits.splice(idx, 1);
                    }
                    updateDigitButtons();
                    updateExpressionDisplay();
                }
            } else if (key === 'Enter') {
                const submitBtn = document.getElementById('submit-btn');
                if (!submitBtn.disabled) {
                    submitAnswer();
                }
            } else if (key === 'Escape' || key === 'c' || key === 'C') {
                gameState.expression = '';
                gameState.usedDigits = [];
                updateDigitButtons();
                updateExpressionDisplay();
            }
        });

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        // åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã‹ã‚‰åˆæœŸåŒ–
        auth.signInAnonymously()
            .then((userCredential) => {
                currentUserId = userCredential.user.uid;
                console.log('åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³æˆåŠŸ');
                console.log('User ID:', currentUserId);
                currentUserNameEl.textContent = currentUserName;
                subscribeToRooms();
                console.log('make10 vs - åˆæœŸåŒ–å®Œäº†');
            })
            .catch((error) => {
                console.error('åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³å¤±æ•—:', error);
                alert('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            });
    </script>
</body>
</html>
