<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>make10 vs - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4a90d9;
            --primary-dark: #357abd;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #eee;
            --text-muted: #888;
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
        }

        header h1 span {
            color: var(--warning-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .user-info:hover {
            background: rgba(255,255,255,0.1);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info .status-dot {
            width: 10px;
            height: 10px;
            background: var(--secondary-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* ãƒ­ãƒ“ãƒ¼ç”»é¢ */
        #lobby-screen.active {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .lobby-header h2 {
            font-size: 1.3rem;
        }

        /* ãƒœã‚¿ãƒ³å…±é€š */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: #555;
            color: white;
        }

        /* ãƒ«ãƒ¼ãƒ ä¸€è¦§ */
        .room-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .room-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
            margin-bottom: 0.5rem;
        }

        .room-count {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .refresh-btn {
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }

        .room-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .room-card:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .room-info {
            flex: 1;
        }

        /* ãƒ«ãƒ¼ãƒ ä¸€è¦§ç”¨ã‚¢ãƒã‚¿ãƒ¼ */
        .room-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .room-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ãƒ­ãƒ“ãƒ¼ã®ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼ */
        .lobby-error {
            background: #ffefef;
            border: 1px solid #ffb3b3;
            color: #7a1f1f;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.75rem 0;
            text-align: center;
        }

        .lobby-error .lobby-error-text {
            font-weight: bold;
        }

        /* ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰å†…ã§ã‚¢ãƒã‚¿ãƒ¼ã¨æƒ…å ±ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹èª¿æ•´ */
        .room-card .room-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .room-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .room-name .lock-icon {
            font-size: 0.9rem;
            color: var(--warning-color);
        }

        .room-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
        }

        .room-players {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .player-count {
            background: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .player-count.full {
            background: var(--danger-color);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 400px;
            padding: 1.5rem;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.2rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-color);
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .form-group label .required {
            color: var(--danger-color);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #333;
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group input::placeholder {
            color: #555;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* å¾…æ©Ÿç”»é¢ */
        #waiting-screen {
            text-align: center;
            padding: 2rem;
        }

        .waiting-room-info {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .waiting-room-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .waiting-players {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin: 2rem 0;
        }

        .waiting-player {
            text-align: center;
        }

        .waiting-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: #555;
            min-width: 60px;
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 0.5rem;
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .player-avatar.empty {
            background: #333;
            border: 3px dashed #555;
        }

        .player-name {
            font-weight: bold;
        }

        .waiting-status {
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .waiting-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-screen.active {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            max-height: calc(100vh - 80px);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }

        .game-player {
            text-align: center;
            flex: 1;
        }

        .game-player-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .game-player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            overflow: hidden;
        }

        .game-player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .game-player-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .game-player-name.highlight {
            color: var(--warning-color);
        }

        .game-score {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
        }

        .score-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #555;
        }

        .score-dot.win {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .score-dot.lose {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }

        .game-vs {
            font-size: 1.2rem;
            font-weight: bold;
            color: #555;
            padding: 0 1rem;
        }

        /* å•é¡Œã‚¨ãƒªã‚¢ */
        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 0.5rem;
            min-height: 0;
        }

        .round-info {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .round-number {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .difficulty {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .difficulty-1 { background: #27ae60; }
        .difficulty-2 { background: #2ecc71; }
        .difficulty-3 { background: #f39c12; }
        .difficulty-4 { background: #e67e22; }
        .difficulty-5 { background: #e74c3c; }

        .problem-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .problem-digits {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .digit-card {
            width: 60px;
            height: 70px;
            background: linear-gradient(135deg, #4a90d9, #357abd);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
        }

        .digit-card:hover:not(.used) {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .digit-card:active:not(.used) {
            transform: scale(0.95);
        }

        .digit-card.used {
            opacity: 0.3;
            transform: scale(0.85);
            cursor: not-allowed;
            background: #444;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼ */
        .timer-container {
            text-align: center;
            margin: 0.5rem 0;
        }

        .timer-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--warning-color));
            transition: width 0.1s linear;
        }

        .timer-fill.danger {
            background: linear-gradient(90deg, var(--warning-color), var(--danger-color));
        }

        .timer-text {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* å¼è¡¨ç¤º */
        .expression-display {
            background: var(--bg-color);
            border: 2px solid #333;
            border-radius: 10px;
            padding: 1rem;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-family: 'Consolas', monospace;
            margin: 0.5rem 0;
        }

        .expression-display.correct {
            border-color: var(--secondary-color);
            background: rgba(46, 204, 113, 0.1);
        }

        .expression-display.wrong {
            border-color: var(--danger-color);
            background: rgba(231, 76, 60, 0.1);
        }

        .expression-result {
            text-align: center;
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .expression-result.valid {
            color: var(--secondary-color);
        }

        /* æ¼”ç®—å­ãƒ»æ‹¬å¼§ãƒœã‚¿ãƒ³è¡Œ */
        .operator-row {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .op-btn {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--warning-color);
            color: #000;
        }

        .op-btn:hover {
            transform: scale(1.1);
            background: #e67e22;
        }

        .op-btn:active {
            transform: scale(0.95);
        }

        .op-btn.bracket {
            background: #9b59b6;
            color: #fff;
        }

        .op-btn.bracket:hover {
            background: #8e44ad;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³è¡Œ */
        .action-row {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin: 0.5rem 0;
        }

        .action-btn {
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.backspace {
            background: #555;
            color: #fff;
        }

        .action-btn.reset {
            background: var(--danger-color);
            color: #fff;
        }

        .action-btn.hint {
            background: var(--info-color, #3498db);
            color: #fff;
        }

        .action-btn.hint:disabled {
            background: #444;
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mobile adjustments: make game screen fit a single smartphone viewport */
        @media (max-width: 420px) {
            .game-screen {
                padding: 0.5rem;
            }

            .game-header, .game-main {
                padding: 0.25rem 0.5rem;
            }

            .digit-card {
                width: 48px;
                height: 56px;
                font-size: 1.6rem;
                margin: 0 0.25rem;
            }

            .problem-digits {
                display: flex;
                gap: 0.4rem;
                justify-content: center;
                flex-wrap: nowrap;
            }

            .operator-row {
                gap: 0.4rem;
                padding: 0.25rem 0;
            }

            .op-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
                border-radius: 10px;
            }

            .action-row { gap: 0.5rem; }

            .action-btn { padding: 0.45rem 0.8rem; font-size: 0. ninerem; }

            .expression-display {
                min-height: 44px;
                font-size: 1.1rem;
                padding: 0.5rem;
            }

            .expression-result { font-size: 0. ninerem; }

            .timer-text { font-size: 1.1rem; }

            .round-info { gap: 0.4rem; }
            .round-number { font-size: 1rem; }
            .difficulty { font-size: 0.85rem; }

            .problem-display { margin-bottom: 0.4rem; }

            .user-avatar-large { width: 56px; height: 56px; font-size: 1.6rem; }

            .opponent-status { font-size: 0. eightrem; padding: 0.4rem; }
        }

        /* ç›¸æ‰‹ã®çŠ¶æ…‹è¡¨ç¤º */
        .opponent-status {
            text-align: center;
            padding: 0.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .opponent-status.submitted {
            color: var(--warning-color);
        }

        .opponent-status.correct {
            color: var(--secondary-color);
        }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .countdown-overlay.hidden {
            display: none;
        }

        .countdown-round {
            font-size: 1.5rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .countdown-number {
            font-size: 8rem;
            font-weight: bold;
            color: var(--primary-color);
            animation: countPulse 1s ease-in-out infinite;
        }

        @keyframes countPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .result-overlay.hidden {
            display: none;
        }

        .result-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .result-title.win {
            color: var(--secondary-color);
        }

        .result-title.lose {
            color: var(--danger-color);
        }

        .result-title.draw {
            color: var(--warning-color);
        }

        .result-answer {
            background: var(--card-bg);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .result-answer-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .result-answer-expr {
            font-size: 1.5rem;
            font-family: 'Consolas', monospace;
        }

        /* ãƒãƒƒãƒçµæœ */
        .match-result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 600;
        }

        .match-result-overlay.hidden {
            display: none;
        }

        .match-result-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 2rem;
        }

        .match-result-score {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 2rem;
        }

        /* ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º */
        .test-mode-badge {
            background: var(--warning-color);
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        .user-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto;
            overflow: hidden;
        }

        .user-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 600px) {
            header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .lobby-header {
                flex-direction: column;
                text-align: center;
            }

            .room-card {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .room-meta {
                justify-content: center;
            }

            .waiting-players {
                flex-direction: column;
            }

            .digit-card {
                width: 50px;
                height: 60px;
                font-size: 1.5rem;
            }

            .input-btn {
                padding: 0.6rem;
                font-size: 1.1rem;
            }

            .expression-display {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header>
        <h1>make<span>10</span> vs</h1>
        <div class="user-info" id="user-info-btn">
            <div class="user-avatar" id="user-avatar">ğŸ‘¤</div>
            <span class="status-dot"></span>
            <span id="current-user-name">ã‚²ã‚¹ãƒˆ</span>
        </div>
    </header>

    <div class="container">
        <!-- ãƒ­ãƒ“ãƒ¼ç”»é¢ -->
        <div id="lobby-screen" class="screen active">
            <div class="lobby-header">
                <h2>ğŸ® ãƒ«ãƒ¼ãƒ ä¸€è¦§</h2>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="test-room-btn">
                        ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤
                    </button>
                    <button class="btn btn-primary" id="create-room-btn">
                        â• ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <div class="room-list-header">
                <span class="room-count" id="room-count">0 éƒ¨å±‹</span>
                <button class="refresh-btn" id="refresh-btn" title="æ›´æ–°">ğŸ”„</button>
            </div>

            <div class="lobby-error" id="lobby-error" style="display:none;">
                <div class="lobby-error-text" id="lobby-error-text">ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚</div>
                <div style="margin-top:0.5rem; display:flex; gap:0.5rem; justify-content:center;">
                    <button class="btn btn-primary" id="lobby-retry-btn">å†è©¦è¡Œ</button>
                    <button class="btn" id="lobby-help-btn">ãƒ˜ãƒ«ãƒ—</button>
                </div>
            </div>
            <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ï¼ˆé–‹ç™ºç”¨ï¼‰ -->
            <div class="debug-panel" id="debug-panel" style="margin:8px 0; padding:8px; border:1px dashed #666; border-radius:6px; background:#fafafa;">
                <div style="display:flex; gap:0.5rem; align-items:center; justify-content:center; flex-wrap:wrap;">
                    <button class="btn" id="auth-info-btn">èªè¨¼æƒ…å ±è¡¨ç¤º</button>
                    <button class="btn" id="test-rooms-read-btn">rooms ã‚’ç›´æ¥å–å¾—</button>
                    <button class="btn" id="force-google-login-btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
                <pre id="debug-output" style="margin-top:8px; max-height:160px; overflow:auto; background:#fff; padding:8px; border-radius:4px; border:1px solid #eee; display:none;"></pre>
            </div>
            <div class="room-list" id="room-list">
                <!-- ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                <div class="empty-state" id="empty-state">
                    <div class="icon">ğŸ¯</div>
                    <p>ç¾åœ¨å‹Ÿé›†ä¸­ã®ãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã¡ã¾ã—ã‚‡ã†ï¼</p>
                </div>
            </div>
        </div>

        <!-- å¾…æ©Ÿç”»é¢ -->
        <div id="waiting-screen" class="screen">
            <div class="waiting-room-info">
                <div class="waiting-room-name" id="waiting-room-name">ãƒ«ãƒ¼ãƒ å</div>
                <div class="waiting-status">
                    <span id="waiting-bo">BO5</span> â€¢ 
                    <span id="waiting-room-id">Room ID: ---</span>
                </div>
                
                <div class="waiting-players">
                    <div class="waiting-player">
                        <div class="player-avatar" id="host-avatar">ğŸ‘‘</div>
                        <div class="player-name" id="host-name">ãƒ›ã‚¹ãƒˆ</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">ãƒ›ã‚¹ãƒˆ</div>
                    </div>
                    <div class="waiting-vs">
                        <span>VS</span>
                    </div>
                    <div class="waiting-player">
                        <div class="player-avatar empty" id="guest-avatar">?</div>
                        <div class="player-name" id="guest-name">å¾…æ©Ÿä¸­...</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">ã‚²ã‚¹ãƒˆ</div>
                    </div>
                </div>

                <div class="waiting-spinner" id="waiting-spinner"></div>
                <p id="waiting-message">å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
            </div>

            <button class="btn btn-danger" id="leave-room-btn">ğŸšª ãƒ«ãƒ¼ãƒ ã‚’é€€å‡º</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="screen">
            <!-- ã‚¹ã‚³ã‚¢ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="game-header">
                <div class="game-player">
                    <div class="game-player-info">
                        <div class="game-player-avatar" id="game-host-avatar">ğŸ‘¤</div>
                        <div class="game-player-name" id="game-host-name">ãƒ›ã‚¹ãƒˆ</div>
                    </div>
                    <div class="game-score" id="host-score"></div>
                </div>
                <div class="game-vs">VS</div>
                <div class="game-player">
                    <div class="game-player-info">
                        <div class="game-player-name" id="game-guest-name">ã‚²ã‚¹ãƒˆ</div>
                        <div class="game-player-avatar" id="game-guest-avatar">ğŸ‘¤</div>
                    </div>
                    <div class="game-score" id="guest-score"></div>
                </div>
            </div>

            <!-- å•é¡Œã‚¨ãƒªã‚¢ -->
            <div class="game-main">
                <div class="round-info">
                    <span class="round-number" id="round-number">ç¬¬1å•</span>
                    <span class="difficulty difficulty-3" id="difficulty">é›£æ˜“åº¦ â˜…â˜…â˜…</span>
                </div>

                <div class="problem-display">
                    <div class="problem-digits" id="problem-digits">
                        <div class="digit-card">3</div>
                        <div class="digit-card">3</div>
                        <div class="digit-card">7</div>
                        <div class="digit-card">9</div>
                    </div>

                    <!-- æ¼”ç®—å­ãƒ»æ‹¬å¼§ãƒœã‚¿ãƒ³ï¼ˆæ•°å­—ã®ä¸‹ï¼‰ -->
                    <div class="operator-row" id="operator-row">
                        <button class="op-btn bracket" data-op="(">(</button>
                        <button class="op-btn" data-op="/">Ã·</button>
                        <button class="op-btn" data-op="*">Ã—</button>
                        <button class="op-btn" data-op="-">âˆ’</button>
                        <button class="op-btn" data-op="+">+</button>
                        <button class="op-btn bracket" data-op=")">)</button>
                    </div>

                    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆæ•°å­—ã®ä¸‹ï¼‰ -->
                    <div class="action-row" id="action-row">
                        <button class="action-btn backspace" data-action="backspace">âŒ« æˆ»ã™</button>
                        <button class="action-btn reset" data-action="reset">AC ãƒªã‚»ãƒƒãƒˆ</button>
                        <button class="action-btn hint" data-action="hint" id="hint-btn" style="display: none;">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
                    </div>
                </div>

                <div class="timer-container">
                    <div class="timer-bar">
                        <div class="timer-fill" id="timer-fill" style="width: 100%;"></div>
                    </div>
                    <div class="timer-text" id="timer-text">25</div>
                </div>

                <div class="expression-result" id="expression-result">å¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                <div class="expression-display" id="expression-display"></div>

                <div class="opponent-status" id="opponent-status">ç›¸æ‰‹: å…¥åŠ›ä¸­...</div>
            </div>

        <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="countdown-overlay hidden" id="countdown-overlay">
            <div class="countdown-round" id="countdown-round">ç¬¬1å•</div>
            <div class="countdown-number" id="countdown-number">5</div>
        </div>

        <!-- ãƒ©ã‚¦ãƒ³ãƒ‰çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="result-overlay hidden" id="result-overlay">
            <div class="result-title" id="result-title">æ­£è§£ï¼</div>
            <div class="result-answer">
                <div class="result-answer-label">ç­”ãˆ</div>
                <div class="result-answer-expr" id="result-answer">3 Ã— 3 + 7 - 9 = 10</div>
            </div>
        </div>

        <!-- ãƒãƒƒãƒçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="match-result-overlay hidden" id="match-result-overlay">
            <div class="match-result-title" id="match-result-title">ğŸ‰ å‹åˆ©ï¼</div>
            <div class="match-result-score" id="match-result-score">3 - 1</div>
            <button class="btn btn-primary" id="back-to-lobby-btn">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="create-room-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ® ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</h3>
                <button class="modal-close" id="close-create-modal">&times;</button>
            </div>
            <form id="create-room-form">
                <div class="form-group">
                    <label>ãƒ«ãƒ¼ãƒ å</label>
                    <input type="text" id="room-name-input" placeholder="ãƒ«ãƒ¼ãƒ 1" maxlength="20">
                </div>
                <div class="form-group">
                    <label>ã‚ãªãŸã®åå‰</label>
                    <input type="text" id="host-name-input" placeholder="ãƒ›ã‚¹ãƒˆ" maxlength="10">
                </div>
                <div class="form-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</label>
                    <input type="password" id="room-password-input" placeholder="ãªã—ã®å ´åˆã¯ç©ºæ¬„">
                </div>
                <div class="form-group">
                    <label>å¯¾æˆ¦æœ¬æ•°</label>
                    <select id="room-bo-input">
                        <option value="3">BO3ï¼ˆ2æœ¬å…ˆå–ï¼‰</option>
                        <option value="5" selected>BO5ï¼ˆ3æœ¬å…ˆå–ï¼‰</option>
                        <option value="7">BO7ï¼ˆ4æœ¬å…ˆå–ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å‡ºé¡Œé›£æ˜“åº¦</label>
                    <select id="room-difficulty-input">
                        <option value="all" selected>ã™ã¹ã¦ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰</option>
                        <option value="easy">ç°¡å˜ï¼ˆè§£ãŒå¤šã„å•é¡Œï¼‰</option>
                        <option value="normal">æ™®é€š</option>
                        <option value="hard">é›£ã—ã„ï¼ˆè§£ãŒå°‘ãªã„å•é¡Œï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ‹¬å¼§ã‚’ä½¿ã†å•é¡Œ</label>
                    <select id="room-brackets-input">
                        <option value="no">å‡ºé¡Œã—ãªã„</option>
                        <option value="yes" selected>å‡ºé¡Œã™ã‚‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³</label>
                    <select id="room-hint-input">
                        <option value="no" selected>ãªã—</option>
                        <option value="yes">ã‚ã‚Šï¼ˆå„ãƒ©ã‚¦ãƒ³ãƒ‰1å›ï¼‰</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-create-room">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ãƒ«ãƒ¼ãƒ å‚åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="join-room-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸš€ ãƒ«ãƒ¼ãƒ ã«å‚åŠ </h3>
                <button class="modal-close" id="close-join-modal">&times;</button>
            </div>
            <form id="join-room-form">
                <div class="form-group">
                    <label>å‚åŠ ã™ã‚‹ãƒ«ãƒ¼ãƒ </label>
                    <input type="text" id="join-room-name" readonly style="background: #222;">
                </div>
                <div class="form-group">
                    <label>ã‚ãªãŸã®åå‰</label>
                    <input type="text" id="guest-name-input" placeholder="ã‚²ã‚¹ãƒˆ" maxlength="10">
                </div>
                <div class="form-group" id="join-password-group" style="display: none;">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="required">*</span></label>
                    <input type="password" id="join-password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                </div>
                <input type="hidden" id="join-room-id">
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-join-room">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-success">å‚åŠ ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="user-settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</h3>
                <button class="modal-close" id="close-user-settings">&times;</button>
            </div>
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div class="user-avatar-large" id="user-avatar-large">ğŸ‘¤</div>
                <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                <button class="btn btn-secondary" id="upload-avatar-btn" style="margin-top: 1rem;">
                    ğŸ“· ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
                </button>
            </div>
            <div class="form-group">
                <label>è¡¨ç¤ºå</label>
                <input type="text" id="display-name-input" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="10">
            </div>
            <div id="login-section">
                <p style="color: var(--text-muted); margin-bottom: 1rem; text-align: center;">
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€åå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³ãŒä¿å­˜ã•ã‚Œã¾ã™
                </p>
                <button class="btn btn-primary" id="google-login-btn" style="width: 100%;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="width: 20px; height: 20px;">
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
            <div id="logout-section" style="display: none;">
                <p style="color: var(--text-muted); margin-bottom: 1rem; text-align: center;" id="logged-in-email"></p>
                <button class="btn btn-danger" id="logout-btn" style="width: 100%;">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
            <div class="form-actions" style="margin-top: 1.5rem;">
                <button class="btn btn-success" id="save-user-settings" style="width: 100%;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // ========================================
        // Firebase åˆæœŸåŒ–
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBM_6leTzC3lKdmO_b4nvb0SgubTSn2rO0",
            authDomain: "make10vs.firebaseapp.com",
            databaseURL: "https://make10vs-default-rtdb.firebaseio.com",
            projectId: "make10vs",
            storageBucket: "make10vs.firebasestorage.app",
            messagingSenderId: "461653417380",
            appId: "1:461653417380:web:d0c64a9c8b0b5498fc7531",
            measurementId: "G-35DCQ7MMMR"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
        // ========================================
        let currentUserId = null;
        let currentUserName = 'ã‚²ã‚¹ãƒˆ';
        let currentRoomId = null;
        let currentRoomRef = null;
        let roomsListener = null;

        // ========================================
        // DOMè¦ç´ 
        // ========================================
        const lobbyScreen = document.getElementById('lobby-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const gameScreen = document.getElementById('game-screen');
        const roomList = document.getElementById('room-list');
        const emptyState = document.getElementById('empty-state');
        const roomCount = document.getElementById('room-count');
        const currentUserNameEl = document.getElementById('current-user-name');

        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        const createRoomModal = document.getElementById('create-room-modal');
        const joinRoomModal = document.getElementById('join-room-modal');

        // ========================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ========================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showModal(modal) {
            modal.classList.add('active');
        }

        function hideModal(modal) {
            modal.classList.remove('active');
        }

        function hashPassword(password) {
            // ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥ï¼ˆæœ¬ç•ªã§ã¯ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã‚’ä½¿ç”¨ï¼‰
            if (!password) return null;
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        // ========================================
        // ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—ãƒ»è¡¨ç¤º
        // ========================================
        function subscribeToRooms() {
            const roomsRef = database.ref('rooms');
            
            // orderByChildã‚’ä½¿ã‚ãšã«ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆDBãƒ«ãƒ¼ãƒ«ã¨ã®äº’æ›æ€§å‘ä¸Šï¼‰
            roomsListener = roomsRef.on('value', (snapshot) => {
                const allRooms = snapshot.val() || {};
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§openãªãƒ«ãƒ¼ãƒ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                const rooms = {};
                Object.entries(allRooms).forEach(([id, room]) => {
                    if (room.meta && room.meta.state === 'open') {
                        rooms[id] = room;
                    }
                });
                renderRoomList(rooms);
            }, (error) => {
                console.error('ãƒ«ãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // permission_denied ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã—ã¦å†è©¦è¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                const message = (error && error.code) ? `${error.code}: ${error.message}` : 'ãƒ«ãƒ¼ãƒ å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                showLobbyError('ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚' + message, true);
            });
        }

        function unsubscribeFromRooms() {
            if (roomsListener) {
                database.ref('rooms').off('value', roomsListener);
                roomsListener = null;
            }
        }

        // ãƒ­ãƒ“ãƒ¼ç”¨ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼è¡¨ç¤º/éè¡¨ç¤º
        function showLobbyError(msg, canRetry = false) {
            const el = document.getElementById('lobby-error');
            const txt = document.getElementById('lobby-error-text');
            if (!el || !txt) return;
            txt.textContent = msg;
            el.style.display = 'block';
            const retryBtn = document.getElementById('lobby-retry-btn');
            if (retryBtn) retryBtn.style.display = canRetry ? 'inline-block' : 'none';
        }

        function hideLobbyError() {
            const el = document.getElementById('lobby-error');
            if (!el) return;
            el.style.display = 'none';
        }

        // èªè¨¼ã‚’è©¦è¡Œã—ã¦ã‹ã‚‰å†ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã™ã‚‹ï¼ˆå†è©¦è¡Œãƒœã‚¿ãƒ³ç”¨ï¼‰
        async function attemptAuthAndSubscribe() {
            hideLobbyError();
            try {
                if (!auth.currentUser) {
                    await auth.signInAnonymously();
                    console.log('å†è©¦è¡Œ: åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³æˆåŠŸ');
                }
            } catch (e) {
                console.error('å†è©¦è¡Œã‚µã‚¤ãƒ³ã‚¤ãƒ³å¤±æ•—:', e);
                showLobbyError('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e && e.message ? e.message : e), true);
                return;
            }

            try {
                // æ—¢å­˜ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†è¨­å®š
                unsubscribeFromRooms();
                subscribeToRooms();
            } catch (e) {
                console.error('å†è©¦è¡Œã§ãƒ«ãƒ¼ãƒ å–å¾—å¤±æ•—:', e);
                showLobbyError('ãƒ«ãƒ¼ãƒ å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e && e.message ? e.message : e), true);
            }
        }

        function renderRoomList(rooms) {
            const roomEntries = Object.entries(rooms).filter(([id, room]) => {
                return room.meta && room.meta.state === 'open';
            });

            roomCount.textContent = `${roomEntries.length} éƒ¨å±‹`;

            if (roomEntries.length === 0) {
                emptyState.style.display = 'block';
                // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
                document.querySelectorAll('.room-card').forEach(card => card.remove());
                return;
            }

            emptyState.style.display = 'none';

            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
            document.querySelectorAll('.room-card').forEach(card => card.remove());

            // ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
            roomEntries.forEach(([roomId, room]) => {
                const meta = room.meta;
                const hasPassword = !!meta.passwordHash;
                const playerCount = meta.guestId ? 2 : 1;

                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-info">
                        <div class="room-avatar" data-host-id="${meta.hostId || ''}">ğŸ‘‘</div>
                        <div>
                            <div class="room-name">
                                ${hasPassword ? '<span class="lock-icon">ğŸ”’</span>' : ''}
                                ${escapeHtml(meta.roomName)}
                            </div>
                            <div class="room-meta">
                                <span class="host-name">ğŸ‘¤ ${escapeHtml(meta.hostName || 'ãƒ›ã‚¹ãƒˆ')}</span>
                                <span>ğŸ¯ BO${meta.bo}</span>
                            </div>
                        </div>
                    </div>
                    <div class="room-players">
                        <span class="player-count ${playerCount >= 2 ? 'full' : ''}">${playerCount}/2</span>
                        <button class="btn btn-success" ${playerCount >= 2 ? 'disabled' : ''}>
                            å‚åŠ 
                        </button>
                    </div>
                `;

                const joinBtn = card.querySelector('.btn-success');
                if (playerCount < 2) {
                    joinBtn.addEventListener('click', () => openJoinModal(roomId, meta));
                }

                roomList.insertBefore(card, emptyState);

                // ãƒ›ã‚¹ãƒˆã®ã‚¢ãƒã‚¿ãƒ¼ã‚’å–å¾—ã—ã¦å·®ã—æ›¿ãˆï¼ˆéåŒæœŸï¼‰
                if (meta.hostId) {
                    database.ref(`users/${meta.hostId}`).once('value').then((ps) => {
                        const p = ps.val();
                        const avatarEl = card.querySelector('.room-avatar');
                        if (p && p.avatar) {
                            avatarEl.innerHTML = `<img src="${p.avatar}" alt="host">`;
                        } else {
                            avatarEl.textContent = 'ğŸ‘‘';
                        }
                    }).catch((err) => {
                        console.warn('ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚¢ãƒã‚¿ãƒ¼å–å¾—å¤±æ•—:', err);
                    });
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // ãƒ«ãƒ¼ãƒ ä½œæˆ
        // ========================================
        document.getElementById('create-room-btn').addEventListener('click', () => {
            showModal(createRoomModal);
        });

        document.getElementById('close-create-modal').addEventListener('click', () => {
            hideModal(createRoomModal);
        });

        document.getElementById('cancel-create-room').addEventListener('click', () => {
            hideModal(createRoomModal);
        });

        document.getElementById('create-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const roomName = document.getElementById('room-name-input').value.trim() || 'ãƒ«ãƒ¼ãƒ 1';
            const hostName = document.getElementById('host-name-input').value.trim() || 'ãƒ›ã‚¹ãƒˆ';
            const password = document.getElementById('room-password-input').value;
            const bo = parseInt(document.getElementById('room-bo-input').value);
            const difficulty = document.getElementById('room-difficulty-input').value;
            const allowBrackets = document.getElementById('room-brackets-input').value === 'yes';
            const allowHint = document.getElementById('room-hint-input').value === 'yes';

            try {
                const newRoomRef = database.ref('rooms').push();
                const roomId = newRoomRef.key;

                await newRoomRef.set({
                    meta: {
                        roomName: roomName,
                        hostId: currentUserId,
                        hostName: hostName,
                        guestId: null,
                        guestName: null,
                        passwordHash: hashPassword(password),
                        bo: bo,
                        difficulty: difficulty,
                        allowBrackets: allowBrackets,
                        allowHint: allowHint,
                        state: 'open',
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    }
                });

                currentUserName = hostName;
                currentUserNameEl.textContent = hostName;
                currentRoomId = roomId;

                hideModal(createRoomModal);
                document.getElementById('create-room-form').reset();

                enterWaitingRoom(roomId, roomName, hostName, null, bo, true);

            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ«ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // ========================================
        // ãƒ«ãƒ¼ãƒ å‚åŠ 
        // ========================================
        function openJoinModal(roomId, meta) {
            document.getElementById('join-room-name').value = meta.roomName;
            document.getElementById('join-room-id').value = roomId;
            
            const passwordGroup = document.getElementById('join-password-group');
            if (meta.passwordHash) {
                passwordGroup.style.display = 'block';
                document.getElementById('join-password-input').required = true;
            } else {
                passwordGroup.style.display = 'none';
                document.getElementById('join-password-input').required = false;
            }

            showModal(joinRoomModal);
        }

        document.getElementById('close-join-modal').addEventListener('click', () => {
            hideModal(joinRoomModal);
        });

        document.getElementById('cancel-join-room').addEventListener('click', () => {
            hideModal(joinRoomModal);
        });

        document.getElementById('join-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const roomId = document.getElementById('join-room-id').value;
            const guestName = document.getElementById('guest-name-input').value.trim() || 'ã‚²ã‚¹ãƒˆ';
            const password = document.getElementById('join-password-input').value;

            try {
                const roomRef = database.ref(`rooms/${roomId}`);
                const snapshot = await roomRef.once('value');
                const room = snapshot.val();

                if (!room || room.meta.state !== 'open') {
                    alert('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã‚‹ã‹ã€å­˜åœ¨ã—ã¾ã›ã‚“');
                    hideModal(joinRoomModal);
                    return;
                }

                if (room.meta.guestId) {
                    alert('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«æº€å“¡ã§ã™');
                    hideModal(joinRoomModal);
                    return;
                }

                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
                if (room.meta.passwordHash && hashPassword(password) !== room.meta.passwordHash) {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                // ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ 
                await roomRef.child('meta').update({
                    guestId: currentUserId,
                    guestName: guestName
                });

                currentUserName = guestName;
                currentUserNameEl.textContent = guestName;
                currentRoomId = roomId;

                hideModal(joinRoomModal);
                document.getElementById('join-room-form').reset();

                enterWaitingRoom(roomId, room.meta.roomName, room.meta.hostName, guestName, room.meta.bo, false);

            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒ å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ«ãƒ¼ãƒ ã¸ã®å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // ========================================
        // å¾…æ©Ÿç”»é¢
        // ========================================
        function enterWaitingRoom(roomId, roomName, hostName, guestName, bo, isHost) {
            showScreen('waiting-screen');

            document.getElementById('waiting-room-name').textContent = roomName;
            document.getElementById('waiting-bo').textContent = `BO${bo}`;
            document.getElementById('waiting-room-id').textContent = `Room ID: ${roomId.slice(-6)}`;
            document.getElementById('host-name').textContent = hostName;

            if (guestName) {
                document.getElementById('guest-name').textContent = guestName;
                document.getElementById('guest-avatar').textContent = 'ğŸ®';
                document.getElementById('guest-avatar').classList.remove('empty');
            } else {
                document.getElementById('guest-name').textContent = 'å¾…æ©Ÿä¸­...';
                document.getElementById('guest-avatar').textContent = '?';
                document.getElementById('guest-avatar').classList.add('empty');
            }

            // ãƒ«ãƒ¼ãƒ ã®å¤‰æ›´ã‚’ç›£è¦–
            currentRoomRef = database.ref(`rooms/${roomId}/meta`);
            // åˆå›å–å¾—ã§ãƒ›ã‚¹ãƒˆ/ã‚²ã‚¹ãƒˆã®ã‚¢ãƒã‚¿ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤º
            database.ref(`rooms/${roomId}/meta`).once('value').then((snap) => {
                const initialMeta = snap.val();
                if (initialMeta && initialMeta.hostId) {
                    database.ref(`users/${initialMeta.hostId}`).once('value').then((ps) => {
                        const p = ps.val();
                        if (p && p.avatar) {
                            const el = document.getElementById('host-avatar');
                            el.innerHTML = `<img src="${p.avatar}" alt="host">`;
                        }
                    }).catch((err) => console.warn('ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—å¤±æ•—:', err));
                }
                if (initialMeta && initialMeta.guestId) {
                    database.ref(`users/${initialMeta.guestId}`).once('value').then((ps) => {
                        const p = ps.val();
                        if (p && p.avatar) {
                            const el = document.getElementById('guest-avatar');
                            el.innerHTML = `<img src="${p.avatar}" alt="guest">`;
                            el.classList.remove('empty');
                        }
                    }).catch((err) => console.warn('ã‚²ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—å¤±æ•—:', err));
                }
            }).catch((err) => console.warn('åˆå›ãƒ«ãƒ¼ãƒ ãƒ¡ã‚¿å–å¾—å¤±æ•—:', err));

            currentRoomRef.on('value', async (snapshot) => {
                const meta = snapshot.val();
                console.log('rooms/' + roomId + '/meta changed:', meta);
                if (!meta) {
                    // ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚ŒãŸ
                    alert('ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                    leaveRoom();
                    return;
                }

                // ã‚²ã‚¹ãƒˆãŒå‚åŠ ã—ãŸ
                if (meta.guestId && meta.guestName) {
                    document.getElementById('guest-name').textContent = meta.guestName;
                    document.getElementById('guest-avatar').classList.remove('empty');
                    // ã‚²ã‚¹ãƒˆã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’DBã‹ã‚‰å–å¾—ã—ã€ã‚¢ãƒã‚¿ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤º
                    database.ref(`users/${meta.guestId}`).once('value').then((ps) => {
                        const p = ps.val();
                        if (p && p.avatar) {
                            document.getElementById('guest-avatar').innerHTML = `<img src="${p.avatar}" alt="guest">`;
                        } else {
                            document.getElementById('guest-avatar').textContent = 'ğŸ®';
                        }
                    }).catch((err) => {
                        console.warn('ã‚²ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—å¤±æ•—:', err);
                        document.getElementById('guest-avatar').textContent = 'ğŸ®';
                    });
                    document.getElementById('waiting-message').textContent = 'å¯¾æˆ¦æº–å‚™å®Œäº†ï¼ã¾ã‚‚ãªãé–‹å§‹ã—ã¾ã™...';

                    // 2äººæƒã£ãŸã‚‰è©¦åˆé–‹å§‹ï¼ˆãƒ›ã‚¹ãƒˆå´ã§é–‹å§‹å‡¦ç†ï¼‰
                    if (isHost && meta.state === 'open') {
                        console.log('Host: starting match countdown');
                        startMatchCountdown(roomId);
                    }
                }

                // è©¦åˆé–‹å§‹çŠ¶æ…‹ã«ãªã£ãŸ
                if (meta.state === 'playing') {
                    console.log('Detected meta.state=playing for room', roomId);
                    // ã‚²ãƒ¼ãƒ ç”»é¢ã¸é·ç§»
                    document.getElementById('waiting-message').textContent = 'è©¦åˆé–‹å§‹ï¼';
                    document.getElementById('waiting-spinner').style.display = 'none';

                    // ãƒ­ãƒ“ãƒ¼ä¸€è¦§ã®ç›£è¦–ã‚’æ­¢ã‚ã€ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ IDã‚’è¨­å®š
                    try {
                        unsubscribeFromRooms();
                    } catch (e) {
                        console.warn('unsubscribe error', e);
                    }

                    currentRoomId = roomId;
                    gameState.isTestMode = false;
                    gameState.isHost = isHost;
                    gameState.bo = meta.bo || gameState.bo;
                    gameState.round = 1;
                    gameState.hostScore = 0;
                    gameState.guestScore = 0;
                    gameState.hostName = meta.hostName || 'ãƒ›ã‚¹ãƒˆ';
                    gameState.guestName = meta.guestName || 'ã‚²ã‚¹ãƒˆ';
                    gameState.hostAvatar = null;
                    gameState.guestAvatar = null;
                    
                    // ãƒ«ãƒ¼ãƒ è¨­å®šã‚’åæ˜ 
                    gameState.difficulty = meta.difficulty || 'all';
                    gameState.allowBrackets = meta.allowBrackets !== false;
                    gameState.allowHint = meta.allowHint === true;

                    // ãƒ›ã‚¹ãƒˆãƒ»ã‚²ã‚¹ãƒˆã®ã‚¢ãƒã‚¿ãƒ¼ã‚’DBã‹ã‚‰å–å¾—
                    const fetchAvatars = async () => {
                        try {
                            if (meta.hostId) {
                                const hostProfile = await database.ref(`users/${meta.hostId}`).once('value');
                                const hp = hostProfile.val();
                                if (hp && hp.avatar) gameState.hostAvatar = hp.avatar;
                            }
                            if (meta.guestId) {
                                const guestProfile = await database.ref(`users/${meta.guestId}`).once('value');
                                const gp = guestProfile.val();
                                if (gp && gp.avatar) gameState.guestAvatar = gp.avatar;
                            }
                        } catch (err) {
                            console.warn('ã‚¢ãƒã‚¿ãƒ¼å–å¾—å¤±æ•—:', err);
                        }
                    };
                    await fetchAvatars();

                    // UIåæ˜ ã—ã¦ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆæ—¢ã«ã‚²ãƒ¼ãƒ ç”»é¢ãªã‚‰é‡è¤‡å‘¼ã³å‡ºã—ã—ãªã„ï¼‰
                    currentUserNameEl.textContent = currentUserName;
                    if (!document.getElementById('game-screen').classList.contains('active')) {
                        console.log('Starting game UI for guest/host');
                        startGame();
                    } else {
                        console.log('Game already active, skipping startGame()');
                    }
                }
            });
        }

        async function startMatchCountdown(roomId) {
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰è©¦åˆçŠ¶æ…‹ã«ç§»è¡Œ
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await database.ref(`rooms/${roomId}/meta`).update({
                state: 'playing'
            });
        }

        // ========================================
        // ãƒ«ãƒ¼ãƒ é€€å‡º
        // ========================================
        document.getElementById('leave-room-btn').addEventListener('click', () => {
            if (confirm('æœ¬å½“ã«ãƒ«ãƒ¼ãƒ ã‚’é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
                leaveRoom();
            }
        });

        async function leaveRoom() {
            if (currentRoomRef) {
                currentRoomRef.off();
            }

            if (currentRoomId) {
                try {
                    const roomRef = database.ref(`rooms/${currentRoomId}/meta`);
                    const snapshot = await roomRef.once('value');
                    const meta = snapshot.val();

                    if (meta) {
                        if (meta.hostId === currentUserId) {
                            // ãƒ›ã‚¹ãƒˆãŒé€€å‡º â†’ ãƒ«ãƒ¼ãƒ å‰Šé™¤
                            await database.ref(`rooms/${currentRoomId}`).remove();
                        } else if (meta.guestId === currentUserId) {
                            // ã‚²ã‚¹ãƒˆãŒé€€å‡º
                            await roomRef.update({
                                guestId: null,
                                guestName: null,
                                state: 'open'
                            });
                        }
                    }
                } catch (error) {
                    console.error('é€€å‡ºã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            currentRoomId = null;
            currentRoomRef = null;
            showScreen('lobby-screen');
        }

        // ========================================
        // æ›´æ–°ãƒœã‚¿ãƒ³
        // ========================================
        document.getElementById('refresh-btn').addEventListener('click', () => {
            const btn = document.getElementById('refresh-btn');
            btn.style.transform = 'rotate(360deg)';
            setTimeout(() => btn.style.transform = '', 500);
        });

        // ========================================
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        // ========================================
        createRoomModal.addEventListener('click', (e) => {
            if (e.target === createRoomModal) hideModal(createRoomModal);
        });

        joinRoomModal.addEventListener('click', (e) => {
            if (e.target === joinRoomModal) hideModal(joinRoomModal);
        });

        // ========================================
        // ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
        // ========================================
        let gameState = {
            isTestMode: false,
            isHost: false,
            bo: 5,
            round: 1,
            hostScore: 0,
            guestScore: 0,
            hostName: 'ãƒ›ã‚¹ãƒˆ',
            guestName: 'ã‚²ã‚¹ãƒˆ',
            hostAvatar: null,
            guestAvatar: null,
            digits: [],
            usedDigits: [],
            expression: '',
            timeLeft: 25,
            timerInterval: null,
            submitted: false,
            solutions: [],
            roundStartTime: null,
            // ãƒ«ãƒ¼ãƒ è¨­å®š
            difficulty: 'all',
            allowBrackets: true,
            allowHint: false,
            hintUsed: false
        };

        // 10ã‚’ä½œã‚Œã‚‹çµ„ã¿åˆã‚ã›ã‚’äº‹å‰è¨ˆç®—ã™ã‚‹ãŸã‚ã®é–¢æ•°
        function generateValidProblems() {
            const validProblems = [];
            for (let a = 1; a <= 9; a++) {
                for (let b = 1; b <= 9; b++) {
                    for (let c = 1; c <= 9; c++) {
                        for (let d = 1; d <= 9; d++) {
                            const digits = [a, b, c, d];
                            const solutions = findSolutions(digits);
                            if (solutions.length > 0) {
                                validProblems.push({ digits, solutions });
                            }
                        }
                    }
                }
            }
            return validProblems;
        }

        // 4ã¤ã®æ•°å­—ã‹ã‚‰10ã‚’ä½œã‚‹å…¨ã¦ã®å¼ã‚’æ¢ã™ï¼ˆæ‹¬å¼§ã‚ã‚Šãƒ»ãªã—ä¸¡æ–¹å¯¾å¿œï¼‰
        function findSolutions(digits, includeBrackets = true) {
            const solutions = [];
            const ops = ['+', '-', '*', '/'];
            const perms = permutations(digits);

            for (const perm of perms) {
                const [a, b, c, d] = perm;
                for (const op1 of ops) {
                    for (const op2 of ops) {
                        for (const op3 of ops) {
                            // æ‹¬å¼§ãªã—: a op1 b op2 c op3 d
                            const expr = `${a}${op1}${b}${op2}${c}${op3}${d}`;
                            if (safeEval(expr) === 10) {
                                solutions.push({ expr: formatExpr(a, op1, b, op2, c, op3, d), hasBrackets: false });
                            }

                            if (includeBrackets) {
                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³1: (a op1 b) op2 c op3 d
                                const expr1 = `(${a}${op1}${b})${op2}${c}${op3}${d}`;
                                if (safeEval(expr1) === 10) {
                                    solutions.push({ expr: `(${a}${formatOp(op1)}${b})${formatOp(op2)}${c}${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³2: a op1 (b op2 c) op3 d
                                const expr2 = `${a}${op1}(${b}${op2}${c})${op3}${d}`;
                                if (safeEval(expr2) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}(${b}${formatOp(op2)}${c})${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³3: a op1 b op2 (c op3 d)
                                const expr3 = `${a}${op1}${b}${op2}(${c}${op3}${d})`;
                                if (safeEval(expr3) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}${b}${formatOp(op2)}(${c}${formatOp(op3)}${d})`, hasBrackets: true });
                                }

                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³4: (a op1 b op2 c) op3 d
                                const expr4 = `(${a}${op1}${b}${op2}${c})${op3}${d}`;
                                if (safeEval(expr4) === 10) {
                                    solutions.push({ expr: `(${a}${formatOp(op1)}${b}${formatOp(op2)}${c})${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³5: a op1 (b op2 c op3 d)
                                const expr5 = `${a}${op1}(${b}${op2}${c}${op3}${d})`;
                                if (safeEval(expr5) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}(${b}${formatOp(op2)}${c}${formatOp(op3)}${d})`, hasBrackets: true });
                                }

                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³6: (a op1 b) op2 (c op3 d)
                                const expr6 = `(${a}${op1}${b})${op2}(${c}${op3}${d})`;
                                if (safeEval(expr6) === 10) {
                                    solutions.push({ expr: `(${a}${formatOp(op1)}${b})${formatOp(op2)}(${c}${formatOp(op3)}${d})`, hasBrackets: true });
                                }

                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³7: ((a op1 b) op2 c) op3 d
                                const expr7 = `((${a}${op1}${b})${op2}${c})${op3}${d}`;
                                if (safeEval(expr7) === 10) {
                                    solutions.push({ expr: `((${a}${formatOp(op1)}${b})${formatOp(op2)}${c})${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³8: (a op1 (b op2 c)) op3 d
                                const expr8 = `(${a}${op1}(${b}${op2}${c}))${op3}${d}`;
                                if (safeEval(expr8) === 10) {
                                    solutions.push({ expr: `(${a}${formatOp(op1)}(${b}${formatOp(op2)}${c}))${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³9: a op1 ((b op2 c) op3 d)
                                const expr9 = `${a}${op1}((${b}${op2}${c})${op3}${d})`;
                                if (safeEval(expr9) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}((${b}${formatOp(op2)}${c})${formatOp(op3)}${d})`, hasBrackets: true });
                                }

                                // æ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³10: a op1 (b op2 (c op3 d))
                                const expr10 = `${a}${op1}(${b}${op2}(${c}${op3}${d}))`;
                                if (safeEval(expr10) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}(${b}${formatOp(op2)}(${c}${formatOp(op3)}${d}))`, hasBrackets: true });
                                }
                            }
                        }
                    }
                }
            }
            // é‡è¤‡ã‚’é™¤å»
            const uniqueExprs = [...new Set(solutions.map(s => s.expr))];
            return uniqueExprs.map(expr => {
                const hasBrackets = expr.includes('(');
                return { expr, hasBrackets };
            });
        }

        function formatOp(op) {
            const opMap = {'+': ' + ', '-': ' - ', '*': ' Ã— ', '/': ' Ã· '};
            return opMap[op] || op;
        }

        function formatExpr(a, op1, b, op2, c, op3, d) {
            return `${a}${formatOp(op1)}${b}${formatOp(op2)}${c}${formatOp(op3)}${d}`;
        }

        function permutations(arr) {
            if (arr.length <= 1) return [arr];
            const result = [];
            for (let i = 0; i < arr.length; i++) {
                const rest = [...arr.slice(0, i), ...arr.slice(i + 1)];
                for (const perm of permutations(rest)) {
                    result.push([arr[i], ...perm]);
                }
            }
            return result;
        }

        function safeEval(expr) {
            try {
                const result = Function('"use strict"; return (' + expr + ')')();
                return Math.abs(result - 10) < 0.0001 ? 10 : result;
            } catch {
                return null;
            }
        }

        // é›£æ˜“åº¦ã‚’è¨ˆç®—ï¼ˆæ‹¬å¼§ãªã—ç”¨ï¼‰
        // é›£æ˜“åº¦1: è§£ãŒå¤šã„ï¼ˆ10å€‹ä»¥ä¸Šï¼‰
        // é›£æ˜“åº¦2: è§£ãŒãã“ãã“ï¼ˆ5-9å€‹ï¼‰
        // é›£æ˜“åº¦3: è§£ãŒå°‘ãªã‚ï¼ˆ2-4å€‹ï¼‰
        // é›£æ˜“åº¦4: è§£ãŒ1ã¤ã ã‘
        // é›£æ˜“åº¦5: é™¤ç®—ã‚’å«ã¿è§£ãŒ1ã¤ã ã‘ã€ã¾ãŸã¯æ‹¬å¼§å¿…é ˆ
        function calculateDifficulty(solutions) {
            if (solutions.length === 0) return 5;
            
            const exprs = solutions.map(s => typeof s === 'string' ? s : s.expr);
            const hasDivide = exprs.some(s => s.includes('Ã·'));
            const onlyBrackets = solutions.every(s => typeof s === 'object' && s.hasBrackets);
            
            if (onlyBrackets) return 5; // æ‹¬å¼§å¿…é ˆã¯æœ€é«˜é›£æ˜“åº¦
            if (solutions.length >= 10) return 1;
            if (solutions.length >= 5) return 2;
            if (solutions.length >= 2) return 3;
            // è§£ãŒ1ã¤ã ã‘
            if (hasDivide) return 5;
            return 4;
        }

        // å•é¡Œã‚’ç”Ÿæˆï¼ˆè¨­å®šã«å¿œã˜ã¦é›£æ˜“åº¦ãƒ»æ‹¬å¼§ã‚’åˆ¶å¾¡ï¼‰
        function generateProblem() {
            const includeBrackets = gameState.allowBrackets;
            const targetDifficulty = gameState.difficulty;
            
            let digits, solutions, difficulty;
            let attempts = 0;
            const maxAttempts = 500;
            
            do {
                digits = [
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 10)
                ];
                solutions = findSolutions(digits, includeBrackets);
                difficulty = calculateDifficulty(solutions);
                attempts++;
                
                // é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (solutions.length > 0 && targetDifficulty !== 'all') {
                    if (targetDifficulty === 'easy' && difficulty > 2) continue;
                    if (targetDifficulty === 'normal' && (difficulty < 2 || difficulty > 4)) continue;
                    if (targetDifficulty === 'hard' && difficulty < 4) continue;
                }
                
            } while (solutions.length === 0 || (targetDifficulty !== 'all' && attempts < maxAttempts && !matchesDifficulty(difficulty, targetDifficulty)));

            // è§£ã®è¡¨ç¤ºå½¢å¼ã‚’æ–‡å­—åˆ—ã«çµ±ä¸€
            const solutionExprs = solutions.map(s => typeof s === 'string' ? s : s.expr);
            return { digits, solutions: solutionExprs };
        }
        
        function matchesDifficulty(difficulty, target) {
            if (target === 'all') return true;
            if (target === 'easy') return difficulty <= 2;
            if (target === 'normal') return difficulty >= 2 && difficulty <= 4;
            if (target === 'hard') return difficulty >= 4;
            return true;
        }

        // ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½
        function showHint() {
            if (gameState.hintUsed || !gameState.allowHint) return;
            
            gameState.hintUsed = true;
            document.getElementById('hint-btn').disabled = true;
            
            // è§£ã®1ã¤ã‹ã‚‰æœ€åˆã®æ•°å­—ã¨æ¼”ç®—å­ã‚’ãƒ’ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¤º
            if (gameState.solutions && gameState.solutions.length > 0) {
                const solution = gameState.solutions[0];
                // æœ€åˆã®3æ–‡å­—ç¨‹åº¦ã‚’ãƒ’ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¤ºï¼ˆä¾‹: "3 + "ï¼‰
                const hint = solution.substring(0, 4).trim();
                alert(`ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã€Œ${hint}...ã€ã‹ã‚‰å§‹ã‚ã¦ã¿ã‚ˆã†ï¼`);
            } else {
                alert('ğŸ’¡ ãƒ’ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“');
            }
        }

        // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰é–‹å§‹
        document.getElementById('test-room-btn').addEventListener('click', () => {
            gameState.isTestMode = true;
            gameState.bo = 5;
            gameState.round = 1;
            gameState.hostScore = 0;
            gameState.guestScore = 0;
            gameState.hostName = 'ã‚ãªãŸ';
            gameState.guestName = 'CPU';
            gameState.difficulty = 'all';
            gameState.allowBrackets = true;
            gameState.allowHint = true; // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ’ãƒ³ãƒˆã‚ã‚Š
            currentUserName = 'ã‚ãªãŸ';
            currentUserNameEl.textContent = 'ã‚ãªãŸ (ãƒ†ã‚¹ãƒˆ)';

            // ãƒ«ãƒ¼ãƒ ç›£è¦–ã‚’åœæ­¢ï¼ˆå¯¾æˆ¦ä¸­ã¯ãƒ­ãƒ“ãƒ¼ã‚’è¦‹ãªã„ï¼‰
            unsubscribeFromRooms();

            startGame();
        });

        function startGame() {
            showScreen('game-screen');
            updateScoreDisplay();
            document.getElementById('game-host-name').textContent = gameState.hostName;
            document.getElementById('game-guest-name').textContent = gameState.guestName;
            
            // ãƒ›ã‚¹ãƒˆãƒ»ã‚²ã‚¹ãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
            const hostAvatarEl = document.getElementById('game-host-avatar');
            const guestAvatarEl = document.getElementById('game-guest-avatar');
            
            if (gameState.hostAvatar) {
                hostAvatarEl.innerHTML = `<img src="${gameState.hostAvatar}" alt="host">`;
            } else {
                hostAvatarEl.textContent = 'ğŸ‘‘';
            }
            
            if (gameState.guestAvatar) {
                guestAvatarEl.innerHTML = `<img src="${gameState.guestAvatar}" alt="guest">`;
            } else {
                guestAvatarEl.textContent = 'ğŸ‘¤';
            }
            
            if (gameState.isTestMode) {
                document.getElementById('game-guest-name').innerHTML = gameState.guestName + ' <span class="test-mode-badge">TEST</span>';
                guestAvatarEl.textContent = 'ğŸ¤–';
            }

            // ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
            const hintBtn = document.getElementById('hint-btn');
            if (gameState.allowHint) {
                hintBtn.style.display = 'inline-block';
            } else {
                hintBtn.style.display = 'none';
            }

            // æ‹¬å¼§ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
            const bracketBtns = document.querySelectorAll('.op-btn.bracket');
            bracketBtns.forEach(btn => {
                btn.style.display = gameState.allowBrackets ? 'inline-block' : 'none';
            });

            startRound();
        }

        async function startRound() {
            gameState.usedDigits = [];
            gameState.expression = '';
            gameState.submitted = false;
            gameState.timeLeft = 25;
            gameState.hintUsed = false;
            
            // ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            const hintBtn = document.getElementById('hint-btn');
            if (hintBtn) hintBtn.disabled = false;

            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ã®å ´åˆã€å•é¡Œã‚’FirebaseçµŒç”±ã§å…±æœ‰
            if (!gameState.isTestMode && currentRoomId) {
                if (gameState.isHost) {
                    // ãƒ›ã‚¹ãƒˆãŒå•é¡Œã‚’ç”Ÿæˆã—ã¦DBã«æ›¸ãè¾¼ã‚€
                    const problem = generateProblem();
                    gameState.digits = problem.digits;
                    gameState.solutions = problem.solutions;

                    await database.ref(`rooms/${currentRoomId}/game/round${gameState.round}`).set({
                        digits: problem.digits,
                        startTime: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // ã‚²ã‚¹ãƒˆã¯DBã‹ã‚‰å•é¡Œã‚’èª­ã¿å–ã‚‹ï¼ˆãƒ›ã‚¹ãƒˆãŒæ›¸ãè¾¼ã‚€ã¾ã§å¾…æ©Ÿï¼‰
                    const roundRef = database.ref(`rooms/${currentRoomId}/game/round${gameState.round}`);
                    await new Promise((resolve) => {
                        const listener = roundRef.on('value', (snapshot) => {
                            const data = snapshot.val();
                            if (data && data.digits) {
                                gameState.digits = data.digits;
                                gameState.solutions = findSolutions(data.digits);
                                roundRef.off('value', listener);
                                resolve();
                            }
                        });
                    });
                }
            } else {
                // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«: å•é¡Œã‚’ç”Ÿæˆ
                const problem = generateProblem();
                gameState.digits = problem.digits;
                gameState.solutions = problem.solutions;
            }

            const difficulty = calculateDifficulty(gameState.solutions);

            // UIæ›´æ–°
            updateDigitButtons();
            updateExpressionDisplay();
            document.getElementById('opponent-status').textContent = 'ç›¸æ‰‹: å…¥åŠ›ä¸­...';
            document.getElementById('opponent-status').className = 'opponent-status';

            // ç›¸æ‰‹ã®å¼ã‚’ç›£è¦–ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦æ™‚ï¼‰
            if (!gameState.isTestMode && currentRoomId) {
                startOpponentExpressionListener();
            }

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
            showCountdown(gameState.round, () => {
                // å•é¡Œè¡¨ç¤º
                renderProblem(difficulty);
                gameState.roundStartTime = Date.now();
                startTimer();
            });
        }

        function showCountdown(round, callback) {
            const overlay = document.getElementById('countdown-overlay');
            const roundEl = document.getElementById('countdown-round');
            const numberEl = document.getElementById('countdown-number');

            overlay.classList.remove('hidden');
            roundEl.textContent = `ç¬¬${round}å•`;

            let count = 3;
            numberEl.textContent = count;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    numberEl.textContent = count;
                } else {
                    clearInterval(interval);
                    overlay.classList.add('hidden');
                    callback();
                }
            }, 1000);
        }

        function renderProblem(difficulty) {
            document.getElementById('round-number').textContent = `ç¬¬${gameState.round}å•`;

            const diffEl = document.getElementById('difficulty');
            diffEl.textContent = 'é›£æ˜“åº¦ ' + 'â˜…'.repeat(difficulty) + 'â˜†'.repeat(5 - difficulty);
            diffEl.className = `difficulty difficulty-${difficulty}`;

            const digitsContainer = document.getElementById('problem-digits');
            digitsContainer.innerHTML = gameState.digits.map((d, i) => 
                `<div class="digit-card" data-index="${i}">${d}</div>`
            ).join('');
        }

        function startTimer() {
            const timerFill = document.getElementById('timer-fill');
            const timerText = document.getElementById('timer-text');

            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft -= 0.1;
                const percent = (gameState.timeLeft / 25) * 100;
                timerFill.style.width = `${percent}%`;
                timerText.textContent = Math.ceil(gameState.timeLeft);

                if (gameState.timeLeft <= 5) {
                    timerFill.classList.add('danger');
                } else {
                    timerFill.classList.remove('danger');
                }

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    handleTimeout();
                }
            }, 100);
        }

        function handleTimeout() {
            if (!gameState.submitted) {
                showRoundResult('draw', gameState.solutions[0] || 'è§£ãªã—', null);
            }
        }

        // ç›¸æ‰‹ã®å¼ã‚’Firebaseã«åŒæœŸ
        let opponentExpressionListener = null;

        function syncExpressionToFirebase() {
            if (gameState.isTestMode || !currentRoomId) return;
            
            const playerKey = gameState.isHost ? 'host' : 'guest';
            const displayExpr = gameState.expression
                .replace(/\*/g, 'Ã—')
                .replace(/\//g, 'Ã·');
            
            database.ref(`rooms/${currentRoomId}/game/round${gameState.round}/${playerKey}`).update({
                expression: displayExpr,
                usedCount: gameState.usedDigits.length
            }).catch(err => console.warn('å¼ã®åŒæœŸå¤±æ•—:', err));
        }

        function startOpponentExpressionListener() {
            if (opponentExpressionListener) {
                opponentExpressionListener.off();
            }
            
            const opponentKey = gameState.isHost ? 'guest' : 'host';
            const opponentRef = database.ref(`rooms/${currentRoomId}/game/round${gameState.round}/${opponentKey}`);
            
            opponentExpressionListener = opponentRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const statusEl = document.getElementById('opponent-status');
                
                if (data && data.expression !== undefined) {
                    // ç›¸æ‰‹ã®å¼ã‚’è¡¨ç¤ºï¼ˆæ•°å­—éƒ¨åˆ†ã¯â—ã§éš ã™ï¼‰
                    const maskedExpr = data.expression.replace(/[0-9]/g, 'â—');
                    statusEl.textContent = `ç›¸æ‰‹: ${maskedExpr || 'å…¥åŠ›ä¸­...'}`;
                    
                    if (data.usedCount === 4) {
                        statusEl.textContent = `ç›¸æ‰‹: ${maskedExpr} (è¨ˆç®—ä¸­...)`;
                        statusEl.className = 'opponent-status submitted';
                    } else {
                        statusEl.className = 'opponent-status';
                    }
                } else {
                    statusEl.textContent = 'ç›¸æ‰‹: å…¥åŠ›ä¸­...';
                    statusEl.className = 'opponent-status';
                }
            });
        }

        function stopOpponentExpressionListener() {
            if (opponentExpressionListener) {
                const opponentKey = gameState.isHost ? 'guest' : 'host';
                database.ref(`rooms/${currentRoomId}/game/round${gameState.round}/${opponentKey}`).off('value', opponentExpressionListener);
                opponentExpressionListener = null;
            }
        }

        // æ•°å­—ã‚«ãƒ¼ãƒ‰ã®ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå•é¡Œã®æ•°å­—ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›ï¼‰
        document.getElementById('problem-digits').addEventListener('click', (e) => {
            if (gameState.submitted) return;

            const card = e.target.closest('.digit-card');
            if (!card || card.classList.contains('used')) return;

            const cardIndex = parseInt(card.dataset.index);
            const digitNum = gameState.digits[cardIndex];

            // æ•°å­—ã®ç›´å¾Œã«æ•°å­—ã¯å…¥åŠ›ä¸å¯ï¼ˆæ¼”ç®—å­ã‹æ‹¬å¼§ãŒå¿…è¦ï¼‰
            const lastChar = gameState.expression.slice(-1);
            if (/[0-9]/.test(lastChar)) return;
            // é–‰ã˜æ‹¬å¼§ã®ç›´å¾Œã«æ•°å­—ã¯å…¥åŠ›ä¸å¯
            if (lastChar === ')') return;

            gameState.expression += digitNum;
            gameState.usedDigits.push(cardIndex); // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ç®¡ç†
            updateDigitCards();
            updateExpressionDisplay();
            syncExpressionToFirebase();
        });

        // æ¼”ç®—å­ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('operator-row').addEventListener('click', (e) => {
            if (gameState.submitted) return;

            const btn = e.target.closest('.op-btn');
            if (!btn) return;

            const op = btn.dataset.op;
            const lastChar = gameState.expression.slice(-1);

            if (op === '(') {
                // é–‹ãæ‹¬å¼§: å¼ã®å…ˆé ­ã€æ¼”ç®—å­ã®å¾Œã€é–‹ãæ‹¬å¼§ã®å¾Œã«å…¥åŠ›å¯èƒ½
                if (gameState.expression.length === 0 || 
                    ['+', '-', '*', '/', '('].includes(lastChar)) {
                    gameState.expression += op;
                    updateExpressionDisplay();
                    syncExpressionToFirebase();
                }
            } else if (op === ')') {
                // é–‰ã˜æ‹¬å¼§: æ•°å­—ã‹é–‰ã˜æ‹¬å¼§ã®å¾Œã«ã®ã¿å…¥åŠ›å¯èƒ½ã€é–‹ãæ‹¬å¼§ã®æ•°ã‚’ãƒã‚§ãƒƒã‚¯
                if (/[0-9)]/.test(lastChar)) {
                    const openCount = (gameState.expression.match(/\(/g) || []).length;
                    const closeCount = (gameState.expression.match(/\)/g) || []).length;
                    if (openCount > closeCount) {
                        gameState.expression += op;
                        updateExpressionDisplay();
                        syncExpressionToFirebase();
                    }
                }
            } else {
                // é€šå¸¸ã®æ¼”ç®—å­: æ•°å­—ã‹é–‰ã˜æ‹¬å¼§ã®å¾Œã«ã®ã¿å…¥åŠ›å¯èƒ½
                if (/[0-9)]/.test(lastChar)) {
                    gameState.expression += op;
                    updateExpressionDisplay();
                    syncExpressionToFirebase();
                }
            }
        });

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('action-row').addEventListener('click', (e) => {
            if (gameState.submitted) return;

            const btn = e.target.closest('.action-btn');
            if (!btn) return;

            const action = btn.dataset.action;

            if (action === 'backspace') {
                if (gameState.expression.length > 0) {
                    const lastChar = gameState.expression.slice(-1);
                    gameState.expression = gameState.expression.slice(0, -1);
                    
                    // æ•°å­—ã‚’å‰Šé™¤ã—ãŸå ´åˆã€usedDigitsã‹ã‚‰ã‚‚å‰Šé™¤
                    if (/[0-9]/.test(lastChar)) {
                        // æœ€å¾Œã«ä½¿ã£ãŸè©²å½“æ•°å­—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¢ã™
                        for (let i = gameState.usedDigits.length - 1; i >= 0; i--) {
                            if (gameState.digits[gameState.usedDigits[i]] === parseInt(lastChar)) {
                                gameState.usedDigits.splice(i, 1);
                                break;
                            }
                        }
                    }
                    updateDigitCards();
                    updateExpressionDisplay();
                    syncExpressionToFirebase();
                }
            } else if (action === 'reset') {
                // å…¨ãƒªã‚»ãƒƒãƒˆ
                gameState.expression = '';
                gameState.usedDigits = [];
                updateDigitCards();
                updateExpressionDisplay();
                syncExpressionToFirebase();
            } else if (action === 'hint') {
                showHint();
            }
        });

        function updateDigitCards() {
            document.querySelectorAll('.digit-card').forEach((card, i) => {
                if (gameState.usedDigits.includes(i)) {
                    card.classList.add('used');
                } else {
                    card.classList.remove('used');
                }
            });
        }

        // æ—§updateDigitButtonsé–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        function updateDigitButtons() {
            updateDigitCards();
        }

        function updateExpressionDisplay() {
            const display = document.getElementById('expression-display');
            const resultEl = document.getElementById('expression-result');
            const submitBtn = document.getElementById('submit-btn');

            // è¡¨ç¤ºç”¨ã«æ¼”ç®—å­ã‚’å¤‰æ›
            const displayExpr = gameState.expression
                .replace(/\*/g, 'Ã—')
                .replace(/\//g, 'Ã·');
            display.textContent = displayExpr || ' ';
            display.className = 'expression-display';

            // å¼ã®è©•ä¾¡
            if (gameState.expression && gameState.usedDigits.length === 4) {
                try {
                    const result = safeEval(gameState.expression);
                    if (result !== null) {
                        resultEl.textContent = `= ${result}`;
                        if (result === 10) {
                            resultEl.classList.add('valid');
                            display.classList.add('correct');
                            // è‡ªå‹•é€ä¿¡ï¼ˆ=10ã«ãªã£ãŸç¬é–“ï¼‰
                            if (!gameState.submitted) {
                                submitAnswer();
                            }
                        } else {
                            resultEl.classList.remove('valid');
                        }
                    } else {
                        resultEl.textContent = 'å¼ãŒä¸æ­£ã§ã™';
                        resultEl.classList.remove('valid');
                    }
                } catch {
                    resultEl.textContent = 'å¼ãŒä¸æ­£ã§ã™';
                    resultEl.classList.remove('valid');
                }
            } else if (gameState.expression) {
                // é€”ä¸­ã®å¼ã‚’è©•ä¾¡
                try {
                    const result = safeEval(gameState.expression);
                    if (result !== null) {
                        resultEl.textContent = `= ${result} (æ•°å­—ã‚’ã™ã¹ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„)`;
                    } else {
                        resultEl.textContent = 'æ•°å­—ã‚’ã™ã¹ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„';
                    }
                } catch {
                    resultEl.textContent = 'æ•°å­—ã‚’ã™ã¹ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„';
                }
                resultEl.classList.remove('valid');
            } else {
                resultEl.textContent = 'å¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                resultEl.classList.remove('valid');
            }
        }

        function submitAnswer() {
            gameState.submitted = true;
            clearInterval(gameState.timerInterval);
            stopOpponentExpressionListener();

            const displayExpr = gameState.expression
                .replace(/\*/g, 'Ã—')
                .replace(/\//g, 'Ã·');

            // è§£ç­”æ™‚é–“ã‚’è¨ˆç®—
            const solveTime = ((Date.now() - gameState.roundStartTime) / 1000).toFixed(2);

            if (gameState.isTestMode) {
                // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯å¸¸ã«è‡ªåˆ†ã®å‹ã¡
                showRoundResult('win', displayExpr + ' = 10', solveTime);
            } else {
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ã®å ´åˆã¯Firebaseã«é€ä¿¡ï¼ˆå¾Œã§å®Ÿè£…ï¼‰
                showRoundResult('win', displayExpr + ' = 10', solveTime);
            }
        }

        function showRoundResult(result, answer, solveTime) {
            const overlay = document.getElementById('result-overlay');
            const titleEl = document.getElementById('result-title');
            const answerEl = document.getElementById('result-answer');

            overlay.classList.remove('hidden');
            
            // æ™‚é–“è¡¨ç¤ºã‚’å«ã‚ã‚‹
            if (solveTime && result === 'win') {
                answerEl.textContent = answer + ` (${solveTime}ç§’)`;
            } else {
                answerEl.textContent = answer;
            }

            if (result === 'win') {
                titleEl.textContent = 'ğŸ‰ æ­£è§£ï¼';
                titleEl.className = 'result-title win';
                gameState.hostScore++;
            } else if (result === 'lose') {
                titleEl.textContent = 'ğŸ˜¢ ç›¸æ‰‹ãŒå…ˆã«æ­£è§£';
                titleEl.className = 'result-title lose';
                gameState.guestScore++;
            } else {
                titleEl.textContent = 'â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—';
                titleEl.className = 'result-title draw';
            }

            updateScoreDisplay();

            // å‹æ•—ãƒã‚§ãƒƒã‚¯
            const winTarget = Math.ceil(gameState.bo / 2);

            setTimeout(() => {
                overlay.classList.add('hidden');

                if (gameState.hostScore >= winTarget) {
                    showMatchResult('win');
                } else if (gameState.guestScore >= winTarget) {
                    showMatchResult('lose');
                } else {
                    gameState.round++;
                    startRound();
                }
            }, 3000);
        }

        function updateScoreDisplay() {
            const hostScoreEl = document.getElementById('host-score');
            const guestScoreEl = document.getElementById('guest-score');
            const winTarget = Math.ceil(gameState.bo / 2);

            hostScoreEl.innerHTML = '';
            guestScoreEl.innerHTML = '';

            for (let i = 0; i < winTarget; i++) {
                const hostDot = document.createElement('div');
                hostDot.className = 'score-dot' + (i < gameState.hostScore ? ' win' : '');
                hostScoreEl.appendChild(hostDot);

                const guestDot = document.createElement('div');
                guestDot.className = 'score-dot' + (i < gameState.guestScore ? ' win' : '');
                guestScoreEl.appendChild(guestDot);
            }
        }

        function showMatchResult(result) {
            const overlay = document.getElementById('match-result-overlay');
            const titleEl = document.getElementById('match-result-title');
            const scoreEl = document.getElementById('match-result-score');

            overlay.classList.remove('hidden');

            if (result === 'win') {
                titleEl.textContent = 'ğŸ‰ å‹åˆ©ï¼';
                titleEl.style.color = 'var(--secondary-color)';
            } else {
                titleEl.textContent = 'ğŸ˜¢ æ•—åŒ—...';
                titleEl.style.color = 'var(--danger-color)';
            }

            scoreEl.textContent = `${gameState.hostScore} - ${gameState.guestScore}`;
        }

        document.getElementById('back-to-lobby-btn').addEventListener('click', () => {
            document.getElementById('match-result-overlay').classList.add('hidden');
            if (!gameState.isTestMode && currentRoomId) {
                leaveRoom();
            } else {
                showScreen('lobby-screen');
            }
            gameState.isTestMode = false;
            
            // ãƒ«ãƒ¼ãƒ ç›£è¦–ã‚’å†é–‹
            subscribeToRooms();
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›å¯¾å¿œ
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('game-screen').classList.contains('active')) return;
            if (gameState.submitted) return;

            const key = e.key;

            if (/^[1-9]$/.test(key)) {
                const digitNum = parseInt(key);
                const availableDigits = [...gameState.digits];
                gameState.usedDigits.forEach(d => {
                    const idx = availableDigits.indexOf(d);
                    if (idx !== -1) availableDigits.splice(idx, 1);
                });

                if (availableDigits.includes(digitNum)) {
                    gameState.expression += key;
                    gameState.usedDigits.push(digitNum);
                    updateDigitButtons();
                    updateExpressionDisplay();
                }
            } else if (['+', '-', '*', '/'].includes(key)) {
                gameState.expression += key;
                updateExpressionDisplay();
            } else if (key === '(' || key === ')') {
                    // æ‹¬å¼§å…¥åŠ›ã¯ç„¡åŠ¹åŒ–ï¼ˆç„¡è¦–ï¼‰
                } else if (key === 'Backspace') {
                if (gameState.expression.length > 0) {
                    const lastChar = gameState.expression.slice(-1);
                    gameState.expression = gameState.expression.slice(0, -1);
                    if (/[1-9]/.test(lastChar)) {
                        const idx = gameState.usedDigits.lastIndexOf(parseInt(lastChar));
                        if (idx !== -1) gameState.usedDigits.splice(idx, 1);
                    }
                    updateDigitButtons();
                    updateExpressionDisplay();
                }
            } else if (key === 'Escape' || key === 'c' || key === 'C') {
                gameState.expression = '';
                gameState.usedDigits = [];
                updateDigitButtons();
                updateExpressionDisplay();
            }
        });

        // ========================================
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãƒ»Googleãƒ­ã‚°ã‚¤ãƒ³
        // ========================================
            const GOOGLE_ICON_URL = 'https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg';
        const userSettingsModal = document.getElementById('user-settings-modal');
        const userAvatarEl = document.getElementById('user-avatar');
        const userAvatarLargeEl = document.getElementById('user-avatar-large');
        let userAvatarUrl = null;

        document.getElementById('user-info-btn').addEventListener('click', () => {
            // ç¾åœ¨ã®è¨­å®šã‚’åæ˜ 
            document.getElementById('display-name-input').value = currentUserName;
            updateLoginSection();
            showModal(userSettingsModal);
        });

        document.getElementById('close-user-settings').addEventListener('click', () => {
            hideModal(userSettingsModal);
        });

        userSettingsModal.addEventListener('click', (e) => {
            if (e.target === userSettingsModal) hideModal(userSettingsModal);
        });

        // ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        document.getElementById('upload-avatar-btn').addEventListener('click', () => {
            document.getElementById('avatar-upload').click();
        });

        document.getElementById('avatar-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    userAvatarUrl = event.target.result;
                    userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                    userAvatarLargeEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                    // LocalStorageã«ä¿å­˜
                    localStorage.setItem('userAvatar', userAvatarUrl);
                    // Firebase Realtime Database ã«ã‚‚ä¿å­˜ï¼ˆStorageã¯ä½¿ã‚ãªã„ãŸã‚ã€base64ãƒ‡ãƒ¼ã‚¿ã‚’DBã«ç½®ãï¼‰
                    if (currentUserId) {
                        try {
                            database.ref(`users/${currentUserId}`).update({
                                avatar: userAvatarUrl,
                                displayName: currentUserName || null
                            });
                        } catch (err) {
                            console.warn('DBã¸ã‚¢ãƒã‚¿ãƒ¼ä¿å­˜å¤±æ•—:', err);
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // Googleãƒ­ã‚°ã‚¤ãƒ³
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        document.getElementById('google-login-btn').addEventListener('click', async () => {
            try {
                const result = await auth.signInWithPopup(googleProvider);
                const user = result.user;
                currentUserId = user.uid;
                currentUserName = user.displayName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                currentUserNameEl.textContent = currentUserName;
                document.getElementById('display-name-input').value = currentUserName;

                // Googleã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒã‚ã‚Œã°ä½¿ã„ã€ç„¡ã‘ã‚Œã°Googleã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
                if (user.photoURL) {
                    userAvatarUrl = user.photoURL;
                } else {
                    userAvatarUrl = GOOGLE_ICON_URL;
                }
                userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                userAvatarLargeEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;

                // DBã«ã‚‚ä¿å­˜ï¼ˆä»–ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ï¼‰
                try {
                    database.ref(`users/${currentUserId}`).update({
                        displayName: currentUserName,
                        avatar: userAvatarUrl
                    });
                } catch (err) {
                    console.warn('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«DBä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                }

                updateLoginSection();
                console.log('Googleãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', user.email);
            } catch (error) {
                console.error('Googleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                if (error.code === 'auth/popup-blocked') {
                    alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                } else if (error.code === 'auth/unauthorized-domain') {
                    alert('ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯èªè¨¼ã«ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚Firebase Consoleã§Authorized domainsã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
                } else {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                // åŒ¿åã§å†ãƒ­ã‚°ã‚¤ãƒ³
                const userCredential = await auth.signInAnonymously();
                currentUserId = userCredential.user.uid;
                currentUserName = 'ã‚²ã‚¹ãƒˆ';
                currentUserNameEl.textContent = currentUserName;
                userAvatarUrl = null;
                userAvatarEl.innerHTML = 'ğŸ‘¤';
                userAvatarLargeEl.innerHTML = 'ğŸ‘¤';
                localStorage.removeItem('userAvatar');
                updateLoginSection();
                console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        });

        function updateLoginSection() {
            const user = auth.currentUser;
            const loginSection = document.getElementById('login-section');
            const logoutSection = document.getElementById('logout-section');
            
            if (user && !user.isAnonymous) {
                loginSection.style.display = 'none';
                logoutSection.style.display = 'block';
                document.getElementById('logged-in-email').textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email}`;
            } else {
                loginSection.style.display = 'block';
                logoutSection.style.display = 'none';
            }
        }

        // è¨­å®šä¿å­˜
        document.getElementById('save-user-settings').addEventListener('click', () => {
            const newName = document.getElementById('display-name-input').value.trim();
            if (newName) {
                currentUserName = newName;
                currentUserNameEl.textContent = newName;
                localStorage.setItem('userName', newName);
                // DBã«ä¿å­˜ï¼ˆåŒ¿åå«ã‚€ï¼‰
                if (currentUserId) {
                    try {
                        database.ref(`users/${currentUserId}`).update({
                            displayName: newName,
                            avatar: userAvatarUrl || null
                        });
                    } catch (err) {
                        console.warn('DBã¸ãƒ¦ãƒ¼ã‚¶ãƒ¼åä¿å­˜å¤±æ•—:', err);
                    }
                }
            }
            hideModal(userSettingsModal);
        });

        // LocalStorageã‹ã‚‰å¾©å…ƒ
        function restoreUserSettings() {
            const savedName = localStorage.getItem('userName');
            const savedAvatar = localStorage.getItem('userAvatar');
            
            if (savedName) {
                currentUserName = savedName;
                currentUserNameEl.textContent = savedName;
            }
            
            if (savedAvatar) {
                userAvatarUrl = savedAvatar;
                userAvatarEl.innerHTML = `<img src="${savedAvatar}" alt="avatar">`;
                userAvatarLargeEl.innerHTML = `<img src="${savedAvatar}" alt="avatar">`;
            }
        }

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserId = user.uid;
                console.log('èªè¨¼çŠ¶æ…‹å¤‰æ›´ - User ID:', currentUserId);
                
                if (!user.isAnonymous && user.displayName) {
                    currentUserName = user.displayName;
                    currentUserNameEl.textContent = currentUserName;
                }
                
                if (!user.isAnonymous && user.photoURL) {
                    userAvatarUrl = user.photoURL;
                    userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                }
                else if (user.providerData && user.providerData.some(p => p.providerId === 'google.com')) {
                    // Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãŒphotoURLã‚’æŒãŸãªã„å ´åˆã¯Googleã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ã†
                    userAvatarUrl = GOOGLE_ICON_URL;
                    userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                }
                // DBã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå„ªå…ˆï¼‰
                try {
                    database.ref(`users/${currentUserId}`).once('value').then((snap) => {
                        const profile = snap.val();
                        if (profile) {
                            if (profile.displayName) {
                                currentUserName = profile.displayName;
                                currentUserNameEl.textContent = currentUserName;
                                localStorage.setItem('userName', currentUserName);
                            }
                            if (profile.avatar) {
                                userAvatarUrl = profile.avatar;
                                userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                                userAvatarLargeEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                                localStorage.setItem('userAvatar', userAvatarUrl);
                            } else {
                                // ç„¡ã‘ã‚Œã°æ—¢å­˜ã®localStorageã‚’å¾©å…ƒ
                                restoreUserSettings();
                            }
                        } else {
                            restoreUserSettings();
                        }
                    }).catch((err) => {
                        console.warn('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                        restoreUserSettings();
                    });
                } catch (err) {
                    console.warn('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«DBãƒã‚§ãƒƒã‚¯å¤±æ•—:', err);
                    restoreUserSettings();
                }

                subscribeToRooms();
                console.log('make10 vs - åˆæœŸåŒ–å®Œäº†');
            } else {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„å ´åˆã¯åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³
                auth.signInAnonymously()
                    .then((userCredential) => {
                        currentUserId = userCredential.user.uid;
                        console.log('åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³æˆåŠŸ');
                        console.log('User ID:', currentUserId);
                        restoreUserSettings();
                        subscribeToRooms();
                        console.log('make10 vs - åˆæœŸåŒ–å®Œäº†');
                    })
                    .catch((error) => {
                        console.error('åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³å¤±æ•—:', error);
                        alert('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                    });
            }
        });

        // ãƒ­ãƒ“ãƒ¼ã®å†è©¦è¡Œãƒ»ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            const retryBtn = document.getElementById('lobby-retry-btn');
            const helpBtn = document.getElementById('lobby-help-btn');
            if (retryBtn) retryBtn.addEventListener('click', attemptAuthAndSubscribe);
            if (helpBtn) helpBtn.addEventListener('click', () => {
                alert('ãƒ«ãƒ¼ãƒ å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebase ã® Realtime Database ã®ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n- é–‹ç™ºä¸­ã¯ä¸€æ™‚çš„ã« " .read": true ã‚’è¨­å®šã—ã¦å‹•ä½œç¢ºèªã§ãã¾ã™\n- æœ¬ç•ªã§ã¯ "auth != null" ã‚’ä½¿ç”¨ã—ã€åŒ¿åãƒ­ã‚°ã‚¤ãƒ³(Anonymous)ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
            });
        });

        // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('DOMContentLoaded', () => {
            const out = document.getElementById('debug-output');
            const authBtn = document.getElementById('auth-info-btn');
            const roomsBtn = document.getElementById('test-rooms-read-btn');
            const googleBtn = document.getElementById('force-google-login-btn');

            function write(msg) {
                if (!out) return;
                out.style.display = 'block';
                out.textContent = (new Date()).toLocaleTimeString() + ' - ' + msg + '\n' + out.textContent;
            }

            if (authBtn) authBtn.addEventListener('click', async () => {
                const u = auth.currentUser;
                if (!u) {
                    write('currentUser: null');
                    return;
                }
                // show key details (uid and provider info)
                try {
                    write('currentUser.uid: ' + (u.uid || '(no uid)'));
                    write('currentUser.providerData: ' + JSON.stringify(u.providerData || []));
                    const token = await u.getIdToken(true);
                    write('ID token (short): ' + token.substring(0, 40) + '...');
                    try {
                        const tr = await u.getIdTokenResult();
                        write('ID token issuer/aud: issuer=' + (tr.issuer || '') + ', aud=' + (tr.audience || tr.claims.aud || ''));
                        write('Token authTime: ' + (tr.authTime || '')); 
                    } catch (e2) {
                        write('getIdTokenResult error: ' + e2);
                    }
                } catch (e) {
                    write('auth info error: ' + e);
                }
            });

            if (roomsBtn) roomsBtn.addEventListener('click', async () => {
                write('rooms direct read: starting...');
                try {
                    const snap = await database.ref('rooms').once('value');
                    const v = snap.val();
                    write('rooms read success: ' + (v ? Object.keys(v).length + ' rooms' : 'no rooms'));
                } catch (e) {
                    write('rooms read error: ' + (e && e.code ? e.code + ' - ' + e.message : e));
                }
            });

            if (googleBtn) googleBtn.addEventListener('click', async () => {
                write('Google sign-in: starting...');
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    const result = await auth.signInWithPopup(provider);
                    write('Google sign-in success: ' + (result.user ? result.user.uid : 'no user'));
                } catch (e) {
                    write('Google sign-in error: ' + (e && e.message ? e.message : e));
                }
            });
        });
    </script>
</body>
</html>
