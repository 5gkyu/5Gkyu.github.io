<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>make10 vs - „É™„Ç¢„É´„Çø„Ç§„É†ÂØæÊà¶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4a90d9;
            --primary-dark: #357abd;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #eee;
            --text-muted: #888;
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
        }

        header h1 span {
            color: var(--warning-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .user-info:hover {
            background: rgba(255,255,255,0.1);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        

        .user-info .status-dot {
            width: 10px;
            height: 10px;
            background: var(--secondary-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
        .container {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        /* ÁîªÈù¢Âàá„ÇäÊõø„Åà */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* „É≠„Éì„ÉºÁîªÈù¢ */
        #lobby-screen.active {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .lobby-header h2 {
            font-size: 1.3rem;
        }

        /* „Éú„Çø„É≥ÂÖ±ÈÄö */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: #555;
            color: white;
        }

        /* „É´„Éº„É†‰∏ÄË¶ß */
        .room-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .room-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
            margin-bottom: 0.5rem;
        }

        .room-count {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .refresh-btn {
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }

        .room-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .room-card:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .room-info {
            flex: 1;
        }

        /* „É´„Éº„É†‰∏ÄË¶ßÁî®„Ç¢„Éê„Çø„Éº */
        .room-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .room-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* „É≠„Éì„Éº„ÅÆ„Ç®„É©„Éº„Éê„Éä„Éº */
        .lobby-error {
            background: #ffefef;
            border: 1px solid #ffb3b3;
            color: #7a1f1f;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.75rem 0;
            text-align: center;
        }

        .lobby-error .lobby-error-text {
            font-weight: bold;
        }

        /* „É´„Éº„É†„Ç´„Éº„ÉâÂÜÖ„Åß„Ç¢„Éê„Çø„Éº„Å®ÊÉÖÂ†±„ÇíÊ®™‰∏¶„Å≥„Å´„Åô„ÇãË™øÊï¥ */
        .room-card .room-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .room-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .room-name .lock-icon {
            font-size: 0.9rem;
            color: var(--warning-color);
        }

        .room-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
        }

        .room-players {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .player-count {
            background: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .player-count.full {
            background: var(--danger-color);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.2rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-color);
        }

        /* „Éï„Ç©„Éº„É† */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .form-group label .required {
            color: var(--danger-color);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #333;
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group input::placeholder {
            color: #555;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* ÂæÖÊ©üÁîªÈù¢ */
        #waiting-screen {
            text-align: center;
            padding: 2rem;
        }

        .waiting-room-info {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .waiting-room-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .waiting-players {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin: 2rem 0;
        }

        .waiting-player {
            text-align: center;
        }

        .waiting-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: #555;
            min-width: 60px;
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 0.5rem;
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .player-avatar.empty {
            background: #333;
            border: 3px dashed #555;
        }

        .player-name {
            font-weight: bold;
        }

        .waiting-status {
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .waiting-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* „Ç≤„Éº„É†ÁîªÈù¢ */
        #game-screen.active {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            max-height: calc(100vh - 80px);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }

        .game-player {
            text-align: center;
            flex: 1;
        }

        .game-player-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .game-player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            overflow: hidden;
        }

        .game-player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .game-player-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .game-player-name.highlight {
            color: var(--warning-color);
        }

        .game-score {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
        }

        .score-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #555;
        }

        .score-dot.win {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .score-dot.lose {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }

        .game-vs {
            font-size: 1.2rem;
            font-weight: bold;
            color: #555;
            padding: 0 1rem;
        }

        /* ÂïèÈ°å„Ç®„É™„Ç¢ */
        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 0.5rem;
            min-height: 0;
        }

        .round-info {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .round-number {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .difficulty {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .difficulty-1 { background: #27ae60; }
        .difficulty-2 { background: #2ecc71; }
        .difficulty-3 { background: #f39c12; }
        .difficulty-4 { background: #e67e22; }
        .difficulty-5 { background: #e74c3c; }

        .problem-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .problem-digits {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .digit-card {
            width: 60px;
            height: 70px;
            background: linear-gradient(135deg, #4a90d9, #357abd);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
        }

        .digit-card:hover:not(.used) {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .digit-card:active:not(.used) {
            transform: scale(0.95);
        }

        .digit-card.used {
            opacity: 0.3;
            transform: scale(0.85);
            cursor: not-allowed;
            background: #444;
        }

        /* „Çø„Ç§„Éû„Éº */
        .timer-container {
            text-align: center;
            margin: 0.5rem 0;
        }

        .timer-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--warning-color));
            transition: width 0.1s linear;
        }

        .timer-fill.danger {
            background: linear-gradient(90deg, var(--warning-color), var(--danger-color));
        }

        .timer-text {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* ÂºèË°®Á§∫ */
        .expression-display {
            background: var(--bg-color);
            border: 2px solid #333;
            border-radius: 10px;
            padding: 1rem;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-family: 'Consolas', monospace;
            margin: 0.5rem 0;
        }

        .expression-display.correct {
            border-color: var(--secondary-color);
            background: rgba(46, 204, 113, 0.1);
        }

        .expression-display.wrong {
            border-color: var(--danger-color);
            background: rgba(231, 76, 60, 0.1);
        }

        .expression-result {
            text-align: center;
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .expression-result.valid {
            color: var(--secondary-color);
        }

        /* ÊºîÁÆóÂ≠ê„ÉªÊã¨Âºß„Éú„Çø„É≥Ë°å */
        .operator-row {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .op-btn {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--warning-color);
            color: #000;
        }

        .op-btn:hover {
            transform: scale(1.1);
            background: #e67e22;
        }

        .op-btn:active {
            transform: scale(0.95);
        }

        .op-btn.bracket {
            background: #9b59b6;
            color: #fff;
        }

        .op-btn.bracket:hover {
            background: #8e44ad;
        }

        /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Ë°å */
        .action-row {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin: 0.5rem 0;
        }

        .action-btn {
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.backspace {
            background: #555;
            color: #fff;
        }

        .action-btn.reset {
            background: var(--danger-color);
            color: #fff;
        }

        /* Mobile adjustments: make game screen fit a single smartphone viewport */
        @media (max-width: 420px) {
            .game-screen {
                padding: 0.5rem;
            }

            .game-header, .game-main {
                padding: 0.25rem 0.5rem;
            }

            .digit-card {
                width: 48px;
                height: 56px;
                font-size: 1.6rem;
                margin: 0 0.25rem;
            }

            .problem-digits {
                display: flex;
                gap: 0.4rem;
                justify-content: center;
                flex-wrap: nowrap;
            }

            .operator-row {
                gap: 0.4rem;
                padding: 0.25rem 0;
            }

            .op-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
                border-radius: 10px;
            }

            .action-row { gap: 0.5rem; }

            .action-btn { padding: 0.45rem 0.8rem; font-size: 0. ninerem; }

            .expression-display {
                min-height: 44px;
                font-size: 1.1rem;
                padding: 0.5rem;
            }

            .expression-result { font-size: 0. ninerem; }

            .timer-text { font-size: 1.1rem; }

            .round-info { gap: 0.4rem; }
            .round-number { font-size: 1rem; }
            .difficulty { font-size: 0.85rem; }

            .problem-display { margin-bottom: 0.4rem; }

            .user-avatar-large { width: 56px; height: 56px; font-size: 1.6rem; }

        }

        /* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .countdown-overlay.hidden {
            display: none;
        }

        .countdown-round {
            font-size: 1.5rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .countdown-number {
            font-size: 8rem;
            font-weight: bold;
            color: var(--primary-color);
            animation: countPulse 1s ease-in-out infinite;
        }

        @keyframes countPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ÁµêÊûú„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .result-overlay.hidden {
            display: none;
        }

        .result-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .result-title.win {
            color: var(--secondary-color);
        }

        .result-title.lose {
            color: var(--danger-color);
        }

        .result-title.draw {
            color: var(--warning-color);
        }

        .result-answer {
            background: var(--card-bg);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .result-answer-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .result-answer-expr {
            font-size: 1.5rem;
            font-family: 'Consolas', monospace;
        }

        /* „Éû„ÉÉ„ÉÅÁµêÊûú */
        .match-result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 600;
        }

        .match-result-overlay.hidden {
            display: none;
        }

        .match-result-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 2rem;
        }

        .match-result-players {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .match-result-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .match-result-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border: 3px solid var(--border-color);
            overflow: hidden;
        }

        .match-result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .match-result-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-secondary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .match-result-score {
            font-size: 4rem;
            font-weight: bold;
            color: white;
        }

        /* „ÉÜ„Çπ„Éà„É¢„Éº„ÉâË°®Á§∫ */
        .test-mode-badge {
            background: var(--warning-color);
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        /* „É¶„Éº„Ç∂„ÉºË®≠ÂÆö„É¢„Éº„ÉÄ„É´ */
        .user-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto;
            overflow: hidden;
        }

        .user-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 600px) {
            header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .lobby-header {
                flex-direction: column;
                text-align: center;
            }

            .room-card {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .room-meta {
                justify-content: center;
            }

            .waiting-players {
                flex-direction: column;
            }

            .digit-card {
                width: 50px;
                height: 60px;
                font-size: 1.5rem;
            }

            .input-btn {
                padding: 0.6rem;
                font-size: 1.1rem;
            }

            .expression-display {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <header>
        <h1>make<span>10</span> vs</h1>
        <div class="user-info" id="user-info-btn">
            <div class="user-avatar" id="user-avatar">üë§</div>
            <span class="status-dot"></span>
            <span id="current-user-name">„Ç≤„Çπ„Éà</span>
        </div>
    </header>

    <div class="container">
        <!-- „É≠„Éì„ÉºÁîªÈù¢ -->
        <div id="lobby-screen" class="screen active">
            <div class="lobby-header">
                <h2>üéÆ „É´„Éº„É†‰∏ÄË¶ß</h2>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="test-room-btn">
                        üéÆ „ÇΩ„É≠„Éó„É¨„Ç§
                    </button>
                    <button class="btn btn-primary" id="create-room-btn">
                        ‚ûï „É´„Éº„É†„Çí‰ΩúÊàê
                    </button>
                </div>
            </div>

            <div class="room-list-header">
                <span class="room-count" id="room-count">0 ÈÉ®Â±ã</span>
                <button class="refresh-btn" id="refresh-btn" title="Êõ¥Êñ∞">üîÑ</button>
            </div>

            <div class="lobby-error" id="lobby-error" style="display:none;">
                <div class="lobby-error-text" id="lobby-error-text">„Éá„Éº„Çø„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ</div>
                <div style="margin-top:0.5rem; display:flex; gap:0.5rem; justify-content:center;">
                    <button class="btn btn-primary" id="lobby-retry-btn">ÂÜçË©¶Ë°å</button>
                    <button class="btn" id="lobby-help-btn">„Éò„É´„Éó</button>
                </div>
            </div>
            <!-- debug panel removed -->
            <div class="room-list" id="room-list">
                <!-- „É´„Éº„É†„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                <div class="empty-state" id="empty-state">
                    <div class="icon">üéØ</div>
                    <p>ÁèæÂú®ÂãüÈõÜ‰∏≠„ÅÆ„É´„Éº„É†„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">Êñ∞„Åó„ÅÑ„É´„Éº„É†„Çí‰ΩúÊàê„Åó„Å¶ÂØæÊà¶Áõ∏Êâã„ÇíÂæÖ„Å°„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                </div>
            </div>
        </div>

        <!-- ÂæÖÊ©üÁîªÈù¢ -->
        <div id="waiting-screen" class="screen">
            <div class="waiting-room-info">
                <div class="waiting-room-name" id="waiting-room-name">„É´„Éº„É†Âêç</div>
                <div class="waiting-status">
                    <span id="waiting-bo">BO5</span> ‚Ä¢ 
                    <span id="waiting-room-id">Room ID: ---</span>
                </div>
                
                <div class="waiting-players">
                    <div class="waiting-player">
                        <div class="player-avatar" id="host-avatar">üëë</div>
                        <div class="player-name" id="host-name">„Éõ„Çπ„Éà</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">„Éõ„Çπ„Éà</div>
                    </div>
                    <div class="waiting-vs">
                        <span>VS</span>
                    </div>
                    <div class="waiting-player">
                        <div class="player-avatar empty" id="guest-avatar">?</div>
                        <div class="player-name" id="guest-name">ÂæÖÊ©ü‰∏≠...</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">„Ç≤„Çπ„Éà</div>
                    </div>
                </div>

                <div class="waiting-spinner" id="waiting-spinner"></div>
                <p id="waiting-message">ÂØæÊà¶Áõ∏Êâã„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...</p>
            </div>

            <button class="btn btn-danger" id="leave-room-btn">üö™ „É´„Éº„É†„ÇíÈÄÄÂá∫</button>
        </div>

        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="game-screen" class="screen">
            <!-- „Çπ„Ç≥„Ç¢„Éò„ÉÉ„ÉÄ„Éº -->
            <div class="game-header">
                <div class="game-player">
                    <div class="game-player-info">
                        <div class="game-player-avatar" id="game-host-avatar">üë§</div>
                        <div class="game-player-name" id="game-host-name">„Éõ„Çπ„Éà</div>
                    </div>
                    <div class="game-score" id="host-score"></div>
                </div>
                <div class="game-vs">VS</div>
                <div class="game-player">
                    <div class="game-player-info">
                        <div class="game-player-name" id="game-guest-name">„Ç≤„Çπ„Éà</div>
                        <div class="game-player-avatar" id="game-guest-avatar">üë§</div>
                    </div>
                    <div class="game-score" id="guest-score"></div>
                </div>
            </div>

            <!-- ÂïèÈ°å„Ç®„É™„Ç¢ -->
            <div class="game-main">
                <div class="round-info">
                    <span class="round-number" id="round-number">Á¨¨1Âïè</span>
                    <span class="difficulty difficulty-3" id="difficulty">Èõ£ÊòìÂ∫¶ ‚òÖ‚òÖ‚òÖ</span>
                </div>

                <div class="problem-display">
                    <div class="problem-digits" id="problem-digits">
                        <div class="digit-card">3</div>
                        <div class="digit-card">3</div>
                        <div class="digit-card">7</div>
                        <div class="digit-card">9</div>
                    </div>

                    <!-- ÊºîÁÆóÂ≠ê„ÉªÊã¨Âºß„Éú„Çø„É≥ÔºàÊï∞Â≠ó„ÅÆ‰∏ãÔºâ -->
                    <div class="operator-row" id="operator-row">
                        <button class="op-btn bracket" data-op="(">(</button>
                        <button class="op-btn" data-op="+">+</button>
                        <button class="op-btn" data-op="-">‚àí</button>
                        <button class="op-btn" data-op="*">√ó</button>
                        <button class="op-btn" data-op="/">√∑</button>
                        <button class="op-btn bracket" data-op=")">)</button>
                    </div>

                    <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ÔºàÊï∞Â≠ó„ÅÆ‰∏ãÔºâ -->
                    <div class="action-row" id="action-row">
                        <button class="action-btn backspace" data-action="backspace">‚å´ Êàª„Åô</button>
                        <button class="action-btn reset" data-action="reset">AC „É™„Çª„ÉÉ„Éà</button>
                    </div>
                </div>

                <div class="timer-container">
                    <div class="timer-bar">
                        <div class="timer-fill" id="timer-fill" style="width: 100%;"></div>
                    </div>
                    <div class="timer-text" id="timer-text">25</div>
                </div>

                <div class="expression-result" id="expression-result">Âºè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                <div class="expression-display" id="expression-display"></div>

                <!-- opponent status removed -->
                <button class="btn btn-danger quit-game-btn" id="quit-game-btn" style="display: none; margin-top: 1rem;">üö™ ÈÄî‰∏≠„Åß„ÇÑ„ÇÅ„Çã</button>
            </div>

        <!-- „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
        <div class="countdown-overlay hidden" id="countdown-overlay">
            <div class="countdown-round" id="countdown-round">Á¨¨1Âïè</div>
            <div class="countdown-number" id="countdown-number">5</div>
        </div>

        <!-- „É©„Ç¶„É≥„ÉâÁµêÊûú„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
        <div class="result-overlay hidden" id="result-overlay">
            <div class="result-title" id="result-title">Ê≠£Ëß£ÔºÅ</div>
            <div class="result-answer">
                <div class="result-answer-label">Á≠î„Åà</div>
                <div class="result-answer-expr" id="result-answer">3 √ó 3 + 7 - 9 = 10</div>
            </div>
        </div>

        <!-- „Éû„ÉÉ„ÉÅÁµêÊûú„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
        <div class="match-result-overlay hidden" id="match-result-overlay">
            <div class="match-result-title" id="match-result-title">üéâ ÂãùÂà©ÔºÅ</div>
            <div class="match-result-players">
                <div class="match-result-player">
                    <div class="match-result-avatar" id="match-host-avatar">üë§</div>
                    <div class="match-result-name" id="match-host-name">„Éõ„Çπ„Éà</div>
                </div>
                <div class="match-result-score" id="match-result-score">3 - 1</div>
                <div class="match-result-player">
                    <div class="match-result-avatar" id="match-guest-avatar">üë§</div>
                    <div class="match-result-name" id="match-guest-name">„Ç≤„Çπ„Éà</div>
                </div>
            </div>
            <button class="btn btn-primary" id="back-to-lobby-btn">„É≠„Éì„Éº„Å´Êàª„Çã</button>
        </div>
    </div>

        <!-- Ê¨°„É©„Ç¶„É≥„ÉâÊ∫ñÂÇôÊ©üÊßãÔºàBO1Âåñ„Å´„Çà„ÇäÂâäÈô§Ôºâ -->

    <!-- „É´„Éº„É†‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="create-room-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>üéÆ „É´„Éº„É†„Çí‰ΩúÊàê</h3>
                <button class="modal-close" id="close-create-modal">&times;</button>
            </div>
            <form id="create-room-form">
                <div class="form-group">
                    <label>„É´„Éº„É†Âêç</label>
                    <input type="text" id="room-name-input" placeholder="„É´„Éº„É†1" maxlength="20">
                </div>
                <div class="form-group">
                    <label>„ÅÇ„Å™„Åü„ÅÆÂêçÂâç</label>
                    <input type="text" id="host-name-input" placeholder="„Éõ„Çπ„Éà" maxlength="10">
                </div>
                <div class="form-group">
                    <label>„Éë„Çπ„ÉØ„Éº„ÉâÔºà‰ªªÊÑèÔºâ</label>
                    <input type="password" id="room-password-input" placeholder="„Å™„Åó„ÅÆÂ†¥Âêà„ÅØÁ©∫Ê¨Ñ">
                </div>
                <!-- ÂØæÊà¶Êú¨Êï∞„ÅØ BO1 Âõ∫ÂÆö„ÅÆ„Åü„ÇÅÂÖ•Âäõ„ÇíÂªÉÊ≠¢ -->
                <div class="form-group">
                    <label>Âá∫È°åÈõ£ÊòìÂ∫¶</label>
                    <select id="room-difficulty-input">
                        <option value="all">„Åô„Åπ„Å¶Ôºà„É©„É≥„ÉÄ„É†Ôºâ</option>
                        <option value="easy" selected>Á∞°ÂçòÔºàËß£„ÅåÂ§ö„ÅÑÂïèÈ°åÔºâ</option>
                        <option value="normal">ÊôÆÈÄö</option>
                        <option value="hard">Èõ£„Åó„ÅÑÔºàËß£„ÅåÂ∞ë„Å™„ÅÑÂïèÈ°åÔºâ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Êã¨Âºß„Çí‰Ωø„ÅÜÂïèÈ°å</label>
                    <select id="room-brackets-input">
                        <option value="no" selected>Âá∫È°å„Åó„Å™„ÅÑ</option>
                        <option value="yes">Âá∫È°å„Åô„Çã</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Âà∂ÈôêÊôÇÈñì</label>
                    <select id="room-timelimit-input">
                        <option value="10">10Áßí</option>
                        <option value="20">20Áßí</option>
                        <option value="30" selected>30Áßí</option>
                        <option value="45">45Áßí</option>
                        <option value="60">60Áßí</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-create-room">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="btn btn-primary">‰ΩúÊàê„Åô„Çã</button>
                </div>
            </form>
        </div>
    </div>

    <!-- „É´„Éº„É†ÂèÇÂä†„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="join-room-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>üöÄ „É´„Éº„É†„Å´ÂèÇÂä†</h3>
                <button class="modal-close" id="close-join-modal">&times;</button>
            </div>
            <form id="join-room-form">
                <div class="form-group">
                    <label>ÂèÇÂä†„Åô„Çã„É´„Éº„É†</label>
                    <input type="text" id="join-room-name" readonly style="background: #222;">
                </div>
                <div class="form-group">
                    <label>„ÅÇ„Å™„Åü„ÅÆÂêçÂâç</label>
                    <input type="text" id="guest-name-input" placeholder="„Ç≤„Çπ„Éà" maxlength="10">
                </div>
                <div class="form-group" id="join-password-group" style="display: none;">
                    <label>„Éë„Çπ„ÉØ„Éº„Éâ <span class="required">*</span></label>
                    <input type="password" id="join-password-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
                </div>
                <input type="hidden" id="join-room-id">
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-join-room">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="btn btn-success">ÂèÇÂä†„Åô„Çã</button>
                </div>
            </form>
        </div>
    </div>

    <!-- „É¶„Éº„Ç∂„ÉºË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="user-settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>üë§ „É¶„Éº„Ç∂„ÉºË®≠ÂÆö</h3>
                <button class="modal-close" id="close-user-settings">&times;</button>
            </div>
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div class="user-avatar-large" id="user-avatar-large">üë§</div>
                <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                <button class="btn btn-secondary" id="upload-avatar-btn" style="margin-top: 1rem;">
                    üì∑ „Ç¢„Ç§„Ç≥„É≥„ÇíÂ§âÊõ¥
                </button>
            </div>
            <div class="form-group">
                <label>Ë°®Á§∫Âêç</label>
                <input type="text" id="display-name-input" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" maxlength="10">
            </div>
            <div id="login-section">
                <p style="color: var(--text-muted); margin-bottom: 1rem; text-align: center;">
                    Google„Åß„É≠„Ç∞„Ç§„É≥„Åô„Çã„Å®„ÄÅÂêçÂâç„Å®„Ç¢„Ç§„Ç≥„É≥„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åô
                </p>
                <button class="btn btn-primary" id="google-login-btn" style="width: 100%;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="width: 20px; height: 20px;">
                    Google„Åß„É≠„Ç∞„Ç§„É≥
                </button>
            </div>
            <div id="logout-section" style="display: none;">
                <p style="color: var(--text-muted); margin-bottom: 1rem; text-align: center;" id="logged-in-email"></p>
                <button class="btn btn-danger" id="logout-btn" style="width: 100%;">
                    „É≠„Ç∞„Ç¢„Ç¶„Éà
                </button>
            </div>
            <div class="form-actions" style="margin-top: 1.5rem;">
                <button class="btn btn-success" id="save-user-settings" style="width: 100%;">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // ========================================
        // Firebase ÂàùÊúüÂåñ
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBM_6leTzC3lKdmO_b4nvb0SgubTSn2rO0",
            authDomain: "make10vs.firebaseapp.com",
            databaseURL: "https://make10vs-default-rtdb.firebaseio.com",
            projectId: "make10vs",
            storageBucket: "make10vs.firebasestorage.app",
            messagingSenderId: "461653417380",
            appId: "1:461653417380:web:d0c64a9c8b0b5498fc7531",
            measurementId: "G-35DCQ7MMMR"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // ========================================
        // „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖã
        // ========================================
        let currentUserId = null;
        let currentUserName = '„Ç≤„Çπ„Éà';
        let currentUserAvatar = null;
        let currentRoomId = null;
        let currentRoomRef = null;
        let roomsListener = null;
        let hostHeartbeatInterval = null;
        let guestHeartbeatInterval = null;
        // room expiry timers: { roomId: timeoutId }
        const roomExpiryTimers = {};

        // ========================================
        // DOMË¶ÅÁ¥†
        // ========================================
        const lobbyScreen = document.getElementById('lobby-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const gameScreen = document.getElementById('game-screen');
        const roomList = document.getElementById('room-list');
        const emptyState = document.getElementById('empty-state');
        const roomCount = document.getElementById('room-count');
        const currentUserNameEl = document.getElementById('current-user-name');

        // „É¢„Éº„ÉÄ„É´
        const createRoomModal = document.getElementById('create-room-modal');
        const joinRoomModal = document.getElementById('join-room-modal');

        // ========================================
        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        // ========================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showModal(modal) {
            modal.classList.add('active');
        }

        function hideModal(modal) {
            modal.classList.remove('active');
        }

        function hashPassword(password) {
            // Á∞°Êòì„Éè„ÉÉ„Ç∑„É•ÔºàÊú¨Áï™„Åß„ÅØ„Çà„ÇäÂÆâÂÖ®„Å™ÊñπÊ≥ï„Çí‰ΩøÁî®Ôºâ
            if (!password) return null;
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        // ========================================
        // „É´„Éº„É†‰∏ÄË¶ß„ÅÆÂèñÂæó„ÉªË°®Á§∫
        // ========================================
        function subscribeToRooms() {
            const roomsRef = database.ref('rooms');
            
            // orderByChild„Çí‰Ωø„Çè„Åö„Å´„Ç∑„É≥„Éó„É´„Å´„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆöÔºàDB„É´„Éº„É´„Å®„ÅÆ‰∫íÊèõÊÄßÂêë‰∏äÔºâ
            roomsListener = roomsRef.on('value', (snapshot) => {
                const allRooms = snapshot.val() || {};
                // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥„Åßopen„Å™„É´„Éº„É†„Çí„Éï„Ç£„É´„Çø„Éº
                const rooms = {};
                Object.entries(allRooms).forEach(([id, room]) => {
                    if (room.meta && room.meta.state === 'open') {
                        rooms[id] = room;
                    }
                });
                renderRoomList(rooms);
            }, (error) => {
                console.error('„É´„Éº„É†ÂèñÂæó„Ç®„É©„Éº:', error);
                // permission_denied „ÅÆ„Çà„ÅÜ„Å™„Ç®„É©„Éº„ÅØ„É¶„Éº„Ç∂„Éº„Å´Ë°®Á§∫„Åó„Å¶ÂÜçË©¶Ë°å„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
                const message = (error && error.code) ? `${error.code}: ${error.message}` : '„É´„Éº„É†ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ';
                showLobbyError('„Éá„Éº„Çø„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ' + message, true);
            });
        }

        function unsubscribeFromRooms() {
            if (roomsListener) {
                database.ref('rooms').off('value', roomsListener);
                roomsListener = null;
            }
        }

        // „É´„Éº„É†Ëá™ÂãïÂâäÈô§Ôºà‰ΩúÊàêÂæå„Å´„Ç≤„Çπ„Éà„ÅåÂÖ•„Çâ„Å™„Åë„Çå„Å∞‰∏ÄÂÆöÊôÇÈñì„ÅßÂâäÈô§Ôºâ
        function scheduleRoomExpiry(roomId, delayMs = 120000) {
            try {
                clearRoomExpiry(roomId);
                roomExpiryTimers[roomId] = setTimeout(async () => {
                    try {
                        const snap = await database.ref(`rooms/${roomId}/meta`).once('value');
                        const meta = snap.val();
                        if (!meta) return; // already removed
                        // „Ç≤„Çπ„Éà„Åå„Åæ„Å†„ÅÑ„Å™„ÅÑ„ÉªÁä∂ÊÖã„Åå open „ÅÆÂ†¥Âêà„ÅØÂâäÈô§
                        if ((!meta.guestId) && meta.state === 'open') {
                            console.log('Room expiry: removing room', roomId);
                            await database.ref(`rooms/${roomId}`).remove();
                        }
                    } catch (err) {
                        console.warn('room expiry check failed for', roomId, err);
                    } finally {
                        clearRoomExpiry(roomId);
                    }
                }, delayMs);
            } catch (err) {
                console.warn('scheduleRoomExpiry failed:', err);
            }
        }

        function clearRoomExpiry(roomId) {
            try {
                const t = roomExpiryTimers[roomId];
                if (t) {
                    clearTimeout(t);
                    delete roomExpiryTimers[roomId];
                }
            } catch (err) {
                console.warn('clearRoomExpiry failed:', err);
            }
        }

        // „É≠„Éì„ÉºÁî®„Ç®„É©„Éº„Éê„Éä„ÉºË°®Á§∫/ÈùûË°®Á§∫
        function showLobbyError(msg, canRetry = false) {
            const el = document.getElementById('lobby-error');
            const txt = document.getElementById('lobby-error-text');
            if (!el || !txt) return;
            txt.textContent = msg;
            el.style.display = 'block';
            const retryBtn = document.getElementById('lobby-retry-btn');
            if (retryBtn) retryBtn.style.display = canRetry ? 'inline-block' : 'none';
        }

        function hideLobbyError() {
            const el = document.getElementById('lobby-error');
            if (!el) return;
            el.style.display = 'none';
        }

        // Ë™çË®º„ÇíË©¶Ë°å„Åó„Å¶„Åã„ÇâÂÜç„Çµ„Éñ„Çπ„ÇØ„É©„Ç§„Éñ„Åô„ÇãÔºàÂÜçË©¶Ë°å„Éú„Çø„É≥Áî®Ôºâ
        async function attemptAuthAndSubscribe() {
            hideLobbyError();
            try {
                if (!auth.currentUser) {
                    await auth.signInAnonymously();
                    console.log('ÂÜçË©¶Ë°å: ÂåøÂêç„Çµ„Ç§„É≥„Ç§„É≥ÊàêÂäü');
                }
            } catch (e) {
                console.error('ÂÜçË©¶Ë°å„Çµ„Ç§„É≥„Ç§„É≥Â§±Êïó:', e);
                showLobbyError('Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (e && e.message ? e.message : e), true);
                return;
            }

            try {
                // Êó¢Â≠ò„É™„Çπ„Éä„Éº„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÜçË®≠ÂÆö
                unsubscribeFromRooms();
                subscribeToRooms();
            } catch (e) {
                console.error('ÂÜçË©¶Ë°å„Åß„É´„Éº„É†ÂèñÂæóÂ§±Êïó:', e);
                showLobbyError('„É´„Éº„É†ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (e && e.message ? e.message : e), true);
            }
        }

        function renderRoomList(rooms) {
            const roomEntries = Object.entries(rooms).filter(([id, room]) => {
                return room.meta && room.meta.state === 'open';
            });

            roomCount.textContent = `${roomEntries.length} ÈÉ®Â±ã`;

            if (roomEntries.length === 0) {
                emptyState.style.display = 'block';
                // Êó¢Â≠ò„ÅÆ„É´„Éº„É†„Ç´„Éº„Éâ„ÇíÂâäÈô§
                document.querySelectorAll('.room-card').forEach(card => card.remove());
                return;
            }

            emptyState.style.display = 'none';

            // Êó¢Â≠ò„ÅÆ„É´„Éº„É†„Ç´„Éº„Éâ„ÇíÂâäÈô§
            document.querySelectorAll('.room-card').forEach(card => card.remove());

            // „É´„Éº„É†„Ç´„Éº„Éâ„ÇíËøΩÂä†
            roomEntries.forEach(([roomId, room]) => {
                const meta = room.meta;
                const hasPassword = !!meta.passwordHash;
                const playerCount = meta.guestId ? 2 : 1;

                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-info">
                        <div class="room-avatar" data-host-id="${meta.hostId || ''}">üëë</div>
                        <div>
                            <div class="room-name">
                                ${hasPassword ? '<span class="lock-icon">üîí</span>' : ''}
                                ${escapeHtml(meta.roomName)}
                            </div>
                            <div class="room-meta">
                                <span class="host-name">üë§ ${escapeHtml(meta.hostName || '„Éõ„Çπ„Éà')}</span>
                                <span>üéØ BO${meta.bo || 5}</span>
                            </div>
                        </div>
                    </div>
                    <div class="room-players">
                        <span class="player-count ${playerCount >= 2 ? 'full' : ''}">${playerCount}/2</span>
                        <button class="btn btn-success join-room-btn" data-room-id="${roomId}" ${playerCount >= 2 ? 'disabled' : ''}>
                            ÂèÇÂä†
                        </button>
                    </div>
                `;

                // „É°„Çø„Éá„Éº„Çø„Çí„Éá„Éº„ÇøÂ±ûÊÄß„Å´‰øùÂ≠ò
                card.dataset.roomId = roomId;
                card.dataset.roomMeta = JSON.stringify(meta);

                roomList.insertBefore(card, emptyState);

                // „Éõ„Çπ„Éà„ÅÆ„Ç¢„Éê„Çø„Éº„ÇíÂèñÂæó„Åó„Å¶Â∑Æ„ÅóÊõø„ÅàÔºàÈùûÂêåÊúüÔºâ
                if (meta.hostId) {
                    database.ref(`users/${meta.hostId}`).once('value').then((ps) => {
                        const p = ps.val();
                        const avatarEl = card.querySelector('.room-avatar');
                        if (p && p.avatar) {
                            avatarEl.innerHTML = `<img src="${p.avatar}" alt="host">`;
                        } else {
                            avatarEl.textContent = 'üëë';
                        }
                    }).catch((err) => {
                        console.warn('„É´„Éº„É†‰∏ÄË¶ß„Ç¢„Éê„Çø„ÉºÂèñÂæóÂ§±Êïó:', err);
                    });
                }
            });
        }

        // „Ç§„Éô„É≥„ÉàÂßî‰ªª„ÅßÂèÇÂä†„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÇíÂá¶ÁêÜ
        roomList.addEventListener('click', (e) => {
            const joinBtn = e.target.closest('.join-room-btn');
            if (joinBtn && !joinBtn.disabled) {
                const card = joinBtn.closest('.room-card');
                if (card && card.dataset.roomId && card.dataset.roomMeta) {
                    const roomId = card.dataset.roomId;
                    const meta = JSON.parse(card.dataset.roomMeta);
                    openJoinModal(roomId, meta);
                }
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // „É´„Éº„É†‰ΩúÊàê
        // ========================================
        document.getElementById('create-room-btn').addEventListener('click', () => {
            // „É´„Éº„É†‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÂâç„Å´„ÄÅ„É¶„Éº„Ç∂„Éº„ÅÆË°®Á§∫Âêç„Åå„ÅÇ„Çå„Å∞„Éõ„Çπ„ÉàÂêçÂÖ•Âäõ„Å´„Çª„ÉÉ„Éà„Åô„Çã
            try {
                const hostInput = document.getElementById('host-name-input');
                if (hostInput) {
                    hostInput.value = currentUserName && currentUserName !== '„Ç≤„Çπ„Éà' ? currentUserName : '';
                }
            } catch (e) {
                console.warn('host name prefill failed', e);
            }
            showModal(createRoomModal);
        });

        document.getElementById('close-create-modal').addEventListener('click', () => {
            hideModal(createRoomModal);
        });

        document.getElementById('cancel-create-room').addEventListener('click', () => {
            hideModal(createRoomModal);
        });

        document.getElementById('create-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const roomName = document.getElementById('room-name-input').value.trim() || '„É´„Éº„É†1';
            const hostName = document.getElementById('host-name-input').value.trim() || '„Éõ„Çπ„Éà';
            const password = document.getElementById('room-password-input').value;
            // BO1 Âõ∫ÂÆö
            const bo = 1;
            const difficulty = document.getElementById('room-difficulty-input').value;
            const allowBrackets = document.getElementById('room-brackets-input').value === 'yes';
            const timeLimit = parseInt(document.getElementById('room-timelimit-input').value) || 30;

            try {
                const newRoomRef = database.ref('rooms').push();
                const roomId = newRoomRef.key;

                await newRoomRef.set({
                    meta: {
                        roomName: roomName,
                        hostId: currentUserId,
                        hostName: hostName,
                        guestId: null,
                        guestName: null,
                        passwordHash: hashPassword(password),
                        bo: bo,
                        difficulty: difficulty,
                        allowBrackets: allowBrackets,
                        timeLimit: timeLimit,
                        state: 'open',
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    }
                });

                // „Éõ„Çπ„Éà„ÅåÂàáÊñ≠„Åó„Åü„Çâ„É´„Éº„É†„ÇíÂâäÈô§„Åô„ÇãÔºàonDisconnectÔºâ
                try {
                    await newRoomRef.child('meta').onDisconnect().remove();
                } catch (err) {
                    console.warn('onDisconnect remove Ë®≠ÂÆöÂ§±Êïó:', err);
                }

                // „Éõ„Çπ„Éà„ÅÆ„Éè„Éº„Éà„Éì„Éº„ÉàÔºàlastSeenÔºâ„ÇíË®≠ÂÆö
                try {
                    await newRoomRef.child('meta').update({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                    if (hostHeartbeatInterval) clearInterval(hostHeartbeatInterval);
                    hostHeartbeatInterval = setInterval(() => {
                        database.ref(`rooms/${roomId}/meta`).update({ lastSeen: firebase.database.ServerValue.TIMESTAMP }).catch(e => console.warn('heartbeat error', e));
                    }, 30000);
                } catch (err) {
                    console.warn('„Éõ„Çπ„Éà„Éè„Éº„Éà„Éì„Éº„ÉàÂàùÊúüÂåñÂ§±Êïó:', err);
                }

                currentUserName = hostName;
                currentUserNameEl.textContent = hostName;
                currentRoomId = roomId;

                // ÈÉ®Â±ã„Åå120ÁßíÈñì„Ç≤„Çπ„Éà„ÇíÂæÖ„Å¶„Å™„Åã„Å£„Åü„ÇâËá™ÂãïÂâäÈô§
                try {
                    scheduleRoomExpiry(roomId, 120000);
                } catch (err) {
                    console.warn('scheduleRoomExpiry error:', err);
                }

                hideModal(createRoomModal);
                document.getElementById('create-room-form').reset();

                enterWaitingRoom(roomId, roomName, hostName, null, bo, true);

            } catch (error) {
                console.error('„É´„Éº„É†‰ΩúÊàê„Ç®„É©„Éº:', error);
                alert('„É´„Éº„É†„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        });

        // ========================================
        // „É´„Éº„É†ÂèÇÂä†
        // ========================================
        function openJoinModal(roomId, meta) {
            document.getElementById('join-room-name').value = meta.roomName;
            document.getElementById('join-room-id').value = roomId;
            document.getElementById('guest-name-input').value = currentUserName && currentUserName !== '„Ç≤„Çπ„Éà' ? currentUserName : '';
            
            const passwordGroup = document.getElementById('join-password-group');
            if (meta.passwordHash) {
                passwordGroup.style.display = 'block';
                document.getElementById('join-password-input').required = true;
            } else {
                passwordGroup.style.display = 'none';
                document.getElementById('join-password-input').required = false;
            }

            showModal(joinRoomModal);
        }

        document.getElementById('close-join-modal').addEventListener('click', () => {
            hideModal(joinRoomModal);
        });

        document.getElementById('cancel-join-room').addEventListener('click', () => {
            hideModal(joinRoomModal);
        });

        document.getElementById('join-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const roomId = document.getElementById('join-room-id').value;
            const guestName = document.getElementById('guest-name-input').value.trim() || '„Ç≤„Çπ„Éà';
            const password = document.getElementById('join-password-input').value;

            try {
                const roomRef = database.ref(`rooms/${roomId}`);
                const snapshot = await roomRef.once('value');
                const room = snapshot.val();

                if (!room || room.meta.state !== 'open') {
                    alert('„Åì„ÅÆ„É´„Éº„É†„ÅØÊó¢„Å´ÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅÂ≠òÂú®„Åó„Åæ„Åõ„Çì');
                    hideModal(joinRoomModal);
                    return;
                }

                if (room.meta.guestId) {
                    alert('„Åì„ÅÆ„É´„Éº„É†„ÅØÊó¢„Å´Ê∫ÄÂì°„Åß„Åô');
                    hideModal(joinRoomModal);
                    return;
                }

                // „Éë„Çπ„ÉØ„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
                if (room.meta.passwordHash && hashPassword(password) !== room.meta.passwordHash) {
                    alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }

                // „Ç≤„Çπ„Éà„Å®„Åó„Å¶ÂèÇÂä†
                await roomRef.child('meta').update({
                    guestId: currentUserId,
                    guestName: guestName
                });

                // ÂèÇÂä†„Åó„Åü„ÅÆ„Åß„É´„Éº„É†Ëá™ÂãïÂâäÈô§„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢ÔºàÂÆâÂÖ®ÂÅ¥Ôºâ
                try {
                    clearRoomExpiry(roomId);
                } catch (err) {
                    console.warn('clearRoomExpiry error (guest join):', err);
                }

                // „Ç≤„Çπ„Éà„ÅåÂàáÊñ≠„Åó„Åü„Çâ guest ÊÉÖÂ†±„Å®Ê∫ñÂÇô„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢„Åô„Çã
                try {
                    await roomRef.child('meta').onDisconnect().update({ guestId: null, guestName: null, state: 'open', guestReadyForStart: null });
                } catch (err) {
                    console.warn('„Ç≤„Çπ„Éà onDisconnect Ë®≠ÂÆöÂ§±Êïó:', err);
                }

                // „Ç≤„Çπ„Éà„ÅÆ„Éè„Éº„Éà„Éì„Éº„ÉàÔºàguestLastSeenÔºâ„ÇíË®≠ÂÆö
                try {
                    await roomRef.child('meta').update({ guestLastSeen: firebase.database.ServerValue.TIMESTAMP });
                    if (guestHeartbeatInterval) clearInterval(guestHeartbeatInterval);
                    guestHeartbeatInterval = setInterval(() => {
                        database.ref(`rooms/${roomId}/meta`).update({ guestLastSeen: firebase.database.ServerValue.TIMESTAMP }).catch(e => console.warn('guest heartbeat error', e));
                    }, 30000);
                } catch (err) {
                    console.warn('„Ç≤„Çπ„Éà„Éè„Éº„Éà„Éì„Éº„ÉàÂàùÊúüÂåñÂ§±Êïó:', err);
                }

                currentUserName = guestName;
                currentUserNameEl.textContent = guestName;
                currentRoomId = roomId;

                hideModal(joinRoomModal);
                document.getElementById('join-room-form').reset();

                enterWaitingRoom(roomId, room.meta.roomName, room.meta.hostName, guestName, room.meta.bo, false);

            } catch (error) {
                console.error('„É´„Éº„É†ÂèÇÂä†„Ç®„É©„Éº:', error);
                alert('„É´„Éº„É†„Å∏„ÅÆÂèÇÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        });

        // ========================================
        // ÂæÖÊ©üÁîªÈù¢
        // ========================================
        function enterWaitingRoom(roomId, roomName, hostName, guestName, bo, isHost) {
            showScreen('waiting-screen');

            document.getElementById('waiting-room-name').textContent = roomName;
            document.getElementById('waiting-bo').textContent = `BO${bo}`;
            document.getElementById('waiting-room-id').textContent = `Room ID: ${roomId.slice(-6)}`;
            document.getElementById('host-name').textContent = hostName;

            if (guestName) {
                document.getElementById('guest-name').textContent = guestName;
                document.getElementById('guest-avatar').textContent = 'üéÆ';
                document.getElementById('guest-avatar').classList.remove('empty');
            } else {
                document.getElementById('guest-name').textContent = 'ÂæÖÊ©ü‰∏≠...';
                document.getElementById('guest-avatar').textContent = '?';
                document.getElementById('guest-avatar').classList.add('empty');
            }

            // „É´„Éº„É†„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
            currentRoomRef = database.ref(`rooms/${roomId}/meta`);
            // ÂàùÂõûÂèñÂæó„Åß„Éõ„Çπ„Éà/„Ç≤„Çπ„Éà„ÅÆ„Ç¢„Éê„Çø„Éº„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
            database.ref(`rooms/${roomId}/meta`).once('value').then((snap) => {
                const initialMeta = snap.val();
                if (initialMeta && initialMeta.hostId) {
                    database.ref(`users/${initialMeta.hostId}`).once('value').then((ps) => {
                        const p = ps.val();
                        if (p && p.avatar) {
                            const el = document.getElementById('host-avatar');
                            el.innerHTML = `<img src="${p.avatar}" alt="host">`;
                        }
                    }).catch((err) => console.warn('„Éõ„Çπ„Éà„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæóÂ§±Êïó:', err));
                }
                if (initialMeta && initialMeta.guestId) {
                    database.ref(`users/${initialMeta.guestId}`).once('value').then((ps) => {
                        const p = ps.val();
                        if (p && p.avatar) {
                            const el = document.getElementById('guest-avatar');
                            el.innerHTML = `<img src="${p.avatar}" alt="guest">`;
                            el.classList.remove('empty');
                        }
                    }).catch((err) => console.warn('„Ç≤„Çπ„Éà„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæóÂ§±Êïó:', err));
                }
            }).catch((err) => console.warn('ÂàùÂõû„É´„Éº„É†„É°„ÇøÂèñÂæóÂ§±Êïó:', err));

            currentRoomRef.on('value', async (snapshot) => {
                const meta = snapshot.val();
                console.log('rooms/' + roomId + '/meta changed:', meta);
                if (!meta) {
                    // „É´„Éº„É†„ÅåÂâäÈô§„Åï„Çå„Åü
                    alert('„É´„Éº„É†„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü');
                    leaveRoom();
                    return;
                }

                // „Ç≤„Çπ„Éà„ÅåÂèÇÂä†„Åó„Åü
                    if (meta.guestId && meta.guestName) {
                    document.getElementById('guest-name').textContent = meta.guestName;
                    document.getElementById('guest-avatar').classList.remove('empty');
                    // „Ç≤„Çπ„Éà„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíDB„Åã„ÇâÂèñÂæó„Åó„ÄÅ„Ç¢„Éê„Çø„Éº„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
                    database.ref(`users/${meta.guestId}`).once('value').then((ps) => {
                        const p = ps.val();
                        if (p && p.avatar) {
                            document.getElementById('guest-avatar').innerHTML = `<img src="${p.avatar}" alt="guest">`;
                        } else {
                            document.getElementById('guest-avatar').textContent = 'üéÆ';
                        }
                    }).catch((err) => {
                        console.warn('„Ç≤„Çπ„Éà„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæóÂ§±Êïó:', err);
                        document.getElementById('guest-avatar').textContent = 'üéÆ';
                    });
                    document.getElementById('waiting-message').textContent = 'ÂØæÊà¶Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ„Åæ„ÇÇ„Å™„ÅèÈñãÂßã„Åó„Åæ„Åô...';

                    // 2‰∫∫ÊèÉ„Å£„Åü„ÇâË©¶ÂêàÈñãÂßãÔºà„Éõ„Çπ„ÉàÂÅ¥„ÅßÈñãÂßãÂá¶ÁêÜÔºâ
                    // „ÇØ„É™„Ç¢: „Ç≤„Çπ„Éà„ÅåÊèÉ„Å£„Åü„ÅÆ„ÅßËá™ÂãïÂâäÈô§„Çø„Ç§„Éû„Éº„ÇíËß£Èô§
                    try { if (isHost) clearRoomExpiry(roomId); } catch(e){console.warn('clear expiry on guest join failed',e)}

                    // „Éõ„Çπ„ÉàÂÅ¥„ÅØ„ÄÅ„Ç≤„Çπ„Éà„ÅåÂæÖÊ©üÁîªÈù¢„Å´Âà∞ÈÅî„Åó„Åü„Åì„Å®„ÇíÁ§∫„Åô„Éï„É©„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åã„ÇâÈñãÂßã„Åô„Çã
                    if (isHost && meta.state === 'open') {
                        if (meta.guestReadyForStart) {
                            console.log('Host: guestReadyForStart detected, starting match countdown');
                            startMatchCountdown(roomId);
                        } else {
                            console.log('Host: guest present but not yet ready; waiting for guestReadyForStart');
                        }
                    }
                }

            // „Ç≤„Çπ„ÉàÂÅ¥„ÅØÂæÖÊ©üÁîªÈù¢„Å´ÂÖ•„Å£„Åü„Çâ "guestReadyForStart" „Çí„Çª„ÉÉ„Éà„Åó„Å¶„Éõ„Çπ„Éà„Å∏ÈÄöÁü•„Åô„Çã
            if (!isHost) {
                try {
                    database.ref(`rooms/${roomId}/meta`).update({ guestReadyForStart: true }).catch(e => console.warn('set guestReadyForStart failed', e));
                } catch (e) {
                    console.warn('guest set ready flag failed', e);
                }
            }

                // Ë©¶ÂêàÈñãÂßãÁä∂ÊÖã„Å´„Å™„Å£„Åü
                if (meta.state === 'playing') {
                    console.log('Detected meta.state=playing for room', roomId);
                    // „Ç≤„Éº„É†ÁîªÈù¢„Å∏ÈÅ∑Áßª
                    document.getElementById('waiting-message').textContent = 'Ë©¶ÂêàÈñãÂßãÔºÅ';
                    document.getElementById('waiting-spinner').style.display = 'none';

                    // „É≠„Éì„Éº‰∏ÄË¶ß„ÅÆÁõ£Ë¶ñ„ÇíÊ≠¢„ÇÅ„ÄÅÁèæÂú®„ÅÆ„É´„Éº„É†ID„ÇíË®≠ÂÆö
                    try {
                        unsubscribeFromRooms();
                    } catch (e) {
                        console.warn('unsubscribe error', e);
                    }

                    currentRoomId = roomId;
                    gameState.isTestMode = false;
                    gameState.isHost = isHost;
                    // BO1 Âõ∫ÂÆö
                    gameState.bo = 1;
                    gameState.round = 1;
                    gameState.hostScore = 0;
                    gameState.guestScore = 0;
                    gameState.hostName = meta.hostName || '„Éõ„Çπ„Éà';
                    gameState.guestName = meta.guestName || '„Ç≤„Çπ„Éà';
                    gameState.hostAvatar = null;
                    gameState.guestAvatar = null;
                    
                    // „É´„Éº„É†Ë®≠ÂÆö„ÇíÂèçÊò†
                    gameState.difficulty = meta.difficulty || 'easy';
                    gameState.allowBrackets = meta.allowBrackets === true;
                    gameState.timeLimit = meta.timeLimit || 30;

                    // „Éõ„Çπ„Éà„Éª„Ç≤„Çπ„Éà„ÅÆ„Ç¢„Éê„Çø„Éº„ÇíDB„Åã„ÇâÂèñÂæó
                    const fetchAvatars = async () => {
                        try {
                            if (meta.hostId) {
                                const hostProfile = await database.ref(`users/${meta.hostId}`).once('value');
                                const hp = hostProfile.val();
                                if (hp && hp.avatar) gameState.hostAvatar = hp.avatar;
                            }
                            if (meta.guestId) {
                                const guestProfile = await database.ref(`users/${meta.guestId}`).once('value');
                                const gp = guestProfile.val();
                                if (gp && gp.avatar) gameState.guestAvatar = gp.avatar;
                            }
                        } catch (err) {
                            console.warn('„Ç¢„Éê„Çø„ÉºÂèñÂæóÂ§±Êïó:', err);
                        }
                    };
                    await fetchAvatars();

                    // UIÂèçÊò†„Åó„Å¶„Ç≤„Éº„É†ÈñãÂßãÔºàÊó¢„Å´„Ç≤„Éº„É†ÁîªÈù¢„Å™„ÇâÈáçË§áÂëº„Å≥Âá∫„Åó„Åó„Å™„ÅÑÔºâ
                    currentUserNameEl.textContent = currentUserName;
                    if (!document.getElementById('game-screen').classList.contains('active')) {
                        console.log('Starting game UI for guest/host');
                        startGame();
                    } else {
                        console.log('Game already active, skipping startGame()');
                    }
                }
            });
        }

        async function startMatchCountdown(roomId) {
            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâË©¶ÂêàÁä∂ÊÖã„Å´ÁßªË°å
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await database.ref(`rooms/${roomId}/meta`).update({
                state: 'playing'
            });
        }

        // ========================================
        // „É´„Éº„É†ÈÄÄÂá∫
        // ========================================
        document.getElementById('leave-room-btn').addEventListener('click', () => {
            if (confirm('Êú¨ÂΩì„Å´„É´„Éº„É†„ÇíÈÄÄÂá∫„Åó„Åæ„Åô„ÅãÔºü')) {
                leaveRoom();
            }
        });

        async function leaveRoom() {
            // ÂÖ®„Å¶„ÅÆ„É™„Çπ„Éä„Éº„ÇíÂÅúÊ≠¢
            if (currentRoomRef) {
                currentRoomRef.off();
            }
            stopMetaListener();
            stopOpponentExpressionListener();
            stopRoundResultListener();
            stopReadyListener();
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }

            if (currentRoomId) {
                try {
                    const roomRef = database.ref(`rooms/${currentRoomId}/meta`);
                    const snapshot = await roomRef.once('value');
                    const meta = snapshot.val();

                    if (meta) {
                        if (meta.hostId === currentUserId) {
                            // „Éõ„Çπ„Éà„ÅåÈÄÄÂá∫ ‚Üí „É´„Éº„É†ÂâäÈô§
                                await database.ref(`rooms/${currentRoomId}`).remove();
                                if (hostHeartbeatInterval) { clearInterval(hostHeartbeatInterval); hostHeartbeatInterval = null; }
                                try { clearRoomExpiry(currentRoomId); } catch(e){console.warn('clear expiry on host leave', e);}
                        } else if (meta.guestId === currentUserId) {
                            // „Ç≤„Çπ„Éà„ÅåÈÄÄÂá∫
                                await roomRef.update({
                                    guestId: null,
                                    guestName: null,
                                    state: 'open'
                                });
                                if (guestHeartbeatInterval) { clearInterval(guestHeartbeatInterval); guestHeartbeatInterval = null; }
                                try { scheduleRoomExpiry(currentRoomId, 120000); } catch(e){console.warn('reschedule expiry on guest leave', e);}
                        }
                    }
                } catch (error) {
                    console.error('ÈÄÄÂá∫„Ç®„É©„Éº:', error);
                }
            }

            currentRoomId = null;
            currentRoomRef = null;
            showScreen('lobby-screen');
        }

        // ========================================
        // Êõ¥Êñ∞„Éú„Çø„É≥
        // ========================================
        document.getElementById('refresh-btn').addEventListener('click', () => {
            const btn = document.getElementById('refresh-btn');
            btn.style.transform = 'rotate(360deg)';
            setTimeout(() => btn.style.transform = '', 500);
        });

        // ========================================
        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        // ========================================
        createRoomModal.addEventListener('click', (e) => {
            if (e.target === createRoomModal) hideModal(createRoomModal);
        });

        joinRoomModal.addEventListener('click', (e) => {
            if (e.target === joinRoomModal) hideModal(joinRoomModal);
        });

        // ========================================
        // „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ
        // ========================================
        let gameState = {
            isTestMode: false,
            isHost: false,
            bo: 5,
            round: 1,
            hostScore: 0,
            guestScore: 0,
            hostName: '„Éõ„Çπ„Éà',
            guestName: '„Ç≤„Çπ„Éà',
            hostAvatar: null,
            guestAvatar: null,
            digits: [],
            usedDigits: [],
            expression: '',
            timeLeft: 25,
            timerInterval: null,
            submitted: false,
            resultShown: false, // ÁµêÊûúË°®Á§∫Ê∏à„Åø„Éï„É©„Ç∞ÔºàÈáçË§áÈò≤Ê≠¢Ôºâ
            solutions: [],
            roundStartTime: null,
            // „É´„Éº„É†Ë®≠ÂÆö
            difficulty: 'easy',
            allowBrackets: false,
            timeLimit: 30
        };

        // 10„Çí‰Ωú„Çå„ÇãÁµÑ„ÅøÂêà„Çè„Åõ„Çí‰∫ãÂâçË®àÁÆó„Åô„Çã„Åü„ÇÅ„ÅÆÈñ¢Êï∞
        function generateValidProblems() {
            const validProblems = [];
            for (let a = 1; a <= 9; a++) {
                for (let b = 1; b <= 9; b++) {
                    for (let c = 1; c <= 9; c++) {
                        for (let d = 1; d <= 9; d++) {
                            const digits = [a, b, c, d];
                            const solutions = findSolutions(digits);
                            if (solutions.length > 0) {
                                validProblems.push({ digits, solutions });
                            }
                        }
                    }
                }
            }
            return validProblems;
        }

        // 4„Å§„ÅÆÊï∞Â≠ó„Åã„Çâ10„Çí‰Ωú„ÇãÂÖ®„Å¶„ÅÆÂºè„ÇíÊé¢„ÅôÔºàÊã¨Âºß„ÅÇ„Çä„Éª„Å™„Åó‰∏°ÊñπÂØæÂøúÔºâ
        function findSolutions(digits, includeBrackets = true) {
            const solutions = [];
            const ops = ['+', '-', '*', '/'];
            const perms = permutations(digits);

            for (const perm of perms) {
                const [a, b, c, d] = perm;
                for (const op1 of ops) {
                    for (const op2 of ops) {
                        for (const op3 of ops) {
                            // Êã¨Âºß„Å™„Åó: a op1 b op2 c op3 d
                            const expr = `${a}${op1}${b}${op2}${c}${op3}${d}`;
                            if (safeEval(expr) === 10) {
                                solutions.push({ expr: formatExpr(a, op1, b, op2, c, op3, d), hasBrackets: false });
                            }

                            if (includeBrackets) {
                                // Êã¨Âºß„Éë„Çø„Éº„É≥1: (a op1 b) op2 c op3 d
                                const expr1 = `(${a}${op1}${b})${op2}${c}${op3}${d}`;
                                if (safeEval(expr1) === 10) {
                                    solutions.push({ expr: `(${a}${formatOp(op1)}${b})${formatOp(op2)}${c}${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // Êã¨Âºß„Éë„Çø„Éº„É≥2: a op1 (b op2 c) op3 d
                                const expr2 = `${a}${op1}(${b}${op2}${c})${op3}${d}`;
                                if (safeEval(expr2) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}(${b}${formatOp(op2)}${c})${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // Êã¨Âºß„Éë„Çø„Éº„É≥3: a op1 b op2 (c op3 d)
                                const expr3 = `${a}${op1}${b}${op2}(${c}${op3}${d})`;
                                if (safeEval(expr3) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}${b}${formatOp(op2)}(${c}${formatOp(op3)}${d})`, hasBrackets: true });
                                }

                                // Êã¨Âºß„Éë„Çø„Éº„É≥4: (a op1 b op2 c) op3 d
                                const expr4 = `(${a}${op1}${b}${op2}${c})${op3}${d}`;
                                if (safeEval(expr4) === 10) {
                                    solutions.push({ expr: `(${a}${formatOp(op1)}${b}${formatOp(op2)}${c})${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // Êã¨Âºß„Éë„Çø„Éº„É≥5: a op1 (b op2 c op3 d)
                                const expr5 = `${a}${op1}(${b}${op2}${c}${op3}${d})`;
                                if (safeEval(expr5) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}(${b}${formatOp(op2)}${c}${formatOp(op3)}${d})`, hasBrackets: true });
                                }

                                // Êã¨Âºß„Éë„Çø„Éº„É≥6: (a op1 b) op2 (c op3 d)
                                const expr6 = `(${a}${op1}${b})${op2}(${c}${op3}${d})`;
                                if (safeEval(expr6) === 10) {
                                    solutions.push({ expr: `(${a}${formatOp(op1)}${b})${formatOp(op2)}(${c}${formatOp(op3)}${d})`, hasBrackets: true });
                                }

                                // Êã¨Âºß„Éë„Çø„Éº„É≥7: ((a op1 b) op2 c) op3 d
                                const expr7 = `((${a}${op1}${b})${op2}${c})${op3}${d}`;
                                if (safeEval(expr7) === 10) {
                                    solutions.push({ expr: `((${a}${formatOp(op1)}${b})${formatOp(op2)}${c})${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // Êã¨Âºß„Éë„Çø„Éº„É≥8: (a op1 (b op2 c)) op3 d
                                const expr8 = `(${a}${op1}(${b}${op2}${c}))${op3}${d}`;
                                if (safeEval(expr8) === 10) {
                                    solutions.push({ expr: `(${a}${formatOp(op1)}(${b}${formatOp(op2)}${c}))${formatOp(op3)}${d}`, hasBrackets: true });
                                }

                                // Êã¨Âºß„Éë„Çø„Éº„É≥9: a op1 ((b op2 c) op3 d)
                                const expr9 = `${a}${op1}((${b}${op2}${c})${op3}${d})`;
                                if (safeEval(expr9) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}((${b}${formatOp(op2)}${c})${formatOp(op3)}${d})`, hasBrackets: true });
                                }

                                // Êã¨Âºß„Éë„Çø„Éº„É≥10: a op1 (b op2 (c op3 d))
                                const expr10 = `${a}${op1}(${b}${op2}(${c}${op3}${d}))`;
                                if (safeEval(expr10) === 10) {
                                    solutions.push({ expr: `${a}${formatOp(op1)}(${b}${formatOp(op2)}(${c}${formatOp(op3)}${d}))`, hasBrackets: true });
                                }
                            }
                        }
                    }
                }
            }
            // ÈáçË§á„ÇíÈô§Âéª„Åó„Å¶ÊñáÂ≠óÂàóÈÖçÂàó„ÇíËøî„Åô
            const uniqueExprs = [...new Set(solutions.map(s => s.expr))];
            return uniqueExprs;
        }

        function formatOp(op) {
            const opMap = {'+': ' + ', '-': ' - ', '*': ' √ó ', '/': ' √∑ '};
            return opMap[op] || op;
        }

        function formatExpr(a, op1, b, op2, c, op3, d) {
            return `${a}${formatOp(op1)}${b}${formatOp(op2)}${c}${formatOp(op3)}${d}`;
        }

        function permutations(arr) {
            if (arr.length <= 1) return [arr];
            const result = [];
            for (let i = 0; i < arr.length; i++) {
                const rest = [...arr.slice(0, i), ...arr.slice(i + 1)];
                for (const perm of permutations(rest)) {
                    result.push([arr[i], ...perm]);
                }
            }
            return result;
        }

        function safeEval(expr) {
            try {
                const result = Function('"use strict"; return (' + expr + ')')();
                return Math.abs(result - 10) < 0.0001 ? 10 : result;
            } catch {
                return null;
            }
        }

        // Èõ£ÊòìÂ∫¶„ÇíË®àÁÆóÔºàÊã¨Âºß„Å™„ÅóÁî®Ôºâ
        // Èõ£ÊòìÂ∫¶1: Ëß£„ÅåÂ§ö„ÅÑÔºà10ÂÄã‰ª•‰∏äÔºâ
        // Èõ£ÊòìÂ∫¶2: Ëß£„Åå„Åù„Åì„Åù„ÅìÔºà5-9ÂÄãÔºâ
        // Èõ£ÊòìÂ∫¶3: Ëß£„ÅåÂ∞ë„Å™„ÇÅÔºà2-4ÂÄãÔºâ
        // Èõ£ÊòìÂ∫¶4: Ëß£„Åå1„Å§„Å†„Åë
        // Èõ£ÊòìÂ∫¶5: Èô§ÁÆó„ÇíÂê´„ÅøËß£„Åå1„Å§„Å†„Åë„ÄÅ„Åæ„Åü„ÅØÊã¨ÂºßÂøÖÈ†à
        function calculateDifficulty(solutions) {
            if (solutions.length === 0) return 5;
            
            const exprs = solutions.map(s => typeof s === 'string' ? s : s.expr);
            const hasDivide = exprs.some(s => s.includes('√∑'));
            const onlyBrackets = solutions.every(s => typeof s === 'object' && s.hasBrackets);
            
            if (onlyBrackets) return 5; // Êã¨ÂºßÂøÖÈ†à„ÅØÊúÄÈ´òÈõ£ÊòìÂ∫¶
            if (solutions.length >= 10) return 1;
            if (solutions.length >= 5) return 2;
            if (solutions.length >= 2) return 3;
            // Ëß£„Åå1„Å§„Å†„Åë
            if (hasDivide) return 5;
            return 4;
        }

        // ÂïèÈ°å„ÇíÁîüÊàêÔºàË®≠ÂÆö„Å´Âøú„Åò„Å¶Èõ£ÊòìÂ∫¶„ÉªÊã¨Âºß„ÇíÂà∂Âæ°Ôºâ
        function generateProblem() {
            const includeBrackets = gameState.allowBrackets;
            const targetDifficulty = gameState.difficulty;
            
            let digits, solutions, difficulty;
            let attempts = 0;
            const maxAttempts = 500;
            
            do {
                digits = [
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 10)
                ];
                solutions = findSolutions(digits, includeBrackets);
                difficulty = calculateDifficulty(solutions);
                attempts++;
                
                // Èõ£ÊòìÂ∫¶„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                if (solutions.length > 0 && targetDifficulty !== 'all') {
                    if (targetDifficulty === 'easy' && difficulty > 2) continue;
                    if (targetDifficulty === 'normal' && (difficulty < 2 || difficulty > 4)) continue;
                    if (targetDifficulty === 'hard' && difficulty < 4) continue;
                }
                
            } while (solutions.length === 0 || (targetDifficulty !== 'all' && attempts < maxAttempts && !matchesDifficulty(difficulty, targetDifficulty)));

            // Ëß£„ÅÆË°®Á§∫ÂΩ¢Âºè„ÇíÊñáÂ≠óÂàó„Å´Áµ±‰∏Ä
            const solutionExprs = solutions.map(s => typeof s === 'string' ? s : s.expr);
            return { digits, solutions: solutionExprs };
        }
        
        function matchesDifficulty(difficulty, target) {
            if (target === 'all') return true;
            if (target === 'easy') return difficulty <= 2;
            if (target === 'normal') return difficulty >= 2 && difficulty <= 4;
            if (target === 'hard') return difficulty >= 4;
            return true;
        }

        // „ÉÜ„Çπ„Éà„É¢„Éº„ÉâÈñãÂßã
        document.getElementById('test-room-btn').addEventListener('click', () => {
            gameState.isTestMode = true;
            gameState.isHost = true;
            gameState.bo = 1;
            gameState.round = 1;
            gameState.hostScore = 0;
            gameState.guestScore = 0;
            gameState.hostName = currentUserName || '„ÅÇ„Å™„Åü';
            gameState.guestName = 'CPU';
            gameState.hostAvatar = currentUserAvatar || null;
            gameState.guestAvatar = null;
            gameState.difficulty = 'easy';
            gameState.allowBrackets = false;
            gameState.timeLimit = 30;

            // „É´„Éº„É†Áõ£Ë¶ñ„ÇíÂÅúÊ≠¢ÔºàÂØæÊà¶‰∏≠„ÅØ„É≠„Éì„Éº„ÇíË¶ã„Å™„ÅÑÔºâ
            unsubscribeFromRooms();

            startGame();
        });

        function startGame() {
            showScreen('game-screen');
            updateScoreDisplay();
            document.getElementById('game-host-name').textContent = gameState.hostName;
            document.getElementById('game-guest-name').textContent = gameState.guestName;
            
            // „Éõ„Çπ„Éà„Éª„Ç≤„Çπ„Éà„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíË®≠ÂÆö
            const hostAvatarEl = document.getElementById('game-host-avatar');
            const guestAvatarEl = document.getElementById('game-guest-avatar');
            
            if (gameState.hostAvatar) {
                hostAvatarEl.innerHTML = `<img src="${gameState.hostAvatar}" alt="host">`;
            } else {
                hostAvatarEl.textContent = 'üëë';
            }
            
            if (gameState.guestAvatar) {
                guestAvatarEl.innerHTML = `<img src="${gameState.guestAvatar}" alt="guest">`;
            } else {
                guestAvatarEl.textContent = 'üë§';
            }
            
            if (gameState.isTestMode) {
                document.getElementById('game-guest-name').textContent = gameState.guestName;
                guestAvatarEl.textContent = 'ü§ñ';
            }

            // Êã¨Âºß„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            const bracketBtns = document.querySelectorAll('.op-btn.bracket');
            bracketBtns.forEach(btn => {
                btn.style.display = gameState.allowBrackets ? 'inline-block' : 'none';
            });

            // ÈÄî‰∏≠„Åß„ÇÑ„ÇÅ„Çã„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫Ôºà„ÇΩ„É≠„Éó„É¨„Ç§„ÅÆ„ÅøË°®Á§∫Ôºâ
            const quitBtn = document.getElementById('quit-game-btn');
            if (gameState.isTestMode) {
                quitBtn.style.display = 'inline-block';
            } else {
                quitBtn.style.display = 'none';
            }

            startRound();
        }

        // „Éï„Çß„Éº„Ç∫Áõ£Ë¶ñÁî®„É™„Çπ„Éä„Éº
        let metaListener = null;
        let lastStartedAt = 0;

        function stopMetaListener() {
            if (metaListener && currentRoomId) {
                database.ref(`rooms/${currentRoomId}/game/meta`).off('value', metaListener);
                metaListener = null;
            }
        }

        // „Ç≤„Çπ„ÉàÁî®Ôºömeta„ÅÆphase='started'„ÇíÂæÖ„Å§
        function startMetaListener() {
            if (!currentRoomId || gameState.isTestMode) return;
            stopMetaListener();

            console.log(`[META] Starting meta listener, waiting for round ${gameState.round}`);
            const metaRef = database.ref(`rooms/${currentRoomId}/game/meta`);
            
            metaListener = metaRef.on('value', async (snapshot) => {
                const meta = snapshot.val();
                if (!meta) return;

                console.log(`[META] Received:`, meta);

                // phase='started' „Åã„Å§Ê≠£„Åó„ÅÑ„É©„Ç¶„É≥„ÉâÁï™Âè∑„ÄÅ„Åã„Å§startedAt„ÅåÊñ∞„Åó„ÅÑÂ†¥Âêà„ÅÆ„ÅøÈñãÂßã
                if (meta.phase === 'started' && 
                    meta.roundNumber === gameState.round && 
                    meta.startedAt > lastStartedAt) {
                    
                    lastStartedAt = meta.startedAt;
                    console.log(`[META] Starting round ${gameState.round} (startedAt: ${meta.startedAt})`);
                    
                    // „É™„Çπ„Éä„Éº„ÇíÂÅúÊ≠¢Ôºà„Åì„ÅÆ„É©„Ç¶„É≥„Éâ„Åß„ÅØ‰∏çË¶ÅÔºâ
                    stopMetaListener();
                    
                    // ÂïèÈ°å„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶ÈñãÂßã
                    await loadRoundDataAndStart();
                }
            });
        }

        // ÂïèÈ°å„Éá„Éº„Çø„Çí„É≠„Éº„Éâ„Åó„Å¶„É©„Ç¶„É≥„Éâ„ÇíÈñãÂßãÔºàÂÖ±ÈÄöÂá¶ÁêÜÔºâ
        async function loadRoundDataAndStart() {
            // Êó¢Â≠ò„ÅÆ„Çø„Ç§„Éû„Éº„ÇíÁ¢∫ÂÆü„Å´„ÇØ„É™„Ç¢
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            // „É™„Çπ„Éä„Éº„ÇíÂÅúÊ≠¢
            stopOpponentExpressionListener();
            stopRoundResultListener();
            
            gameState.usedDigits = [];
            gameState.expression = '';
            gameState.submitted = false;
            gameState.resultShown = false;
            gameState.timeLeft = gameState.timeLimit || 30;

            console.log(`[ROUND] loadRoundDataAndStart: round=${gameState.round}, isHost=${gameState.isHost}`);

            // „Ç™„É≥„É©„Ç§„É≥ÂØæÊà¶„ÅÆÂ†¥Âêà„ÄÅÂïèÈ°å„ÇíFirebase„Åã„ÇâÂèñÂæó
            if (!gameState.isTestMode && currentRoomId) {
                const roundRef = database.ref(`rooms/${currentRoomId}/game/round${gameState.round}`);
                
                // ÂïèÈ°å„Éá„Éº„Çø„ÇíÂèñÂæóÔºà„Éõ„Çπ„Éà„ÅåÊó¢„Å´Êõ∏„ÅçËæº„Çì„Åß„ÅÑ„Çã„ÅØ„ÅöÔºâ
                let retryCount = 0;
                while (retryCount < 10) {
                    const snap = await roundRef.once('value');
                    const data = snap.val();
                    
                    if (data && data.digits && data.roundNumber === gameState.round) {
                        console.log(`[ROUND] Got round ${gameState.round} data:`, data.digits);
                        gameState.digits = data.digits;
                        gameState.solutions = findSolutions(data.digits);
                        break;
                    }
                    
                    console.log(`[ROUND] Waiting for round data... retry ${retryCount + 1}`);
                    await new Promise(r => setTimeout(r, 500));
                    retryCount++;
                }
                
                // ÊúÄÁµÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàÈÄöÂ∏∏„ÅØÂà∞ÈÅî„Åó„Å™„ÅÑÔºâ
                if (!gameState.digits || gameState.digits.length === 0) {
                    console.warn(`[ROUND] Fallback: generating local problem`);
                    const problem = generateProblem();
                    gameState.digits = problem.digits;
                    gameState.solutions = problem.solutions;
                }

                // --- ËøΩÂä†: ÈñãÂßãÊôÇÁÇπ„ÅßÊó¢„Å´ winner „ÅåÊ±∫„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ ---
                try {
                    const roundSnap = await database.ref(`rooms/${currentRoomId}/game/round${gameState.round}`).once('value');
                    const roundData = roundSnap.val();
                    if (roundData && roundData.winner && roundData.winner !== currentUserId && !gameState.submitted && !gameState.resultShown) {
                        console.log(`[ROUND] Opponent already won round ${gameState.round}:`, roundData.winner);
                        gameState.submitted = true;
                        if (gameState.timerInterval) { clearInterval(gameState.timerInterval); gameState.timerInterval = null; }
                        stopOpponentExpressionListener();
                        stopRoundResultListener();
                        const opponentKey = gameState.isHost ? 'guest' : 'host';
                        const oppData = roundData[opponentKey] || {};
                        const opponentExpr = (oppData.expression || '???')
                            .replace(/\*/g, '√ó')
                            .replace(/\//g, '√∑');
                        showRoundResult('lose', opponentExpr + ' = 10', oppData.solveTime);
                        return;
                    }
                } catch (e) {
                    console.warn('[ROUND] Error checking winner pre-finish:', e);
                }
            } else {
                // „ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Åæ„Åü„ÅØ„É≠„Éº„Ç´„É´: ÂïèÈ°å„ÇíÁîüÊàê
                const problem = generateProblem();
                gameState.digits = problem.digits;
                gameState.solutions = problem.solutions;
            }

            const difficulty = calculateDifficulty(gameState.solutions);

            // UIÊõ¥Êñ∞
            updateDigitButtons();
            updateExpressionDisplay();
            // opponent status element removed; no-op

            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫
            showCountdown(gameState.round, () => {
                // ÂïèÈ°åË°®Á§∫
                renderProblem(difficulty);
                gameState.roundStartTime = Date.now();
                
                // Áõ∏Êâã„ÅÆÂõûÁ≠î„ÇíÁõ£Ë¶ñÔºà„Ç™„É≥„É©„Ç§„É≥ÂØæÊà¶ÊôÇÔºâ- „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Âæå„Å´ÈñãÂßã
                if (!gameState.isTestMode && currentRoomId) {
                    startOpponentExpressionListener();
                    startRoundResultListener();
                }
                
                startTimer();
            });
        }

        // „Éõ„Çπ„ÉàÁî®Ôºö„É©„Ç¶„É≥„Éâ„ÇíÊ∫ñÂÇô„Åó„Å¶ÈñãÂßã„Ç∑„Ç∞„Éä„É´„ÇíÈÄÅ„Çã
        async function hostPrepareAndStartRound() {
            console.log(`[HOST] Preparing round ${gameState.round}`);
            
            const roundRef = database.ref(`rooms/${currentRoomId}/game/round${gameState.round}`);
            const metaRef = database.ref(`rooms/${currentRoomId}/game/meta`);
            
            // Êó¢Â≠ò„Éá„Éº„Çø„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà‰∫ãÂâçÊõ∏„ÅçËæº„Åø„Åå„ÅÇ„Çã„ÅãÔºâ
            const existingSnap = await roundRef.once('value');
            const existingData = existingSnap.val();
            
            if (existingData && existingData.digits && existingData.roundNumber === gameState.round) {
                console.log(`[HOST] Using pre-written round ${gameState.round} data:`, existingData.digits);
            } else {
                // ÂàùÂõûÔºàround 1Ôºâ„Åæ„Åü„ÅØ„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶èÁîüÊàê
                const problem = generateProblem();
                console.log(`[HOST] Writing round ${gameState.round} data:`, problem.digits);
                await roundRef.set({
                    digits: problem.digits,
                    roundNumber: gameState.round,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            // phase='started' „Å´Êõ¥Êñ∞„Åó„Å¶‰∏°ËÄÖ„Å´ÈñãÂßã„Ç∑„Ç∞„Éä„É´„ÇíÈÄÅ„Çã
            console.log(`[HOST] Setting phase=started for round ${gameState.round}`);
            await metaRef.set({
                phase: 'started',
                roundNumber: gameState.round,
                startedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            // „Éõ„Çπ„ÉàËá™Ë∫´„ÇÇ„É©„Ç¶„É≥„Éâ„ÇíÈñãÂßã
            await loadRoundDataAndStart();
        }

        // startRound: „Éõ„Çπ„Éà„ÅØÊ∫ñÂÇô‚ÜíÈñãÂßã„ÄÅ„Ç≤„Çπ„Éà„ÅØmetaÁõ£Ë¶ñ„ÇíÈñãÂßã
        async function startRound() {
            console.log(`[GAME] startRound called: round=${gameState.round}, isHost=${gameState.isHost}, testMode=${gameState.isTestMode}`);
            
            if (gameState.isTestMode || !currentRoomId) {
                // „ÉÜ„Çπ„Éà„É¢„Éº„ÉâÔºöÁõ¥Êé•ÈñãÂßã
                await loadRoundDataAndStart();
            } else if (gameState.isHost) {
                // „Éõ„Çπ„ÉàÔºöÂïèÈ°å„ÇíÊõ∏„ÅçËæº„Çì„Åßphase=started„Å´„Åô„Çã
                await hostPrepareAndStartRound();
            } else {
                // „Ç≤„Çπ„ÉàÔºömeta„ÅÆphase=started„ÇíÂæÖ„Å§
                startMetaListener();
            }
        }

        function showCountdown(round, callback) {
            const overlay = document.getElementById('countdown-overlay');
            const roundEl = document.getElementById('countdown-round');
            const numberEl = document.getElementById('countdown-number');

            overlay.classList.remove('hidden');
            roundEl.textContent = `Á¨¨${round}Âïè`;

            let count = 3;
            numberEl.textContent = count;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    numberEl.textContent = count;
                } else {
                    clearInterval(interval);
                    overlay.classList.add('hidden');
                    callback();
                }
            }, 1000);
        }

        function renderProblem(difficulty) {
            document.getElementById('round-number').textContent = `Á¨¨${gameState.round}Âïè`;

            const diffEl = document.getElementById('difficulty');
            diffEl.textContent = 'Èõ£ÊòìÂ∫¶ ' + '‚òÖ'.repeat(difficulty) + '‚òÜ'.repeat(5 - difficulty);
            diffEl.className = `difficulty difficulty-${difficulty}`;

            const digitsContainer = document.getElementById('problem-digits');
            digitsContainer.innerHTML = gameState.digits.map((d, i) => 
                `<div class="digit-card" data-index="${i}">${d}</div>`
            ).join('');
        }

        function startTimer() {
            // Êó¢Â≠ò„ÅÆ„Çø„Ç§„Éû„Éº„Åå„ÅÇ„Çå„Å∞„ÇØ„É™„Ç¢ÔºàÂÄçÈÄüÈò≤Ê≠¢Ôºâ
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            const timerFill = document.getElementById('timer-fill');
            const timerText = document.getElementById('timer-text');
            const maxTime = gameState.timeLimit || 30;

            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft -= 0.1;
                const percent = (gameState.timeLeft / maxTime) * 100;
                timerFill.style.width = `${percent}%`;
                timerText.textContent = Math.ceil(gameState.timeLeft);

                if (gameState.timeLeft <= 5) {
                    timerFill.classList.add('danger');
                } else {
                    timerFill.classList.remove('danger');
                }

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    handleTimeout();
                }
            }, 100);
        }

        function handleTimeout() {
            if (gameState.submitted || gameState.resultShown) return; // Êó¢„Å´Âá¶ÁêÜÊ∏à„Åø„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            
            // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
            gameState.submitted = true;
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = null;
            stopOpponentExpressionListener();
            stopRoundResultListener();
            
            // „Ç™„É≥„É©„Ç§„É≥ÂØæÊà¶ÊôÇ„ÅØ„Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÇíDB„Å´Ë®òÈå≤Ôºàtransaction„ÅßÂãùÊïóÂà§ÂÆöÔºâ
            if (!gameState.isTestMode && currentRoomId) {
                const playerKey = gameState.isHost ? 'host' : 'guest';
                const roundPath = `rooms/${currentRoomId}/game/round${gameState.round}`;
                const roundRef = database.ref(roundPath);

                const payload = {
                    finished: true,
                    correct: false,
                    solveTime: null
                };

                roundRef.transaction((current) => {
                    if (current === null) {
                        // ÈÄöÂ∏∏„Åì„Åì„Å´„ÅØÊù•„Å™„ÅÑ
                        const node = {};
                        node[playerKey] = payload;
                        return node;
                    }
                    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„ÅüÂÅ¥„ÅØ winner „ÇíÂèñ„Çâ„Å™„ÅÑÔºàÁõ∏Êâã„ÅåÂÖà„Å´Ê≠£Ëß£„Åó„Å¶„ÅÑ„Çå„Å∞ winner „ÅØÊó¢Â≠òÔºâ
                    // „Åü„Å†„ÅóËá™ÂàÜ„ÅÆ„Éá„Éº„Çø„ÅØÊõ∏„ÅçËæº„ÇÄ
                    current[playerKey] = payload;
                    return current;
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.warn('„Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®òÈå≤Â§±Êïó:', error);
                    }
                    // Áõ∏Êâã„ÅåÂãùËÄÖ„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const data = snapshot ? snapshot.val() : null;
                    if (data && data.winner && data.winner !== currentUserId) {
                        // Áõ∏Êâã„ÅåÂãùËÄÖ
                        const opponentKey = gameState.isHost ? 'guest' : 'host';
                        const oppData = data[opponentKey] || {};
                        const oppExpr = (oppData.expression || '???')
                            .replace(/\*/g, '√ó')
                            .replace(/\//g, '√∑');
                        showRoundResult('lose', oppExpr + ' = 10', oppData.solveTime);
                    } else {
                        // ‰∏°ËÄÖ„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åæ„Åü„ÅØÁõ∏Êâã„ÇÇ„Åæ„Å†
                        showRoundResult('draw', gameState.solutions[0] || 'Ëß£„Å™„Åó', null);
                    }
                }, false);
            } else {
                showRoundResult('draw', gameState.solutions[0] || 'Ëß£„Å™„Åó', null);
            }
        }

        // Áõ∏Êâã„ÅÆÂºè„ÇíFirebase„Å´ÂêåÊúü
        let opponentExpressionListener = null;
        let roundResultListener = null;
        let roundResultRef = null;

        function syncExpressionToFirebase() {
            if (gameState.isTestMode || !currentRoomId) return;
            
            const playerKey = gameState.isHost ? 'host' : 'guest';
            const displayExpr = gameState.expression
                .replace(/\*/g, '√ó')
                .replace(/\//g, '√∑');
            
            database.ref(`rooms/${currentRoomId}/game/round${gameState.round}/${playerKey}`).update({
                expression: displayExpr,
                usedCount: gameState.usedDigits.length
            }).catch(err => console.warn('Âºè„ÅÆÂêåÊúüÂ§±Êïó:', err));
        }

        function startOpponentExpressionListener() {
            if (opponentExpressionListener) {
                opponentExpressionListener.off();
            }
            
            const opponentKey = gameState.isHost ? 'guest' : 'host';
            const opponentRef = database.ref(`rooms/${currentRoomId}/game/round${gameState.round}/${opponentKey}`);
            
            opponentExpressionListener = opponentRef.on('value', (snapshot) => {
                const data = snapshot.val();
                // opponent status UI removed ‚Äî keep minimal logging for debugging
                if (data && data.expression !== undefined) {
                    const maskedExpr = data.expression.replace(/[0-9]/g, '‚óè');
                    console.log('[OPP] expression:', maskedExpr);
                } else {
                    // no expression yet
                }

                // Áõ∏Êâã„ÅåÊ≠£Ëß£„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàËá™ÂàÜ„Åå„Åæ„Å†ÁµêÊûúË°®Á§∫„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ
                // ‚Äª startRoundResultListener „ÅßÂá¶ÁêÜ„Åô„Çã„ÅÆ„Åß„Åì„Åì„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            });
        }

        // „É©„Ç¶„É≥„ÉâÁµêÊûú„ÅÆ„É™„Çπ„Éä„ÉºÔºàwinner„Éï„Ç£„Éº„É´„Éâ„ÅßÁõ∏Êâã„ÅÆÂãùÂà©„ÇíÊ§úÁü•Ôºâ
        function startRoundResultListener() {
            if (roundResultListener) {
                stopRoundResultListener();
            }

            if (!currentRoomId) return;
            // „É©„Ç¶„É≥„Éâ„Éé„Éº„ÉâÂÖ®‰Ωì„ÇíÁõ£Ë¶ñÔºàwinner „Éï„Ç£„Éº„É´„Éâ„ÇíÊ§úÁü•„Åô„Çã„Åü„ÇÅÔºâ
            const path = `rooms/${currentRoomId}/game/round${gameState.round}`;
            roundResultRef = database.ref(path);

            roundResultListener = (snapshot) => {
                const data = snapshot.val();
                // winner „ÅåÂ≠òÂú®„Åó„ÄÅËá™ÂàÜ„Åß„Å™„ÅÑÂ†¥Âêà = Áõ∏Êâã„ÅåÂãùËÄÖ
                if (data && data.winner && data.winner !== currentUserId && !gameState.submitted && !gameState.resultShown) {
                    console.log('[RoundResult] Opponent won this round. winner=' + data.winner);
                    gameState.submitted = true;
                    clearInterval(gameState.timerInterval);
                    gameState.timerInterval = null;
                    stopOpponentExpressionListener();
                    stopRoundResultListener();
                    const opponentKey = gameState.isHost ? 'guest' : 'host';
                    const oppData = data[opponentKey] || {};
                    const opponentExpr = (oppData.expression || '???')
                        .replace(/\*/g, '√ó')
                        .replace(/\//g, '√∑');
                    showRoundResult('lose', opponentExpr + ' = 10', oppData.solveTime);
                }
            };

            roundResultRef.on('value', roundResultListener);
        }

        function stopRoundResultListener() {
            if (roundResultRef && roundResultListener) {
                try {
                    roundResultRef.off('value', roundResultListener);
                } catch (e) {
                    // ignore
                }
                roundResultRef = null;
                roundResultListener = null;
            }
        }

        function stopOpponentExpressionListener() {
            if (opponentExpressionListener) {
                const opponentKey = gameState.isHost ? 'guest' : 'host';
                database.ref(`rooms/${currentRoomId}/game/round${gameState.round}/${opponentKey}`).off('value', opponentExpressionListener);
                opponentExpressionListener = null;
            }
        }

        // Ready Ê©üÊßã„ÅØ BO1 „ÅÆ„Åü„ÇÅÂªÉÊ≠¢„ÄÇÂëº„Å≥Âá∫„Åó„ÅåÊÆã„Å£„Å¶„ÅÑ„ÇãÁÆáÊâÄÂêë„Åë„ÅÆ noop „ÇíÊèê‰æõ„ÄÇ
        function stopReadyListener() {
            // noop
        }

        // Êï∞Â≠ó„Ç´„Éº„Éâ„ÅÆ„Çø„ÉÉ„Éó„Ç§„Éô„É≥„ÉàÔºàÂïèÈ°å„ÅÆÊï∞Â≠ó„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÂÖ•ÂäõÔºâ
        document.getElementById('problem-digits').addEventListener('click', (e) => {
            if (gameState.submitted) return;

            const card = e.target.closest('.digit-card');
            if (!card || card.classList.contains('used')) return;

            const cardIndex = parseInt(card.dataset.index);
            const digitNum = gameState.digits[cardIndex];

            // Êï∞Â≠ó„ÅÆÁõ¥Âæå„Å´Êï∞Â≠ó„ÅØÂÖ•Âäõ‰∏çÂèØÔºàÊºîÁÆóÂ≠ê„ÅãÊã¨Âºß„ÅåÂøÖË¶ÅÔºâ
            const lastChar = gameState.expression.slice(-1);
            if (/[0-9]/.test(lastChar)) return;
            // Èñâ„ÅòÊã¨Âºß„ÅÆÁõ¥Âæå„Å´Êï∞Â≠ó„ÅØÂÖ•Âäõ‰∏çÂèØ
            if (lastChar === ')') return;

            gameState.expression += digitNum;
            gameState.usedDigits.push(cardIndex); // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅßÁÆ°ÁêÜ
            updateDigitCards();
            updateExpressionDisplay();
            syncExpressionToFirebase();
        });

        // ÊºîÁÆóÂ≠ê„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
        document.getElementById('operator-row').addEventListener('click', (e) => {
            if (gameState.submitted) return;

            const btn = e.target.closest('.op-btn');
            if (!btn) return;

            const op = btn.dataset.op;
            const lastChar = gameState.expression.slice(-1);

            if (op === '(') {
                // Èñã„ÅçÊã¨Âºß: Âºè„ÅÆÂÖàÈ†≠„ÄÅÊºîÁÆóÂ≠ê„ÅÆÂæå„ÄÅÈñã„ÅçÊã¨Âºß„ÅÆÂæå„Å´ÂÖ•ÂäõÂèØËÉΩ
                if (gameState.expression.length === 0 || 
                    ['+', '-', '*', '/', '('].includes(lastChar)) {
                    gameState.expression += op;
                    updateExpressionDisplay();
                    syncExpressionToFirebase();
                }
            } else if (op === ')') {
                // Èñâ„ÅòÊã¨Âºß: Êï∞Â≠ó„ÅãÈñâ„ÅòÊã¨Âºß„ÅÆÂæå„Å´„ÅÆ„ÅøÂÖ•ÂäõÂèØËÉΩ„ÄÅÈñã„ÅçÊã¨Âºß„ÅÆÊï∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                if (/[0-9)]/.test(lastChar)) {
                    const openCount = (gameState.expression.match(/\(/g) || []).length;
                    const closeCount = (gameState.expression.match(/\)/g) || []).length;
                    if (openCount > closeCount) {
                        gameState.expression += op;
                        updateExpressionDisplay();
                        syncExpressionToFirebase();
                    }
                }
            } else {
                // ÈÄöÂ∏∏„ÅÆÊºîÁÆóÂ≠ê: Êï∞Â≠ó„ÅãÈñâ„ÅòÊã¨Âºß„ÅÆÂæå„Å´„ÅÆ„ÅøÂÖ•ÂäõÂèØËÉΩ
                if (/[0-9)]/.test(lastChar)) {
                    gameState.expression += op;
                    updateExpressionDisplay();
                    syncExpressionToFirebase();
                }
            }
        });

        // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
        document.getElementById('action-row').addEventListener('click', (e) => {
            if (gameState.submitted) return;

            const btn = e.target.closest('.action-btn');
            if (!btn) return;

            const action = btn.dataset.action;

            if (action === 'backspace') {
                if (gameState.expression.length > 0) {
                    const lastChar = gameState.expression.slice(-1);
                    gameState.expression = gameState.expression.slice(0, -1);
                    
                    // Êï∞Â≠ó„ÇíÂâäÈô§„Åó„ÅüÂ†¥Âêà„ÄÅusedDigits„Åã„Çâ„ÇÇÂâäÈô§
                    if (/[0-9]/.test(lastChar)) {
                        // ÊúÄÂæå„Å´‰Ωø„Å£„ÅüË©≤ÂΩìÊï∞Â≠ó„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊé¢„Åô
                        for (let i = gameState.usedDigits.length - 1; i >= 0; i--) {
                            if (gameState.digits[gameState.usedDigits[i]] === parseInt(lastChar)) {
                                gameState.usedDigits.splice(i, 1);
                                break;
                            }
                        }
                    }
                    updateDigitCards();
                    updateExpressionDisplay();
                    syncExpressionToFirebase();
                }
            } else if (action === 'reset') {
                // ÂÖ®„É™„Çª„ÉÉ„Éà
                gameState.expression = '';
                gameState.usedDigits = [];
                updateDigitCards();
                updateExpressionDisplay();
                syncExpressionToFirebase();
            } else if (action === 'hint') {
                showHint();
            }
        });

        function updateDigitCards() {
            document.querySelectorAll('.digit-card').forEach((card, i) => {
                if (gameState.usedDigits.includes(i)) {
                    card.classList.add('used');
                } else {
                    card.classList.remove('used');
                }
            });
        }

        // ÊóßupdateDigitButtonsÈñ¢Êï∞Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        function updateDigitButtons() {
            updateDigitCards();
        }

        function updateExpressionDisplay() {
            const display = document.getElementById('expression-display');
            const resultEl = document.getElementById('expression-result');
            const submitBtn = document.getElementById('submit-btn');

            // Ë°®Á§∫Áî®„Å´ÊºîÁÆóÂ≠ê„ÇíÂ§âÊèõ
            const displayExpr = gameState.expression
                .replace(/\*/g, '√ó')
                .replace(/\//g, '√∑');
            display.textContent = displayExpr || ' ';
            display.className = 'expression-display';

            // Âºè„ÅÆË©ï‰æ°
            if (gameState.expression && gameState.usedDigits.length === 4) {
                try {
                    const result = safeEval(gameState.expression);
                    if (result !== null) {
                        resultEl.textContent = `= ${result}`;
                        if (result === 10) {
                            resultEl.classList.add('valid');
                            display.classList.add('correct');
                            // Ëá™ÂãïÈÄÅ‰ø°Ôºà=10„Å´„Å™„Å£„ÅüÁû¨ÈñìÔºâ
                            if (!gameState.submitted) {
                                submitAnswer();
                            }
                        } else {
                            resultEl.classList.remove('valid');
                        }
                    } else {
                        resultEl.textContent = 'Âºè„Åå‰∏çÊ≠£„Åß„Åô';
                        resultEl.classList.remove('valid');
                    }
                } catch {
                    resultEl.textContent = 'Âºè„Åå‰∏çÊ≠£„Åß„Åô';
                    resultEl.classList.remove('valid');
                }
            } else if (gameState.expression) {
                // ÈÄî‰∏≠„ÅÆÂºè„ÇíË©ï‰æ°
                try {
                    const result = safeEval(gameState.expression);
                    if (result !== null) {
                        resultEl.textContent = `= ${result} (Êï∞Â≠ó„Çí„Åô„Åπ„Å¶‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ)`;
                    } else {
                        resultEl.textContent = 'Êï∞Â≠ó„Çí„Åô„Åπ„Å¶‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    }
                } catch {
                    resultEl.textContent = 'Êï∞Â≠ó„Çí„Åô„Åπ„Å¶‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                }
                resultEl.classList.remove('valid');
            } else {
                resultEl.textContent = 'Âºè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                resultEl.classList.remove('valid');
            }
        }

        function submitAnswer() {
            gameState.submitted = true;
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = null;
            stopOpponentExpressionListener();
            stopRoundResultListener();

            const displayExpr = gameState.expression
                .replace(/\*/g, '√ó')
                .replace(/\//g, '√∑');

            // Ëß£Á≠îÊôÇÈñì„ÇíË®àÁÆó
            const solveTime = parseFloat(((Date.now() - gameState.roundStartTime) / 1000).toFixed(2));

            if (gameState.isTestMode) {
                // „ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Åß„ÅØÂ∏∏„Å´Ëá™ÂàÜ„ÅÆÂãù„Å°
                showRoundResult('win', displayExpr + ' = 10', solveTime);
            } else {
                // „Ç™„É≥„É©„Ç§„É≥ÂØæÊà¶„ÅÆÂ†¥Âêà„ÅØ transaction „Åß„ÄåÂÖà„Å´Êõ∏„ÅÑ„ÅüÊñπ„ÅåÂãù„Å°„Äç„ÇíÂÆüÁèæ
                const playerKey = gameState.isHost ? 'host' : 'guest';
                const roundPath = `rooms/${currentRoomId}/game/round${gameState.round}`;
                const roundRef = database.ref(roundPath);

                const payload = {
                    finished: true,
                    correct: true,
                    expression: gameState.expression,
                    solveTime: solveTime
                };

                console.log(`[SUBMIT] Writing my result for round ${gameState.round}, player=${playerKey}`);

                // ÂÖà„Å´Ëá™ÂàÜ„ÅÆÁµêÊûú„Éá„Éº„Çø„Å†„Åë„ÇíÊõ∏„ÅçËæº„ÇÄÔºàÁõ∏ÊâãÂÅ¥„ÅåÂºè„ÇÑÊôÇÈñì„ÇíË¶ã„Çâ„Çå„Çã„Çà„ÅÜ„Å´„Åô„ÇãÔºâ
                roundRef.child(playerKey).update(payload).then(() => {
                    console.log('[SUBMIT] My result written, now attempting winner transaction');

                    // winner „ÅØ„É©„Ç¶„É≥„Éâ„Éé„Éº„Éâ„ÅÆ child „Å®„Åó„Å¶ÂçòÁã¨„Åß transaction „ÇíË°å„ÅÜ
                    const winnerRef = roundRef.child('winner');
                    winnerRef.transaction((current) => {
                        if (current) return; // Êó¢„Å´ winner „Åå„ÅÑ„Çã -> abort
                        return currentUserId; // winner „Å´Ëá™ÂàÜ„ÅÆ uid „ÇíÊõ∏„ÅçËæº„ÇÄ
                    }, (error, committed, snap) => {
                        if (error) {
                            console.error('[SUBMIT] Winner transaction error:', error);
                            // winner „ÅÆÁ¢∫ÂÆö„Å´Â§±Êïó„Åó„Åü„ÅåËá™ÂàÜ„ÅÆÁµêÊûú„ÅØÊõ∏„ÅçËæº„Åæ„Çå„Å¶„ÅÑ„Çã
                            // „Åì„Åì„Åß„ÅØÂÆâÂÖ®Á≠ñ„Å®„Åó„Å¶Áõ∏Êâã„ÅÆÁä∂ÊÖã„ÇíË™≠„Åø„ÄÅÂãùÊïó„ÇíÂà§ÂÆö„Åô„Çã
                            roundRef.once('value').then(s => {
                                const data = s.val() || {};
                                if (data.winner && data.winner !== currentUserId) {
                                    // Áõ∏Êâã„Åå winner
                                    const opponentKey = gameState.isHost ? 'guest' : 'host';
                                    const oppData = data[opponentKey] || {};
                                    const oppExpr = (oppData.expression || '???').replace(/\*/g, '√ó').replace(/\//g, '√∑');
                                    showRoundResult('lose', oppExpr + ' = 10', oppData.solveTime);
                                } else {
                                    // ÊõñÊòß„Å™Â†¥Âêà„ÅØËá™ÂàÜ„ÅÆÂãù„Å°„Å®„Åó„Å¶Ë°®Á§∫Ôºà„É≠„Ç∞Ë®òÈå≤Ôºâ
                                    console.warn('[SUBMIT] Ambiguous winner state after error, treating as win');
                                    showRoundResult('win', displayExpr + ' = 10', solveTime);
                                }
                            }).catch(e => {
                                console.error('[SUBMIT] Failed to read round after winner error:', e);
                                showRoundResult('win', displayExpr + ' = 10', solveTime);
                            });
                            return;
                        }

                        // committed „Åå true „ÅÆÂ†¥Âêà„ÄÅwinner „ÇíÊõ∏„ÅçËæº„ÇÅ„Åü
                        const roundData = snap ? snap.val() : null;
                        if (committed && roundData === currentUserId) {
                            console.log(`[SUBMIT] I became winner for round ${gameState.round}`);
                            showRoundResult('win', displayExpr + ' = 10', solveTime);
                        } else if (roundData && roundData !== currentUserId) {
                            console.log(`[SUBMIT] Opponent already winner (${roundData}) for round ${gameState.round}`);
                            // Áõ∏Êâã„Åå winner „ÅÆÂ†¥Âêà„ÅØÁõ∏Êâã„Éá„Éº„Çø„ÇíË°®Á§∫
                            roundRef.once('value').then(s => {
                                const data = s.val() || {};
                                const opponentKey = gameState.isHost ? 'guest' : 'host';
                                const oppData = data[opponentKey] || {};
                                const oppExpr = (oppData.expression || '???').replace(/\*/g, '√ó').replace(/\//g, '√∑');
                                showRoundResult('lose', oppExpr + ' = 10', oppData.solveTime);
                            }).catch(e => {
                                console.error('[SUBMIT] Failed to read round after opponent winner:', e);
                                showRoundResult('lose', 'Áõ∏Êâã„ÅåÂÖà„Å´Ê≠£Ëß£', null);
                            });
                        } else {
                            // committed=false „Åã„Å§ winner „ÇÇÁÑ°„ÅÑ‰∏çÊï¥Âêà„Å™Áä∂ÊÖã
                            console.warn('[SUBMIT] Transaction not committed and no winner found; treating as lose');
                            roundRef.once('value').then(s => {
                                const data = s.val() || {};
                                if (data.winner && data.winner !== currentUserId) {
                                    const opponentKey = gameState.isHost ? 'guest' : 'host';
                                    const oppData = data[opponentKey] || {};
                                    const oppExpr = (oppData.expression || '???').replace(/\*/g, '√ó').replace(/\//g, '√∑');
                                    showRoundResult('lose', oppExpr + ' = 10', oppData.solveTime);
                                } else {
                                    showRoundResult('win', displayExpr + ' = 10', solveTime);
                                }
                            }).catch(e => {
                                console.error('[SUBMIT] Failed to read round after ambiguous state:', e);
                                showRoundResult('win', displayExpr + ' = 10', solveTime);
                            });
                        }
                    }, false);
                }).catch(err => {
                    console.error('[SUBMIT] Failed to write my result before winner transaction:', err);
                    // Êõ∏„ÅçËæº„Åø„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÂæìÊù•„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØË°®Á§∫
                    showRoundResult('win', displayExpr + ' = 10', solveTime);
                });
            }
        }

        function showRoundResult(result, answer, solveTime) {
            // ÁµêÊûúË°®Á§∫„ÅÆÈáçË§á„ÇíÈò≤Ê≠¢
            if (gameState.resultShown) {
                console.log('showRoundResult already called, skipping');
                return;
            }
            gameState.resultShown = true;
            
            // ÂÖ®„Å¶„ÅÆ„É™„Çπ„Éä„Éº„Å®„Çø„Ç§„Éû„Éº„ÇíÁ¢∫ÂÆü„Å´ÂÅúÊ≠¢
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            stopOpponentExpressionListener();
            stopRoundResultListener();
            
            const overlay = document.getElementById('result-overlay');
            const titleEl = document.getElementById('result-title');
            const answerEl = document.getElementById('result-answer');

            overlay.classList.remove('hidden');
            
            // ÊôÇÈñìË°®Á§∫„ÇíÂê´„ÇÅ„Çã
            if (solveTime && result === 'win') {
                answerEl.textContent = answer + ` (${solveTime}Áßí)`;
            } else {
                answerEl.textContent = answer;
            }

            if (result === 'win') {
                titleEl.textContent = 'üéâ Ê≠£Ëß£ÔºÅ';
                titleEl.className = 'result-title win';
                // 'win' means the current player won
                if (gameState.isHost) {
                    gameState.hostScore++;
                } else {
                    gameState.guestScore++;
                }
            } else if (result === 'lose') {
                titleEl.textContent = 'üò¢ Áõ∏Êâã„ÅåÂÖà„Å´Ê≠£Ëß£';
                titleEl.className = 'result-title lose';
                // 'lose' means opponent won
                if (gameState.isHost) {
                    gameState.guestScore++;
                } else {
                    gameState.hostScore++;
                }
            } else {
                titleEl.textContent = '‚è±Ô∏è „Çø„Ç§„É†„Ç¢„ÉÉ„Éó';
                titleEl.className = 'result-title draw';
            }

            updateScoreDisplay();

            // ÂãùÊïó„ÉÅ„Çß„ÉÉ„ÇØ
            const winTarget = Math.ceil(gameState.bo / 2);
            const gameEnded = gameState.hostScore >= winTarget || gameState.guestScore >= winTarget;

            // „Éõ„Çπ„Éà„ÅØÊ¨°„ÅÆ„É©„Ç¶„É≥„Éâ„ÅÆÂïèÈ°å„ÇíÂÖà„Å´Êõ∏„ÅçËæº„Çì„Åß„Åä„ÅèÔºàÂãùÊïó„ÅåÊ±∫„Åæ„Å£„Å¶„Å™„ÅÑÂ†¥ÂêàÔºâ
            if (!gameEnded && gameState.isHost && !gameState.isTestMode && currentRoomId) {
                const nextRound = gameState.round + 1;
                const problem = generateProblem();
                console.log(`[HOST] Pre-writing round ${nextRound} data:`, problem.digits);
                database.ref(`rooms/${currentRoomId}/game/round${nextRound}`).set({
                    digits: problem.digits,
                    roundNumber: nextRound,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).catch(err => console.error('Failed to pre-write next round:', err));
            }

            setTimeout(async () => {
                overlay.classList.add('hidden');

                if (gameState.hostScore >= winTarget) {
                    // „Éõ„Çπ„Éà„ÅåÂãù„Å£„Åü
                    stopMetaListener();
                    showMatchResult(gameState.isHost ? 'win' : 'lose');
                    return;
                } else if (gameState.guestScore >= winTarget) {
                    // „Ç≤„Çπ„Éà„ÅåÂãù„Å£„Åü
                    stopMetaListener();
                    showMatchResult(gameState.isHost ? 'lose' : 'win');
                    return;
                }

                // BO1 „ÅÆ„Åü„ÇÅ„ÄÅÊ¨°„É©„Ç¶„É≥„ÉâÊ∫ñÂÇô„ÅØ‰∏çË¶Å„ÄÇË©¶Âêà„ÅØ„Åì„Åì„ÅßÁµÇ‰∫ÜÊâ±„ÅÑ„Å´„Åô„Çã„ÄÇ
                // Êó¢„Å´‰∏ä„ÅÆÂãùÊïó„ÉÅ„Çß„ÉÉ„ÇØ„ÅßÂãùËÄÖÂà§ÂÆö„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅÂºï„ÅçÂàÜ„Åë„Å™„Çâ draw „Å®„Åó„Å¶ÁµÇ‰∫Ü„ÄÇ
                if (gameState.hostScore >= winTarget) {
                    stopMetaListener();
                    showMatchResult(gameState.isHost ? 'win' : 'lose');
                    return;
                } else if (gameState.guestScore >= winTarget) {
                    stopMetaListener();
                    showMatchResult(gameState.isHost ? 'lose' : 'win');
                    return;
                } else {
                    // Âºï„ÅçÂàÜ„Åë„Å®„Åó„Å¶Ë©¶ÂêàÁµÇ‰∫Ü
                    stopMetaListener();
                    // showMatchResult „ÅØ 'win'/'lose' „Åó„ÅãÊâ±„Çè„Å™„ÅÑ„Åü„ÇÅ 'draw' „ÅØ 'lose' Ë¶ã„Å™„Åô‰ª£ÊõøË°®Á§∫
                    showMatchResult('lose');
                    return;
                }
            }, 3000);
        }

        // ================================
        // ReadyÔºàÊ∫ñÂÇôÂÆå‰∫ÜÔºâUI „Å®„É™„Çπ„Éä„Éº
        // ================================
        function showReadyOverlay(round) {
            const overlay = document.getElementById('ready-overlay');
            if (!overlay) return;
            const roundEl = document.getElementById('ready-round-number');
            if (roundEl) roundEl.textContent = `Á¨¨${round}Âïè„ÅÆÊ∫ñÂÇô`;
            gameState.pendingRound = round;
            gameState.ready = false;
            gameState.opponentReady = false;
            updateReadyStatusUI(false, false);
            overlay.classList.remove('hidden');
            const readyBtn = document.getElementById('ready-btn');
            if (readyBtn) { readyBtn.disabled = false; readyBtn.textContent = 'Ê∫ñÂÇôÂÆå‰∫Ü'; }
        }

        function hideReadyOverlay() {
            const overlay = document.getElementById('ready-overlay');
            if (overlay) overlay.classList.add('hidden');
            const readyBtn = document.getElementById('ready-btn');
            if (readyBtn) { readyBtn.disabled = false; readyBtn.textContent = 'Ê∫ñÂÇôÂÆå‰∫Ü'; }
            stopReadyListener();
            gameState.pendingRound = null;
        }

        function updateReadyStatusUI(myReady, oppReady) {
            const myEl = document.getElementById('my-ready-status');
            const oppEl = document.getElementById('opp-ready-status');
            if (myEl) myEl.textContent = myReady ? '„ÅÇ„Å™„Åü: Ê∫ñÂÇôÂÆå‰∫Ü' : '„ÅÇ„Å™„Åü: Êú™Ê∫ñÂÇô';
            if (oppEl) oppEl.textContent = oppReady ? 'Áõ∏Êâã: Ê∫ñÂÇôÂÆå‰∫Ü' : 'Áõ∏Êâã: Êú™Ê∫ñÂÇô';
        }

        // Ê¨°„É©„Ç¶„É≥„Éâ„ÅÆÊ∫ñÂÇô„Éï„É≠„Éº„ÅØ BO1 Âåñ„Å´„Çà„ÇäÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ

        function updateScoreDisplay() {
            const hostScoreEl = document.getElementById('host-score');
            const guestScoreEl = document.getElementById('guest-score');
            const winTarget = Math.ceil(gameState.bo / 2);

            hostScoreEl.innerHTML = '';
            guestScoreEl.innerHTML = '';

            for (let i = 0; i < winTarget; i++) {
                const hostDot = document.createElement('div');
                hostDot.className = 'score-dot' + (i < gameState.hostScore ? ' win' : '');
                hostScoreEl.appendChild(hostDot);

                const guestDot = document.createElement('div');
                guestDot.className = 'score-dot' + (i < gameState.guestScore ? ' win' : '');
                guestScoreEl.appendChild(guestDot);
            }
        }

        function showMatchResult(result) {
            const overlay = document.getElementById('match-result-overlay');
            const titleEl = document.getElementById('match-result-title');
            const scoreEl = document.getElementById('match-result-score');

            overlay.classList.remove('hidden');

            if (result === 'win') {
                titleEl.textContent = 'üéâ ÂãùÂà©ÔºÅ';
                titleEl.style.color = 'var(--secondary-color)';
            } else {
                titleEl.textContent = 'üò¢ ÊïóÂåó...';
                titleEl.style.color = 'var(--danger-color)';
            }

            scoreEl.textContent = `${gameState.hostScore} - ${gameState.guestScore}`;

            // „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
            const hostAvatarEl = document.getElementById('match-host-avatar');
            const hostNameEl = document.getElementById('match-host-name');
            const guestAvatarEl = document.getElementById('match-guest-avatar');
            const guestNameEl = document.getElementById('match-guest-name');

            // „Ç≤„Éº„É†ÁîªÈù¢„ÅÆ„Ç¢„Éê„Çø„Éº„Çí„Ç≥„Éî„Éº
            const gameHostAvatar = document.getElementById('game-host-avatar');
            const gameGuestAvatar = document.getElementById('game-guest-avatar');
            
            hostAvatarEl.innerHTML = gameHostAvatar.innerHTML;
            guestAvatarEl.innerHTML = gameGuestAvatar.innerHTML;
            
            hostNameEl.textContent = gameState.hostName || '„Éõ„Çπ„Éà';
            guestNameEl.textContent = gameState.guestName || '„Ç≤„Çπ„Éà';
        }

        document.getElementById('back-to-lobby-btn').addEventListener('click', () => {
            document.getElementById('match-result-overlay').classList.add('hidden');
            if (!gameState.isTestMode && currentRoomId) {
                leaveRoom();
            } else {
                showScreen('lobby-screen');
            }
            gameState.isTestMode = false;
            
            // „É´„Éº„É†Áõ£Ë¶ñ„ÇíÂÜçÈñãÔºàË™çË®º„ÇíÁ¢∫ÂÆü„Å´Ë°å„Å£„Å¶„Åã„ÇâÔºâ
            attemptAuthAndSubscribe();
        });

        // ÈÄî‰∏≠„Åß„ÇÑ„ÇÅ„Çã„Éú„Çø„É≥Ôºà„ÇΩ„É≠„Éó„É¨„Ç§Áî®Ôºâ
        document.getElementById('quit-game-btn').addEventListener('click', () => {
            if (confirm('Êú¨ÂΩì„Å´„ÇÑ„ÇÅ„Åæ„Åô„ÅãÔºü')) {
                // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
                if (gameState.timerInterval) {
                    clearInterval(gameState.timerInterval);
                    gameState.timerInterval = null;
                }
                // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÈùûË°®Á§∫
                document.getElementById('countdown-overlay').classList.add('hidden');
                document.getElementById('result-overlay').classList.add('hidden');
                document.getElementById('match-result-overlay').classList.add('hidden');
                // „É≠„Éì„Éº„Å´Êàª„Çã
                gameState.isTestMode = false;
                showScreen('lobby-screen');
                attemptAuthAndSubscribe();
            }
        });

        // BO1 „ÅÆ„Åü„ÇÅ„ÄåÊ∫ñÂÇôÂÆå‰∫Ü„Äç„Éú„Çø„É≥„ÅØ‰ΩøÁî®„Åó„Åæ„Åõ„Çì„ÄÇ

        // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•ÂäõÂØæÂøú
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('game-screen').classList.contains('active')) return;
            if (gameState.submitted) return;

            const key = e.key;

            if (/^[1-9]$/.test(key)) {
                const digitNum = parseInt(key);
                const availableDigits = [...gameState.digits];
                gameState.usedDigits.forEach(d => {
                    const idx = availableDigits.indexOf(d);
                    if (idx !== -1) availableDigits.splice(idx, 1);
                });

                if (availableDigits.includes(digitNum)) {
                    gameState.expression += key;
                    gameState.usedDigits.push(digitNum);
                    updateDigitButtons();
                    updateExpressionDisplay();
                }
            } else if (['+', '-', '*', '/'].includes(key)) {
                gameState.expression += key;
                updateExpressionDisplay();
            } else if (key === '(' || key === ')') {
                    // Êã¨ÂºßÂÖ•Âäõ„ÅØÁÑ°ÂäπÂåñÔºàÁÑ°Ë¶ñÔºâ
                } else if (key === 'Backspace') {
                if (gameState.expression.length > 0) {
                    const lastChar = gameState.expression.slice(-1);
                    gameState.expression = gameState.expression.slice(0, -1);
                    if (/[1-9]/.test(lastChar)) {
                        const idx = gameState.usedDigits.lastIndexOf(parseInt(lastChar));
                        if (idx !== -1) gameState.usedDigits.splice(idx, 1);
                    }
                    updateDigitButtons();
                    updateExpressionDisplay();
                }
            } else if (key === 'Escape' || key === 'c' || key === 'C') {
                gameState.expression = '';
                gameState.usedDigits = [];
                updateDigitButtons();
                updateExpressionDisplay();
            }
        });

        // ========================================
        // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö„ÉªGoogle„É≠„Ç∞„Ç§„É≥
        // ========================================
            const GOOGLE_ICON_URL = 'https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg';
        const userSettingsModal = document.getElementById('user-settings-modal');
        const userAvatarEl = document.getElementById('user-avatar');
        const userAvatarLargeEl = document.getElementById('user-avatar-large');
        let userAvatarUrl = null;

        document.getElementById('user-info-btn').addEventListener('click', () => {
            // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèçÊò†
            document.getElementById('display-name-input').value = currentUserName;
            updateLoginSection();
            showModal(userSettingsModal);
        });

        document.getElementById('close-user-settings').addEventListener('click', () => {
            hideModal(userSettingsModal);
        });

        userSettingsModal.addEventListener('click', (e) => {
            if (e.target === userSettingsModal) hideModal(userSettingsModal);
        });

        // „Ç¢„Éê„Çø„Éº„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        document.getElementById('upload-avatar-btn').addEventListener('click', () => {
            document.getElementById('avatar-upload').click();
        });

        document.getElementById('avatar-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    userAvatarUrl = event.target.result;
                    userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                    userAvatarLargeEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                    // LocalStorage„Å´‰øùÂ≠ò
                    localStorage.setItem('userAvatar', userAvatarUrl);
                    // Firebase Realtime Database „Å´„ÇÇ‰øùÂ≠òÔºàStorage„ÅØ‰Ωø„Çè„Å™„ÅÑ„Åü„ÇÅ„ÄÅbase64„Éá„Éº„Çø„ÇíDB„Å´ÁΩÆ„ÅèÔºâ
                    if (currentUserId) {
                        try {
                            database.ref(`users/${currentUserId}`).update({
                                avatar: userAvatarUrl,
                                displayName: currentUserName || null
                            });
                        } catch (err) {
                            console.warn('DB„Å∏„Ç¢„Éê„Çø„Éº‰øùÂ≠òÂ§±Êïó:', err);
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // Google„É≠„Ç∞„Ç§„É≥
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        document.getElementById('google-login-btn').addEventListener('click', async () => {
            try {
                let result;
                const current = auth.currentUser;
                // Êó¢„Å´ÂåøÂêç„É¶„Éº„Ç∂„Éº„Å™„Çâ„É™„É≥„ÇØ„Åó„Å¶Âêå„ÅòUID„Å´Google„ÇíÁ¥ê‰ªò„Åë„Çã
                if (current && current.isAnonymous) {
                    try {
                        result = await current.linkWithPopup(googleProvider);
                    } catch (linkErr) {
                        // „É™„É≥„ÇØ„ÅåÂ§±Êïó„Åó„Åü„ÇâÈÄöÂ∏∏„ÅÆ„Çµ„Ç§„É≥„Ç§„É≥„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        console.warn('linkWithPopupÂ§±Êïó„ÄÅsignInWithPopup„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ:', linkErr);
                        result = await auth.signInWithPopup(googleProvider);
                    }
                } else {
                    result = await auth.signInWithPopup(googleProvider);
                }

                const user = result.user;
                currentUserId = user.uid;
                currentUserName = user.displayName || currentUserName || '„É¶„Éº„Ç∂„Éº';
                currentUserNameEl.textContent = currentUserName;
                document.getElementById('display-name-input').value = currentUserName;

                // Google„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè„Åå„ÅÇ„Çå„Å∞‰Ωø„ÅÑ„ÄÅÁÑ°„Åë„Çå„Å∞Google„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫
                if (user.photoURL) {
                    userAvatarUrl = user.photoURL;
                } else {
                    userAvatarUrl = GOOGLE_ICON_URL;
                }
                userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                userAvatarLargeEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;

                // DB„Å´„ÇÇ‰øùÂ≠òÔºà‰ªñ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂèñÂæó„Åß„Åç„Çã„Çà„ÅÜ„Å´Ôºâ
                try {
                    await database.ref(`users/${currentUserId}`).update({
                        displayName: currentUserName,
                        avatar: userAvatarUrl
                    });
                } catch (err) {
                    console.warn('„Éó„É≠„Éï„Ç£„Éº„É´DB‰øùÂ≠ò„Ç®„É©„Éº:', err);
                }

                updateLoginSection();
                console.log('Google„É≠„Ç∞„Ç§„É≥ÊàêÂäü:', user.email || user.uid);
            } catch (error) {
                console.error('Google„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                if (error && error.code === 'auth/popup-blocked') {
                    alert('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else if (error && error.code === 'auth/unauthorized-domain') {
                    alert('„Åì„ÅÆ„Éâ„É°„Ç§„É≥„ÅØË™çË®º„Å´‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇFirebase Console„ÅßAuthorized domains„Å´ËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    alert('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error && error.message ? error.message : error));
                }
            }
        });

        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                // ÂåøÂêç„ÅßÂÜç„É≠„Ç∞„Ç§„É≥
                const userCredential = await auth.signInAnonymously();
                currentUserId = userCredential.user.uid;
                currentUserName = '„Ç≤„Çπ„Éà';
                currentUserNameEl.textContent = currentUserName;
                userAvatarUrl = null;
                userAvatarEl.innerHTML = 'üë§';
                userAvatarLargeEl.innerHTML = 'üë§';
                localStorage.removeItem('userAvatar');
                updateLoginSection();
                console.log('„É≠„Ç∞„Ç¢„Ç¶„ÉàÂÆå‰∫Ü');
            } catch (error) {
                console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
            }
        });

        function updateLoginSection() {
            const user = auth.currentUser;
            const loginSection = document.getElementById('login-section');
            const logoutSection = document.getElementById('logout-section');
            
            if (user && !user.isAnonymous) {
                loginSection.style.display = 'none';
                logoutSection.style.display = 'block';
                document.getElementById('logged-in-email').textContent = `„É≠„Ç∞„Ç§„É≥‰∏≠: ${user.email}`;
            } else {
                loginSection.style.display = 'block';
                logoutSection.style.display = 'none';
            }
        }

        // Ë®≠ÂÆö‰øùÂ≠ò
        document.getElementById('save-user-settings').addEventListener('click', () => {
            const newName = document.getElementById('display-name-input').value.trim();
            if (newName) {
                currentUserName = newName;
                currentUserNameEl.textContent = newName;
                localStorage.setItem('userName', newName);
                // DB„Å´‰øùÂ≠òÔºàÂåøÂêçÂê´„ÇÄÔºâ
                if (currentUserId) {
                    try {
                        database.ref(`users/${currentUserId}`).update({
                            displayName: newName,
                            avatar: userAvatarUrl || null
                        });
                    } catch (err) {
                        console.warn('DB„Å∏„É¶„Éº„Ç∂„ÉºÂêç‰øùÂ≠òÂ§±Êïó:', err);
                    }
                }
            }
            hideModal(userSettingsModal);
        });

        // LocalStorage„Åã„ÇâÂæ©ÂÖÉ
        function restoreUserSettings() {
            const savedName = localStorage.getItem('userName');
            const savedAvatar = localStorage.getItem('userAvatar');
            
            if (savedName) {
                currentUserName = savedName;
                currentUserNameEl.textContent = savedName;
            }
            
            if (savedAvatar) {
                userAvatarUrl = savedAvatar;
                currentUserAvatar = savedAvatar;
                userAvatarEl.innerHTML = `<img src="${savedAvatar}" alt="avatar">`;
                userAvatarLargeEl.innerHTML = `<img src="${savedAvatar}" alt="avatar">`;
            }
        }

        // ========================================
        // ÂàùÊúüÂåñ
        // ========================================
        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserId = user.uid;
                console.log('Ë™çË®ºÁä∂ÊÖãÂ§âÊõ¥ - User ID:', currentUserId);
                
                if (!user.isAnonymous && user.displayName) {
                    currentUserName = user.displayName;
                    currentUserNameEl.textContent = currentUserName;
                }
                
                if (!user.isAnonymous && user.photoURL) {
                    userAvatarUrl = user.photoURL;
                    userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                }
                else if (user.providerData && user.providerData.some(p => p.providerId === 'google.com')) {
                    // Google„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Çã„ÅåphotoURL„ÇíÊåÅ„Åü„Å™„ÅÑÂ†¥Âêà„ÅØGoogle„Ç¢„Ç§„Ç≥„É≥„Çí‰Ωø„ÅÜ
                    userAvatarUrl = GOOGLE_ICON_URL;
                    userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                }
                // DB„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Éó„É≠„Éï„Ç£„Éº„É´„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÂÑ™ÂÖàÔºâ
                try {
                    database.ref(`users/${currentUserId}`).once('value').then((snap) => {
                        const profile = snap.val();
                        if (profile) {
                            if (profile.displayName) {
                                currentUserName = profile.displayName;
                                currentUserNameEl.textContent = currentUserName;
                                localStorage.setItem('userName', currentUserName);
                            }
                            if (profile.avatar) {
                                userAvatarUrl = profile.avatar;
                                currentUserAvatar = profile.avatar;
                                userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                                userAvatarLargeEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
                                localStorage.setItem('userAvatar', userAvatarUrl);
                            } else {
                                // ÁÑ°„Åë„Çå„Å∞Êó¢Â≠ò„ÅÆlocalStorage„ÇíÂæ©ÂÖÉ
                                restoreUserSettings();
                            }
                        } else {
                            restoreUserSettings();
                        }
                    }).catch((err) => {
                        console.warn('„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó„Ç®„É©„Éº:', err);
                        restoreUserSettings();
                    });
                } catch (err) {
                    console.warn('„Éó„É≠„Éï„Ç£„Éº„É´DB„ÉÅ„Çß„ÉÉ„ÇØÂ§±Êïó:', err);
                    restoreUserSettings();
                }

                subscribeToRooms();
                console.log('make10 vs - ÂàùÊúüÂåñÂÆå‰∫Ü');
            } else {
                // „É¶„Éº„Ç∂„Éº„Åå„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂåøÂêç„Çµ„Ç§„É≥„Ç§„É≥
                auth.signInAnonymously()
                    .then((userCredential) => {
                        currentUserId = userCredential.user.uid;
                        console.log('ÂåøÂêç„Çµ„Ç§„É≥„Ç§„É≥ÊàêÂäü');
                        console.log('User ID:', currentUserId);
                        restoreUserSettings();
                        subscribeToRooms();
                        console.log('make10 vs - ÂàùÊúüÂåñÂÆå‰∫Ü');
                    })
                    .catch((error) => {
                        console.error('ÂåøÂêç„Çµ„Ç§„É≥„Ç§„É≥Â§±Êïó:', error);
                        alert('„Çµ„Éº„Éê„Éº„Å∏„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    });
            }
        });

        // „É≠„Éì„Éº„ÅÆÂÜçË©¶Ë°å„Éª„Éò„É´„Éó„Éú„Çø„É≥Ë®≠ÂÆö
        document.addEventListener('DOMContentLoaded', () => {
            const retryBtn = document.getElementById('lobby-retry-btn');
            const helpBtn = document.getElementById('lobby-help-btn');
            if (retryBtn) retryBtn.addEventListener('click', attemptAuthAndSubscribe);
            if (helpBtn) helpBtn.addEventListener('click', () => {
                alert('„É´„Éº„É†ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇFirebase „ÅÆ Realtime Database „ÅÆ„É´„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n- ÈñãÁô∫‰∏≠„ÅØ‰∏ÄÊôÇÁöÑ„Å´ " .read": true „ÇíË®≠ÂÆö„Åó„Å¶Âãï‰ΩúÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô\n- Êú¨Áï™„Åß„ÅØ "auth != null" „Çí‰ΩøÁî®„Åó„ÄÅÂåøÂêç„É≠„Ç∞„Ç§„É≥(Anonymous)„ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            });
        });

        // debug handlers removed
    </script>
</body>
</html>
