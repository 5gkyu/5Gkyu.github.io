<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BANPIC - ãƒ–ãƒ­ã‚¹ã‚¿ãƒ„ãƒ¼ãƒ«</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

:root {
--primary-color: #4a90d9;
--primary-dark: #357abd;
--secondary-color: #2ecc71;
--danger-color: #e74c3c;
--warning-color: #f39c12;
--bg-color: #1a1a2e;
--card-bg: #16213e;
--text-color: #eee;
--text-muted: #888;
--border-radius: 12px;
}

body {
font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
background: var(--bg-color);
color: var(--text-color);
min-height: 100vh;
display: flex;
flex-direction: column;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
header {
background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
padding: 0.75rem 1rem;
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: 0 2px 10px rgba(0,0,0,0.3);
height: 60px;
flex-shrink: 0;
}

header h1 {
font-size: 1.5rem;
font-weight: bold;
letter-spacing: 2px;
}

header h1 span {
color: var(--warning-color);
}

.user-info {
display: flex;
align-items: center;
gap: 0.5rem;
font-size: 0.9rem;
cursor: pointer;
padding: 0.5rem;
border-radius: 8px;
transition: background 0.2s;
}

.user-info:hover {
background: rgba(255,255,255,0.1);
}

.user-avatar {
width: 32px;
height: 32px;
border-radius: 50%;
background: var(--primary-dark);
display: flex;
align-items: center;
justify-content: center;
font-size: 1rem;
overflow: hidden;
}

.user-avatar img {
width: 100%;
height: 100%;
object-fit: cover;
}

/* ã‚³ã‚¤ãƒ³ãƒˆã‚¹æ¼”å‡º */
.coin-toss-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
.coin-toss-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 1.5rem;
}
.coin {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ffd93d, #f39c12);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: bold;
    color: #333;
    box-shadow: 0 4px 20px rgba(255, 217, 61, 0.5);
    animation: coinFlip 1.5s ease-out forwards;
}
@keyframes coinFlip {
    0% { transform: rotateY(0deg) scale(1); }
    25% { transform: rotateY(360deg) scale(1.2); }
    50% { transform: rotateY(720deg) scale(1.3); }
    75% { transform: rotateY(1080deg) scale(1.2); }
    100% { transform: rotateY(1440deg) scale(1); }
}
.coin-result {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--warning-color);
    margin-top: 1.5rem;
    opacity: 0;
    animation: fadeInResult 0.5s ease-out 1.5s forwards;
}
@keyframes fadeInResult {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ãƒãƒƒãƒ—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¼”å‡º */
.map-preview-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: mapPreviewFadeIn 0.5s ease-out;
}
@keyframes mapPreviewFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.map-preview-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 1rem;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}
.map-preview-image {
    max-width: 80%;
    max-height: 60vh;
    border-radius: 12px;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
    animation: mapImageZoom 0.5s ease-out;
}
@keyframes mapImageZoom {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* ãƒ¢ãƒ¼ãƒ‰ãƒãƒŠãƒ¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å·¦ä¸Šï¼‰ */
.header-left {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
}
.mode-banner{
    display:flex;
    align-items:center;
    gap:0.6rem;
    position:relative;
    height: clamp(2rem, 4.5vw, 2.8rem);
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    background: linear-gradient(90deg, rgba(0,0,0,0.08), rgba(0,0,0,0.04));
}
.mode-banner .mode-logo{
    height: 100%;
    width: auto;
    display:block;
    border-radius:6px;
}
.mode-banner .banner-text{
    display:flex;
    flex-direction:column;
    text-align:left;
}
.mode-banner .mode-name{ font-weight:700; font-size: clamp(0.78rem, 1.8vw, 0.98rem); }
.mode-banner .map-name{ font-size: clamp(0.56rem, 1.4vw, 0.72rem); opacity:0.95; }

/* ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
.mode-controls{ display:flex; gap:0.4rem; align-items:center; }
.mode-controls select, .mode-controls input{ background: rgba(255,255,255,0.06); color:var(--text-color); border:1px solid rgba(255,255,255,0.06); padding:0.25rem 0.35rem; border-radius:6px; }




.user-info .status-dot {
width: 10px;
height: 10px;
background: var(--secondary-color);
border-radius: 50%;
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
.container {
flex: 1;
max-width: 100%;
width: 100%;
margin: 0 auto;
padding: 0;
overflow: hidden;
}

/* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
.screen {
display: none;
}

.screen.active {
display: block;
}

/* ãƒ­ãƒ“ãƒ¼ç”»é¢ */
#lobby-screen.active {
display: flex;
flex-direction: column;
gap: 1rem;
}

.pick-area {
    flex: 1 1 60%;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    min-width: 0;
}

.pick-row {
    display: flex;
    gap: 0.25rem;
    justify-content: center;
    flex: 1 1 auto;
    min-width: 0;
}

.pick-slot {
    min-width: 40px;
    min-height: 40px;
    aspect-ratio: 1 / 1;
    flex: 1 1 0;
    background: #222;
    border: 2px dashed #444;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(0.95rem, 3.2vw, 1.8rem);
    position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.btn:active {
transform: translateY(0);
}

.btn-primary {
background: linear-gradient(135deg, #4a90d9, #357abd);
color: white;
box-shadow: 0 4px 15px rgba(74, 144, 217, 0.4);
border: none;
}

.btn-primary:hover {
background: linear-gradient(135deg, #5a9fe9, #4080cd);
box-shadow: 0 6px 20px rgba(74, 144, 217, 0.5);
transform: translateY(-2px);
}

.btn-success {
background: linear-gradient(135deg, #2ecc71, #27ae60);
color: white;
box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
border: none;
}

.btn-success:hover {
background: linear-gradient(135deg, #3ddb80, #2ecc71);
box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5);
transform: translateY(-2px);
}

.btn-danger {
background: linear-gradient(135deg, #e74c3c, #c0392b);
color: white;
box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
border: none;
}

.btn-danger:hover {
background: linear-gradient(135deg, #f55c4e, #e74c3c);
box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5);
transform: translateY(-2px);
}

.btn-warning {
background: linear-gradient(135deg, #f39c12, #e67e22);
color: #000;
box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
border: none;
}

.btn-warning:hover {
background: linear-gradient(135deg, #f5ab35, #f39c12);
box-shadow: 0 6px 20px rgba(243, 156, 18, 0.5);
transform: translateY(-2px);
}

.btn-secondary {
background: linear-gradient(135deg, #555, #444);
color: white;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
border: none;
}

.btn-secondary:hover {
background: linear-gradient(135deg, #666, #555);
box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
transform: translateY(-2px);
}

/* ç®¡ç†è€…å‰Šé™¤ãƒœã‚¿ãƒ³ */
.btn-admin-delete {
padding: 0.3rem 0.5rem;
font-size: 0.8rem;
min-width: auto;
}

/* ãƒ«ãƒ¼ãƒ ä¸€è¦§ */
.room-list {
display: flex;
flex-direction: column;
gap: 0.75rem;
}

.room-list-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 0.5rem 0;
border-bottom: 1px solid #333;
margin-bottom: 0.5rem;
}

.room-count {
font-size: 0.9rem;
color: var(--text-muted);
}

.refresh-btn {
background: transparent;
border: none;
color: var(--primary-color);
cursor: pointer;
font-size: 1.2rem;
padding: 0.25rem;
}

.room-card {
background: var(--card-bg);
border-radius: var(--border-radius);
padding: 1rem;
display: flex;
justify-content: space-between;
align-items: center;
transition: all 0.2s ease;
border: 2px solid transparent;
}

.room-card:hover {
border-color: var(--primary-color);
transform: translateX(5px);
}

.room-info {
flex: 1;
}

/* ãƒ«ãƒ¼ãƒ ä¸€è¦§ç”¨ã‚¢ãƒã‚¿ãƒ¼ */
.room-avatar {
width: 48px;
height: 48px;
border-radius: 50%;
background: var(--primary-dark);
display: flex;
align-items: center;
justify-content: center;
font-size: 1.25rem;
overflow: hidden;
flex-shrink: 0;
}

.room-avatar img {
width: 100%;
height: 100%;
object-fit: cover;
}

/* ãƒ­ãƒ“ãƒ¼ã®ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼ */
.lobby-error {
background: #ffefef;
border: 1px solid #ffb3b3;
color: #7a1f1f;
padding: 0.75rem;
border-radius: 8px;
margin: 0.75rem 0;
text-align: center;
}

.lobby-error .lobby-error-text {
font-weight: bold;
}

/* ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰å†…ã§ã‚¢ãƒã‚¿ãƒ¼ã¨æƒ…å ±ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹èª¿æ•´ */
.room-card .room-info {
display: flex;
align-items: center;
gap: 0.75rem;
}
/* ãƒ­ãƒ“ãƒ¼å…¨ä½“ã®ä¸­å¤®å¯„ã›ã¨ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
#lobby-screen .lobby-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    max-width: 960px;
    margin: 0 auto 1rem;
    width: 100%;
}

.container {
    width: 100%;
    max-width: 1100px;
    margin: 0 auto;
    padding: 1rem;
}

.room-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.75rem;
    align-items: start;
    margin-top: 1rem;
}

/* ç©ºçŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚°ãƒªãƒƒãƒ‰å…¨å¹…ã«åºƒã’ã¦ä¸­å¤®å¯„ã›ã™ã‚‹ */
.room-list .empty-state {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.room-card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
}

.empty-state {
    text-align: center;
    padding: 2rem;
    width: 100%;
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å³ç«¯å¯„ã›ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å†…ï¼‰ */
header .user-info { margin-left: auto; }

.room-name {
font-size: 1.1rem;
font-weight: bold;
margin-bottom: 0.25rem;
display: flex;
align-items: center;
gap: 0.5rem;
}

.room-name .lock-icon {
font-size: 0.9rem;
color: var(--warning-color);
}

.room-meta {
font-size: 0.85rem;
color: var(--text-muted);
display: flex;
gap: 1rem;
}

.room-players {
display: flex;
align-items: center;
gap: 0.5rem;
}

.player-count {
background: var(--primary-color);
padding: 0.25rem 0.75rem;
border-radius: 20px;
font-size: 0.85rem;
font-weight: bold;
}

.player-count.full {
background: var(--danger-color);
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 40vh;
}

.empty-state .icon {
font-size: 3rem;
margin-bottom: 1rem;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.7);
justify-content: center;
align-items: center;
z-index: 1000;
padding: 1rem;
}

.modal-overlay.active {
display: flex;
}

.modal {
background: var(--card-bg);
border-radius: var(--border-radius);
width: 100%;
max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
padding: 1.5rem;
animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
from {
opacity: 0;
transform: translateY(-20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
}

.modal-header h3 {
font-size: 1.2rem;
}

.modal-close {
background: transparent;
border: none;
color: var(--text-muted);
font-size: 1.5rem;
cursor: pointer;
padding: 0;
line-height: 1;
}

.modal-close:hover {
color: var(--text-color);
}

/* ãƒ•ã‚©ãƒ¼ãƒ  */
.form-group {
margin-bottom: 1rem;
}

.form-group label {
display: block;
margin-bottom: 0.4rem;
font-size: 0.85rem;
color: var(--text-muted);
}

.form-group label .required {
color: var(--danger-color);
}

.form-group input,
.form-group select {
width: 100%;
padding: 0.75rem 1rem;
border: 2px solid #333;
border-radius: 8px;
background: var(--bg-color);
color: var(--text-color);
font-size: 1rem;
transition: border-color 0.2s ease;
}

.form-group input:focus,
.form-group select:focus {
outline: none;
border-color: var(--primary-color);
}

.form-group input::placeholder {
color: #555;
}

.form-actions {
display: flex;
gap: 0.75rem;
margin-top: 1.5rem;
}

.form-actions .btn {
flex: 1;
}

/* ãƒ¢ãƒ¼ãƒ‰ãƒ»ãƒãƒƒãƒ—ç”»åƒã‚°ãƒªãƒƒãƒ‰é¸æŠ */
.mode-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.4rem;
    margin-top: 0.3rem;
}
.mode-grid-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem;
    background: var(--card-bg);
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.mode-grid-item:hover {
    background: rgba(74, 144, 217, 0.15);
}
.mode-grid-item.selected {
    border-color: var(--primary-color);
    background: rgba(74, 144, 217, 0.25);
}
.mode-grid-item img {
    width: 48px;
    height: 48px;
    object-fit: contain;
    border-radius: 6px;
}
.mode-grid-item .mode-label {
    font-size: 0.75rem;
    margin-top: 0.3rem;
    text-align: center;
    color: var(--text-color);
}

.map-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.4rem;
    margin-top: 0.3rem;
    max-height: 280px;
    overflow-y: auto;
}
.map-grid-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.4rem;
    background: var(--card-bg);
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.map-grid-item:hover {
    background: rgba(74, 144, 217, 0.15);
}
.map-grid-item.selected {
    border-color: var(--secondary-color);
    background: rgba(46, 204, 113, 0.2);
}
.map-grid-item img {
    width: 100%;
    max-width: 90px;
    height: 60px;
    object-fit: contain;
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.2);
}
.map-grid-item .map-label {
    font-size: 0.7rem;
    margin-top: 0.25rem;
    text-align: center;
    color: var(--text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
}

/* æ¨ªé•·ç”»é¢ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»PCï¼‰å¯¾å¿œ */
@media (min-width: 768px) {
    .modal {
        max-width: 700px;
        max-height: 95vh;
    }
    
    #create-room-modal .modal {
        max-width: 850px;
        max-height: 95vh;
        padding: 1.2rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    #create-room-modal .modal-header {
        margin-bottom: 1rem;
        flex-shrink: 0;
    }
    
    #create-room-modal form {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    #create-room-modal .modal-body {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 1.5rem;
        flex: 1;
        overflow: hidden;
    }
    
    #create-room-modal .settings-column {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }
    
    #create-room-modal .selection-column {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        min-height: 0;
    }
    
    #create-room-modal .form-group-mode {
        flex-shrink: 0;
    }
    
    #create-room-modal .form-group-map {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }
    
    #create-room-modal .form-group-map .map-grid {
        flex: 1;
        min-height: 0;
    }
    
    #create-room-modal .form-group {
        margin-bottom: 0;
    }
    
    #create-room-modal .form-actions {
        margin-top: 1rem;
        flex-shrink: 0;
        grid-column: 1 / -1;
    }
    
    .mode-grid {
        overflow: visible;
        max-height: none;
    }
    
    .map-grid {
        overflow-y: auto;
        max-height: 100%;
    }
    
    .mode-grid-item,
    .map-grid-item {
        padding: 0.35rem;
    }
    
    .mode-grid-item img {
        width: 42px;
        height: 42px;
    }
    
    .map-grid-item img {
        max-width: 100%;
        height: 55px;
    }
}

@media (min-width: 1024px) {
    #create-room-modal .modal {
        max-width: 950px;
    }
    
    #create-room-modal .modal-body {
        grid-template-columns: 300px 1fr;
    }
    
    .mode-grid-item img {
        width: 48px;
        height: 48px;
    }
    
    .map-grid-item img {
        height: 60px;
    }
}

/* å¾…æ©Ÿç”»é¢ */
#waiting-screen {
text-align: center;
padding: 2rem;
}

.waiting-room-info {
background: var(--card-bg);
border-radius: var(--border-radius);
padding: 2rem;
margin-bottom: 2rem;
}

.waiting-room-name {
font-size: 1.5rem;
font-weight: bold;
margin-bottom: 1rem;
}

.waiting-players {
display: flex;
justify-content: center;
align-items: center;
gap: 2rem;
margin: 2rem 0;
}

.waiting-player {
text-align: center;
}

.waiting-vs {
display: flex;
align-items: center;
justify-content: center;
font-size: 2rem;
font-weight: bold;
color: #555;
min-width: 60px;
}

.player-avatar {
width: 80px;
height: 80px;
border-radius: 50%;
background: var(--primary-color);
display: flex;
align-items: center;
justify-content: center;
font-size: 2rem;
margin: 0 auto 0.5rem;
overflow: hidden;
}

.player-avatar img {
width: 100%;
height: 100%;
object-fit: cover;
border-radius: 50%;
}

.player-avatar.empty {
background: #333;
border: 3px dashed #555;
}

.player-name {
font-weight: bold;
}

.waiting-status {
color: var(--text-muted);
margin-bottom: 1rem;
}

.waiting-spinner {
display: inline-block;
width: 30px;
height: 30px;
border: 3px solid #333;
border-top-color: var(--primary-color);
border-radius: 50%;
animation: spin 1s linear infinite;
margin-bottom: 1rem;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* ã‚²ãƒ¼ãƒ ç”»é¢ */
#game-screen.active {
display: flex;
flex-direction: column;
justify-content: flex-start; /* ä¸Šã‹ã‚‰é…ç½® */
align-items: stretch;
height: calc(100vh - 80px);
max-height: calc(100vh - 80px);
overflow-y: auto;
}

.game-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 0.75rem;
background: var(--card-bg);
border-radius: var(--border-radius);
margin-bottom: 0.5rem;
}

.game-player {
text-align: center;
flex: 1;
}

.game-player-info {
display: flex;
align-items: center;
justify-content: center;
gap: 0.5rem;
}

.game-player-avatar {
width: 32px;
height: 32px;
border-radius: 50%;
background: var(--primary-color);
display: flex;
align-items: center;
justify-content: center;
font-size: 1rem;
overflow: hidden;
}

.game-player-avatar img {
width: 100%;
height: 100%;
object-fit: cover;
border-radius: 50%;
}

.game-player-name {
font-weight: bold;
font-size: 1rem;
margin-bottom: 0.25rem;
}

.game-player-name.highlight {
color: var(--warning-color);
}

.game-score {
display: flex;
justify-content: center;
gap: 0.25rem;
}

.score-dot {
width: 20px;
height: 20px;
border-radius: 50%;
background: #333;
border: 2px solid #555;
}

.score-dot.win {
background: var(--secondary-color);
border-color: var(--secondary-color);
}

.score-dot.lose {
background: var(--danger-color);
border-color: var(--danger-color);
}

.game-vs {
font-size: 1.2rem;
font-weight: bold;
color: #555;
padding: 0 0.25rem;
}

/* å•é¡Œã‚¨ãƒªã‚¢ */
.game-main {
flex: 1;
display: flex;
flex-direction: column;
background: var(--card-bg);
border-radius: var(--border-radius);
padding: 1rem;
margin-bottom: 0.5rem;
min-height: 0;
}

.round-info {
text-align: center;
margin-bottom: 0.5rem;
}

.round-number {
font-size: 1.1rem;
color: var(--text-muted);
}

.difficulty {
display: inline-block;
padding: 0.25rem 0.75rem;
border-radius: 20px;
font-size: 0.8rem;
margin-left: 0.5rem;
}

.difficulty-1 { background: #27ae60; }
.difficulty-2 { background: #2ecc71; }
.difficulty-3 { background: #f39c12; }
.difficulty-4 { background: #e67e22; }
.difficulty-5 { background: #e74c3c; }

.problem-display {
flex: 1;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}

.problem-digits {
display: flex;
justify-content: center;
gap: 1rem;
margin: 1rem 0;
}

.digit-card {
width: 60px;
height: 70px;
background: linear-gradient(135deg, #4a90d9, #357abd);
border-radius: 10px;
display: flex;
align-items: center;
justify-content: center;
font-size: 2rem;
font-weight: bold;
box-shadow: 0 4px 8px rgba(0,0,0,0.3);
cursor: pointer;
transition: all 0.15s ease;
user-select: none;
}

.digit-card:hover:not(.used) {
transform: scale(1.1);
box-shadow: 0 6px 12px rgba(0,0,0,0.4);
}

.digit-card:active:not(.used) {
transform: scale(0.95);
}

.digit-card.used {
opacity: 0.3;
transform: scale(0.85);
cursor: not-allowed;
background: #444;
}

/* ã‚¿ã‚¤ãƒãƒ¼ */
.timer-container {
text-align: center;
margin: 0.5rem 0;
}

.timer-bar {
height: 8px;
background: #333;
border-radius: 4px;
overflow: hidden;
margin-bottom: 0.5rem;
}

.timer-fill {
height: 100%;
background: linear-gradient(90deg, var(--secondary-color), var(--warning-color));
transition: width 0.1s linear;
}

.timer-fill.danger {
background: linear-gradient(90deg, var(--warning-color), var(--danger-color));
}

.timer-text {
font-size: 1.5rem;
font-weight: bold;
}

/* å¼è¡¨ç¤º */
.expression-display {
background: var(--bg-color);
border: 2px solid #333;
border-radius: 10px;
padding: 1rem;
min-height: 60px;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.5rem;
font-family: 'Consolas', monospace;
margin: 0.5rem 0;
}

.expression-display.correct {
border-color: var(--secondary-color);
background: rgba(46, 204, 113, 0.1);
}

.expression-display.wrong {
border-color: var(--danger-color);
background: rgba(231, 76, 60, 0.1);
}

.expression-result {
text-align: center;
font-size: 1rem;
color: var(--text-muted);
margin-bottom: 0.5rem;
}

.expression-result.valid {
color: var(--secondary-color);
}

/* æ¼”ç®—å­ãƒ»æ‹¬å¼§ãƒœã‚¿ãƒ³è¡Œ */
.operator-row {
    /* ã‚°ãƒªãƒƒãƒ‰ã«ã—ã¦å¹…ã«å¿œã˜ã¦2è¡Œã«æŠ˜ã‚Šè¿”ã—ã‚„ã™ãã™ã‚‹ï¼ˆUIå´©ã‚Œå¯¾ç­–ï¼‰ */
    display: grid;
    grid-template-columns: repeat(5, minmax(44px, 1fr));
    gap: 0.5rem;
    margin: 0.75rem 0;
}

.op-btn {
    width: 100%;
    height: 50px;
    font-size: 1.5rem;
    font-weight: bold;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.15s ease;
    background: var(--warning-color);
    color: #000;
}

.op-btn:hover {
transform: scale(1.1);
background: #e67e22;
}

.op-btn:active {
transform: scale(0.95);
}

.op-btn.bracket {
background: #9b59b6;
color: #fff;
}

.op-btn.bracket:hover {
background: #8e44ad;
}

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³è¡Œ */
.action-row {
    display: grid;
    grid-template-columns: repeat(3, minmax(44px, 1fr));
    gap: 0.75rem;
    margin: 0.5rem 0;
}

.action-btn {
padding: 0.6rem 1.2rem;
font-size: 1rem;
font-weight: bold;
border: none;
border-radius: 8px;
cursor: pointer;
transition: all 0.15s ease;
}

.action-btn:hover {
transform: scale(1.05);
}

.action-btn:active {
transform: scale(0.95);
}

.action-btn.backspace {
background: #555;
color: #fff;
}

.action-btn.reset {
background: var(--danger-color);
color: #fff;
}

.action-btn.hint {
background: var(--info-color, #3498db);
color: #fff;
}

.action-btn.hint:disabled {
background: #444;
opacity: 0.5;
cursor: not-allowed;
}

/* Mobile adjustments: make game screen fit a single smartphone viewport */
@media (max-width: 420px) {
.game-screen {
padding: 0.5rem;
}

.game-header, .game-main {
padding: 0.25rem 0.5rem;
}

.digit-card {
width: 48px;
height: 56px;
font-size: 1.6rem;
margin: 0 0.25rem;
}

.problem-digits {
display: flex;
gap: 0.4rem;
justify-content: center;
flex-wrap: nowrap;
}

.operator-row {
gap: 0.4rem;
padding: 0.25rem 0;
}

.op-btn {
width: 40px;
height: 40px;
font-size: 1.1rem;
border-radius: 10px;
}

.action-row { gap: 0.5rem; }

.action-btn { padding: 0.45rem 0.8rem; font-size: 0.9rem; }

.expression-display {
    min-height: 44px;
    font-size: 1.1rem;
    padding: 0.5rem;
}

.expression-result { font-size: 0.9rem; }

.timer-text { font-size: 1.1rem; }

.round-info { gap: 0.4rem; }
.round-number { font-size: 1rem; }
.difficulty { font-size: 0.85rem; }

.problem-display { margin-bottom: 0.4rem; }

.user-avatar-large { width: 56px; height: 56px; font-size: 1.6rem; }

.opponent-status { font-size: 0.8rem; padding: 0.4rem; }
}

/* ç›¸æ‰‹ã®çŠ¶æ…‹è¡¨ç¤º */
.opponent-status {
text-align: center;
padding: 0.5rem;
background: rgba(0,0,0,0.3);
border-radius: 8px;
font-size: 0.85rem;
color: var(--text-muted);
}

.opponent-status.submitted {
color: var(--warning-color);
}

.opponent-status.correct {
color: var(--secondary-color);
}

/* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.countdown-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.8);
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
z-index: 500;
}

.countdown-overlay.hidden {
display: none;
}

.countdown-round {
font-size: 1.5rem;
color: var(--text-muted);
margin-bottom: 1rem;
}

.countdown-number {
font-size: 8rem;
font-weight: bold;
color: var(--primary-color);
animation: countPulse 1s ease-in-out infinite;
}

@keyframes countPulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.1); }
}

/* çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.result-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.85);
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
z-index: 500;
}

.result-overlay.hidden {
display: none;
}

.result-title {
font-size: 2rem;
font-weight: bold;
margin-bottom: 1rem;
}

.result-title.win {
color: var(--secondary-color);
}

.result-title.lose {
color: var(--danger-color);
}

.result-title.draw {
color: var(--warning-color);
}

.result-answer {
background: var(--card-bg);
padding: 1.5rem 2rem;
border-radius: var(--border-radius);
margin-bottom: 1rem;
}

.result-answer-label {
font-size: 0.9rem;
color: var(--text-muted);
margin-bottom: 0.5rem;
}

.result-answer-expr {
font-size: 1.5rem;
font-family: 'Consolas', monospace;
}

/* ãƒãƒƒãƒçµæœ */
.match-result-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.9);
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
z-index: 600;
}

.match-result-overlay.hidden {
display: none;
}

.match-result-title {
font-size: 3rem;
font-weight: bold;
margin-bottom: 2rem;
}

.match-result-score {
font-size: 4rem;
font-weight: bold;
margin-bottom: 2rem;
}

.match-result-players {
display: flex;
align-items: center;
justify-content: center;
gap: 2rem;
margin-bottom: 2rem;
}

.match-result-player {
display: flex;
flex-direction: column;
align-items: center;
gap: 0.5rem;
}

.match-result-avatar {
width: 80px;
height: 80px;
border-radius: 50%;
background: var(--card-bg);
display: flex;
align-items: center;
justify-content: center;
font-size: 2.5rem;
overflow: hidden;
border: 3px solid var(--text-muted);
}

.match-result-avatar img {
width: 100%;
height: 100%;
object-fit: cover;
}

.match-result-name {
font-size: 1rem;
color: var(--text-color);
max-width: 100px;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}

.match-result-vs {
font-size: 1.5rem;
font-weight: bold;
color: var(--text-muted);
}

.match-result-avatar.winner {
    border-color: var(--success-color);
    box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.12);
}
.match-result-avatar.loser {
    border-color: var(--danger-color);
    opacity: 0.7;
}
.match-result-avatar.draw {
    border-color: var(--text-muted);
}

/* ç‹å† è¡¨ç¤ºï¼ˆã‚¢ãƒã‚¿ãƒ¼ä¸Šéƒ¨ï¼‰ */
.match-result-avatar.winner::after,
.game-player-avatar.winner::after {
    content: "ğŸ‘‘";
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 18px;
    pointer-events: none;
}

.game-player-avatar { position: relative; }

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
.user-avatar-large {
width: 100px;
height: 100px;
border-radius: 50%;
background: var(--primary-color);
display: flex;
align-items: center;
justify-content: center;
font-size: 3rem;
margin: 0 auto;
overflow: hidden;
}

.user-avatar-large img {
width: 100%;
height: 100%;
object-fit: cover;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 600px) {
header {
flex-direction: column;
gap: 0.5rem;
text-align: center;
}

.lobby-header {
flex-direction: column;
text-align: center;
}

.room-card {
flex-direction: column;
gap: 1rem;
text-align: center;
}

.room-meta {
justify-content: center;
}

.waiting-players {
flex-direction: column;
}

.digit-card {
width: 50px;
height: 60px;
font-size: 1.5rem;
}

.input-btn {
padding: 0.6rem;
font-size: 1.1rem;
}

.expression-display {
font-size: 1.2rem;
}
}

/* ========================================
   BANPIC ã‚²ãƒ¼ãƒ ç”»é¢ ã‚¹ã‚¿ã‚¤ãƒ«
   ======================================== */

#game-screen.active {
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* ä¸Šã‹ã‚‰é…ç½® */
    align-items: stretch;
    height: calc(100vh - 60px);
    max-height: calc(100vh - 60px);
    padding: 0;
    margin: 0;
    max-width: 100%;
    overflow: hidden;
    overflow-y: auto; /* å¿…è¦æ™‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
}

/* ãƒãƒƒãƒ—ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ */
.map-display-area {
    width: 100%;
    background: linear-gradient(180deg, #0f0f1a, #1a1a2e);
    border-bottom: 2px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.4rem 0.5rem;
    flex-shrink: 0;
    height: auto;
    min-height: 50px;
}
.map-display-area .banpic-mode-banner {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0.6rem;
    border-radius: 8px;
    background: linear-gradient(135deg, rgba(74, 144, 217, 0.2), rgba(74, 144, 217, 0.1));
    border: 1px solid rgba(74, 144, 217, 0.3);
    transition: all 0.2s ease;
}
.map-display-area .banpic-mode-banner:hover {
    background: linear-gradient(135deg, rgba(74, 144, 217, 0.3), rgba(74, 144, 217, 0.2));
    transform: scale(1.02);
}
.map-display-area .mode-logo {
    height: 32px;
    width: auto;
    border-radius: 6px;
}
.map-display-area .banner-text {
    display: flex;
    flex-direction: column;
    text-align: left;
}
.map-view-hint {
    font-size: 1.2rem;
    margin-left: 0.3rem;
    opacity: 0.8;
}

/* banpic-header å†…ã«é…ç½®ã—ãŸãƒãƒŠãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä»¥å‰ã® .map-display-area ã¨åŒç­‰ï¼‰ */
.banpic-header .banpic-mode-banner,
.banpic-mode-banner {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0.6rem;
    border-radius: 8px;
    background: linear-gradient(135deg, rgba(74, 144, 217, 0.2), rgba(74, 144, 217, 0.1));
    border: 1px solid rgba(74, 144, 217, 0.3);
    transition: all 0.2s ease;
}
.banpic-header .banpic-mode-banner:hover,
.banpic-mode-banner:hover {
    background: linear-gradient(135deg, rgba(74, 144, 217, 0.3), rgba(74, 144, 217, 0.2));
    transform: scale(1.02);
}
.banpic-header .mode-logo, .banpic-mode-banner .mode-logo {
    height: 32px;
    width: auto;
    border-radius: 6px;
}
.banpic-header .banner-text, .banpic-mode-banner .banner-text {
    display: flex;
    flex-direction: column;
    text-align: left;
}


/* ãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« */
.map-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    flex-direction: column;
    padding: 1rem;
    box-sizing: border-box;
}
.map-modal-overlay.active {
    display: flex;
}
.map-modal-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    max-width: 95vw;
    max-height: 85vh;
}
.map-modal-timer {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--warning-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.map-modal-image {
    max-width: 100%;
    max-height: 65vh;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}
.map-modal-close {
    padding: 0.8rem 2rem;
    font-size: 1.1rem;
    font-weight: bold;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.map-modal-close:hover {
    background: #357abd;
    transform: scale(1.05);
}

.banpic-header {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.3rem 0.5rem;
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-bottom: 2px solid #333;
    flex-shrink: 0;
    min-height: 50px;
    height: auto;
    flex-wrap: wrap;
    gap: 0.3rem;
}

.banpic-spacer {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0.35rem 0.5rem;
    box-sizing: border-box;
    background: transparent;
}
.banpic-spacer .banpic-phase-display {
    width: 100%;
    max-width: 980px;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0.6rem;
    border-radius: 8px;
    background: rgba(0,0,0,0.03);
}

/* ã‚¹ãƒãƒ›ç¸¦å‘ã */
@media (max-width: 600px) and (orientation: portrait) {
    .banpic-header {
        flex-direction: column !important;
        align-items: center !important;
        padding: 0.4rem !important;
        gap: 0.3rem !important;
        height: auto !important;
        min-height: auto !important;
    }
    .banpic-mode-banner {
        order: 1;
        width: 100% !important;
        max-width: 100% !important;
        justify-content: flex-start !important;
        flex-shrink: 0;
        display: flex !important;
        align-items: center !important;
        padding: 0.3rem 0.5rem !important;
    }
    .banpic-phase-display {
        order: 2;
        width: 100% !important;
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        text-align: left !important;
        padding: 0.2rem 0.5rem !important;
        background: rgba(0,0,0,0.02) !important;
        border-radius: 8px !important;
    }
    .phase-text {
        font-size: 0.9rem !important;
    }
    .phase-timer {
        justify-content: center !important;
    }
}

/* ã‚¹ãƒãƒ›æ¨ªå‘ã: ä¸Šéƒ¨è¦‹åˆ‡ã‚Œå¯¾ç­– */
@media (max-height: 500px) and (orientation: landscape) {
    #game-screen.active {
        height: auto !important;
        max-height: none !important;
        min-height: 100vh;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
        justify-content: flex-start !important;
    }
    .banpic-header {
        min-height: 36px;
        padding: 0.15rem 0.4rem;
        flex-shrink: 0;
    }
    .phase-indicator {
        min-height: 24px;
        padding: 0.1rem 0.3rem;
        flex-shrink: 0;
    }
    .banpic-slots {
        padding: 0.25rem;
        flex-shrink: 0;
    }
    .banpic-actions {
        min-height: 36px;
        padding: 0.2rem 0.4rem;
        flex-shrink: 0;
    }
    .character-grid-container {
        flex-shrink: 0;
        min-height: 80px;
    }
}

.banpic-phase-display {
    text-align: center;
}

.phase-text {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--warning-color);
}

.phase-timer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    margin-top: 0.25rem;
}

.timer-icon {
    font-size: 0.9rem;
}

.timer-value {
    font-size: 1rem;
    font-weight: bold;
    color: var(--danger-color);
}

.btn-sm {
    padding: 0.4rem 0.75rem;
    font-size: 0.9rem;
}

/* ãƒ•ã‚§ãƒ¼ã‚ºã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.phase-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: #111;
    flex-shrink: 0;
    min-height: 32px;
}

.phase-indicator-wrapper {
    display: flex;
    justify-content: center;
    gap: 0.25rem;
    flex: 1;
}

.phase-step {
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    font-weight: bold;
    border-radius: 4px;
    background: #333;
    color: #666;
    transition: all 0.3s ease;
}

.phase-step.active {
    background: var(--warning-color);
    color: #000;
}

/* PICãƒ•ã‚§ãƒ¼ã‚ºã®ãƒãƒ¼ãƒ è‰²ï¼ˆå…ˆæ”»=145=é’ã€å¾Œæ”»=236=èµ¤ï¼‰ */
.phase-step.active[data-phase="pic1"],
.phase-step.active[data-phase="pic4"],
.phase-step.active[data-phase="pic5"] {
    background: #4a90d9;
    color: #fff;
}

.phase-step.active[data-phase="pic2"],
.phase-step.active[data-phase="pic3"],
.phase-step.active[data-phase="pic6"] {
    background: #e74c3c;
    color: #fff;
}

.phase-step.completed {
    background: var(--secondary-color);
    color: #fff;
}

/* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
.character-grid-container {
    overflow-x: auto;
    overflow-y: hidden;
    background: transparent;
    flex: 0 0 auto;
    min-height: 0;
    height: fit-content;
}

.character-grid {
    display: grid;
    grid-template-rows: repeat(2, minmax(60px, 75px));
    grid-auto-flow: column;
    gap: 0.4rem;
    padding: 0.4rem 0.3rem;
    height: fit-content;
    min-height: auto;
}

.character-card {
    width: 95px;
    height: 70px;
    background: linear-gradient(135deg, #4a90d9, #357abd);
    border-radius: 6px;
    display: flex;
    align-items: flex-end;
    justify-content: flex-start;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    border: 3px solid transparent;
    flex-shrink: 0;
    overflow: hidden;
}

.character-card:hover:not(.banned):not(.picked) {
    transform: scale(1.1);
    border-color: var(--warning-color);
    z-index: 10;
}

.character-card.selected {
    border-color: var(--warning-color);
    box-shadow: 0 0 10px var(--warning-color);
}

.character-card.banned {
    cursor: not-allowed;
    position: relative;
}

.character-card.banned::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(231, 76, 60, 0.75);
    z-index: 2;
}

.character-card.banned::after {
    content: 'ç¦æ­¢';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.1rem;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    z-index: 3;
    pointer-events: none;
}

.character-card.picked {
    cursor: not-allowed;
    position: relative;
}

.character-card.picked::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 2;
}

.character-card.picked::after {
    content: 'é¸æŠæ¸ˆ';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.9rem;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    z-index: 3;
    pointer-events: none;
}

.character-card.banned .char-name,
.character-card.picked .char-name {
    opacity: 1;
    z-index: 4;
}

.character-card .char-icon {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
}

.character-card .char-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.character-card .char-name {
    position: relative;
    z-index: 3;
    font-size: 0.62rem;
    font-weight: 600;
    text-align: left;
    color: #fff;
    padding: 0.25rem 0.35rem;
    background: linear-gradient(to top, rgba(0,0,0,0.75), rgba(0,0,0,0.4), transparent);
    width: 100%;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.character-card .ban-overlay {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background: var(--danger-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    z-index: 5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.character-card .rarity-badge {
    display: none;
}

/* ãƒ¬ã‚¢åº¦ã”ã¨ã®èƒŒæ™¯è‰² */
.character-card[data-rarity="1"] {
    background: linear-gradient(135deg, #6c757d, #495057);
}
/* ãƒ¬ã‚¢: é»„ç·‘ */
.character-card[data-rarity="2"] {
    background: linear-gradient(135deg, #9be564, #57b846);
}
/* ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¬ã‚¢: é’ï¼ˆå¾“æ¥ã®ãƒ¬ã‚¢è‰²ï¼‰ */
.character-card[data-rarity="3"] {
    background: linear-gradient(135deg, #4a90e2, #2e5f9e);
}
.character-card[data-rarity="4"] {
    background: linear-gradient(135deg, #e056fd, #b03bc2);
}
.character-card[data-rarity="5"] {
    background: linear-gradient(135deg, #ff4757, #c23647);
}
.character-card[data-rarity="6"] {
    background: linear-gradient(135deg, #ffd93d, #f39c12);
}
/* ã‚¦ãƒ«ãƒˆãƒ©ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰: é»’ */
.character-card[data-rarity="7"] {
    background: linear-gradient(135deg, #1a1a1a, #000000);
}

/* BAN/PICK ã‚¹ãƒ­ãƒƒãƒˆã‚¨ãƒªã‚¢ */
.banpic-slots {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0.5rem;
    background: linear-gradient(90deg, rgba(8,28,64,1) 0%, rgba(8,28,64,0.95) 35%, rgba(96,16,16,0.95) 65%, rgba(96,16,16,1) 100%);
    border-top: 2px solid #333;
    flex-shrink: 0;
    gap: 0.5rem;
    flex-wrap: nowrap;
    overflow: hidden;
    width: 100%;
    box-sizing: border-box;
    min-height: fit-content;
    position: relative;
}

.ban-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.1rem;
    min-width: 28px;
    flex-shrink: 0;
}

.ban-label {
    display: none;
}

.ban-left .ban-label {
    display: none;
}

.ban-right .ban-label {
    display: none;
}

.ban-slots {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

/* ä¸­å¤®ã®VSç”»åƒã‚¹ãƒšãƒ¼ã‚¹ï¼ˆPICã‚¹ãƒ­ãƒƒãƒˆé–“ã®ä¸­å¤®ã«é…ç½®ï¼‰ */
.vs-center {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 68px;
    height: 68px;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 10;
}
.vs-center .vs-text { display:flex; align-items:center; justify-content:center; width:100%; height:100%; font-weight:900; color: #fff; font-size: 1.6rem; letter-spacing: -1px; text-shadow: 0 2px 6px rgba(0,0,0,0.6); }

/* PICã‚¹ãƒ­ãƒƒãƒˆå·¦ä¸‹ã®ãƒ”ãƒƒã‚¯é †ãƒãƒƒã‚¸ï¼ˆé»’ä¸¸ã«ç™½æ–‡å­—ï¼‰ */
.pick-order {
    position: absolute;
    left: 4px;
    bottom: 4px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #000;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    border: 2px solid #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.7);
    z-index: 100;
    pointer-events: none;
}

.ban-slot {
    min-width: 38px;
    min-height: 38px;
    aspect-ratio: 1 / 1;
    flex: 0 0 auto;
    background: #262737; /* å°‘ã—æ˜ã‚‹ã‚ã®ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
    border: 2px dashed #666; /* æ˜ã‚‹ã‚ã®ã‚°ãƒ¬ãƒ¼æ  */
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    overflow: hidden;
}

.ban-slot.filled {
    border-style: solid;
    border-color: var(--danger-color);
}

.ban-slot img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 4px;
}

.ban-slot.filled img {
    filter: grayscale(100%);
    opacity: 0.7;
}

/* ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºã‚’ã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã¯å‰Šé™¤ï¼‰ */
.slot-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    line-height: 1;
    font-size: 1.1rem; /* åŸºæœ¬ã‚µã‚¤ã‚º */
}
.slot-icon-pick {
    font-size: 1.8rem; /* PICK ã¯å¤§ãã‚ */
}

/* ç¢ºå®šãƒã‚§ãƒƒã‚¯ã®è¡¨ç¤º */
.slot-check {
    position: absolute;
    right: 6px;
    bottom: 6px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #28a745;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    line-height: 1;
    box-shadow: 0 1px 3px rgba(0,0,0,0.35);
    opacity: 0.98;
}

/* æœªç¢ºå®šé¸æŠã¯è–„ãè¦‹ã›ã‚‹ */
.ban-slot.selected {
    outline: 2px dashed rgba(255,255,255,0.08);
}

/* PIC é¸æŠæ™‚: æ—¢å­˜ã®é’/èµ¤ã®è‰²ã‚’ç™½ç³»ã«ç½®ãæ›ãˆã‚‹ï¼ˆè¿½åŠ ã®ç™½ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã¯ä½¿ã‚ãªã„ï¼‰ */
.pick-row-blue .pick-slot.pic-phase-active,
.pick-row-red .pick-slot.pic-phase-active {
    border-color: rgba(255,255,255,0.95) !important;
    background: rgba(255,255,255,0.06) !important;
    box-shadow: none !important;
}

/* æœªæ±ºå®šã‚¹ãƒ­ãƒƒãƒˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã¯å°‘ã—å†…å´ã«ã—ã¦å¤§ãã™ããªã„ã‚ˆã†ã«ã™ã‚‹ */
.ban-slot.empty img {
    width: 84%;
    height: 84%;
    object-fit: cover;
    border-radius: 6px;
}
.pick-slot.empty img {
    width: 90%;
    height: 90%;
    object-fit: cover;
    border-radius: 6px;
}

/* ã‚¹ãƒ­ãƒƒãƒˆã®æœ€å¤§ã‚µã‚¤ã‚ºã‚’åˆ¶é™ã—ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒãŒéåº¦ã«æ‹¡å¤§ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
.ban-slot, .pick-slot {
    box-sizing: border-box;
    max-width: 160px;
    max-height: 160px;
}

/* æœªæ±ºå®šã‚¹ãƒ­ãƒƒãƒˆã®ç”»åƒã¯æ å†…ã«åã‚ã‚‹ï¼ˆæ‹¡å¤§æŠ‘åˆ¶ï¼‰ */
.ban-slot.empty img,
.pick-slot.empty img {
    object-fit: contain;
    width: 78%;
    height: 78%;
    max-width: 140px;
    max-height: 140px;
    background: transparent;
}

/* ãƒ”ãƒƒã‚¯ã‚¹ãƒ­ãƒƒãƒˆã®æ‹¡å¼µã‚’æŠ‘ãˆã¤ã¤ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚’ä¿ã¤ */
:root {
    --slot-size: min(11vw, 90px);
    --ban-slot-size: min(5.5vw, 50px);
}

/* PICK ã‚¹ãƒ­ãƒƒãƒˆã¯å®Œå…¨ãªæ­£æ–¹å½¢ */
.pick-slot {
    width: var(--slot-size);
    height: var(--slot-size);
    min-width: 50px;
    min-height: 50px;
    max-width: 90px;
    max-height: 90px;
    aspect-ratio: 1 / 1;
    flex: 0 0 auto;
}

/* BANã‚¹ãƒ­ãƒƒãƒˆã¯åŸºæœ¬çš„ã«å›ºå®šå¯„ã‚Šã«ã™ã‚‹ï¼ˆåˆ—å†…ã§æºã‚‰ãŒãªã„ã‚ˆã†ã«ï¼‰ */
.ban-slot {
    flex: 0 0 auto;
    width: var(--ban-slot-size);
    height: var(--ban-slot-size);
    min-width: 30px;
    min-height: 30px;
    max-width: 50px;
    max-height: 50px;
}

.ban-left .ban-slot {
    border-color: #4a90d9;
}

.ban-right .ban-slot {
    border-color: #e74c3c;
}

/* PICK ã‚¨ãƒªã‚¢ */
.pick-area {
    flex: 0 1 auto;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 5.5rem;
    min-width: 0;
    position: relative;
}

.pick-row {
    display: flex;
    gap: 0.4rem;
    justify-content: center;
}

.pick-slot {
    width: var(--slot-size);
    height: var(--slot-size);
    min-width: 55px;
    min-height: 55px;
    aspect-ratio: 1 / 1;
    flex: 0 0 auto;
    background: #222;
    border: 2px dashed #444;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: visible;
    font-size: clamp(0.9rem, 2.6vw, 1.5rem);
    position: relative;
    overflow: hidden;
}

.pick-slot.filled {
    border-style: solid;
}

.pick-slot img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 6px;
}

.pick-row-blue .pick-slot {
    border-color: #4a90d9;
    background: rgba(74, 144, 217, 0.1);
}

.pick-row-red .pick-slot {
    border-color: #e74c3c;
    background: rgba(231, 76, 60, 0.1);
}



/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ */
.banpic-actions {
    padding: 0.5rem 0.75rem;
    background: #111;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    min-height: 50px;
    gap: 1rem;
}

.player-info-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.player-info-display.left {
    justify-content: flex-start;
    margin-right: auto;
}

.player-info-display.right {
    justify-content: flex-end;
    margin-left: auto;
    flex-direction: row-reverse;
}

.player-display-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    overflow: hidden;
    flex-shrink: 0;
}

.player-display-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.player-display-name {
    font-weight: bold;
    font-size: 1rem;
    color: var(--text-color);
}



/* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç¢ºå®šãƒœã‚¿ãƒ³ */
.floating-confirm-btn {
    position: fixed;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
    font-weight: bold;
    background: var(--secondary-color);
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    transition: all 0.2s ease;
}

.floating-confirm-btn:hover:not(:disabled) {
    transform: translateX(-50%) scale(1.05);
    box-shadow: 0 6px 16px rgba(0,0,0,0.5);
}

.floating-confirm-btn:disabled {
    background: #555;
    cursor: not-allowed;
    opacity: 0.5;
}

/* ãƒãƒŠãƒ¼å†…ã«ç½®ãç¢ºå®šãƒœã‚¿ãƒ³ï¼ˆãƒãƒŠãƒ¼å³ç«¯ã«è¡¨ç¤ºï¼‰ */
.confirm-in-actions {
    padding: 0.45rem 0.9rem;
    font-size: 0.95rem;
    font-weight: 700;
    background: var(--secondary-color);
    color: #000;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
.confirm-in-actions:disabled { opacity: 0.6; background: #777; color: #ddd; cursor: not-allowed; }

@media (orientation: landscape) and (max-height: 480px) {
    .floating-confirm-btn { display: none !important; }
    .confirm-in-actions { padding: 0.28rem 0.6rem; font-size: 0.85rem; }
}

.mode-name {
    font-size: 1rem;
    font-weight: bold;
    color: var(--text-color);
}

.map-name {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
}

/* ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒãƒƒã‚¸ */
.test-mode-indicator {
    position: fixed;
    top: 70px;
    right: 10px;
    z-index: 100;
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆèª¿æ•´ (iPadç­‰) */
@media (min-width: 768px) and (max-width: 1024px) {
    :root {
        --slot-size: 12vw;
        --ban-slot-size: 6vw;
    }
    
    .character-card {
        width: 90px;
        height: 66px;
    }
    
    .character-card .char-name {
        font-size: 0.58rem;
        padding: 0.2rem 0.3rem;
    }
    
    .character-grid {
        grid-template-rows: repeat(2, 66px);
        height: fit-content;
        gap: 0.35rem;
    }
    
    .ban-slot {
        width: 5vw;
        height: 5vw;
        min-width: 40px;
        min-height: 40px;
        max-width: 55px;
        max-height: 55px;
        aspect-ratio: 1 / 1;
        flex: 0 0 auto;
        font-size: 0.95rem;
    }
    
    .pick-slot {
        width: 10vw;
        height: 10vw;
        min-width: 65px;
        min-height: 65px;
        max-width: 85px;
        max-height: 85px;
        aspect-ratio: 1 / 1;
        flex: 0 0 auto;
        font-size: clamp(0.85rem, 2.2vw, 1.35rem);
    }
    
    .pick-area {
        gap: 1.5rem;
    }
    
    .pick-row {
        gap: 0.4rem;
    }
    
    .ban-slots {
        gap: 0.3rem;
    }
    
    .banpic-slots {
        padding: 0.5rem 0.4rem;
        gap: 0.4rem;
    }
    
    .phase-text {
        font-size: 0.9rem;
    }
    
    .phase-step {
        font-size: 0.68rem;
        padding: 0.22rem 0.45rem;
    }
}

/* slot-icon ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
@media (min-width: 768px) and (max-width: 1024px) {
    .slot-icon { font-size: 1.2rem; }
    .slot-icon-pick { font-size: 1.9rem; }
}

@media (max-width: 767px) {
    .slot-icon { font-size: 1.0rem; }
    .slot-icon-pick { font-size: 1.6rem; }
}

@media (max-width: 480px) {
    .slot-icon { font-size: 0.95rem; }
    .slot-icon-pick { font-size: 1.3rem; }
}

/* ã‚¹ãƒãƒ›ã§ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒå¤§ãã™ãã‚‹å•é¡Œã‚’è§£æ¶ˆ */
@media (max-width: 480px) {
    .slot-check {
        width: 12px;
        height: 12px;
        font-size: 9px;
        right: 4px;
        bottom: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
}

@media (max-width: 767px) and (min-width: 481px) {
    .slot-check {
        width: 14px;
        height: 14px;
        font-size: 9.5px;
        right: 5px;
        bottom: 5px;
    }
}

/* ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
@media (max-width: 767px) {
    .character-card {
        width: 85px;
        height: 62px;
    }
    
    .character-card .char-name {
        font-size: 0.55rem;
        padding: 0.2rem 0.3rem;
    }
    
    .character-card.banned::after {
        font-size: 0.95rem;
    }
    
    .character-card.picked::after {
        font-size: 0.75rem;
    }
    
    .character-grid {
        grid-template-rows: repeat(2, 64px);
        height: fit-content;
        gap: 0.35rem;
        padding-bottom: 0.4rem;
    }
    
    .ban-slot {
        width: 38px;
        height: 38px;
        min-width: 32px;
        min-height: 32px;
        max-width: 45px;
        max-height: 45px;
        aspect-ratio: 1 / 1;
        flex: 0 0 auto;
        font-size: 0.7rem;
    }
    
    .ban-column {
        min-width: auto;
    }
    
    .ban-label {
        display: none;
    }
    
    .pick-slot {
        width: 60px;
        height: 60px;
        min-width: 50px;
        min-height: 50px;
        max-width: 70px;
        max-height: 70px;
        aspect-ratio: 1 / 1;
        flex: 0 0 auto;
        font-size: clamp(0.8rem, 2.4vw, 1.1rem);
    }
    
    .pick-area {
        gap: 1rem;
        min-width: 0;
    }
    
    .pick-row {
        gap: 0.35rem;
    }
    
    .ban-slots {
        gap: 0.25rem;
    }
    
    .banpic-slots {
        gap: 0.3rem;
        padding: 0.4rem 0.3rem;
    }
    
    .phase-text {
        font-size: 0.8rem;
    }
    
    .phase-step {
        font-size: 0.62rem;
        padding: 0.18rem 0.38rem;
    }
    
    .mode-name {
        font-size: 0.85rem;
    }
    
    .map-name {
        font-size: 0.72rem;
    }
    
    .banpic-header {
        padding: 0.35rem 0.65rem;
    }
    
    .vs-divider {
        font-size: 0.95rem;
        padding: 0 0.22rem;
    }
    
    .banpic-slots {
        padding: 0.5rem;
    }
    
    .player-display-avatar {
        width: 30px;
        height: 30px;
        font-size: 1rem;
    }
    
    .player-display-name {
        font-size: 0.85rem;
    }
    
    .vs-text {
        font-size: 1.2rem;
    }
    
    .floating-confirm-btn {
        bottom: 60px;
        padding: 0.6rem 1.5rem;
        font-size: 0.95rem;
    }
}

@media (max-width: 480px) {
    .character-card {
        width: 75px;
        height: 58px;
    }
    
    .character-card .char-name {
        font-size: 0.52rem;
        padding: 0.18rem 0.25rem;
    }
    
    .character-card.banned::after {
        font-size: 0.85rem;
    }
    
    .character-card.picked::after {
        font-size: 0.7rem;
    }
    
    .character-grid {
        grid-template-rows: repeat(2, 58px);
        height: fit-content;
        gap: 0.3rem;
        padding-bottom: 0.3rem;
    }
    
    .player-display-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.9rem;
    }
    
    .player-display-name {
        font-size: 0.75rem;
    }
    
    .vs-text {
        font-size: 1rem;
    }
    
    .floating-confirm-btn {
        bottom: 58px;
        padding: 0.55rem 1.2rem;
        font-size: 0.85rem;
    }
    
    .ban-slot {
        width: 30px;
        height: 30px;
        min-width: 26px;
        min-height: 26px;
        max-width: 36px;
        max-height: 36px;
        aspect-ratio: 1 / 1;
        flex: 0 0 auto;
        font-size: 0.6rem;
    }
    
    .ban-column {
        min-width: auto;
    }
    
    .ban-label {
        display: none;
    }
    
    .pick-slot {
        width: 50px;
        height: 50px;
        min-width: 42px;
        min-height: 42px;
        max-width: 58px;
        max-height: 58px;
        aspect-ratio: 1 / 1;
        flex: 0 0 auto;
        font-size: clamp(0.7rem, 2.2vw, 0.9rem);
    }
    
    .pick-area {
        gap: 0.8rem;
        min-width: 0;
    }
    
    .pick-row {
        gap: 0.3rem;
    }
    
    .ban-slots {
        gap: 0.2rem;
    }
    
    .banpic-slots {
        padding: 0.3rem 0.2rem;
        gap: 0.25rem;
    }
    
    .phase-text {
        font-size: 0.72rem;
    }
    
    .phase-step {
        font-size: 0.58rem;
        padding: 0.15rem 0.28rem;
    }
    
    .mode-name {
        font-size: 0.8rem;
    }
    
    .map-name {
        font-size: 0.68rem;
    }
    
    .timer-value {
        font-size: 0.85rem;
    }
    
    .vs-divider {
        font-size: 0.85rem;
        padding: 0 0.18rem;
    }
    
    .btn-lg {
        padding: 0.55rem 1.3rem;
        font-size: 0.95rem;
    }
    
    .banpic-slots {
        padding: 0.45rem;
    }
    
    .banpic-header {
        padding: 0.3rem 0.55rem;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã§ãƒãƒŠãƒ¼ã¨ãƒ•ã‚§ãƒ¼ã‚ºã‚’å·¦å³ã«é…ç½® */
    .banpic-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }
    
    .phase-indicator {
        padding: 0.3rem 0.4rem;
    }
    
    .banpic-actions {
        padding: 0.6rem 1.5rem;
        font-size: 1rem;
    }
    
    .banpic-slots {
        padding: 0.5rem;
        gap: 0.3rem;
    }
    
    .banpic-header {
        padding: 0.35rem 0.6rem;
    }
    /* ãƒãƒŠãƒ¼ã‚’å·¦ç«¯ã«å¯„ã›ã‚‹ä¸Šæ›¸ããƒ«ãƒ¼ãƒ« */
    .banpic-header {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    .banpic-mode-banner {
        margin-left: 0 !important;
    }

    /* ãƒãƒŠãƒ¼ã‚’ç”»é¢å·¦ç«¯ã«å›ºå®šé…ç½®ã—ã€ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºã®ãŸã‚ã«ä½™ç™½ã‚’ç¢ºä¿ */
    .banpic-header {
        position: relative;
    }
    .banpic-mode-banner {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        z-index: 20;
    }
    .banpic-header .banpic-phase-display {
        margin-left: 240px; /* ãƒãƒŠãƒ¼å¹…åˆ†ã®ä½™ç™½ï¼ˆå¿…è¦ãªã‚‰èª¿æ•´ï¼‰ */
    }
}
</style>

<!-- Override: å¤ã„ absolute ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒãƒŠãƒ¼/ãƒ•ã‚§ãƒ¼ã‚ºã‚’æ­£å¸¸è¡¨ç¤º -->
<style>
    .banpic-header { position: static !important; padding-left: 0.4rem !important; padding-right: 0.4rem !important; align-items: flex-start !important; }
    .banpic-mode-banner { position: static !important; left: auto !important; top: auto !important; transform: none !important; margin-left: 0 !important; z-index: 1 !important; width: auto !important; max-width: 420px !important; display: flex !important; align-items: center !important; }
    .banpic-header .banpic-phase-display { margin-left: 0 !important; width: 100% !important; max-width: 980px !important; }
    .banpic-spacer { display: flex !important; }
    /* ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºã‚’å…¨ãƒ‡ãƒã‚¤ã‚¹ã§ä¸­å¤®å¯„ã›ã«çµ±ä¸€ */
    .banpic-phase-display {
        display: flex !important;
        flex-direction: row !important;
        justify-content: center !important;
        align-items: center !important;
        gap: 0.5rem !important;
        text-align: center !important;
        width: 100% !important;
    }
    .banpic-phase-display .phase-text { text-align: center !important; }
    .banpic-phase-display .phase-timer { justify-content: center !important; }
</style>
</head>
<style>
/* å¼·åˆ¶ä¸Šæ›¸ã: ãƒãƒŠãƒ¼ã¨ãƒ•ã‚§ãƒ¼ã‚ºã‚’åˆ¥è¡Œã§è¡¨ç¤ºï¼ˆå…¨ãƒ‡ãƒã‚¤ã‚¹ï¼‰ */
.banpic-header {
    display: flex !important;
    flex-direction: column !important;
    align-items: stretch !important;
    justify-content: center !important;
    gap: 0.4rem !important;
    padding: 0.35rem 0.5rem !important;
}
.banpic-mode-banner {
    position: relative !important;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 auto !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 0.32rem 0.6rem !important;
}
.banpic-spacer {
    width: 100% !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 0.18rem 0.5rem !important;
}
.banpic-spacer .banpic-phase-display,
.banpic-phase-display {
    width: 100% !important;
    max-width: 980px !important;
    display: flex !important;
    flex-direction: row !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 0.5rem !important;
    text-align: center !important;
}
/* ç„¡åŠ¹åŒ–: å¤ã„ absolute ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã®ä¸Šæ›¸ã */
.banpic-mode-banner[style], .banpic-mode-banner { left: auto !important; top: auto !important; transform: none !important; }
</style>
<style>
/* ã‚¹ãƒãƒ›æ¨ªå‘ãï¼ˆé«˜ã•ãŒå°ã•ã„ç«¯æœ«ï¼‰ã§1ç”»é¢ã«åã‚ã‚‹ãŸã‚ã®ç¸®å°ãƒ«ãƒ¼ãƒ« */
@media (orientation: landscape) and (max-height: 480px) {
    #game-screen.active {
        height: 100vh !important;
        max-height: 100vh !important;
        /* å°ã•ã„æ¨ªç”»é¢ã§ã¯ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ã—ã¦ä¸‹éƒ¨è¦ç´ ã‚’è¡¨ç¤º */
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
        padding-bottom: 72px !important; /* ä¸‹éƒ¨é ˜åŸŸã‚’ç¢ºä¿ */
    }
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
    .banpic-header {
        padding: 0.12rem 0.25rem !important;
        min-height: 28px !important;
        gap: 0.12rem !important;
    }
    .banpic-mode-banner {
        padding: 0.08rem 0.3rem !important;
    }
    .banpic-mode-banner .mode-logo { height: 20px !important; }
    .banpic-mode-banner .banner-text { gap: 0.08rem !important; }
    .banpic-spacer { padding: 0.08rem 0.2rem !important; }
    .banpic-spacer .banpic-phase-display { padding: 0.08rem 0.3rem !important; }
    .phase-text { font-size: 0.78rem !important; }
    .phase-timer .timer-value { font-size: 0.85rem !important; }

    /* ä¸‹éƒ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’ç¢ºå®Ÿã«è¡¨ç¤º */
    .banpic-actions {
        position: relative !important;
        z-index: 30 !important;
        display: flex !important;
        justify-content: space-between !important;
        padding: 0.08rem 0.5rem !important;
        background: rgba(0,0,0,0.02) !important;
        border-radius: 6px !important;
    }

    .banpic-confirm-area {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 0.5rem;
    }
    .confirm-in-actions {
        /* ensure visible on dark bg */
        background: var(--secondary-color);
        color: #000;
    }

    /* ã‚­ãƒ£ãƒ©ã‚°ãƒªãƒƒãƒ‰ç¸®å° */
    .character-grid { grid-template-rows: repeat(2, minmax(40px, 48px)) !important; gap: 0.18rem !important; padding: 0.15rem !important; }
    .character-card { width: 68px !important; height: 48px !important; }
    .character-card .char-name { font-size: 0.56rem !important; padding: 0.15rem !important; }

    /* BAN/PICK ã‚¹ãƒ­ãƒƒãƒˆã‚’å°ã•ã */
    .banpic-slots { padding: 0.2rem !important; gap: 0.18rem !important; }
    .ban-slot, .pick-slot { min-width: 30px !important; min-height: 30px !important; max-width: 110px !important; max-height: 110px !important; }
    .vs-center { width: 48px !important; height: 48px !important; }
    .pick-order { width: 18px !important; height: 18px !important; font-size: 0.65rem !important; left: 3px !important; bottom: 3px !important; }

    /* ãƒ•ã‚§ãƒ¼ã‚ºã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚‚å°ã•ã */
    .phase-indicator { padding: 0.12rem 0.2rem !important; }
    .phase-step { font-size: 0.6rem !important; padding: 0.18rem 0.36rem !important; }

    /* ãƒ†ã‚­ã‚¹ãƒˆç¸®å° */
    body, #game-screen { font-size: 0.92rem !important; }
}
</style>
<body>
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header>
    <div class="header-left">
        <h1 style="font-size:1rem; color: #fff;">BANPIC</h1>
    </div>
    <!-- mode banner removed: injected dynamically via applyBanner() when needed -->
    <div class="user-info" id="user-info-btn">
        <div class="user-avatar" id="user-avatar">ğŸ‘¤</div>
        <span class="status-dot"></span>
        <span id="current-user-name">ã‚²ã‚¹ãƒˆ</span>
    </div>
</header>

<div class="container">
<!-- ãƒ­ãƒ“ãƒ¼ç”»é¢ -->
<div id="lobby-screen" class="screen active">
<div class="lobby-header">
<h2>ğŸ® ãƒ«ãƒ¼ãƒ ä¸€è¦§</h2>
<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
<button class="btn btn-primary" id="create-room-btn">
â• ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
</button>
<button class="btn btn-warning" id="test-mode-btn" style="background: var(--warning-color); color: #000;">
ğŸ¤– ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
</button>
</div>
</div>

<div class="room-list-header">
<span class="room-count" id="room-count">0 éƒ¨å±‹</span>
<button class="refresh-btn" id="refresh-btn" title="æ›´æ–°">ğŸ”„</button>
</div>

<div class="lobby-error" id="lobby-error" style="display:none;">
<div class="lobby-error-text" id="lobby-error-text">ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚</div>
<div style="margin-top:0.5rem; display:flex; gap:0.5rem; justify-content:center;">
<button class="btn btn-primary" id="lobby-retry-btn">å†è©¦è¡Œ</button>
<button class="btn" id="lobby-help-btn">ãƒ˜ãƒ«ãƒ—</button>
</div>
</div>
<!-- debug panel removed -->
<div class="room-list" id="room-list">
<!-- ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
<div class="empty-state" id="empty-state">
<div class="icon">ğŸ¯</div>
<p>ç¾åœ¨å‹Ÿé›†ä¸­ã®ãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</p>
<p style="margin-top: 0.5rem; font-size: 0.9rem;">æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã¡ã¾ã—ã‚‡ã†ï¼</p>
</div>
</div>
</div>

<!-- å¾…æ©Ÿç”»é¢ -->
<div id="waiting-screen" class="screen">
<div class="waiting-room-info">
<div class="waiting-room-name" id="waiting-room-name">ãƒ«ãƒ¼ãƒ å</div>
<div class="waiting-status">
<span id="waiting-room-id">Room ID: ---</span>
</div>

<div class="waiting-players">
<div class="waiting-player">
<div class="player-avatar" id="host-avatar">ğŸ‘‘</div>
<div class="player-name" id="host-name">ãƒ›ã‚¹ãƒˆ</div>
<div style="font-size: 0.8rem; color: var(--text-muted);">ãƒ›ã‚¹ãƒˆ</div>
</div>
<div class="waiting-vs">
<span>VS</span>
</div>
<div class="waiting-player">
<div class="player-avatar empty" id="guest-avatar">?</div>
<div class="player-name" id="guest-name">å¾…æ©Ÿä¸­...</div>
<div style="font-size: 0.8rem; color: var(--text-muted);">ã‚²ã‚¹ãƒˆ</div>
</div>
</div>

<div class="waiting-spinner" id="waiting-spinner"></div>
<p id="waiting-message">å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
</div>

<button class="btn btn-danger" id="leave-room-btn">ğŸšª ãƒ«ãƒ¼ãƒ ã‚’é€€å‡º</button>
</div>

<!-- BANPIC ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="game-screen" class="screen">
    <!-- ä¸Šéƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼: ãƒãƒŠãƒ¼ï¼ˆå·¦ï¼‰ã¨ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå³ï¼‰ -->
    <div class="banpic-header">
        <div class="banpic-mode-banner" id="banpic-mode-banner" style="cursor: pointer;" onclick="openMapModal()">
                <img id="banpic-mode-logo" class="mode-logo" src="image/e-soccer.png" alt="mode logo">
                <div class="banner-text">
                    <div class="mode-name" id="banpic-mode">ãƒ–ãƒ­ã‚¹ãƒˆãƒ©ã‚¤ã‚«ãƒ¼</div>
                    <div class="map-name" id="banpic-map">é™ã‹ãªåºƒå ´</div>
                        <div id="first-move-indicator" style="font-size:0.78rem; color:var(--text-muted); margin-top:2px;">å…ˆæ”»: ãƒ©ãƒ³ãƒ€ãƒ </div>
                </div>
                <span class="map-view-hint">ğŸ–¼ï¸</span>
            </div>
    </div>

    <!-- ãƒ•ã‚§ãƒ¼ã‚ºã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div class="phase-indicator">
        <div class="phase-indicator-wrapper">
            <div class="phase-step active" data-phase="ban">BAN</div>
            <div class="phase-step" data-phase="pic1">PIC1</div>
            <div class="phase-step" data-phase="pic2">PIC2</div>
            <div class="phase-step" data-phase="pic3">PIC3</div>
            <div class="phase-step" data-phase="pic4">PIC4</div>
            <div class="phase-step" data-phase="pic5">PIC5</div>
            <div class="phase-step" data-phase="pic6">PIC6</div>
            <div class="phase-step" data-phase="done">çµ‚äº†</div>
        </div>
        <!-- ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ï¼ˆå³ç«¯ã«é…ç½®ï¼‰ -->
        <button class="btn btn-secondary btn-sm" id="sort-toggle-btn" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;" title="è¡¨ç¤ºé †ã‚’å¤‰æ›´">ğŸ“Š</button>
    </div>

    <!-- ãƒãƒŠãƒ¼ã¨ã‚­ãƒ£ãƒ©ã®é–“ã®ã‚¹ãƒšãƒ¼ã‚¹: ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºã‚’ã“ã“ã«é…ç½® -->
    <div class="banpic-spacer">
        <div class="banpic-phase-display">
            <span class="phase-text" id="phase-text">ä½¿ç”¨ç¦æ­¢ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æŒ‡å®šã—ã¦ãã ã•ã„</span>
            <div class="phase-timer">
                <span class="timer-icon">â±</span>
                <span class="timer-value" id="phase-timer">20ç§’</span>
            </div>
        </div>
    </div>

    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã‚¨ãƒªã‚¢ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
    <div class="character-grid-container">
        <div class="character-grid" id="character-grid">
            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
    </div>

    <!-- ä¸‹éƒ¨: BAN/PICK ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤º -->
    <div class="banpic-slots">
        <!-- å·¦å´: è‡ªåˆ†ã®BANã‚¹ãƒ­ãƒƒãƒˆ (ç¸¦3ã¤) -->
        <div class="ban-column ban-left">
            <div class="ban-label">BAN</div>
            <div class="ban-slots" id="ban-slots-left">
                <div class="ban-slot empty" data-slot="0"></div>
                <div class="ban-slot empty" data-slot="1"></div>
                <div class="ban-slot empty" data-slot="2"></div>
            </div>
        </div>

        <!-- ä¸­å¤®: PICKã‚¹ãƒ­ãƒƒãƒˆ (6ã¤ã€3x3 â†’ ä¸Šæ®µè‡ªåˆ†ã€ä¸‹æ®µç›¸æ‰‹ ãªã©ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) -->
        <div class="pick-area">
            <div class="pick-row pick-row-blue" id="pick-slots-blue">
                <div class="pick-slot empty" data-slot="0"><span class="pick-order">1</span></div>
                <div class="pick-slot empty" data-slot="1"><span class="pick-order">2</span></div>
                <div class="pick-slot empty" data-slot="2"><span class="pick-order">3</span></div>
            </div>
            <div class="pick-row pick-row-red" id="pick-slots-red">
                <div class="pick-slot empty" data-slot="0"><span class="pick-order">4</span></div>
                <div class="pick-slot empty" data-slot="1"><span class="pick-order">5</span></div>
                <div class="pick-slot empty" data-slot="2"><span class="pick-order">6</span></div>
            </div>
        </div>

        <!-- ä¸­å¤®: VS ãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒšãƒ¼ã‚¹ -->
        <div class="vs-center" aria-hidden="true">
            <span class="vs-text">VS</span>
        </div>

        <!-- å³å´: ç›¸æ‰‹ã®BANã‚¹ãƒ­ãƒƒãƒˆ (ç¸¦3ã¤) -->
        <div class="ban-column ban-right">
            <div class="ban-label">BAN</div>
            <div class="ban-slots" id="ban-slots-right">
                <div class="ban-slot empty" data-slot="0"></div>
                <div class="ban-slot empty" data-slot="1"></div>
                <div class="ban-slot empty" data-slot="2"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="banpic-actions">
        <div class="player-info-display left">
            <div class="player-display-avatar" id="blue-player-avatar">ğŸ‘¤</div>
            <div class="player-display-name" id="blue-player-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</div>
        </div>
        <div class="banpic-confirm-area">
            <button id="confirm-selection-btn" class="confirm-in-actions" disabled>é¸æŠã‚’ç¢ºå®š</button>
        </div>
        <div class="player-info-display right">
            <div class="player-display-avatar" id="red-player-avatar">ğŸ‘¤</div>
            <div class="player-display-name" id="red-player-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</div>
        </div>
    </div>
    
</div>
    <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç¢ºå®šãƒœã‚¿ãƒ³ï¼ˆå‰Šé™¤ã€‚ãƒãƒŠãƒ¼å†…ã®ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ï¼‰ -->
</div>

<!-- ãƒãƒƒãƒ—ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="map-modal-overlay" id="map-modal" onclick="closeMapModal()">
    <div class="map-modal-content">
        <div class="map-modal-timer">
            <span class="timer-icon">â±</span>
            <span id="map-modal-timer-value">20ç§’</span>
        </div>
        <img id="map-modal-image" class="map-modal-image" src="" alt="ãƒãƒƒãƒ—ç”»åƒ">
    </div>
</div>

<!-- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰é–‹å§‹ãƒœã‚¿ãƒ³ï¼ˆãƒ­ãƒ“ãƒ¼ã«è¿½åŠ ï¼‰ -->

<!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="create-room-modal">
<div class="modal">
<div class="modal-header">
<h3>ğŸ® ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</h3>
<button class="modal-close" id="close-create-modal">&times;</button>
</div>
<form id="create-room-form">
<div class="modal-body">
<div class="settings-column">
<div class="form-group">
<label>ãƒ«ãƒ¼ãƒ å</label>
<input type="text" id="room-name-input" placeholder="ãƒ«ãƒ¼ãƒ 1" maxlength="20">
</div>
<div class="form-group">
<label>åˆ¶é™æ™‚é–“ï¼ˆBAN/PICï¼‰</label>
<select id="room-timer-select" required>
<option value="20" selected>20ç§’</option>
<option value="30">30ç§’</option>
<option value="40">40ç§’</option>
</select>
</div>
<div class="form-group">
<label>å…ˆæ”»å¾Œæ”»</label>
<select id="room-first-move-select" required>
<option value="random" selected>ãƒ©ãƒ³ãƒ€ãƒ </option>
<option value="host">ãƒ›ã‚¹ãƒˆå…ˆæ”»</option>
<option value="guest">ã‚²ã‚¹ãƒˆå…ˆæ”»</option>
</select>
</div>
<div class="form-group">
<label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</label>
<input type="password" id="room-password-input" placeholder="ãªã—ã®å ´åˆã¯ç©ºæ¬„">
</div>
</div>
<div class="selection-column">
<div class="form-group form-group-mode">
<label>ãƒ¢ãƒ¼ãƒ‰</label>
<input type="hidden" id="room-mode-select" value="eme">
<div class="mode-grid" id="mode-grid">
<!-- ãƒ¢ãƒ¼ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ãŒJSã§æŒ¿å…¥ã•ã‚Œã‚‹ -->
</div>
</div>
<div class="form-group form-group-map">
<label>ãƒãƒƒãƒ—</label>
<input type="hidden" id="room-map-select" value="">
<div class="map-grid" id="map-grid">
<!-- ãƒãƒƒãƒ—ç”»åƒãŒJSã§æŒ¿å…¥ã•ã‚Œã‚‹ -->
</div>
</div>
</div>
</div>
<div class="form-actions">
<button type="button" class="btn btn-secondary" id="cancel-create-room">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
<button type="submit" class="btn btn-primary">ä½œæˆã™ã‚‹</button>
</div>
</form>
</div>
</div>

<!-- ãƒ«ãƒ¼ãƒ å‚åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="join-room-modal">
<div class="modal">
<div class="modal-header">
<h3>ğŸš€ ãƒ«ãƒ¼ãƒ ã«å‚åŠ </h3>
<button class="modal-close" id="close-join-modal">&times;</button>
</div>
<form id="join-room-form">
<div class="form-group">
<label>å‚åŠ ã™ã‚‹ãƒ«ãƒ¼ãƒ </label>
<input type="text" id="join-room-name" readonly style="background: #222;">
</div>
<div class="form-group">
<label>ã‚ãªãŸã®åå‰</label>
<input type="text" id="guest-name-input" placeholder="ã‚²ã‚¹ãƒˆ" maxlength="10">
</div>
<div class="form-group" id="join-password-group" style="display: none;">
<label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="required">*</span></label>
<input type="password" id="join-password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
</div>
<input type="hidden" id="join-room-id">
<div class="form-actions">
<button type="button" class="btn btn-secondary" id="cancel-join-room">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
<button type="submit" class="btn btn-success">å‚åŠ ã™ã‚‹</button>
</div>
</form>
</div>
</div>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="user-settings-modal">
<div class="modal">
<div class="modal-header">
<h3>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</h3>
<button class="modal-close" id="close-user-settings">&times;</button>
</div>
<div style="text-align: center; margin-bottom: 1.5rem;">
<div class="user-avatar-large" id="user-avatar-large">ğŸ‘¤</div>
<input type="file" id="avatar-upload" accept="image/*" style="display: none;">
<button class="btn btn-secondary" id="upload-avatar-btn" style="margin-top: 1rem;">
ğŸ“· ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
</button>
</div>
<div class="form-group">
<label>è¡¨ç¤ºå</label>
<input type="text" id="display-name-input" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="10">
</div>
<div id="login-section">
<p style="color: var(--text-muted); margin-bottom: 1rem; text-align: center;">
Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€åå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³ãŒä¿å­˜ã•ã‚Œã¾ã™
</p>
<button class="btn btn-primary" id="google-login-btn" style="width: 100%;">
<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="width: 20px; height: 20px;">
Googleã§ãƒ­ã‚°ã‚¤ãƒ³
</button>
</div>
<div id="logout-section" style="display: none;">
<p style="color: var(--text-muted); margin-bottom: 1rem; text-align: center;" id="logged-in-email"></p>
<button class="btn btn-danger" id="logout-btn" style="width: 100%;">
ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
</button>
</div>
<div class="form-actions" style="margin-top: 1.5rem;">
<button class="btn btn-success" id="save-user-settings" style="width: 100%;">ä¿å­˜</button>
</div>
</div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// ========================================
// Firebase åˆæœŸåŒ–
// ========================================
const firebaseConfig = {
apiKey: "AIzaSyBM_6leTzC3lKdmO_b4nvb0SgubTSn2rO0",
authDomain: "make10vs.firebaseapp.com",
databaseURL: "https://make10vs-default-rtdb.firebaseio.com",
projectId: "make10vs",
storageBucket: "make10vs.firebasestorage.app",
messagingSenderId: "461653417380",
appId: "1:461653417380:web:d0c64a9c8b0b5498fc7531",
measurementId: "G-35DCQ7MMMR"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// ========================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
// ========================================
let currentUserId = null;
let currentUserName = 'ã‚²ã‚¹ãƒˆ';
let currentRoomId = null;
let currentRoomRef = null;
let roomsListener = null;
let hostHeartbeatInterval = null;
let guestHeartbeatInterval = null;
// room expiry timers: { roomId: timeoutId }
const roomExpiryTimers = {};

// ç”»åƒãƒ‡ãƒ¼ã‚¿
let IMAGE_DATA = null;
let BRAWLERS = [];

// ========================================
// ç”»åƒãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// ========================================
async function loadImageData() {
    try {
        const response = await fetch('image-data-full.json');
        IMAGE_DATA = await response.json();
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        BRAWLERS = IMAGE_DATA.brawlers || [];
        
        // ãƒ¢ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ã¨ãƒãƒƒãƒ—ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
        populateModeGrid();
        const initialMode = document.getElementById('room-mode-select')?.value || 'eme';
        populateMapGrid(initialMode);
    } catch (error) {
        console.error('ç”»åƒãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        IMAGE_DATA = { modes: {}, maps: [], brawlers: [] };
        BRAWLERS = [];
    }
}

// ãƒ¢ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ (3Ã—2)
function populateModeGrid() {
    const modeGrid = document.getElementById('mode-grid');
    const modeInput = document.getElementById('room-mode-select');
    if (!modeGrid || !IMAGE_DATA || !IMAGE_DATA.modes) return;
    
    modeGrid.innerHTML = '';
    const modes = Object.values(IMAGE_DATA.modes);
    
    modes.forEach((mode, idx) => {
        const item = document.createElement('div');
        item.className = 'mode-grid-item' + (idx === 0 ? ' selected' : '');
        item.dataset.mode = mode.id;
        item.innerHTML = `
            <img src="image/${mode.logo}" alt="${mode.label}">
            <span class="mode-label">${mode.label}</span>
        `;
        item.addEventListener('click', () => {
            modeGrid.querySelectorAll('.mode-grid-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            modeInput.value = mode.id;
            populateMapGrid(mode.id);
        });
        modeGrid.appendChild(item);
    });
    
    // åˆæœŸå€¤ã‚’è¨­å®š
    if (modes.length > 0) {
        modeInput.value = modes[0].id;
    }
}

// ãƒãƒƒãƒ—ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ (3Ã—n)
function populateMapGrid(modeKey) {
    const mapGrid = document.getElementById('map-grid');
    const mapInput = document.getElementById('room-map-select');
    if (!mapGrid || !IMAGE_DATA) return;
    
    mapGrid.innerHTML = '';
    
    // ãƒ¢ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹ãƒãƒƒãƒ—ã‚’ãƒ•ã‚£ãƒ«ã‚¿
    const hasModeInfo = IMAGE_DATA.maps.some(m => Array.isArray(m.modes) && m.modes.length > 0);
    let mapsToShow = IMAGE_DATA.maps;
    if (modeKey && hasModeInfo) {
        mapsToShow = IMAGE_DATA.maps.filter(m => Array.isArray(m.modes) && m.modes.includes(modeKey));
        if (mapsToShow.length === 0) mapsToShow = IMAGE_DATA.maps;
    }
    
    mapsToShow.forEach((map, idx) => {
        const item = document.createElement('div');
        item.className = 'map-grid-item' + (idx === 0 ? ' selected' : '');
        item.dataset.mapId = map.id;
        item.dataset.mapImage = map.image;
        item.innerHTML = `
            <img src="image/${map.image}" alt="${map.name}">
            <span class="map-label">${map.name}</span>
        `;
        item.addEventListener('click', () => {
            mapGrid.querySelectorAll('.map-grid-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            mapInput.value = map.id;
        });
        mapGrid.appendChild(item);
    });
    
    // åˆæœŸå€¤ã‚’è¨­å®š
    if (mapsToShow.length > 0) {
        mapInput.value = mapsToShow[0].id;
    }
}

// å¤ã„ã‚»ãƒ¬ã‚¯ãƒˆç”¨ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
function populateMapSelect(modeKey) {
    populateMapGrid(modeKey);
}

// ========================================
// DOMè¦ç´ 
// ========================================
const lobbyScreen = document.getElementById('lobby-screen');

// -------------------------
// ãƒ¢ãƒ¼ãƒ‰ãƒãƒŠãƒ¼ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
// -------------------------
const modeBanner = document.getElementById('mode-banner');
const modeLogo = document.getElementById('mode-logo');
const bannerModeName = document.getElementById('banner-mode-name');
const bannerMapName = document.getElementById('banner-map-name');
const banpicModeLogo = document.getElementById('banpic-mode-logo');
const banpicModeBanner = document.getElementById('banpic-mode-banner');
const banpicModeNameEl = document.getElementById('banpic-mode');
const banpicMapNameEl = document.getElementById('banpic-map');
const mapDisplayImg = document.getElementById('map-display-img');

const MODE_DATA = {
    eme:    { label: 'ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ãƒãƒ³ãƒˆ', color: '#9A3DF3', logo: 'e-eme.png' },
    bounty: { label: 'è³é‡‘ç¨¼ã',       color: '#00CFFF', logo: 'e-syoukin.png' },
    soccer: { label: 'ãƒ–ãƒ­ã‚¹ãƒˆãƒ©ã‚¤ã‚«ãƒ¼', color: '#8CA0E0', logo: 'e-soccer.png' },
    hotzone:{ label: 'ãƒ›ãƒƒãƒˆã‚¾ãƒ¼ãƒ³',     color: '#E33B50', logo: 'e-hotzone.png' },
    heist:  { label: 'å¼·å¥ª',           color: '#D65CD3', logo: 'e-godatu.png' },
    knockout:{ label: 'ãƒãƒƒã‚¯ã‚¢ã‚¦ãƒˆ',    color: '#F7831C', logo: 'e-knock.png' }
};

function applyBanner(modeKey, mapName, mapImage){
    const data = MODE_DATA[modeKey] || MODE_DATA.eme;
    if (typeof bannerModeName !== 'undefined' && bannerModeName) bannerModeName.textContent = data.label;
    if (typeof bannerMapName !== 'undefined' && bannerMapName) bannerMapName.textContent = mapName || bannerMapName.textContent;
    if (typeof modeLogo !== 'undefined' && modeLogo) modeLogo.src = 'image/' + data.logo;
    if (typeof modeBanner !== 'undefined' && modeBanner) {
        modeBanner.style.setProperty('--mode-bg', data.color);
        modeBanner.style.background = `linear-gradient(90deg, ${data.color}33, ${data.color}22)`;
    }
    // ã‚²ãƒ¼ãƒ ç”»é¢ç”¨ãƒãƒŠãƒ¼ã«ã‚‚åæ˜ 
    if(banpicModeLogo) banpicModeLogo.src = 'image/' + data.logo;
    if(banpicModeBanner) banpicModeBanner.style.background = `linear-gradient(90deg, ${data.color}33, ${data.color}22)`;
    if(banpicModeNameEl) banpicModeNameEl.textContent = data.label;
    if(banpicMapNameEl) banpicMapNameEl.textContent = mapName || banpicMapNameEl.textContent;
    // ãƒãƒƒãƒ—ç”»åƒã‚’åæ˜ 
    if(mapDisplayImg && mapImage) {
        mapDisplayImg.src = 'image/' + mapImage;
    }
}

// åˆæœŸè¡¨ç¤º
// åˆæœŸãƒãƒŠãƒ¼ã®è‡ªå‹•ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¯é¸æŠæ™‚ã«è¨­å®šã•ã‚Œã‚‹ï¼‰
// applyBanner('soccer', 'é™ã‹ãªåºƒå ´');
const waitingScreen = document.getElementById('waiting-screen');
const gameScreen = document.getElementById('game-screen');
const roomList = document.getElementById('room-list');
const emptyState = document.getElementById('empty-state');
const roomCount = document.getElementById('room-count');
const currentUserNameEl = document.getElementById('current-user-name');

// ãƒ¢ãƒ¼ãƒ€ãƒ«
const createRoomModal = document.getElementById('create-room-modal');
const joinRoomModal = document.getElementById('join-room-modal');

// ========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
// ========================================
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºåˆ‡æ›¿ã‚’é©ç”¨
    if (typeof setHeaderVisibilityForScreen === 'function') setHeaderVisibilityForScreen(screenId);
}

// ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºåˆ‡æ›¿ï¼ˆãƒ«ãƒ¼ãƒ å†…ã§ã¯éè¡¨ç¤ºã«ã™ã‚‹ï¼‰
function setHeaderVisibilityForScreen(screenId) {
    const headerEl = document.querySelector('header');
    if (!headerEl) return;
    // ãƒ­ãƒ“ãƒ¼ç”»é¢ã®ã¿ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤ºã€ãã‚Œä»¥å¤–ï¼ˆwaiting/gameï¼‰ã¯éè¡¨ç¤º
    if (screenId === 'lobby-screen') {
        headerEl.style.display = '';
    } else {
        headerEl.style.display = 'none';
    }
}

function showModal(modal) {
modal.classList.add('active');
}

function hideModal(modal) {
modal.classList.remove('active');
}

function hashPassword(password) {
// ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥ï¼ˆæœ¬ç•ªã§ã¯ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã‚’ä½¿ç”¨ï¼‰
if (!password) return null;
let hash = 0;
for (let i = 0; i < password.length; i++) {
const char = password.charCodeAt(i);
hash = ((hash << 5) - hash) + char;
hash = hash & hash;
}
return hash.toString(16);
}

// ========================================
// ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—ãƒ»è¡¨ç¤º
// ========================================
function subscribeToRooms() {
const roomsRef = database.ref('rooms');

// orderByChildã‚’ä½¿ã‚ãšã«ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆDBãƒ«ãƒ¼ãƒ«ã¨ã®äº’æ›æ€§å‘ä¸Šï¼‰
roomsListener = roomsRef.on('value', (snapshot) => {
const allRooms = snapshot.val() || {};
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§openãªãƒ«ãƒ¼ãƒ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
const rooms = {};
Object.entries(allRooms).forEach(([id, room]) => {
if (room.meta && room.meta.state === 'open') {
rooms[id] = room;
}
});
renderRoomList(rooms);
}, (error) => {
console.error('ãƒ«ãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
// permission_denied ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã—ã¦å†è©¦è¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
const message = (error && error.code) ? `${error.code}: ${error.message}` : 'ãƒ«ãƒ¼ãƒ å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
showLobbyError('ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚' + message, true);
});
}

function unsubscribeFromRooms() {
if (roomsListener) {
database.ref('rooms').off('value', roomsListener);
roomsListener = null;
}
}

// ãƒ«ãƒ¼ãƒ è‡ªå‹•å‰Šé™¤ï¼ˆä½œæˆå¾Œã«ã‚²ã‚¹ãƒˆãŒå…¥ã‚‰ãªã‘ã‚Œã°ä¸€å®šæ™‚é–“ã§å‰Šé™¤ï¼‰
function scheduleRoomExpiry(roomId, delayMs = 120000) {
try {
clearRoomExpiry(roomId);
roomExpiryTimers[roomId] = setTimeout(async () => {
try {
const snap = await database.ref(`rooms/${roomId}/meta`).once('value');
const meta = snap.val();
if (!meta) return; // already removed
// ã‚²ã‚¹ãƒˆãŒã¾ã ã„ãªã„ãƒ»çŠ¶æ…‹ãŒ open ã®å ´åˆã¯å‰Šé™¤
if ((!meta.guestId) && meta.state === 'open') {
console.log('Room expiry: removing room', roomId);
await database.ref(`rooms/${roomId}`).remove();
}
} catch (err) {
console.warn('room expiry check failed for', roomId, err);
} finally {
clearRoomExpiry(roomId);
}
}, delayMs);
} catch (err) {
console.warn('scheduleRoomExpiry failed:', err);
}
}

// å¤ã„ãƒ«ãƒ¼ãƒ ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ (lastSeenãŒ180ç§’ä»¥ä¸Šå¤ã„)
function isStaleRoom(meta) {
    if (!meta || !meta.lastSeen) return false;
    const now = Date.now();
    const lastSeen = meta.lastSeen;
    return (now - lastSeen) > 180000; // 3åˆ†ä»¥ä¸ŠçµŒé
}

function clearRoomExpiry(roomId) {
try {
const t = roomExpiryTimers[roomId];
if (t) {
clearTimeout(t);
delete roomExpiryTimers[roomId];
}
} catch (err) {
console.warn('clearRoomExpiry failed:', err);
}
}

// ãƒ­ãƒ“ãƒ¼ç”¨ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼è¡¨ç¤º/éè¡¨ç¤º
function showLobbyError(msg, canRetry = false) {
const el = document.getElementById('lobby-error');
const txt = document.getElementById('lobby-error-text');
if (!el || !txt) return;
txt.textContent = msg;
el.style.display = 'block';
const retryBtn = document.getElementById('lobby-retry-btn');
if (retryBtn) retryBtn.style.display = canRetry ? 'inline-block' : 'none';
}

function hideLobbyError() {
const el = document.getElementById('lobby-error');
if (!el) return;
el.style.display = 'none';
}

// èªè¨¼ã‚’è©¦è¡Œã—ã¦ã‹ã‚‰å†ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã™ã‚‹ï¼ˆå†è©¦è¡Œãƒœã‚¿ãƒ³ç”¨ï¼‰
async function attemptAuthAndSubscribe() {
hideLobbyError();
try {
if (!auth.currentUser) {
await auth.signInAnonymously();
console.log('å†è©¦è¡Œ: åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³æˆåŠŸ');
}
} catch (e) {
console.error('å†è©¦è¡Œã‚µã‚¤ãƒ³ã‚¤ãƒ³å¤±æ•—:', e);
showLobbyError('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e && e.message ? e.message : e), true);
return;
}

try {
// æ—¢å­˜ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†è¨­å®š
unsubscribeFromRooms();
subscribeToRooms();
} catch (e) {
console.error('å†è©¦è¡Œã§ãƒ«ãƒ¼ãƒ å–å¾—å¤±æ•—:', e);
showLobbyError('ãƒ«ãƒ¼ãƒ å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e && e.message ? e.message : e), true);
}
}

function renderRoomList(rooms) {
const roomEntries = Object.entries(rooms).filter(([id, room]) => {
    // openã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿è¡¨ç¤º + å¤ã„ãƒ«ãƒ¼ãƒ (lastSeen 3åˆ†ä»¥ä¸Š)ã¯é™¤å¤–
    if (!room.meta || room.meta.state !== 'open') return false;
    if (isStaleRoom(room.meta)) {
        // å¤ã„ãƒ«ãƒ¼ãƒ ã¯è‡ªå‹•å‰Šé™¤ã‚’è©¦ã¿ã‚‹
        database.ref(`rooms/${id}`).remove().catch(e => console.warn('stale room remove failed', e));
        return false;
    }
    return true;
});

roomCount.textContent = `${roomEntries.length} éƒ¨å±‹`;

if (roomEntries.length === 0) {
emptyState.style.display = 'block';
// æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
document.querySelectorAll('.room-card').forEach(card => card.remove());
return;
}

emptyState.style.display = 'none';

// æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
document.querySelectorAll('.room-card').forEach(card => card.remove());

// ãƒ«ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
const ADMIN_USER_ID = 'cANK5ZBzjGPwfvz8cbH3o93wUZ33';
roomEntries.forEach(([roomId, room]) => {
const meta = room.meta;
const hasPassword = !!meta.passwordHash;
const playerCount = meta.guestId ? 2 : 1;
const isAdmin = (currentUserId === ADMIN_USER_ID);

const card = document.createElement('div');
card.className = 'room-card';
card.innerHTML = `
                   <div class="room-info">
                       <div class="room-avatar" data-host-id="${meta.hostId || ''}">ğŸ‘‘</div>
                       <div>
                           <div class="room-name">
                               ${hasPassword ? '<span class="lock-icon">ğŸ”’</span>' : ''}
                               ${escapeHtml(meta.roomName)}
                           </div>
                           <div class="room-meta">
                               <span class="host-name">ğŸ‘¤ ${escapeHtml(meta.hostName || 'ãƒ›ã‚¹ãƒˆ')}</span>
                           </div>
                       </div>
                   </div>
                   <div class="room-players">
                       <span class="player-count ${playerCount >= 2 ? 'full' : ''}">${playerCount}/2</span>
                       <button class="btn btn-success" ${playerCount >= 2 ? 'disabled' : ''}>
                           å‚åŠ 
                       </button>
                       ${isAdmin ? '<button class="btn btn-danger btn-admin-delete" title="ç®¡ç†è€…: å‰Šé™¤">ğŸ—‘ï¸</button>' : ''}
                   </div>
               `;

const joinBtn = card.querySelector('.btn-success');
if (playerCount < 2) {
joinBtn.addEventListener('click', () => openJoinModal(roomId, meta));
}

// ç®¡ç†è€…å‰Šé™¤ãƒœã‚¿ãƒ³
const adminDeleteBtn = card.querySelector('.btn-admin-delete');
if (adminDeleteBtn) {
    adminDeleteBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (confirm(`ãƒ«ãƒ¼ãƒ ã€Œ${meta.roomName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            try {
                await database.ref(`rooms/${roomId}`).remove();
                console.log('Admin deleted room:', roomId);
            } catch (err) {
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            }
        }
    });
}

roomList.insertBefore(card, emptyState);

// ãƒ›ã‚¹ãƒˆã®ã‚¢ãƒã‚¿ãƒ¼ã‚’å–å¾—ã—ã¦å·®ã—æ›¿ãˆï¼ˆéåŒæœŸï¼‰
if (meta.hostId) {
database.ref(`users/${meta.hostId}`).once('value').then((ps) => {
const p = ps.val();
const avatarEl = card.querySelector('.room-avatar');
if (p && p.avatar) {
avatarEl.innerHTML = `<img src="${p.avatar}" alt="host">`;
} else {
avatarEl.textContent = 'ğŸ‘‘';
}
}).catch((err) => {
console.warn('ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚¢ãƒã‚¿ãƒ¼å–å¾—å¤±æ•—:', err);
});
}
});
}

function escapeHtml(text) {
const div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}

// ========================================
// ãƒ«ãƒ¼ãƒ ä½œæˆ
// ========================================
document.getElementById('create-room-btn').addEventListener('click', () => {
// ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
showModal(createRoomModal);
});

// ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚Œã‚‹ç›´å‰ã« map ã‚»ãƒ¬ã‚¯ãƒˆã‚’åˆæœŸåŒ–
document.getElementById('create-room-btn').addEventListener('click', () => {
    const modeSelect = document.getElementById('room-mode-select');
    const mapSelect = document.getElementById('room-map-select');
    const preferredMode = (banpicState && banpicState.mode && banpicState.mode.id) ? banpicState.mode.id : (modeSelect ? modeSelect.value : 'eme');
    if (modeSelect) modeSelect.value = preferredMode;
    if (typeof populateMapSelect === 'function') {
        populateMapSelect(preferredMode);
    }
    // é¸æŠå€™è£œãŒã‚ã‚Œã°å…ˆé ­ã‚’é¸æŠ
    if (mapSelect && mapSelect.options && mapSelect.options.length > 1) {
        // å¯èƒ½ãªã‚‰ã€Œãƒ€ãƒ–ãƒ«ãƒ¬ãƒ¼ãƒ«ã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠã«ã™ã‚‹
        let foundIndex = -1;
        for (let i = 0; i < mapSelect.options.length; i++) {
            if (mapSelect.options[i].text.includes('ãƒ€ãƒ–ãƒ«ãƒ¬ãƒ¼ãƒ«')) { foundIndex = i; break; }
        }
        mapSelect.selectedIndex = (foundIndex >= 0) ? foundIndex : 1; // 0 ã¯ 'é¸æŠã—ã¦ãã ã•ã„'
    }
});

document.getElementById('close-create-modal').addEventListener('click', () => {
// é–‰ã˜ã‚‹æ™‚ã¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
hideModal(createRoomModal);
// ãƒ¢ãƒ¼ãƒ‰ã«é–¢ã‚ã‚‰ãš map select ã®å¿…é ˆã‚’å¾©å…ƒ
const mapSelectClose = document.getElementById('room-map-select');
if (mapSelectClose) mapSelectClose.required = true;
delete createRoomModal.dataset.testMode;
const headerH3 = document.querySelector('#create-room-modal .modal-header h3');
if (headerH3) headerH3.textContent = 'ğŸ® ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ';
});

document.getElementById('cancel-create-room').addEventListener('click', () => {
// ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã‚‚ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
hideModal(createRoomModal);
// map select ã®å¿…é ˆã‚’å¾©å…ƒ
const mapSelectCancel = document.getElementById('room-map-select');
if (mapSelectCancel) mapSelectCancel.required = true;
delete createRoomModal.dataset.testMode;
const headerH3c = document.querySelector('#create-room-modal .modal-header h3');
if (headerH3c) headerH3c.textContent = 'ğŸ® ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ';
});

document.getElementById('create-room-form').addEventListener('submit', async (e) => {
e.preventDefault();

const roomName = document.getElementById('room-name-input').value.trim() || 'ãƒ«ãƒ¼ãƒ 1';
// åå‰å…¥åŠ›ã‚’å‰Šé™¤ã—ãŸãŸã‚ã€ãƒ›ã‚¹ãƒˆåã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä½¿ã†ï¼ˆã‚²ã‚¹ãƒˆãªã‚‰ 'ãƒ›ã‚¹ãƒˆ'ï¼‰
const hostName = (typeof currentUserName !== 'undefined' && currentUserName && currentUserName !== 'ã‚²ã‚¹ãƒˆ') ? currentUserName : 'ãƒ›ã‚¹ãƒˆ';
const password = document.getElementById('room-password-input').value;
const modeKey = document.getElementById('room-mode-select').value;
const mapId = document.getElementById('room-map-select').value;
const firstMove = document.getElementById('room-first-move-select').value;
const timerDuration = parseInt(document.getElementById('room-timer-select').value, 10) || 20;

// ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«å–å¾—ï¼ˆIMAGE_DATAãŒã¾ã èª­è¾¼ä¸­ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ï¼‰
let mapData = null;
if (IMAGE_DATA && Array.isArray(IMAGE_DATA.maps)) {
    mapData = IMAGE_DATA.maps.find(m => m.id === mapId) || null;
}
const mapName = mapData ? mapData.name : 'é™ã‹ãªåºƒå ´';
const mapImage = mapData ? mapData.image : 'm-é™ã‹ãªåºƒå ´.png';

// ãƒãƒŠãƒ¼ã‚’æ›´æ–°
applyBanner(modeKey, mapName, mapImage);

// ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å‘¼ã³å‡ºã•ã‚ŒãŸå ´åˆã¯ãƒ«ãƒ¼ãƒ ã‚’ä½œã‚‰ãšãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ï¼ˆé¸æŠãƒ¢ãƒ¼ãƒ‰ï¼ãƒãƒƒãƒ—ã‚’æ¸¡ã™ï¼‰
if (createRoomModal && createRoomModal.dataset.testMode === 'true') {
    startTestMode(modeKey, mapName, firstMove);
    hideModal(createRoomModal);
    document.getElementById('create-room-form').reset();
    // restore map select required attribute
    const mapSelectSubmit = document.getElementById('room-map-select');
    if (mapSelectSubmit) mapSelectSubmit.required = true;
    delete createRoomModal.dataset.testMode;
    const headerH3t = document.querySelector('#create-room-modal .modal-header h3');
    if (headerH3t) headerH3t.textContent = 'ğŸ® ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ';
    return;
}

try {
const newRoomRef = database.ref('rooms').push();
const roomId = newRoomRef.key;

await newRoomRef.set({
meta: {
roomName: roomName,
hostId: currentUserId,
hostName: hostName,
guestId: null,
guestName: null,
passwordHash: hashPassword(password),
state: 'open',
createdAt: firebase.database.ServerValue.TIMESTAMP,
mode: modeKey,
mapName: mapName,
mapImage: mapImage,
firstMove: firstMove,
timerDuration: timerDuration
}
});

// ãƒ›ã‚¹ãƒˆãŒåˆ‡æ–­ã—ãŸã‚‰ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤ã™ã‚‹ï¼ˆonDisconnectï¼‰
try {
await newRoomRef.child('meta').onDisconnect().remove();
} catch (err) {
console.warn('onDisconnect remove è¨­å®šå¤±æ•—:', err);
}

// ãƒ›ã‚¹ãƒˆã®ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆï¼ˆlastSeenï¼‰ã‚’è¨­å®š
try {
await newRoomRef.child('meta').update({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
if (hostHeartbeatInterval) clearInterval(hostHeartbeatInterval);
hostHeartbeatInterval = setInterval(() => {
database.ref(`rooms/${roomId}/meta`).update({ lastSeen: firebase.database.ServerValue.TIMESTAMP }).catch(e => console.warn('heartbeat error', e));
}, 30000);
} catch (err) {
console.warn('ãƒ›ã‚¹ãƒˆãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆåˆæœŸåŒ–å¤±æ•—:', err);
}

currentUserName = hostName;
currentUserNameEl.textContent = hostName;
currentRoomId = roomId;

// éƒ¨å±‹ãŒ120ç§’é–“ã‚²ã‚¹ãƒˆã‚’å¾…ã¦ãªã‹ã£ãŸã‚‰è‡ªå‹•å‰Šé™¤
try {
scheduleRoomExpiry(roomId, 120000);
} catch (err) {
console.warn('scheduleRoomExpiry error:', err);
}

hideModal(createRoomModal);
document.getElementById('create-room-form').reset();

enterWaitingRoom(roomId, roomName, hostName, null, true);

} catch (error) {
console.error('ãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
alert('ãƒ«ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
}
});

// ========================================
// ãƒ«ãƒ¼ãƒ å‚åŠ 
// ========================================
function openJoinModal(roomId, meta) {
document.getElementById('join-room-name').value = meta.roomName;
document.getElementById('join-room-id').value = roomId;

// ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è‡ªå‹•å…¥åŠ›
const guestNameInput = document.getElementById('guest-name-input');
if (currentUserName && currentUserName !== 'ã‚²ã‚¹ãƒˆ') {
guestNameInput.value = currentUserName;
} else {
guestNameInput.value = '';
}

const passwordGroup = document.getElementById('join-password-group');
if (meta.passwordHash) {
passwordGroup.style.display = 'block';
document.getElementById('join-password-input').required = true;
} else {
passwordGroup.style.display = 'none';
document.getElementById('join-password-input').required = false;
}

showModal(joinRoomModal);
}

document.getElementById('close-join-modal').addEventListener('click', () => {
hideModal(joinRoomModal);
});

document.getElementById('cancel-join-room').addEventListener('click', () => {
hideModal(joinRoomModal);
});

document.getElementById('join-room-form').addEventListener('submit', async (e) => {
e.preventDefault();

const roomId = document.getElementById('join-room-id').value;
const guestName = document.getElementById('guest-name-input').value.trim() || 'ã‚²ã‚¹ãƒˆ';
const password = document.getElementById('join-password-input').value;

try {
const roomRef = database.ref(`rooms/${roomId}`);
const snapshot = await roomRef.once('value');
const room = snapshot.val();

if (!room || room.meta.state !== 'open') {
alert('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã‚‹ã‹ã€å­˜åœ¨ã—ã¾ã›ã‚“');
hideModal(joinRoomModal);
return;
}

if (room.meta.guestId) {
alert('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«æº€å“¡ã§ã™');
hideModal(joinRoomModal);
return;
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
if (room.meta.passwordHash && hashPassword(password) !== room.meta.passwordHash) {
alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
return;
}

// ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ 
await roomRef.child('meta').update({
guestId: currentUserId,
guestName: guestName
});

// å‚åŠ ã—ãŸã®ã§ãƒ«ãƒ¼ãƒ è‡ªå‹•å‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆå®‰å…¨å´ï¼‰
try {
clearRoomExpiry(roomId);
} catch (err) {
console.warn('clearRoomExpiry error (guest join):', err);
}

// ã‚²ã‚¹ãƒˆãŒåˆ‡æ–­ã—ãŸã‚‰ guest æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
try {
await roomRef.child('meta').onDisconnect().update({ guestId: null, guestName: null, state: 'open' });
} catch (err) {
console.warn('ã‚²ã‚¹ãƒˆ onDisconnect è¨­å®šå¤±æ•—:', err);
}

// ã‚²ã‚¹ãƒˆã®ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆï¼ˆguestLastSeenï¼‰ã‚’è¨­å®š
try {
await roomRef.child('meta').update({ guestLastSeen: firebase.database.ServerValue.TIMESTAMP });
if (guestHeartbeatInterval) clearInterval(guestHeartbeatInterval);
guestHeartbeatInterval = setInterval(() => {
database.ref(`rooms/${roomId}/meta`).update({ guestLastSeen: firebase.database.ServerValue.TIMESTAMP }).catch(e => console.warn('guest heartbeat error', e));
}, 30000);
} catch (err) {
console.warn('ã‚²ã‚¹ãƒˆãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆåˆæœŸåŒ–å¤±æ•—:', err);
}

currentUserName = guestName;
currentUserNameEl.textContent = guestName;
currentRoomId = roomId;

hideModal(joinRoomModal);
document.getElementById('join-room-form').reset();

enterWaitingRoom(roomId, room.meta.roomName, room.meta.hostName, guestName, false);

} catch (error) {
console.error('ãƒ«ãƒ¼ãƒ å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
alert('ãƒ«ãƒ¼ãƒ ã¸ã®å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
}
});

// ========================================
// å¾…æ©Ÿç”»é¢
// ========================================
function enterWaitingRoom(roomId, roomName, hostName, guestName, isHost) {
showScreen('waiting-screen');

document.getElementById('waiting-room-name').textContent = roomName;
document.getElementById('waiting-room-id').textContent = `Room ID: ${roomId.slice(-6)}`;
document.getElementById('host-name').textContent = hostName;

if (guestName) {
document.getElementById('guest-name').textContent = guestName;
document.getElementById('guest-avatar').textContent = 'ğŸ®';
document.getElementById('guest-avatar').classList.remove('empty');
} else {
document.getElementById('guest-name').textContent = 'å¾…æ©Ÿä¸­...';
document.getElementById('guest-avatar').textContent = '?';
document.getElementById('guest-avatar').classList.add('empty');
}

// ãƒ«ãƒ¼ãƒ ã®å¤‰æ›´ã‚’ç›£è¦–
currentRoomRef = database.ref(`rooms/${roomId}/meta`);
// åˆå›å–å¾—ã§ãƒ›ã‚¹ãƒˆ/ã‚²ã‚¹ãƒˆã®ã‚¢ãƒã‚¿ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤º
database.ref(`rooms/${roomId}/meta`).once('value').then((snap) => {
const initialMeta = snap.val();
if (initialMeta && initialMeta.hostId) {
database.ref(`users/${initialMeta.hostId}`).once('value').then((ps) => {
const p = ps.val();
if (p && p.avatar) {
const el = document.getElementById('host-avatar');
el.innerHTML = `<img src="${p.avatar}" alt="host">`;
}
}).catch((err) => console.warn('ãƒ›ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—å¤±æ•—:', err));
}
if (initialMeta && initialMeta.guestId) {
database.ref(`users/${initialMeta.guestId}`).once('value').then((ps) => {
const p = ps.val();
if (p && p.avatar) {
const el = document.getElementById('guest-avatar');
el.innerHTML = `<img src="${p.avatar}" alt="guest">`;
el.classList.remove('empty');
}
}).catch((err) => console.warn('ã‚²ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—å¤±æ•—:', err));
}
}).catch((err) => console.warn('åˆå›ãƒ«ãƒ¼ãƒ ãƒ¡ã‚¿å–å¾—å¤±æ•—:', err));

    let roomGameStarted = false;
    currentRoomRef.on('value', async (snapshot) => {
        const meta = snapshot.val();
        console.log('rooms/' + roomId + '/meta changed:', meta);
if (!meta) {
// ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚ŒãŸ
alert('ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
leaveRoom();
return;
}

// ã‚²ã‚¹ãƒˆãŒå‚åŠ ã—ãŸ
if (meta.guestId && meta.guestName) {
document.getElementById('guest-name').textContent = meta.guestName;
document.getElementById('guest-avatar').classList.remove('empty');
// ã‚²ã‚¹ãƒˆã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’DBã‹ã‚‰å–å¾—ã—ã€ã‚¢ãƒã‚¿ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤º
database.ref(`users/${meta.guestId}`).once('value').then((ps) => {
const p = ps.val();
if (p && p.avatar) {
document.getElementById('guest-avatar').innerHTML = `<img src="${p.avatar}" alt="guest">`;
} else {
document.getElementById('guest-avatar').textContent = 'ğŸ®';
}
}).catch((err) => {
console.warn('ã‚²ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—å¤±æ•—:', err);
document.getElementById('guest-avatar').textContent = 'ğŸ®';
});
document.getElementById('waiting-message').textContent = '2äººæƒã„ã¾ã—ãŸï¼';

// ã‚²ã‚¹ãƒˆãŒæƒã£ãŸã®ã§è‡ªå‹•å‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã‚’è§£é™¤
try { if (isHost) clearRoomExpiry(roomId); } catch(e){console.warn('clear expiry on guest join failed',e)}
}
        // ãƒ›ã‚¹ãƒˆå´ã§ã¯ã€ã‚²ã‚¹ãƒˆãŒæƒã£ãŸæ™‚ç‚¹ã§ãƒ«ãƒ¼ãƒ çŠ¶æ…‹ã‚’ 'playing' ã«é·ç§»ã•ã›ã‚‹
        if (meta.guestId && meta.guestName && isHost && meta.state === 'open') {
            try {
                // å…ˆæ”»æƒ…å ±ã‚’è§£æ±ºã—ã¦ä¿å­˜ï¼ˆrandom ã®å ´åˆã¯ãƒ›ã‚¹ãƒˆã§æ±ºå®šï¼‰
                let resolvedIsBlue = true;
                if (meta.firstMove === 'host') resolvedIsBlue = true;
                else if (meta.firstMove === 'guest') resolvedIsBlue = false;
                else resolvedIsBlue = Math.random() < 0.5;

                await database.ref(`rooms/${roomId}/meta`).update({ state: 'playing', resolvedFirstMoveIsBlue: resolvedIsBlue });
            } catch (err) {
                console.warn('failed to update room state to playing:', err);
            }
        }

        // ãƒ«ãƒ¼ãƒ ãŒ playing çŠ¶æ…‹ã«ãªã£ãŸã‚‰ä¸¡ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†ã‚’å‘¼ã¶
        if (meta.state === 'playing' && !roomGameStarted) {
            roomGameStarted = true;
            try {
                // ãƒ©ãƒ³ãƒ€ãƒ æ™‚ã¯ã‚³ã‚¤ãƒ³ãƒˆã‚¹æ¼”å‡ºã‚’è¡¨ç¤º
                if (meta.firstMove === 'random' || !meta.firstMove) {
                    const winnerName = meta.resolvedFirstMoveIsBlue 
                        ? (meta.hostName || 'ãƒ›ã‚¹ãƒˆ') 
                        : (meta.guestName || 'ã‚²ã‚¹ãƒˆ');
                    await showCoinToss(winnerName);
                }
                startOnlineMode(meta, roomId);
            } catch (err) {
                console.warn('startOnlineMode error:', err);
            }
        }
});
}

// ========================================
// ãƒ«ãƒ¼ãƒ é€€å‡º
// ========================================
document.getElementById('leave-room-btn').addEventListener('click', () => {
if (confirm('æœ¬å½“ã«ãƒ«ãƒ¼ãƒ ã‚’é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
leaveRoom();
}
});

async function leaveRoom() {
if (currentRoomRef) {
currentRoomRef.off();
}

if (currentRoomId) {
try {
const roomRef = database.ref(`rooms/${currentRoomId}/meta`);
const snapshot = await roomRef.once('value');
const meta = snapshot.val();

if (meta) {
if (meta.hostId === currentUserId) {
// ãƒ›ã‚¹ãƒˆãŒé€€å‡º â†’ ãƒ«ãƒ¼ãƒ å‰Šé™¤
await database.ref(`rooms/${currentRoomId}`).remove();
if (hostHeartbeatInterval) { clearInterval(hostHeartbeatInterval); hostHeartbeatInterval = null; }
try { clearRoomExpiry(currentRoomId); } catch(e){console.warn('clear expiry on host leave', e);}
} else if (meta.guestId === currentUserId) {
// ã‚²ã‚¹ãƒˆãŒé€€å‡º
await roomRef.update({
guestId: null,
guestName: null,
state: 'open'
});
if (guestHeartbeatInterval) { clearInterval(guestHeartbeatInterval); guestHeartbeatInterval = null; }
try { scheduleRoomExpiry(currentRoomId, 120000); } catch(e){console.warn('reschedule expiry on guest leave', e);}
}
}
} catch (error) {
console.error('é€€å‡ºã‚¨ãƒ©ãƒ¼:', error);
}
}

currentRoomId = null;
currentRoomRef = null;
showScreen('lobby-screen');
}

// ========================================
// æ›´æ–°ãƒœã‚¿ãƒ³
// ========================================
document.getElementById('refresh-btn').addEventListener('click', () => {
const btn = document.getElementById('refresh-btn');
btn.style.transform = 'rotate(360deg)';
setTimeout(() => btn.style.transform = '', 500);
});

// ========================================
// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
// ========================================
createRoomModal.addEventListener('click', (e) => {
if (e.target === createRoomModal) hideModal(createRoomModal);
});

joinRoomModal.addEventListener('click', (e) => {
if (e.target === joinRoomModal) hideModal(joinRoomModal);
});

// ========================================
// ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆé–‹ç™ºä¸­ï¼‰ã‹ã‚‰æˆ»ã‚‹ãƒœã‚¿ãƒ³
// ========================================
const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
if (backToLobbyBtn) {
backToLobbyBtn.addEventListener('click', () => {
if (currentRoomId) {
leaveRoom();
} else {
showScreen('lobby-screen');
}
});
}

// ========================================
// ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãƒ»Googleãƒ­ã‚°ã‚¤ãƒ³
// ========================================
const GOOGLE_ICON_URL = 'https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg';
const userSettingsModal = document.getElementById('user-settings-modal');
const userAvatarEl = document.getElementById('user-avatar');
const userAvatarLargeEl = document.getElementById('user-avatar-large');
let userAvatarUrl = null;

document.getElementById('user-info-btn').addEventListener('click', () => {
// ç¾åœ¨ã®è¨­å®šã‚’åæ˜ 
document.getElementById('display-name-input').value = currentUserName;
updateLoginSection();
showModal(userSettingsModal);
});

document.getElementById('close-user-settings').addEventListener('click', () => {
hideModal(userSettingsModal);
});

userSettingsModal.addEventListener('click', (e) => {
if (e.target === userSettingsModal) hideModal(userSettingsModal);
});

// ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
document.getElementById('upload-avatar-btn').addEventListener('click', () => {
document.getElementById('avatar-upload').click();
});

document.getElementById('avatar-upload').addEventListener('change', (e) => {
const file = e.target.files[0];
if (file) {
const reader = new FileReader();
reader.onload = (event) => {
userAvatarUrl = event.target.result;
userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
userAvatarLargeEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
// LocalStorageã«ä¿å­˜
localStorage.setItem('userAvatar', userAvatarUrl);
// Firebase Realtime Database ã«ã‚‚ä¿å­˜ï¼ˆStorageã¯ä½¿ã‚ãªã„ãŸã‚ã€base64ãƒ‡ãƒ¼ã‚¿ã‚’DBã«ç½®ãï¼‰
if (currentUserId) {
try {
database.ref(`users/${currentUserId}`).update({
avatar: userAvatarUrl,
displayName: currentUserName || null
});
} catch (err) {
console.warn('DBã¸ã‚¢ãƒã‚¿ãƒ¼ä¿å­˜å¤±æ•—:', err);
}
}
};
reader.readAsDataURL(file);
}
});

// Googleãƒ­ã‚°ã‚¤ãƒ³
const googleProvider = new firebase.auth.GoogleAuthProvider();

document.getElementById('google-login-btn').addEventListener('click', async () => {
try {
let result;
const current = auth.currentUser;
// æ—¢ã«åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰ãƒªãƒ³ã‚¯ã—ã¦åŒã˜UIDã«Googleã‚’ç´ä»˜ã‘ã‚‹
if (current && current.isAnonymous) {
try {
result = await current.linkWithPopup(googleProvider);
} catch (linkErr) {
// ãƒªãƒ³ã‚¯ãŒå¤±æ•—ã—ãŸã‚‰é€šå¸¸ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
console.warn('linkWithPopupå¤±æ•—ã€signInWithPopupã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', linkErr);
result = await auth.signInWithPopup(googleProvider);
}
} else {
result = await auth.signInWithPopup(googleProvider);
}

const user = result.user;
currentUserId = user.uid;
currentUserName = user.displayName || currentUserName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
currentUserNameEl.textContent = currentUserName;
document.getElementById('display-name-input').value = currentUserName;

// Googleã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒã‚ã‚Œã°ä½¿ã„ã€ç„¡ã‘ã‚Œã°Googleã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
if (user.photoURL) {
userAvatarUrl = user.photoURL;
} else {
userAvatarUrl = GOOGLE_ICON_URL;
}
userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
userAvatarLargeEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;

// DBã«ã‚‚ä¿å­˜ï¼ˆä»–ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ï¼‰
try {
await database.ref(`users/${currentUserId}`).update({
displayName: currentUserName,
avatar: userAvatarUrl
});
} catch (err) {
console.warn('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«DBä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
}

updateLoginSection();
console.log('Googleãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', user.email || user.uid);
} catch (error) {
console.error('Googleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
if (error && error.code === 'auth/popup-blocked') {
alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
} else if (error && error.code === 'auth/unauthorized-domain') {
alert('ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯èªè¨¼ã«ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚Firebase Consoleã§Authorized domainsã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
} else {
alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error && error.message ? error.message : error));
}
}
});

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
document.getElementById('logout-btn').addEventListener('click', async () => {
try {
await auth.signOut();
// åŒ¿åã§å†ãƒ­ã‚°ã‚¤ãƒ³
const userCredential = await auth.signInAnonymously();
currentUserId = userCredential.user.uid;
currentUserName = 'ã‚²ã‚¹ãƒˆ';
currentUserNameEl.textContent = currentUserName;
userAvatarUrl = null;
userAvatarEl.innerHTML = 'ğŸ‘¤';
userAvatarLargeEl.innerHTML = 'ğŸ‘¤';
localStorage.removeItem('userAvatar');
updateLoginSection();
console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
} catch (error) {
console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
}
});

function updateLoginSection() {
const user = auth.currentUser;
const loginSection = document.getElementById('login-section');
const logoutSection = document.getElementById('logout-section');

if (user && !user.isAnonymous) {
loginSection.style.display = 'none';
logoutSection.style.display = 'block';
document.getElementById('logged-in-email').textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email}`;
} else {
loginSection.style.display = 'block';
logoutSection.style.display = 'none';
}
}

// è¨­å®šä¿å­˜
document.getElementById('save-user-settings').addEventListener('click', () => {
const newName = document.getElementById('display-name-input').value.trim();
if (newName) {
currentUserName = newName;
currentUserNameEl.textContent = newName;
localStorage.setItem('userName', newName);
// DBã«ä¿å­˜ï¼ˆåŒ¿åå«ã‚€ï¼‰
if (currentUserId) {
try {
database.ref(`users/${currentUserId}`).update({
displayName: newName,
avatar: userAvatarUrl || null
});
} catch (err) {
console.warn('DBã¸ãƒ¦ãƒ¼ã‚¶ãƒ¼åä¿å­˜å¤±æ•—:', err);
}
}
}
hideModal(userSettingsModal);
});

// LocalStorageã‹ã‚‰å¾©å…ƒ
function restoreUserSettings() {
const savedName = localStorage.getItem('userName');
const savedAvatar = localStorage.getItem('userAvatar');

if (savedName) {
currentUserName = savedName;
currentUserNameEl.textContent = savedName;
}

if (savedAvatar) {
userAvatarUrl = savedAvatar;
userAvatarEl.innerHTML = `<img src="${savedAvatar}" alt="avatar">`;
userAvatarLargeEl.innerHTML = `<img src="${savedAvatar}" alt="avatar">`;
}
}

// ========================================
// åˆæœŸåŒ–
// ========================================
// èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
auth.onAuthStateChanged((user) => {
if (user) {
currentUserId = user.uid;
console.log('èªè¨¼çŠ¶æ…‹å¤‰æ›´ - User ID:', currentUserId);

if (!user.isAnonymous && user.displayName) {
currentUserName = user.displayName;
currentUserNameEl.textContent = currentUserName;
}

if (!user.isAnonymous && user.photoURL) {
userAvatarUrl = user.photoURL;
userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
}
else if (user.providerData && user.providerData.some(p => p.providerId === 'google.com')) {
// Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãŒphotoURLã‚’æŒãŸãªã„å ´åˆã¯Googleã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ã†
userAvatarUrl = GOOGLE_ICON_URL;
userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
}
// DBã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå„ªå…ˆï¼‰
try {
database.ref(`users/${currentUserId}`).once('value').then((snap) => {
const profile = snap.val();
if (profile) {
if (profile.displayName) {
currentUserName = profile.displayName;
currentUserNameEl.textContent = currentUserName;
localStorage.setItem('userName', currentUserName);
}
if (profile.avatar) {
userAvatarUrl = profile.avatar;
userAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
userAvatarLargeEl.innerHTML = `<img src="${userAvatarUrl}" alt="avatar">`;
localStorage.setItem('userAvatar', userAvatarUrl);
} else {
// ç„¡ã‘ã‚Œã°æ—¢å­˜ã®localStorageã‚’å¾©å…ƒ
restoreUserSettings();
}
} else {
restoreUserSettings();
}
}).catch((err) => {
console.warn('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
restoreUserSettings();
});
} catch (err) {
console.warn('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«DBãƒã‚§ãƒƒã‚¯å¤±æ•—:', err);
restoreUserSettings();
}

subscribeToRooms();
console.log('make10 vs - åˆæœŸåŒ–å®Œäº†');
} else {
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„å ´åˆã¯åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³
auth.signInAnonymously()
.then((userCredential) => {
currentUserId = userCredential.user.uid;
console.log('åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³æˆåŠŸ');
console.log('User ID:', currentUserId);
restoreUserSettings();
subscribeToRooms();
console.log('make10 vs - åˆæœŸåŒ–å®Œäº†');
})
.catch((error) => {
console.error('åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³å¤±æ•—:', error);
alert('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
});
}
});

// ãƒ­ãƒ“ãƒ¼ã®å†è©¦è¡Œãƒ»ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³è¨­å®š
// ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
function preloadImages() {
    if (!BRAWLERS || BRAWLERS.length === 0) return;
    
    // å„ªå…ˆåº¦é«˜: æœ€åˆã®20ã‚­ãƒ£ãƒ©ã‚’å³åº§ã«ãƒ­ãƒ¼ãƒ‰
    const priorityBrawlers = BRAWLERS.slice(0, 20);
    priorityBrawlers.forEach(brawler => {
        const img = new Image();
        img.src = `image/${brawler.image}`;
    });
    
    // æ®‹ã‚Šã¯é…å»¶ãƒ­ãƒ¼ãƒ‰
    setTimeout(() => {
        BRAWLERS.slice(20).forEach(brawler => {
            const img = new Image();
            img.src = `image/${brawler.image}`;
        });
    }, 500);
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚‚ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
    ['default_ban.png', 'default_pic.png'].forEach(file => {
        const img = new Image();
        img.src = `image/${file}`;
    });
}

document.addEventListener('DOMContentLoaded', () => {
loadImageData().then(() => {
    // ç”»åƒãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«ã‚¹ãƒ­ãƒƒãƒˆåˆæœŸè¡¨ç¤ºã‚’æ›´æ–°
    if (typeof updateSlotPreview === 'function') updateSlotPreview();
    // ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰é–‹å§‹
    preloadImages();
}).catch(() => {
    if (typeof updateSlotPreview === 'function') updateSlotPreview();
}); // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
const retryBtn = document.getElementById('lobby-retry-btn');
const helpBtn = document.getElementById('lobby-help-btn');
if (retryBtn) retryBtn.addEventListener('click', attemptAuthAndSubscribe);
if (helpBtn) helpBtn.addEventListener('click', () => {
alert('ãƒ«ãƒ¼ãƒ å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebase ã® Realtime Database ã®ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n- é–‹ç™ºä¸­ã¯ä¸€æ™‚çš„ã« " .read": true ã‚’è¨­å®šã—ã¦å‹•ä½œç¢ºèªã§ãã¾ã™\n- æœ¬ç•ªã§ã¯ "auth != null" ã‚’ä½¿ç”¨ã—ã€åŒ¿åãƒ­ã‚°ã‚¤ãƒ³(Anonymous)ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
});
});

// debug handlers removed

// ========================================
// BANPIC ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
// ========================================

// ãƒ–ãƒ­ã‚¹ã‚¿ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆç”»åƒãƒ™ãƒ¼ã‚¹ãƒ»æ‹¡å¼µå¯èƒ½ï¼‰
// rarityé †åº: 1=åˆæœŸ, 2=ãƒ¬ã‚¢, 3=ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¬ã‚¢, 4=ã‚¨ãƒ”ãƒƒã‚¯, 5=ãƒŸã‚·ãƒƒã‚¯, 6=ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰
// ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚½ãƒ¼ãƒˆé–¢æ•°
function sortBrawlers(brawlers, sortType = 'rarity') {
    const sorted = [...brawlers];
    switch (sortType) {
        case 'rarity':
            // ãƒ¬ã‚¢åº¦é †ï¼ˆrarityLevelæ˜‡é † â†’ orderæ˜‡é †ï¼‰
            return sorted.sort((a, b) => {
                if (a.rarityLevel !== b.rarityLevel) return a.rarityLevel - b.rarityLevel;
                return a.order - b.order;
            });
        case 'name':
            // åå‰é †ï¼ˆ50éŸ³é †ï¼‰
            return sorted.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
        case 'id':
            // IDé †ï¼ˆç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åé †ï¼‰
            return sorted.sort((a, b) => a.image.localeCompare(b.image));
        default:
            return sorted;
    }
}

// ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆè¨­å®šï¼ˆå°†æ¥çš„ã«UI ã§å¤‰æ›´å¯èƒ½ã«ï¼‰
let currentBrawlerSort = 'rarity';

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚²ãƒ¼ãƒ ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ï¼ˆãƒªã‚¹ãƒŠãƒ¼ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç”¨ï¼‰
let activeGameRef = null;

// ãƒ¢ãƒ¼ãƒ‰ä¸€è¦§ï¼ˆåˆæœŸã¯ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ãƒãƒ³ãƒˆï¼‰
const GAME_MODES = [
    { id: 'gemgrab', name: 'ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ãƒãƒ³ãƒˆ', icon: 'ğŸ’' },
    { id: 'bounty', name: 'è³é‡‘ç¨¼ã', icon: 'â­' },
    { id: 'brawlball', name: 'ãƒ–ãƒ­ã‚¹ãƒˆãƒ©ã‚¤ã‚«ãƒ¼', icon: 'âš½' },
    { id: 'hotzone', name: 'ãƒ›ãƒƒãƒˆã‚¾ãƒ¼ãƒ³', icon: 'ğŸ”¥' },
    { id: 'heist', name: 'å¼·å¥ª', icon: 'ğŸ”' },
    { id: 'knockout', name: 'ãƒãƒƒã‚¯ã‚¢ã‚¦ãƒˆ', icon: 'ğŸ¥Š' },
    { id: 'showdown', name: 'ãƒãƒˆãƒ«ãƒ­ã‚¤ãƒ¤ãƒ«', icon: 'ğŸ’€' },
];

// BANPIC ã‚²ãƒ¼ãƒ çŠ¶æ…‹
let banpicState = {
    isTestMode: false,
    isBlueTeam: true,  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ–ãƒ«ãƒ¼ãƒãƒ¼ãƒ ã‹ã©ã†ã‹
    phase: 'ban',      // 'ban', 'pic1'~'pic6', 'done'
    phaseIndex: 0,     // 0=BAN, 1-6=PIC1-6, 7=done
    timer: 20,
    timerInterval: null,
    
    // é¸æŠçŠ¶æ…‹
    selectedCharacters: [],  // ç¾åœ¨é¸æŠä¸­ï¼ˆBANæ™‚ã¯æœ€å¤§3ã€PICæ™‚ã¯1ï¼‰
    
    // ç¢ºå®šæ¸ˆã¿
    blueBans: [],    // ãƒ–ãƒ«ãƒ¼ãƒãƒ¼ãƒ ã®BAN (3)
    redBans: [],     // ãƒ¬ãƒƒãƒ‰ãƒãƒ¼ãƒ ã®BAN (3)
    bluePicks: [],   // ãƒ–ãƒ«ãƒ¼ãƒãƒ¼ãƒ ã®PICK (3)
    redPicks: [],    // ãƒ¬ãƒƒãƒ‰ãƒãƒ¼ãƒ ã®PICK (3)
    
    // BANåˆç®—çµæœ
    allBannedIds: [],
    
    // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰/ãƒãƒƒãƒ—
    mode: { id: 'eme', name: (MODE_DATA && MODE_DATA.eme) ? MODE_DATA.eme.label : 'ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ãƒãƒ³ãƒˆ' },
    map: 'é™ã‹ãªåºƒå ´',
};

// ã‚­ãƒ£ãƒ©ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
function renderCharacterGrid() {
    const grid = document.getElementById('character-grid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    // ã‚½ãƒ¼ãƒˆé©ç”¨
    const sortedBrawlers = sortBrawlers(BRAWLERS, currentBrawlerSort);
    
    sortedBrawlers.forEach(brawler => {
        const isBanned = banpicState.allBannedIds.includes(brawler.id);
        const isPicked = [...banpicState.bluePicks, ...banpicState.redPicks].includes(brawler.id);
        const isSelected = banpicState.selectedCharacters.includes(brawler.id);
        
        const card = document.createElement('div');
        card.className = 'character-card';
        card.setAttribute('data-rarity', brawler.rarityLevel);
        if (isBanned) card.classList.add('banned');
        if (isPicked) card.classList.add('picked');
        if (isSelected) card.classList.add('selected');
        
        card.innerHTML = `
            <div class="char-icon"><img src="image/${brawler.image}" alt="${brawler.name}"></div>
            <div class="char-name">${brawler.name}</div>
            ${isBanned ? '<div class="ban-overlay">ğŸš«</div>' : ''}
        `;
        
        if (!isBanned && !isPicked) {
            card.addEventListener('click', () => selectCharacter(brawler.id));
        }
        
        grid.appendChild(card);
    });
}

// ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
function selectCharacter(charId) {
    const phase = banpicState.phase;
    
    // å®Œäº†ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯é¸æŠä¸å¯
    if (phase === 'done') {
        return;
    }
    
    // æ—¢ã«ç¢ºå®šæ¸ˆã¿ã®å ´åˆã¯é¸æŠã§ããªã„
    if (banpicState.confirmed) {
        console.log('Already confirmed, cannot select');
        return;
    }
    
    // BANãƒ•ã‚§ãƒ¼ã‚ºã®å‡¦ç†
    if (phase === 'ban') {
        // BANãƒ•ã‚§ãƒ¼ã‚º: æœ€å¤§3ä½“ã¾ã§é¸æŠå¯èƒ½ï¼ˆãƒˆã‚°ãƒ«ï¼‰
        const idx = banpicState.selectedCharacters.indexOf(charId);
        if (idx >= 0) {
            banpicState.selectedCharacters.splice(idx, 1);
        } else if (banpicState.selectedCharacters.length < 3) {
            banpicState.selectedCharacters.push(charId);
        }
    } else if (phase.startsWith('pic')) {
        // PICãƒ•ã‚§ãƒ¼ã‚º: è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®ã¿é¸æŠå¯èƒ½
        if (!isPlayerTurn()) {
            console.log('Not your turn - blocking selection');
            return;
        }
        // 1ä½“ã ã‘é¸æŠï¼ˆç½®ãæ›ãˆï¼‰
        // æ—¢ã«åŒã˜ã‚­ãƒ£ãƒ©ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€å†åº¦æŠ¼ã™ã¨å³ç¢ºå®š
        if (banpicState.selectedCharacters.length === 1 && banpicState.selectedCharacters[0] === charId) {
            confirmSelection();
            return;
        }
        banpicState.selectedCharacters = [charId];
    } else {
        // ä¸æ˜ãªãƒ•ã‚§ãƒ¼ã‚ºã¯ç„¡è¦–
        console.log('Unknown phase:', phase);
        return;
    }
    
    renderCharacterGrid();
    updateConfirmButton();
    updateSlotPreview();
}

// ç¢ºå®šãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
function updateConfirmButton() {
    const btn = document.getElementById('confirm-selection-btn');
    if (!btn) return;
    
    const phase = banpicState.phase;
    
    // æ—¢ã«ç¢ºå®šæ¸ˆã¿ã®å ´åˆ
    if (banpicState.confirmed) {
        btn.disabled = true;
        if (phase === 'ban') {
            btn.textContent = 'ç¢ºå®šæ¸ˆã¿ - ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...';
        } else {
            btn.textContent = 'ç¢ºå®šæ¸ˆã¿';
        }
        return;
    }
    
    if (phase === 'ban') {
        btn.disabled = banpicState.selectedCharacters.length !== 3;
        btn.textContent = `BANç¢ºå®š (${banpicState.selectedCharacters.length}/3)`;
    } else if (phase && phase.startsWith('pic')) {
        // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã‹ã©ã†ã‹
        const isMyTurn = isPlayerTurn();
        if (!isMyTurn) {
            btn.disabled = true;
            btn.textContent = 'ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³...';
        } else {
            btn.disabled = banpicState.selectedCharacters.length !== 1;
            btn.textContent = banpicState.selectedCharacters.length === 1 ? 'é¸æŠã‚’ç¢ºå®š' : 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ';
        }
    } else if (phase === 'done') {
        btn.disabled = true;
        btn.textContent = 'å®Œäº†';
    } else {
        btn.disabled = true;
        btn.textContent = 'æº–å‚™ä¸­...';
    }
}

// ã‚¹ãƒ­ãƒƒãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
function updateSlotPreview() {
    // æœªæ±ºå®šã‚¹ãƒ­ãƒƒãƒˆç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function setSlotToDefault(slot) {
        if (!slot) return;
        slot.classList.remove('filled');
        slot.classList.add('empty');
        // pick-orderãƒãƒƒã‚¸ã‚’ä¿æŒ
        const existingOrder = slot.querySelector('.pick-order');
        const orderHTML = existingOrder ? existingOrder.outerHTML : '';
        if (slot.classList.contains('ban-slot')) {
            slot.innerHTML = `<img src="image/default_ban.png" alt="BAN">`;
        } else if (slot.classList.contains('pick-slot')) {
            slot.innerHTML = `<img src="image/default_pic.png" alt="PIC">${orderHTML}`;
        } else {
            slot.innerHTML = '';
        }
    }

    // å…ˆã«å…¨ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºã«æˆ»ã™
    const allLeft = document.querySelectorAll('#ban-slots-left .ban-slot');
    const allRight = document.querySelectorAll('#ban-slots-right .ban-slot');
    const allBluePick = document.querySelectorAll('#pick-slots-blue .pick-slot');
    const allRedPick = document.querySelectorAll('#pick-slots-red .pick-slot');
    allLeft.forEach(setSlotToDefault);
    allRight.forEach(setSlotToDefault);
    allBluePick.forEach(setSlotToDefault);
    allRedPick.forEach(setSlotToDefault);

    // BANã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤º
    const leftSlots = document.querySelectorAll('#ban-slots-left .ban-slot');
    const rightSlots = document.querySelectorAll('#ban-slots-right .ban-slot');
    
    banpicState.blueBans.forEach((charId, i) => {
        const brawler = BRAWLERS.find(b => b.id === charId);
        if (brawler && leftSlots[i]) {
            leftSlots[i].innerHTML = `<img src="image/${brawler.image}" alt="${brawler.name}">`;
            leftSlots[i].classList.add('filled');
            leftSlots[i].classList.remove('empty');
        }
    });
    
    banpicState.redBans.forEach((charId, i) => {
        const brawler = BRAWLERS.find(b => b.id === charId);
        if (brawler && rightSlots[i]) {
            rightSlots[i].innerHTML = `<img src="image/${brawler.image}" alt="${brawler.name}">`;
            rightSlots[i].classList.add('filled');
            rightSlots[i].classList.remove('empty');
        }
    });
    
    // PICKã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤º
    const bluePickSlots = document.querySelectorAll('#pick-slots-blue .pick-slot');
    const redPickSlots = document.querySelectorAll('#pick-slots-red .pick-slot');
    
    banpicState.bluePicks.forEach((charId, i) => {
        const brawler = BRAWLERS.find(b => b.id === charId);
        if (brawler && bluePickSlots[i]) {
            const orderBadge = bluePickSlots[i].querySelector('.pick-order');
            const orderHTML = orderBadge ? orderBadge.outerHTML : '';
            bluePickSlots[i].innerHTML = `<img src="image/${brawler.image}" alt="${brawler.name}"><span class="slot-check">âœ“</span>${orderHTML}`;
            bluePickSlots[i].classList.add('filled');
            bluePickSlots[i].classList.remove('empty');
        }
    });
    
    banpicState.redPicks.forEach((charId, i) => {
        const brawler = BRAWLERS.find(b => b.id === charId);
        // ãƒ¬ãƒƒãƒ‰å´ã¯é€†é †ã§è¡¨ç¤ºï¼ˆdata-slot="2,1,0"ã®é †ï¼‰
        const slotIndex = 2 - i;
        const slot = Array.from(redPickSlots).find(s => s.dataset.slot === String(slotIndex));
        if (brawler && slot) {
            const orderBadge = slot.querySelector('.pick-order');
            const orderHTML = orderBadge ? orderBadge.outerHTML : '';
            slot.innerHTML = `<img src="image/${brawler.image}" alt="${brawler.name}"><span class="slot-check">âœ“</span>${orderHTML}`;
            slot.classList.add('filled');
            slot.classList.remove('empty');
        }
    });

    // æœªç¢ºå®šã®é¸æŠã‚’ã‚¹ãƒ­ãƒƒãƒˆã«è¡¨ç¤ºï¼ˆè‡ªåˆ†ã®é¸æŠï¼‰
    const phase = banpicState.phase;
    const isBluePlayer = banpicState.isBlueTeam;
    if (banpicState.selectedCharacters.length > 0) {
        if (phase === 'ban') {
            // BANæ™‚ã¯åŒã˜åˆ—ï¼ˆè‡ªãƒãƒ¼ãƒ ï¼‰ã«é¸æŠã‚’è¡¨ç¤º
            const targetSlots = isBluePlayer ? leftSlots : rightSlots;
            banpicState.selectedCharacters.forEach((charId, i) => {
                const b = BRAWLERS.find(x => x.id === charId);
                if (b && targetSlots[i] && targetSlots[i].classList.contains('empty')) {
                    targetSlots[i].innerHTML = `<img src="image/${b.image}" alt="${b.name}">`;
                    targetSlots[i].classList.add('selected');
                    targetSlots[i].classList.remove('empty');
                }
            });
        } else if (phase.startsWith('pic')) {
            // PICæ™‚ã¯è‡ªãƒãƒ¼ãƒ ã®æ¬¡ã®ãƒ”ãƒƒã‚¯ã‚¹ãƒ­ãƒƒãƒˆã«è¡¨ç¤º
            if (isBluePlayer) {
                const nextIndex = banpicState.bluePicks.length; // 0..2
                const slot = bluePickSlots[nextIndex];
                const b = BRAWLERS.find(x => x.id === banpicState.selectedCharacters[0]);
                if (b && slot && slot.classList.contains('empty')) {
                    slot.innerHTML = `<img src="image/${b.image}" alt="${b.name}">`;
                    slot.classList.add('selected');
                    slot.classList.remove('empty');
                }
            } else {
                // ãƒ¬ãƒƒãƒ‰ã¯é€†ä½ç½®
                const nextIndex = banpicState.redPicks.length; // 0..2
                const targetSlotIndex = 2 - nextIndex; // data-slot mapping
                const slot = Array.from(redPickSlots).find(s => s.dataset.slot === String(targetSlotIndex));
                const b = BRAWLERS.find(x => x.id === banpicState.selectedCharacters[0]);
                if (b && slot && slot.classList.contains('empty')) {
                    slot.innerHTML = `<img src="image/${b.image}" alt="${b.name}">`;
                    slot.classList.add('selected');
                    slot.classList.remove('empty');
                }
            }
        }
    }

    // PIC ãƒ•ã‚§ãƒ¼ã‚ºã«å¿œã˜ã¦è©²å½“ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚¯ãƒ©ã‚¹ pic-phase-activeï¼‰
    // ã¾ãšæ—¢å­˜ã®ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
    document.querySelectorAll('#pick-slots-blue .pick-slot, #pick-slots-red .pick-slot').forEach(s => s.classList.remove('pic-phase-active'));
    if (banpicState.phase && banpicState.phase.startsWith('pic')) {
        const picNum = parseInt(banpicState.phase.replace('pic',''));
        const isBlueTurn = ['1','4','5'].includes(String(picNum)) ? true : false;
        // ãŸã ã—å®Ÿéš›ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ–ãƒ«ãƒ¼ã‹ã¯é–¢ä¿‚ãªãã€è¡¨ç¤ºä¸Šã¯è‡ªãƒãƒ¼ãƒ ã®æ¬¡ã‚¹ãƒ­ãƒƒãƒˆã‚’ç™½ã«ã™ã‚‹
        if (isBlueTurn) {
            const nextIndex = banpicState.bluePicks.length; // æ¬¡ã«åŸ‹ã¾ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            const target = bluePickSlots[nextIndex];
            if (target) target.classList.add('pic-phase-active');
        } else {
            const nextIndex = banpicState.redPicks.length; // 0..2
            const targetSlotIndex = 2 - nextIndex;
            const target = Array.from(redPickSlots).find(s => s.dataset.slot === String(targetSlotIndex));
            if (target) target.classList.add('pic-phase-active');
        }
    }
    // ãƒ”ãƒƒã‚¯é †ãƒãƒƒã‚¸ãŒæ¶ˆãˆã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€ã‚¹ãƒ­ãƒƒãƒˆæ›´æ–°å¾Œã«å†æç”»
    if (typeof updatePickOrderLabels === 'function') updatePickOrderLabels();
}

// ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºã‚’æ›´æ–°
function updatePhaseDisplay() {
    const phaseText = document.getElementById('phase-text');
    const timerEl = document.getElementById('phase-timer');
    
    const phaseSteps = document.querySelectorAll('.phase-step');
    phaseSteps.forEach((step, i) => {
        step.classList.remove('active', 'completed');
        if (i < banpicState.phaseIndex) {
            step.classList.add('completed');
        } else if (i === banpicState.phaseIndex) {
            step.classList.add('active');
        }
    });
    
    if (phaseText) {
        const phase = banpicState.phase;
        if (phase === 'ban') {
            phaseText.textContent = 'ä½¿ç”¨ç¦æ­¢ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ (BAN)';
            phaseText.style.color = 'var(--text-color)';
        } else if (phase && phase.startsWith('pic')) {
            const picNum = parseInt(phase.replace('pic', ''));
            const isMyTurn = isPlayerTurn();
            phaseText.textContent = isMyTurn 
                ? `ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ (PICK ${picNum})` 
                : `ç›¸æ‰‹ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠä¸­... (PICK ${picNum})`;
            phaseText.style.color = 'var(--text-color)';
        } else if (phase === 'done') {
            phaseText.textContent = 'ğŸ‰ BANPICå®Œäº†ï¼';
            phaseText.style.color = 'var(--secondary-color)';
        } else {
            phaseText.textContent = 'æº–å‚™ä¸­...';
        }
    }
    
    if (timerEl) {
        timerEl.textContent = `${banpicState.timer}ç§’`;
        if (banpicState.timer <= 5) {
            timerEl.style.color = 'var(--danger-color)';
        } else {
            timerEl.style.color = 'var(--warning-color)';
        }
    }
    
    // ãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒãƒ¼ã‚‚æ›´æ–°
    const mapModalTimer = document.getElementById('map-modal-timer-value');
    if (mapModalTimer) {
        mapModalTimer.textContent = `${banpicState.timer}ç§’`;
    }
}

// ãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openMapModal() {
    const modal = document.getElementById('map-modal');
    const mapImage = document.getElementById('map-modal-image');
    const mapName = banpicState.map;
    
    // ãƒãƒƒãƒ—ç”»åƒã‚’è¨­å®š
    if (IMAGE_DATA && IMAGE_DATA.maps) {
        const mapData = IMAGE_DATA.maps.find(m => m.name === mapName);
        if (mapData) {
            mapImage.src = `image/${mapData.image}`;
        } else {
            mapImage.src = `image/m-${mapName}.png`;
        }
    } else {
        mapImage.src = `image/m-${mapName}.png`;
    }
    
    // ã‚¿ã‚¤ãƒãƒ¼ã‚’åŒæœŸ
    const mapModalTimer = document.getElementById('map-modal-timer-value');
    if (mapModalTimer) {
        mapModalTimer.textContent = `${banpicState.timer}ç§’`;
    }
    
    modal.classList.add('active');
}

// ãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeMapModal() {
    const modal = document.getElementById('map-modal');
    modal.classList.remove('active');
}

// è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã‹ã©ã†ã‹ã‚’åˆ¤å®š
// PICKé †: å…ˆæ”»â†’å¾Œæ”»â†’å¾Œæ”»â†’å…ˆæ”»â†’å…ˆæ”»â†’å¾Œæ”»
// PIC 1,4,5 = å…ˆæ”»ãƒãƒ¼ãƒ ã®ã‚¿ãƒ¼ãƒ³
// PIC 2,3,6 = å¾Œæ”»ãƒãƒ¼ãƒ ã®ã‚¿ãƒ¼ãƒ³
function isPlayerTurn() {
    const phase = banpicState.phase;
    const isBlue = banpicState.isBlueTeam;
    
    if (phase === 'ban') return true;  // BANã¯åŒæ™‚ãªã®ã§å¸¸ã«è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³
    
    // å…ˆæ”»ãŒPIC1,4,5 / å¾Œæ”»ãŒPIC2,3,6
    const firstMoveTurns = ['pic1', 'pic4', 'pic5'];
    const secondMoveTurns = ['pic2', 'pic3', 'pic6'];
    
    // isBlue = true ãªã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å…ˆæ”»ãƒãƒ¼ãƒ 
    if (isBlue) {
        return firstMoveTurns.includes(phase);
    } else {
        return secondMoveTurns.includes(phase);
    }
}

// ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
function startPhaseTimer() {
    // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’å®Œå…¨ã«åœæ­¢
    stopPhaseTimer();
    
    // ã‚¿ã‚¤ãƒãƒ¼ãŒæ—¢ã«å‹•ã„ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆäºŒé‡èµ·å‹•é˜²æ­¢ï¼‰
    if (banpicState.timerInterval) {
        console.warn('Timer already running, skipping start');
        return;
    }
    
    banpicState.timer = banpicState.timerDuration || 20;
    updatePhaseDisplay();
    
    banpicState.timerInterval = setInterval(() => {
        banpicState.timer--;
        updatePhaseDisplay();
        
        if (banpicState.timer <= 0) {
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã§ç¢ºå®š
            handleTimeout();
        }
    }, 1000);
}

function stopPhaseTimer() {
    if (banpicState.timerInterval) {
        clearInterval(banpicState.timerInterval);
        banpicState.timerInterval = null;
    }
}

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
function isOnlineMode() {
    return !banpicState.isTestMode && banpicState.roomId;
}

// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
function handleTimeout() {
    const phase = banpicState.phase;
    const available = getAvailableCharacters();
    
    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆç›¸æ‰‹ã®æ™‚é–“åˆ‡ã‚Œã¯ç›¸æ‰‹å´ã§å‡¦ç†ï¼‰
    if (isOnlineMode() && !isPlayerTurn()) {
        return;
    }
    
    if (phase === 'ban') {
        // è¶³ã‚Šãªã„åˆ†ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§åŸ‹ã‚ã‚‹
        while (banpicState.selectedCharacters.length < 3 && available.length > 0) {
            const randomIdx = Math.floor(Math.random() * available.length);
            const charId = available[randomIdx].id;
            if (!banpicState.selectedCharacters.includes(charId)) {
                banpicState.selectedCharacters.push(charId);
                available.splice(randomIdx, 1);
            }
        }
    } else if (phase.startsWith('pic') && banpicState.selectedCharacters.length === 0) {
        // ãƒ©ãƒ³ãƒ€ãƒ ã§1ä½“é¸æŠ
        if (available.length > 0) {
            const randomIdx = Math.floor(Math.random() * available.length);
            banpicState.selectedCharacters = [available[randomIdx].id];
        }
    }
    
    confirmSelection();
}

// åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ£ãƒ©ã‚’å–å¾—
function getAvailableCharacters() {
    return BRAWLERS.filter(b => {
        return !banpicState.allBannedIds.includes(b.id) 
            && !banpicState.bluePicks.includes(b.id)
            && !banpicState.redPicks.includes(b.id);
    });
}

// é¸æŠç¢ºå®š
function confirmSelection() {
    stopPhaseTimer();

    const phase = banpicState.phase;
    const isBlue = banpicState.isBlueTeam;
    const roomId = banpicState.roomId;

    // æ—¢ã«ç¢ºå®šæ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆäºŒé‡ç¢ºå®šé˜²æ­¢ï¼‰
    if (banpicState.confirmed) {
        console.log('Already confirmed, ignoring');
        return;
    }

    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰: Firebase ã«å¯¾ã—ã¦ç¢ºå®šã‚’æ›¸ãè¾¼ã‚€
    if (!banpicState.isTestMode && roomId) {
        const gameRef = database.ref(`rooms/${roomId}/game`);

        if (phase === 'ban') {
            // BANã¯3ä½“é¸æŠã§ç¢ºå®š
            if (!banpicState.selectedCharacters || banpicState.selectedCharacters.length !== 3) {
                console.log('BAN requires exactly 3 characters');
                return;
            }

            banpicState.confirmed = true; // äºŒé‡ç¢ºå®šé˜²æ­¢

            const updateData = {};
            if (isBlue) {
                updateData.blueBans = banpicState.selectedCharacters;
                updateData.blueConfirmed = true;
            } else {
                updateData.redBans = banpicState.selectedCharacters;
                updateData.redConfirmed = true;
            }

            gameRef.update(updateData).then(() => {
                banpicState.selectedCharacters = [];
                updateConfirmButton();
                renderCharacterGrid();
            }).catch(err => {
                console.error('BANç¢ºå®šã‚¨ãƒ©ãƒ¼:', err);
                banpicState.confirmed = false;
                alert('ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ');
            });

        } else if (phase.startsWith('pic')) {
            // PICã¯1ä½“é¸æŠã§ç¢ºå®š
            if (!banpicState.selectedCharacters || banpicState.selectedCharacters.length !== 1) {
                console.log('PIC requires exactly 1 character');
                return;
            }

            const picNum = parseInt(phase.replace('pic', ''));
            // PIC 1,4,5 = å…ˆæ”»(blue)ã®ã‚¿ãƒ¼ãƒ³ / PIC 2,3,6 = å¾Œæ”»(red)ã®ã‚¿ãƒ¼ãƒ³
            const isBluePhase = [1,4,5].includes(picNum);

            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®ã¿ç¢ºå®šã‚’è¨±ã™
            if ((isBlue && isBluePhase) || (!isBlue && !isBluePhase)) {
                banpicState.confirmed = true;
                // èª­ã¿å‡ºã—ã¦é…åˆ—ã«è¿½åŠ ã—ã¦ã‹ã‚‰æ›´æ–°
                gameRef.once('value').then(snap => {
                    const current = snap.val() || {};
                    const picks = isBlue ? ([...(current.bluePicks || [])]) : ([...(current.redPicks || [])]);

                    // æ—¢ã«åŒã˜ãƒ”ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    const pickId = banpicState.selectedCharacters[0];
                    if (picks.includes(pickId)) {
                        console.log('Character already picked');
                        banpicState.confirmed = false;
                        return;
                    }

                    picks.push(pickId);

                    const updateData = {};
                    if (isBlue) {
                        updateData.bluePicks = picks;
                        updateData.blueConfirmed = true;
                    } else {
                        updateData.redPicks = picks;
                        updateData.redConfirmed = true;
                    }

                    return gameRef.update(updateData);
                }).then(() => {
                    banpicState.selectedCharacters = [];
                    updateConfirmButton();
                    renderCharacterGrid();
                }).catch(err => {
                    console.error('PICKç¢ºå®šã‚¨ãƒ©ãƒ¼:', err);
                    banpicState.confirmed = false;
                    alert('ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
            } else {
                console.log('Not your turn');
            }
        }

        // UI ã‚’æ›´æ–°ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã¯ gameRef ã®ç›£è¦–ã§è¡Œã†ï¼‰
        renderCharacterGrid();
        updateSlotPreview();
        updatePhaseDisplay();
        updateConfirmButton();

        return;
    }

    // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®æ—¢å­˜å‡¦ç†
    if (phase === 'ban') {
        if (isBlue) {
            banpicState.blueBans = [...banpicState.selectedCharacters];
        } else {
            banpicState.redBans = [...banpicState.selectedCharacters];
        }
        banpicState.selectedCharacters = [];

        if (banpicState.isTestMode) {
            if (isBlue) {
                banpicState.redBans = generateBotBans();
            } else {
                banpicState.blueBans = generateBotBans();
            }
        }

        const allBans = new Set([...banpicState.blueBans, ...banpicState.redBans]);
        banpicState.allBannedIds = [...allBans];

        banpicState.phase = 'pic1';
        banpicState.phaseIndex = 1;

        if (banpicState.isTestMode && !isPlayerTurn()) {
            renderCharacterGrid();
            updateSlotPreview();
            updatePhaseDisplay();
            updateConfirmButton();
            setTimeout(() => {
                botSelectPick();
            }, 1000);
            return;
        }

    } else if (phase.startsWith('pic')) {
        const picNum = parseInt(phase.replace('pic', ''));
        const isMyTurn = isPlayerTurn();

        if (isMyTurn) {
            if (isBlue) {
                banpicState.bluePicks.push(banpicState.selectedCharacters[0]);
            } else {
                banpicState.redPicks.push(banpicState.selectedCharacters[0]);
            }
            banpicState.selectedCharacters = [];
        }

        if (picNum < 6) {
            banpicState.phase = `pic${picNum + 1}`;
            banpicState.phaseIndex = picNum + 1;

            if (banpicState.isTestMode && !isPlayerTurn()) {
                setTimeout(() => {
                    botSelectPick();
                }, 1000);
                return;
            }
        } else {
            banpicState.phase = 'done';
            banpicState.phaseIndex = 7;
            showBanpicResult();
            return;
        }
    }

    renderCharacterGrid();
    updateSlotPreview();
    updatePhaseDisplay();
    updateConfirmButton();

    if (banpicState.phase !== 'done') {
        startPhaseTimer();
    }
}

// BOTã®BANç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ 3ä½“ï¼‰
function generateBotBans() {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒBANã—ãŸã‚­ãƒ£ãƒ©ã‚’é™¤å¤–
    const playerBans = banpicState.isBlueTeam ? banpicState.blueBans : banpicState.redBans;
    const available = BRAWLERS.filter(b => !playerBans.includes(b.id));
    const bans = [];
    
    for (let i = 0; i < 3 && available.length > 0; i++) {
        const idx = Math.floor(Math.random() * available.length);
        bans.push(available[idx].id);
        available.splice(idx, 1);
    }
    
    return bans;
}

// BOTã®PICKé¸æŠ
function botSelectPick() {
    const available = getAvailableCharacters();
    if (available.length === 0) {
        confirmSelection();
        return;
    }
    
    const idx = Math.floor(Math.random() * available.length);
    const charId = available[idx].id;
    
    // BOTã®PICKã‚’è¿½åŠ ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå¯¾å´ï¼‰
    if (banpicState.isBlueTeam) {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé’ãªã®ã§BOTã¯èµ¤
        banpicState.redPicks.push(charId);
    } else {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒèµ¤ãªã®ã§BOTã¯é’
        banpicState.bluePicks.push(charId);
    }
    
    // æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸
    const picNum = parseInt(banpicState.phase.replace('pic', ''));
    if (picNum < 6) {
        banpicState.phase = `pic${picNum + 1}`;
        banpicState.phaseIndex = picNum + 1;
    } else {
        banpicState.phase = 'done';
        banpicState.phaseIndex = 7;
        renderCharacterGrid();
        updateSlotPreview();
        updatePhaseDisplay();
        showBanpicResult();
        return;
    }
    
    renderCharacterGrid();
    updateSlotPreview();
    updatePhaseDisplay();
    updateConfirmButton();
    
    // BOTãŒé€£ç¶šã‚¿ãƒ¼ãƒ³ã®å ´åˆ
    if (banpicState.isTestMode && !isPlayerTurn()) {
        setTimeout(() => {
            botSelectPick();
        }, 1000);
    } else {
        startPhaseTimer();
    }
}

// BANPICçµæœè¡¨ç¤º
function showBanpicResult() {
    stopPhaseTimer();
    
    const phaseText = document.getElementById('phase-text');
    if (phaseText) {
        phaseText.textContent = 'ğŸ‰ BANPICå®Œäº†ï¼';
        phaseText.style.color = 'var(--secondary-color)';
    }
    
    // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’ã€Œãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹ã€ã«å¤‰æ›´
    const btn = document.getElementById('confirm-selection-btn');
    if (btn) {
        btn.disabled = false;
        btn.textContent = 'ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹';
        btn.onclick = exitBanpic;
    }
}

// BANPICé–‹å§‹ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰
// å¼•æ•°: modeKey (optional) - MODE_DATA ã®ã‚­ãƒ¼ã€ mapName (optional)ã€firstMove (optional) - 'random'/'host'/'guest'
function startTestMode(modeKey, mapName, firstMove) {
    // å…ˆæ”»å¾Œæ”»ã‚’æ±ºå®šï¼ˆfirstMoveãŒrandomãªã‚‰50%ã§åˆ‡ã‚Šæ›¿ãˆï¼‰
    let isBlueFirst = true;
    // random ãŒæŒ‡å®šã•ã‚Œã‚‹ã‹ã€å¼•æ•°ãŒæœªæŒ‡å®šã®å ´åˆã¯50/50ã§æ±ºå®š
    if (!firstMove || firstMove === 'random') {
        isBlueFirst = Math.random() < 0.5;
    } else if (firstMove === 'guest') {
        isBlueFirst = false; // guest æŒ‡å®šãªã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å¾Œæ”»ï¼ˆèµ¤ï¼‰ã«ãªã‚‹
    } else if (firstMove === 'host') {
        isBlueFirst = true; // host æŒ‡å®šãªã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å…ˆæ”»ï¼ˆé’ï¼‰
    }
    // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    banpicState = {
        isTestMode: true,
        isBlueTeam: isBlueFirst,
        phase: 'ban',
        phaseIndex: 0,
        timer: 20,
        timerDuration: 20,
        timerInterval: null,
        selectedCharacters: [],
        blueBans: [],
        redBans: [],
        bluePicks: [],
        redPicks: [],
        allBannedIds: [],
        // mode ã¯ name ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æœŸå¾…ã™ã‚‹ãŸã‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§æ ¼ç´
        mode: null,
        map: 'é™ã‹ãªåºƒå ´',
    };
    // å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸ modeKey ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ãªã‘ã‚Œã°æ—¢å­˜ã® GAME_MODES ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
    if (modeKey && MODE_DATA && MODE_DATA[modeKey]) {
        banpicState.mode = { id: modeKey, name: MODE_DATA[modeKey].label };
    } else if (typeof GAME_MODES !== 'undefined' && Array.isArray(GAME_MODES) && GAME_MODES.length) {
        // GAME_MODES ã®å„è¦ç´ ãŒ {id, name} ã‹ {name} ã‚’æƒ³å®š
        const gm = GAME_MODES[Math.floor(Math.random() * GAME_MODES.length)];
        banpicState.mode = (gm && gm.name) ? gm : { id: gm && gm.id ? gm.id : 'soccer', name: gm && gm.name ? gm.name : (MODE_DATA && MODE_DATA.soccer ? MODE_DATA.soccer.label : 'ãƒ–ãƒ­ã‚¹ãƒˆãƒ©ã‚¤ã‚«ãƒ¼') };
    } else {
        banpicState.mode = { id: 'soccer', name: (MODE_DATA && MODE_DATA.soccer ? MODE_DATA.soccer.label : 'ãƒ–ãƒ­ã‚¹ãƒˆãƒ©ã‚¤ã‚«ãƒ¼') };
    }

    if (mapName) banpicState.map = mapName;

    // ãƒ¢ãƒ¼ãƒ‰ãƒ»ãƒãƒƒãƒ—è¡¨ç¤º
    const banpicModeEl = document.getElementById('banpic-mode');
    const banpicMapEl = document.getElementById('banpic-map');
    if (banpicModeEl) banpicModeEl.textContent = banpicState.mode.name;
    if (banpicMapEl) banpicMapEl.textContent = banpicState.map;
    
    // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯è¡¨ç¤ºã—ãªã„ï¼ˆå³å´ã®ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ï¼‰
    // å…ƒã®å®Ÿè£…ã¯ã“ã“ã§è¦ç´ ã‚’è¿½åŠ ã—ã¦ã„ãŸãŒã€UIã‹ã‚‰é™¤å»ã—ã¾ã™ã€‚
    
    // ã‚¹ãƒ­ãƒƒãƒˆãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('.ban-slot, .pick-slot').forEach(slot => {
        slot.innerHTML = '';
        slot.classList.remove('filled');
        slot.classList.add('empty');
    });
    
    // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’åˆæœŸåŒ–
    const btn = document.getElementById('confirm-selection-btn');
    if (btn) {
        btn.onclick = null;
        btn.textContent = 'é¸æŠã‚’ç¢ºå®š';
        btn.disabled = true;
    }
    
    showScreen('game-screen');
    renderCharacterGrid();
    updateSlotPreview();
    updatePickOrderLabels(); // ãƒ”ãƒƒã‚¯é †ãƒ©ãƒ™ãƒ«æ›´æ–°
    updatePhaseDisplay();
    updateConfirmButton();
    
    // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’è¨­å®š
    const blueNameEl = document.getElementById('blue-player-name');
    const redNameEl = document.getElementById('red-player-name');
    const blueAvatarEl = document.getElementById('blue-player-avatar');
    const redAvatarEl = document.getElementById('red-player-avatar');
    if (banpicState.isBlueTeam) {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé’ï¼ˆå·¦ï¼‰ã€BOTãŒèµ¤ï¼ˆå³ï¼‰
        if (blueNameEl) blueNameEl.textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
        if (redNameEl) redNameEl.textContent = 'BOT';
        // ã‚¢ãƒã‚¿ãƒ¼è¨­å®š
        if (blueAvatarEl && userAvatarUrl) {
            blueAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="player">`;
        } else if (blueAvatarEl) {
            blueAvatarEl.textContent = 'ğŸ‘¤';
        }
        if (redAvatarEl) redAvatarEl.textContent = 'ğŸ¤–';
    } else {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒèµ¤ï¼ˆå³ï¼‰ã€BOTãŒé’ï¼ˆå·¦ï¼‰
        if (blueNameEl) blueNameEl.textContent = 'BOT';
        if (redNameEl) redNameEl.textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
        // ã‚¢ãƒã‚¿ãƒ¼è¨­å®š
        if (blueAvatarEl) blueAvatarEl.textContent = 'ğŸ¤–';
        if (redAvatarEl && userAvatarUrl) {
            redAvatarEl.innerHTML = `<img src="${userAvatarUrl}" alt="player">`;
        } else if (redAvatarEl) {
            redAvatarEl.textContent = 'ğŸ‘¤';
        }
    }
    // å…ˆæ”»è¡¨ç¤ºã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
    const firstMoveIndicator = document.getElementById('first-move-indicator');
    if (firstMoveIndicator) {
        if (banpicState.isBlueTeam) {
            firstMoveIndicator.textContent = 'å…ˆæ”»: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
        } else {
            firstMoveIndicator.textContent = 'å…ˆæ”»: BOT';
        }
    }
    
    startPhaseTimer();
}

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦é–‹å§‹å‡¦ç† (meta ã¯ rooms/{id}/meta ã®å†…å®¹)
function startOnlineMode(meta, roomId) {
    // å¤ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤ï¼ˆå‰å›ã®ãƒ«ãƒ¼ãƒ ã®æ®‹éª¸é˜²æ­¢ï¼‰
    if (activeGameRef) {
        activeGameRef.off();
        activeGameRef = null;
    }
    stopPhaseTimer();
    
    // å…ˆæ”»æƒ…å ±ã®è§£æ±ºï¼ˆhost ãŒæ±ºå®šæ¸ˆã¿ã® resolvedFirstMoveIsBlue ã‚’å„ªå…ˆï¼‰
    let resolvedIsBlue = true;
    if (typeof meta.resolvedFirstMoveIsBlue !== 'undefined') {
        resolvedIsBlue = !!meta.resolvedFirstMoveIsBlue;
    } else if (meta.firstMove === 'host') {
        resolvedIsBlue = true;
    } else if (meta.firstMove === 'guest') {
        resolvedIsBlue = false;
    } else {
        resolvedIsBlue = Math.random() < 0.5;
    }

    const amHost = (currentUserId === meta.hostId);
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰è¦‹ãŸè‡ªãƒãƒ¼ãƒ : ãƒ›ã‚¹ãƒˆãŒå…ˆæ”»ã§ resolvedIsBlue=true ãªã‚‰ãƒ›ã‚¹ãƒˆã¯é’
    const myIsBlue = amHost ? resolvedIsBlue : !resolvedIsBlue;

    // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ—ãƒ¬ã‚¤ï¼‰
    const gameDuration = meta.timerDuration || 20;
    banpicState = {
        isTestMode: false,
        isBlueTeam: myIsBlue,
        phase: 'ban',
        phaseIndex: 0,
        timer: gameDuration,
        timerDuration: gameDuration,
        timerInterval: null,
        selectedCharacters: [],
        blueBans: [],
        redBans: [],
        bluePicks: [],
        redPicks: [],
        allBannedIds: [],
        mode: { id: (meta.mode || 'eme'), name: (MODE_DATA && MODE_DATA[meta.mode] ? MODE_DATA[meta.mode].label : (meta.mode || 'ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ãƒãƒ³ãƒˆ')) },
        map: meta.mapName || 'é™ã‹ãªåºƒå ´',
        roomId: roomId,
        amHost: amHost,
        confirmed: false,  // ç¢ºå®šæ¸ˆã¿ãƒ•ãƒ©ã‚°ï¼ˆãã®ãƒ•ã‚§ãƒ¼ã‚ºå†…ã§ã®äºŒé‡ç¢ºå®šé˜²æ­¢ï¼‰
        banPhaseComplete: false
    };

    // ãƒ›ã‚¹ãƒˆã¯ game ãƒãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ã—ã¦é€²è¡Œã‚’ç®¡ç†ã™ã‚‹
    const gameRef = database.ref(`rooms/${roomId}/game`);
    activeGameRef = gameRef; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç”¨ï¼‰
    if (amHost) {
        gameRef.set({
            phase: 'ban',
            phaseIndex: 0,
            blueBans: [],
            redBans: [],
            bluePicks: [],
            redPicks: [],
            blueConfirmed: false,
            redConfirmed: false
        }).catch(e => console.warn('failed to init game node', e));
    }

    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ç›£è¦–
    // å‰å›ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’è¿½è·¡ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´æ¤œå‡ºç”¨ï¼‰
    let previousPhase = null;
    
    gameRef.on('value', (snapshot) => {
        const gameData = snapshot.val();
        if (!gameData) return;
        console.log('Game state updated:', JSON.stringify(gameData));

        const dbPhase = gameData.phase || 'ban';
        const dbPhaseIndex = gameData.phaseIndex || 0;
        const blueConfirmed = !!gameData.blueConfirmed;
        const redConfirmed = !!gameData.redConfirmed;

        // =====================================
        // 1. BAN/PICK ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
        // =====================================
        if (dbPhase === 'ban') {
            // BANãƒ•ã‚§ãƒ¼ã‚ºä¸­ã¯ç›¸æ‰‹ã®BANã‚’ä¸¡è€…ç¢ºå®šã¾ã§éš ã™
            if (myIsBlue) {
                banpicState.blueBans = gameData.blueBans || [];
                banpicState.redBans = (blueConfirmed && redConfirmed) ? (gameData.redBans || []) : [];
            } else {
                banpicState.redBans = gameData.redBans || [];
                banpicState.blueBans = (blueConfirmed && redConfirmed) ? (gameData.blueBans || []) : [];
            }
        } else {
            // PICä»¥é™ã¯å…¨BANã‚’è¡¨ç¤º
            banpicState.blueBans = gameData.blueBans || [];
            banpicState.redBans = gameData.redBans || [];
        }

        banpicState.bluePicks = gameData.bluePicks || [];
        banpicState.redPicks = gameData.redPicks || [];
        banpicState.allBannedIds = [...new Set([...(banpicState.blueBans || []), ...(banpicState.redBans || [])])];

        // =====================================
        // 2. ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã®åˆ¤å®šï¼ˆãƒ›ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼‰
        // =====================================
        if (amHost) {
            // BAN â†’ PIC1: ä¸¡è€…ç¢ºå®šã—ãŸã‚‰é·ç§»
            if (dbPhase === 'ban' && blueConfirmed && redConfirmed) {
                console.log('Host: BAN complete, transitioning to PIC1');
                gameRef.update({
                    phase: 'pic1',
                    phaseIndex: 1,
                    blueConfirmed: false,
                    redConfirmed: false
                }).catch(e => console.warn('Phase transition failed:', e));
                return; // æ¬¡ã®æ›´æ–°ã§å‡¦ç†ã•ã‚Œã‚‹
            }

            // PICé€²è¡Œ: è©²å½“ãƒãƒ¼ãƒ ãŒç¢ºå®šã—ãŸã‚‰æ¬¡ã¸
            if (dbPhase.startsWith('pic')) {
                const picNum = parseInt(dbPhase.replace('pic', ''));
                // PIC 1,4,5 = å…ˆæ”»(blue)ã®ã‚¿ãƒ¼ãƒ³ / PIC 2,3,6 = å¾Œæ”»(red)ã®ã‚¿ãƒ¼ãƒ³
                const isBluePhase = [1, 4, 5].includes(picNum);
                const turnConfirmed = isBluePhase ? blueConfirmed : redConfirmed;

                if (turnConfirmed) {
                    if (picNum < 6) {
                        console.log(`Host: PIC${picNum} complete, transitioning to PIC${picNum + 1}`);
                        gameRef.update({
                            phase: `pic${picNum + 1}`,
                            phaseIndex: picNum + 1,
                            blueConfirmed: false,
                            redConfirmed: false
                        }).catch(e => console.warn('Phase transition failed:', e));
                    } else {
                        console.log('Host: All PICs complete, transitioning to done');
                        gameRef.update({
                            phase: 'done',
                            phaseIndex: 7
                        }).catch(e => console.warn('Phase transition failed:', e));
                    }
                    return; // æ¬¡ã®æ›´æ–°ã§å‡¦ç†ã•ã‚Œã‚‹
                }
            }
        }

        // =====================================
        // 3. ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’DBã¨åŒæœŸ
        // =====================================
        const phaseChanged = (previousPhase !== null && previousPhase !== dbPhase);
        previousPhase = dbPhase;

        // ãƒ•ã‚§ãƒ¼ã‚ºã‚’æ›´æ–°
        banpicState.phase = dbPhase;
        banpicState.phaseIndex = dbPhaseIndex;

        // è‡ªåˆ†ã®ç¢ºå®šçŠ¶æ…‹ã‚’DBã‹ã‚‰å–å¾—
        const myConfirmedInDB = myIsBlue ? blueConfirmed : redConfirmed;
        
        // ãƒ•ã‚§ãƒ¼ã‚ºãŒå¤‰ã‚ã£ãŸå ´åˆ
        if (phaseChanged) {
            console.log('Phase changed to:', dbPhase);
            banpicState.selectedCharacters = [];
            banpicState.confirmed = false;
            banpicState.banPhaseComplete = (dbPhase !== 'ban');

            if (dbPhase === 'done') {
                stopPhaseTimer();
                showBanpicResult();
            } else {
                stopPhaseTimer();
                startPhaseTimer();
            }
        } else {
            // ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ãªã—ã®å ´åˆã€DBã®ç¢ºå®šçŠ¶æ…‹ã‚’åæ˜ 
            banpicState.confirmed = myConfirmedInDB;
        }

        // =====================================
        // 4. UIæ›´æ–°
        // =====================================
        renderCharacterGrid();
        updateSlotPreview();
        updatePickOrderLabels();
        updatePhaseDisplay();
        updateConfirmButton();
    });

    // UI åˆæœŸåŒ–
    const banpicModeEl = document.getElementById('banpic-mode');
    const banpicMapEl = document.getElementById('banpic-map');
    if (banpicModeEl) banpicModeEl.textContent = banpicState.mode.name;
    if (banpicMapEl) banpicMapEl.textContent = banpicState.map;

    document.querySelectorAll('.ban-slot, .pick-slot').forEach(slot => {
        slot.innerHTML = '';
        slot.classList.remove('filled');
        slot.classList.add('empty');
    });

    // åå‰è¡¨ç¤º: å„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§è‡ªåˆ†ãŒå·¦ï¼ˆé’å´ï¼‰ã€ç›¸æ‰‹ãŒå³ï¼ˆèµ¤å´ï¼‰ã«è¡¨ç¤º
    const blueNameEl = document.getElementById('blue-player-name');
    const redNameEl = document.getElementById('red-player-name');
    const myName = amHost ? (meta.hostName || 'ãƒ›ã‚¹ãƒˆ') : (meta.guestName || 'ã‚²ã‚¹ãƒˆ');
    const opponentName = amHost ? (meta.guestName || 'ã‚²ã‚¹ãƒˆ') : (meta.hostName || 'ãƒ›ã‚¹ãƒˆ');
    
    // è‡ªåˆ†ãŒé’ãƒãƒ¼ãƒ ï¼ˆå·¦å´ï¼‰ãªã‚‰è‡ªåˆ†ã®åå‰ã‚’å·¦ã«ã€ãã†ã§ãªã‘ã‚Œã°ç›¸æ‰‹ã®åå‰ã‚’å·¦ã«
    if (myIsBlue) {
        if (blueNameEl) blueNameEl.textContent = myName;
        if (redNameEl) redNameEl.textContent = opponentName;
    } else {
        if (blueNameEl) blueNameEl.textContent = opponentName;
        if (redNameEl) redNameEl.textContent = myName;
    }

    // ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤ºã‚’è¨­å®š
    setPlayerAvatars(meta, amHost, myIsBlue);

    const firstMoveIndicator = document.getElementById('first-move-indicator');
    if (firstMoveIndicator) {
        // å…ˆæ”»ã¯å¸¸ã«é’ãƒãƒ¼ãƒ å´ã®åå‰
        const firstMoverName = resolvedIsBlue 
            ? (meta.hostName || 'ãƒ›ã‚¹ãƒˆ') 
            : (meta.guestName || 'ã‚²ã‚¹ãƒˆ');
        firstMoveIndicator.textContent = `å…ˆæ”»: ${firstMoverName}`;
    }

    // ãƒãƒƒãƒ—ãƒãƒŠãƒ¼ã‚’æ­£ã—ãè¨­å®šï¼ˆã‚²ã‚¹ãƒˆå´ã§ã‚‚åæ˜ ï¼‰
    const modeKey = meta.mode || 'eme';
    const mapName = meta.mapName || 'é™ã‹ãªåºƒå ´';
    // ãƒãƒƒãƒ—ç”»åƒã‚’å–å¾—
    let mapImage = null;
    if (typeof imageData !== 'undefined' && imageData.maps) {
        const mapObj = imageData.maps.find(m => m.name === mapName);
        if (mapObj) mapImage = mapObj.image;
    }
    applyBanner(modeKey, mapName, mapImage);

    showScreen('game-screen');
    renderCharacterGrid();
    updateSlotPreview();
    updatePickOrderLabels();
    updatePhaseDisplay();
    updateConfirmButton();
    startPhaseTimer();
}

// ãƒ”ãƒƒã‚¯é †ãƒ©ãƒ™ãƒ«æ›´æ–°ï¼ˆå›ºå®š: å·¦=1,4,5 / å³=2,3,6ï¼‰
function updatePickOrderLabels() {
    const blueSlots = document.querySelectorAll('#pick-slots-blue .pick-slot');
    const redSlots = document.querySelectorAll('#pick-slots-red .pick-slot');
    
    // å¸¸ã«å›ºå®š: å·¦å´(å…ˆæ”»)=1,4,5 / å³å´(å¾Œæ”»)=2,3,6
    // è¡¨ç¤ºã¯å·¦ã‹ã‚‰: top-row(é’)ãŒ 1,4,5ã€‚
    // bottom-row(èµ¤)ã¯å·¦ã‹ã‚‰ 6,3,2 ã¨è¡¨ç¤ºã™ã‚‹ï¼ˆå·¦â†’å³ã§ 1 4 5 6 3 2 ã¨ãªã‚‹ã‚ˆã†ã«ï¼‰
    const blueOrder = [1, 4, 5];
    const redOrder = [6, 3, 2];
    
    blueSlots.forEach((slot, i) => {
        let badge = slot.querySelector('.pick-order');
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'pick-order';
            slot.appendChild(badge);
        }
        badge.textContent = blueOrder[i] || (i+1);
    });
    
    redSlots.forEach((slot, i) => {
        let badge = slot.querySelector('.pick-order');
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'pick-order';
            slot.appendChild(badge);
        }
        badge.textContent = redOrder[i] || (i+4);
    });
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ã‚’è¨­å®šï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
function setPlayerAvatars(meta, amHost, myIsBlue) {
    const blueAvatarEl = document.getElementById('blue-player-avatar');
    const redAvatarEl = document.getElementById('red-player-avatar');
    
    const myId = amHost ? meta.hostId : meta.guestId;
    const opponentId = amHost ? meta.guestId : meta.hostId;
    
    // è‡ªåˆ†ã¨ç›¸æ‰‹ã®IDã‚’é’/èµ¤ã«å‰²ã‚Šå½“ã¦
    const blueId = myIsBlue ? myId : opponentId;
    const redId = myIsBlue ? opponentId : myId;
    
    // é’å´ï¼ˆå·¦ï¼‰ã®ã‚¢ãƒã‚¿ãƒ¼å–å¾—
    if (blueId && blueAvatarEl) {
        database.ref(`users/${blueId}`).once('value').then(snap => {
            const p = snap.val();
            if (p && p.avatar) {
                blueAvatarEl.innerHTML = `<img src="${p.avatar}" alt="player">`;
            } else {
                blueAvatarEl.textContent = 'ğŸ‘¤';
            }
        }).catch(() => { blueAvatarEl.textContent = 'ğŸ‘¤'; });
    }
    
    // èµ¤å´ï¼ˆå³ï¼‰ã®ã‚¢ãƒã‚¿ãƒ¼å–å¾—
    if (redId && redAvatarEl) {
        database.ref(`users/${redId}`).once('value').then(snap => {
            const p = snap.val();
            if (p && p.avatar) {
                redAvatarEl.innerHTML = `<img src="${p.avatar}" alt="player">`;
            } else {
                redAvatarEl.textContent = 'ğŸ‘¤';
            }
        }).catch(() => { redAvatarEl.textContent = 'ğŸ‘¤'; });
    }
}

// ã‚³ã‚¤ãƒ³ãƒˆã‚¹æ¼”å‡ºã‚’è¡¨ç¤º
function showCoinToss(winnerName) {
    return new Promise(resolve => {
        const overlay = document.createElement('div');
        overlay.className = 'coin-toss-overlay';
        overlay.innerHTML = `
            <div class="coin-toss-title">ğŸ² å…ˆæ”»ã‚’æ±ºå®šä¸­...</div>
            <div class="coin">ğŸª™</div>
            <div class="coin-result">å…ˆæ”»: ${winnerName}</div>
        `;
        document.body.appendChild(overlay);
        
        // 2.5ç§’å¾Œã«ã‚³ã‚¤ãƒ³çµæœè¡¨ç¤ºâ†’ãƒãƒƒãƒ—ç”»åƒã‚’4ç§’è¡¨ç¤º
        setTimeout(() => {
            overlay.remove();
            showMapPreview().then(resolve);
        }, 2500);
    });
}

// ã‚³ã‚¤ãƒ³ãƒˆã‚¹å¾Œã«ãƒãƒƒãƒ—ç”»åƒã‚’4ç§’è¡¨ç¤º
function showMapPreview() {
    return new Promise(resolve => {
        const mapName = banpicState.map || '';
        let mapImage = '';
        
        if (IMAGE_DATA && IMAGE_DATA.maps) {
            const mapData = IMAGE_DATA.maps.find(m => m.name === mapName);
            if (mapData) mapImage = mapData.image;
        }
        
        if (!mapImage) {
            resolve();
            return;
        }
        
        const overlay = document.createElement('div');
        overlay.className = 'map-preview-overlay';
        overlay.innerHTML = `
            <div class="map-preview-title">ğŸ—ºï¸ ${mapName}</div>
            <img src="image/${mapImage}" class="map-preview-image" alt="${mapName}">
        `;
        document.body.appendChild(overlay);
        
        // 4ç§’å¾Œã«å‰Šé™¤
        setTimeout(() => {
            overlay.remove();
            resolve();
        }, 4000);
    });
}

// BANPICçµ‚äº†
function exitBanpic() {
    stopPhaseTimer();
    
    // Firebaseãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤ï¼ˆæ¬¡å›ã®ãƒ«ãƒ¼ãƒ ã§äºŒé‡ç™ºç«ã‚’é˜²æ­¢ï¼‰
    if (activeGameRef) {
        activeGameRef.off();
        activeGameRef = null;
    }
    
    // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    banpicState.roomId = null;
    banpicState.confirmed = false;
    banpicState.banPhaseComplete = false;
    
    // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼å‰Šé™¤
    const indicator = document.querySelector('.test-mode-indicator');
    if (indicator) indicator.remove();
    
    // ç¢ºå®šãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’å…ƒã«æˆ»ã™
    const btn = document.getElementById('confirm-selection-btn');
    if (btn) {
        btn.onclick = null;
        btn.removeEventListener('click', exitBanpic);
        btn.addEventListener('click', confirmSelection);
        btn.textContent = 'é¸æŠã‚’ç¢ºå®š';
        btn.disabled = true;
    }
    
    showScreen('lobby-screen');
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
document.addEventListener('DOMContentLoaded', () => {
    // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
    const testModeBtn = document.getElementById('test-mode-btn');
    if (testModeBtn) {
        testModeBtn.addEventListener('click', () => {
            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ã«å†åˆ©ç”¨
            if (!createRoomModal) return;
            createRoomModal.dataset.testMode = 'true';
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
            const headerH3 = document.querySelector('#create-room-modal .modal-header h3');
            if (headerH3) headerH3.textContent = 'ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰è¨­å®š';
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’åŸ‹ã‚ã‚‹
            const roomNameInput = document.getElementById('room-name-input');
            const modeSelect = document.getElementById('room-mode-select');
            const mapSelect = document.getElementById('room-map-select');
            if (roomNameInput) roomNameInput.value = 'ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ ';
            if (modeSelect) modeSelect.value = 'eme';
            if (mapSelect) {
                // ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã§ submit ãŒæ­¢ã¾ã‚‰ãªã„ã‚ˆã† required ã‚’ä¸€æ™‚è§£é™¤
                mapSelect.required = false;
                // populateMapSelect ã‚’å‘¼ã‚“ã§å¯¾è±¡ãƒ¢ãƒ¼ãƒ‰ã®å€™è£œã‚’ä½œã‚‹
                if (typeof populateMapSelect === 'function') populateMapSelect('eme');
                if (mapSelect.options && mapSelect.options.length > 1) {
                    // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ãƒ€ãƒ–ãƒ«ãƒ¬ãƒ¼ãƒ«ã‚’å„ªå…ˆé¸æŠ
                    let foundIndex = -1;
                    for (let i = 0; i < mapSelect.options.length; i++) {
                        if (mapSelect.options[i].text.includes('ãƒ€ãƒ–ãƒ«ãƒ¬ãƒ¼ãƒ«')) { foundIndex = i; break; }
                    }
                    mapSelect.selectedIndex = (foundIndex >= 0) ? foundIndex : 1;
                }
            }
            showModal(createRoomModal);
        });
    }
    
    // ç¢ºå®šãƒœã‚¿ãƒ³
    const confirmBtn = document.getElementById('confirm-selection-btn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', confirmSelection);
    }
    
    // ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
    const sortToggleBtn = document.getElementById('sort-toggle-btn');
    if (sortToggleBtn) {
        sortToggleBtn.addEventListener('click', () => {
            // ã‚½ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ: rarity â†’ name â†’ id â†’ rarity...
            const sortModes = ['rarity', 'name', 'id'];
            const currentIndex = sortModes.indexOf(currentBrawlerSort);
            const nextIndex = (currentIndex + 1) % sortModes.length;
            currentBrawlerSort = sortModes[nextIndex];
            
            // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            const labels = { rarity: 'ğŸ“Š', name: 'ğŸ”¤', id: 'ğŸ”¢' };
            sortToggleBtn.textContent = labels[currentBrawlerSort];
            sortToggleBtn.title = currentBrawlerSort === 'rarity' ? 'ãƒ¬ã‚¢åº¦é †' : 
                                   currentBrawlerSort === 'name' ? 'åå‰é †' : 'IDé †';
            
            // ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»
            renderCharacterGrid();
        });
    }
});
</script>
</body>
</html>
